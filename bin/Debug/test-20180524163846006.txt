#region copyright
// <copyright file="NotSupportExpressionException.cs" company="cis"> 
// Copyright (c) cis. All Right Reserved
// </copyright>
// <author>孙强</author>
// <datecreated>2018-04-20</datecreated>
#endregion
namespace Cis.BaseDto
{
    using Cis.BaseModel;
    using System.ComponentModel;
    public interface IPageRequest
    {
        int PageNum { get; set; }
        int PageSize { get; set; }
        int? TotalCount { get; set; }
    }
    /// <summary>
    /// 请求
    /// </summary>
    [Description("请求2")]
    public abstract class PageRequst2<TResult> : BaseModel<TResult>, IPageRequest where TResult : class
    {
        private int _pageNum = 1;
        public int PageNum
        {
            get
            {
                if (_pageNum < 1)
                {
                    _pageNum = 1;
                }
                return _pageNum;
            }
            set
            {
                _pageNum = value;
            }
        }
        public int PageSize { get; set; } = 10;
        public int? TotalCount { get; set; }
        public int BeginIndex
        {
            get { return (_pageNum - 1) * PageSize; }
        }
        public int EndIndex
        {
            get { return _pageNum * PageSize; }
        }
    }
    /// <summary>
    /// 请求
    /// </summary>
    [Description("请求")]
    public abstract class PageRequst : IPageRequest
    {
        private int _pageNum = 1;
        public int PageNum
        {
            get
            {
                if (_pageNum < 1)
                {
                    _pageNum = 1;
                }
                return _pageNum;
            }
            set
            {
                _pageNum = value;
            }
        }
        public int PageSize { get; set; } = 10;
        public int? TotalCount { get; set; }
        public int BeginIndex
        {
            get { return (_pageNum - 1) * PageSize; }
        }
        public int EndIndex
        {
            get { return _pageNum * PageSize; }
        }
    }
}
#region copyright
// <copyright file="NotSupportExpressionException.cs" company="cis"> 
// Copyright (c) cis. All Right Reserved
// </copyright>
// <author>孙强</author>
// <datecreated>2018-04-20</datecreated>
#endregion
namespace Cis.BaseDto
{
    using System.ComponentModel;
    using System;
    /// <summary>
    /// 分页列表响应
    /// </summary>
    [Description("分页列表响应")]
    public class PageResponse<T> : Response<T>
    {
        /// <summary>
        /// 总数
        /// </summary>
        [Description("总数")]
        public int? TotalCount { get; set; }
        /// <summary>
        /// 分页大小
        /// </summary>
        [Description("分页大小")]
        public int PageSize { get; set; }
        private int _pageNum = 1;
        /// <summary>
        /// 页索引
        /// </summary>
        [Description("页索引")]
        public int PageNum
        {
            get
            {
                if (_pageNum < 1)
                {
                    _pageNum = 1;
                }
                if (TotalCount > 0 && _pageNum > Math.Ceiling((double)TotalCount / PageSize))
                {
                    _pageNum = (int)Math.Ceiling((double)TotalCount / PageSize);
                }
                return _pageNum;
            }
            set
            {
                _pageNum = value;
            }
        }
    }
}
#region copyright
// <copyright file="NotSupportExpressionException.cs" company="cis"> 
// Copyright (c) cis. All Right Reserved
// </copyright>
// <author>孙强</author>
// <datecreated>2018-04-20</datecreated>
#endregion
namespace Cis.BaseDto
{
    using System.ComponentModel;
    /// <summary>
    /// 获取单个实体响应
    /// </summary>
    [Description("获取单个实体响应")]
    public class Response<T>
    {
        /// <summary>
        /// 错误码
        /// </summary>
        [Description("错误码")]
        public string ErrCode { get; set; }
        /// <summary>
        /// 错误信息
        /// </summary>
        [Description("错误信息")]
        public string ErrMsg { get; set; }
        /// <summary>
        /// 附加信息
        /// </summary>
        [Description("附加信息")]
        public object AttachedObject { get; set; }
        /// <summary>
        /// 响应结果是否错误
        /// </summary>
        [Description("响应结果是否成功")]
        public bool IsSuccess
        {
            get
            {
                return string.IsNullOrEmpty(this.ErrMsg);
            }
        }
        /// <summary>
        /// 子项
        /// </summary>
        [Description("子项")]
        public T Result { get; set; }
    }
}
using Cis.BaseModel.Enum;
using Cis.BaseModel.SqlAttribute;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using System.Text;
namespace Cis.BaseModel
{
    public abstract class BaseModel<TResult> : IBaseModel
    {
        /// <summary>
        /// 动态对象访问器
        /// </summary>
        public static readonly DynamicAccessor<TResult> DynamicAccessor = new DynamicAccessor<TResult>();
        /// <summary>
        /// select查询列
        /// </summary>
        public static string DbSelect = GetSelectStr();
        private static string GetSelectStr()
        {
            StringBuilder sb = new StringBuilder();
            Dictionary<string, string> rel = new Dictionary<string, string>();
            foreach (var propertyInfo in typeof(TResult).GetProperties())
            {
                var ca = propertyInfo.GetCustomAttributes(true).OfType<SqlSelectAttribute>().FirstOrDefault();
                if (ca != null)
                {
                    var tableAlias = string.IsNullOrEmpty(ca.TableAlias) ? "" : (ca.TableAlias + ".");
                    var colName = (ca.ColName ?? propertyInfo.Name);
                    if (string.IsNullOrEmpty(ca.Format))
                    {
                        sb.Append(" " + tableAlias + colName + ",");
                    }
                    else
                    {
                        sb.AppendFormat(" " + tableAlias + ca.Format + ",", colName);
                    }
                }
            }
            if (sb.Length > 0)
            {
                sb.Remove(sb.Length - 1, 1);
            }
            sb.Append(" ");
            return sb.ToString();
        }
        /// <summary>
        /// sql查询信息
        /// </summary>
        [Newtonsoft.Json.JsonIgnore]
        public DbInfo DbInfo { get; set; }
        /// <summary>
        /// 设置查询sql参数
        /// </summary>
        public void SetDbInfo()
        {
            DbInfo = new DbInfo();
            var appendList = new List<PropertyInfo>();
            var allList = typeof(TResult).GetProperties().Where(m =>
            {
                var whereAttr = m.GetCustomAttributes(true).OfType<SqlWhereAttribute>().FirstOrDefault();
                object value = this.GetValue(m.Name);
                return whereAttr != null && IsAppend(whereAttr, value);
            });
            var sigleList = allList.Where(m =>
            {
                var whereAttr = m.GetCustomAttributes(true).OfType<SqlWhereAttribute>().FirstOrDefault();
                return whereAttr.IsSingle;
            });
            if (sigleList.Count() > 0)
            {
                var requireList = allList.Where(m =>
                {
                    var whereAttr = m.GetCustomAttributes(true).OfType<SqlWhereAttribute>().FirstOrDefault();
                    return whereAttr.IsRequire;
                });
                appendList = sigleList.Union(requireList).ToList();
            }
            else
            {
                SetSql();
                appendList = allList.ToList();
            }
            foreach (var propertyInfo in appendList)
            {
                object value = this.GetValue(propertyInfo.Name);
                var whereAttr = propertyInfo.GetCustomAttributes(true).OfType<SqlWhereAttribute>().FirstOrDefault();
                AppendWhere(whereAttr, propertyInfo, value);
                AppendJoin(propertyInfo, (whereAttr.TableAlias ?? "") + propertyInfo.Name);
            }
            SetRequireSql();
        }
        /// <summary>
        /// 判断where条件是否需要添加
        /// </summary>
        /// <param name="whereAttr"></param>
        /// <param name="value"></param>
        /// <returns></returns>
        private bool IsAppend(SqlWhereAttribute whereAttr, object value)
        {
            var formula = whereAttr.Formula;
            var isAppend = false;
            switch (whereAttr.ConditionType)
            {
                case ConditionType.IsNullOrEmpty:
                    if (value != null)
                    {
                        if (value is string && value.ToString().Trim() != "")
                        {
                            if (formula == "in" || formula == "not in")
                            {
                                string[] list = value.ToString().Split(new char[] { whereAttr.InSplit }, StringSplitOptions.RemoveEmptyEntries);
                                if (list.Length > 0)
                                {
                                    isAppend = true;
                                }
                            }
                            else
                            {
                                isAppend = true;
                            }
                        }
                        else if (value is IEnumerable<object>)
                        {
                            var tempList = new List<object>();
                            foreach (var item in (value as IEnumerable<object>))
                            {
                                string tempStr = (item ?? "").ToString();
                                if (!string.IsNullOrEmpty(tempStr) && tempStr != (whereAttr.Values ?? "").ToString())
                                {
                                    tempList.Add(item);
                                }
                            }
                            var count = tempList.Count;
                            if (count > 0)
                            {
                                isAppend = true;
                            }
                        }
                        else if (value is int || value is long || value is decimal || value is System.Enum)
                        {
                            if (Convert.ToDecimal(value) != 0)
                            {
                                isAppend = true;
                            }
                        }
                        else if (value is DateTime)
                        {
                            if ((Convert.ToDateTime(value)) != DateTime.MinValue)
                            {
                                isAppend = true;
                            }
                        }
                    }
                    break;
                default:
                    break;
            }
            return isAppend;
        }
        /// <summary>
        /// 添加where条件
        /// </summary>
        /// <param name="whereAttr"></param>
        /// <param name="propertyInfo"></param>
        /// <param name="value"></param>
        private void AppendWhere(SqlWhereAttribute whereAttr, PropertyInfo propertyInfo, object value)
        {
            var tableAlias = string.IsNullOrEmpty(whereAttr.TableAlias) ? "" : (whereAttr.TableAlias + ".");
            var colName = tableAlias + (whereAttr.ColName ?? propertyInfo.Name);
            var paramName = (whereAttr.TableAlias ?? "") + propertyInfo.Name;
            var formula = whereAttr.Formula.ToLower().Trim();
            object newValue = null;
            if (value is string && (formula == "in" || formula == "not in"))
            {
                string[] list = value.ToString().Split(new char[] { whereAttr.InSplit }, StringSplitOptions.RemoveEmptyEntries);
                if (list.Length == 1)
                {
                    formula = formula == "in" ? "=" : "<>";
                    value = list.First();
                }
                else
                {
                    value = list;
                }
            }
            else if (value is IEnumerable<object>)
            {
                var tempList = new List<object>();
                foreach (var item in (value as IEnumerable<object>))
                {
                    string tempStr = (item ?? "").ToString();
                    if (!string.IsNullOrEmpty(tempStr) && tempStr != (whereAttr.Values ?? "").ToString())
                    {
                        tempList.Add(item);
                    }
                }
                if (tempList.Count == 1)
                {
                    formula = "=";
                    value = tempList.First();
                }
                else
                {
                    value = tempList;
                }
            }
            newValue = value;
            switch (formula)
            {
                case "in":
                case "not in":
                    if (string.IsNullOrEmpty(whereAttr.TmpTableName))
                    {
                        DbInfo.WhereJoin.Add(string.Format(
                            " inner join (select column_value from table(PKG_Tools_Str.fun_Str_Split(:{0},'{1}'))) {0}_ on {0}_.column_value {2} {3} ",
                            paramName,
                            whereAttr.InSplit,
                            formula == "in" ? "=" : "<>",
                            colName));
                        if (value is IEnumerable)
                        {
                            newValue = String.Join(whereAttr.InSplit.ToString(), (value as IEnumerable<object>).ToArray());
                        }
                    }
                    else
                    {
                        if (string.IsNullOrEmpty(whereAttr.TmpTableColName))
                        {
                            throw new Exception("where 使用临时表方案必须指定临时表列名");
                        }
                        DbInfo.Where.Add(string.Format(
                            "{0}(select 1 from Global_Temp_Search where {1}={2})",
                            formula == "in" ? "exists" : "not exists",
                            whereAttr.TmpTableColName,
                            colName));
                        DbInfo.TmpTables.Add(new TmpTable()
                        {
                            TableName = whereAttr.TmpTableName,
                            TableColName = whereAttr.TmpTableColName,
                            Values = value as IEnumerable<object>
                        });
                        newValue = null;
                    }
                    break;
                default:
                    if (string.IsNullOrEmpty(whereAttr.ColName))
                    {
                        break;
                    }
                    if (value is DateTime && !string.IsNullOrEmpty(whereAttr.DateTimeFormat))
                    {
                        var dateStr = ((DateTime)value).ToString(whereAttr.DateTimeFormat);
                        DbInfo.Where.Add(String.Format("{0} {1} '{2}'", colName, formula, dateStr));
                        newValue = null;
                    }
                    else if (value is string && !string.IsNullOrEmpty(whereAttr.DateTimeFormat))
                    {
                        var dateStr = DateTime.ParseExact(
                                value.ToString(),
                                whereAttr.DateTimeFormat,
                                System.Globalization.CultureInfo.CurrentCulture
                            ).ToString(whereAttr.DateTimeFormat);
                        DbInfo.Where.Add(String.Format("{0} {1} '{2}'", colName, formula, dateStr));
                        newValue = null;
                    }
                    else
                    {
                        DbInfo.Where.Add(String.Format("{0} {1} :{2}", colName, formula, paramName));
                    }
                    break;
            }
            if (newValue != null)
            {
                DbInfo.Params.Add(paramName, newValue);
            }
        }
        /// <summary>
        /// 添加join
        /// </summary>
        /// <param name="propertyInfo"></param>
        /// <param name="paramName"></param>
        private void AppendJoin(PropertyInfo propertyInfo, string paramName)
        {
            var joinAttr = propertyInfo.GetCustomAttributes(true).OfType<SqlJoinAttribute>().FirstOrDefault();
            if (joinAttr != null && !string.IsNullOrEmpty(joinAttr.JoinString))
            {
                this.DbInfo.FromJoin.Add(string.Format(joinAttr.JoinString, paramName));
            }
        }
        /// <summary>
        /// 特殊条件添加
        /// </summary>
        public virtual void SetSql() { }
        /// <summary>
        /// 必须添加的特殊条件
        /// </summary>
        public virtual void SetRequireSql() { }
        /// <summary>
        /// 根据属性名称获取值 动态编译方法
        /// </summary>
        /// <param name="name"></param>
        /// <returns></returns>
        public object GetValue(string name)
        {
            return DynamicAccessor.GetValue(this, name);
        }
        /// <summary>
        /// 根据属性名称设置值 动态编译方法
        /// </summary>
        /// <param name="name"></param>
        /// <param name="value"></param>
        public void SetValue(string name, object value)
        {
            DynamicAccessor.SetValue(this, name, value);
        }
    }
    /// <summary>
    /// 临时表信息
    /// </summary>
    public class TmpTable
    {
        public string TableName { get; set; }
        public string TableColName { get; set; }
        public IEnumerable<object> Values { get; set; }
    }
    /// <summary>
    /// sql查询信息
    /// </summary>
    public class DbInfo
    {
        public List<string> Where { get; set; } = new List<string>();
        public List<string> FromJoin { get; set; } = new List<string>();
        public List<string> WhereJoin { get; set; } = new List<string>();
        public string WhereStr
        {
            get
            {
                return string.Join(" and ", Where);
            }
        }
        public string JoinStr
        {
            get
            {
                return string.Join(" ", FromJoin) + " " + string.Join(" ", WhereJoin);
            }
        }
        public IDictionary<string, object> Params { get; set; } = new Dictionary<string, object>();
        public List<TmpTable> TmpTables { get; set; } = new List<TmpTable>();
    }
}
using System.Collections.Generic;
using System.Data;
namespace Cis.BaseModel
{
    /// <summary>
    /// 数据源转为Model 作者:苗建龙
    /// </summary>
    public class DeserializeObject
    {
        /// <summary>
        /// DataRow to Model
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="row"></param>
        /// <returns></returns>
        public static T CreateItem<T>(DataRow row) where T : class
        {
            return BaseModel<T>.DynamicAccessor.GetModel(row, GetColumns(row.Table.Columns));
        }
        /// <summary>
        /// DataRow to Model
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="row"></param>
        /// <param name="columns"></param>
        /// <returns></returns>
        public static T CreateItem<T>(DataRow row, IList<string> columns) where T : class
        {
            return BaseModel<T>.DynamicAccessor.GetModel(row, columns);
        }
        /// <summary>
        /// IDataRecord to Model
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="row"></param>
        /// <returns></returns>
        public static T CreateItem<T>(IDataRecord dr) where T : class
        {
            return BaseModel<T>.DynamicAccessor.GetModel(dr, GetColumns(dr));
        }
        /// <summary>
        /// IDataRecord to Model
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="dr"></param>
        /// <param name="columns"></param>
        /// <returns></returns>
        public static T CreateItem<T>(IDataRecord dr, IList<string> columns) where T : class
        {
            return BaseModel<T>.DynamicAccessor.GetModel(dr, columns);
        }
        /// <summary>
        /// IDataRecord to Model
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="row"></param>
        /// <returns></returns>
        public static T CreateItem<T>(IDictionary<string, object> dic) where T : class
        {
            return BaseModel<T>.DynamicAccessor.GetModel(dic);
        }
        /// <summary>
        /// 列明忽略大小写 保持效率
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="table"></param>
        /// <returns></returns>
        public static IList<T> ConvertTo<T>(DataTable table) where T : class
        {
            List<string> cols = GetColumns(table.Columns);
            IList<T> list = new List<T>();
            foreach (DataRow row in table.Rows)
            {
                list.Add(CreateItem<T>(row, cols));
            }
            return list;
        }
        /// <summary>
        /// DataColumnCollection 转List<string> 忽略大小写
        /// </summary>
        /// <param name="cols"></param>
        /// <returns></returns>
        private static List<string> GetColumns(DataColumnCollection cols)
        {
            List<string> columnNames = new List<string>();
            for (int i = 0; i < cols.Count; i++)
            {
                //.ToUpper()可忽略大小写转换
                columnNames.Add(cols[i].ColumnName.ToUpper());
            }
            return columnNames;
        }
        /// <summary>
        /// 
        /// </summary>
        /// <param name="record"></param>
        /// <returns></returns>
        private static List<string> GetColumns(IDataRecord record)
        {
            List<string> columnNames = new List<string>();
            for (int i = 0; i < record.FieldCount; i++)
            {
                //.ToUpper()可忽略大小写转换
                columnNames.Add(record.GetName(i).ToUpper());
            }
            return columnNames;
        }
    }
}
using Cis.BaseModel.SqlAttribute;
using Cis.DbLight.TableMetadata;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Linq;
using System.Linq.Expressions;
using System.Reflection;
using System.Threading.Tasks;
namespace Cis.BaseModel
{
    /// <summary>
    /// Model动态对象
    /// 动态编译相关功能
    /// </summary>
    /// <typeparam name="TResult"></typeparam>
    public class DynamicAccessor<TResult>
    {
        private Action<object, string, object> _setValueDelegate;
        private Func<object, string, object> _getValueDelegate;
        private Func<IDataRecord, IList<string>, TResult> _getModelByIDataRecordDelegate;
        private Func<DataRow, IList<string>, TResult> _getModelByDataRowDelegate;
        private Func<IDictionary<string, object>, TResult> _getModelByIDictionaryDelegate;
        private Type _type;
        /// <summary>
        /// 实例化
        /// </summary>
        public DynamicAccessor()
        {
            _type = typeof(TResult);
            ProMap = GetProMap();
            //ColumnProMap = GetColumnProMap();
            _getValueDelegate = GenerateGetValue();
            _setValueDelegate = GenerateSetValue();
            _getModelByDataRowDelegate = GenerateGetModelByDataRow();
            _getModelByIDataRecordDelegate = GenerateGetModelByIDataRecord();
            _getModelByIDictionaryDelegate = GenerateGetModelByIDictionary();
        }
        /// <summary>
        /// 属性-名称 映射列表
        /// </summary>
        public Dictionary<string, string> ProMap { get; set; }
        /// <summary>
        /// 属性-Column 映射列表
        /// </summary>
        //public Dictionary<string, ColumnAttribute> ColumnProMap { get; set; }
        /// <summary>
        /// 获取指定对象的指定属性的值
        /// </summary>
        /// <param name="instance">要获取属性值的对象</param>
        /// <param name="memberName">要获取的属性的名称</param>
        /// <returns></returns>
        public object GetValue(object instance, string memberName)
        {
            return _getValueDelegate(instance, memberName);
        }
        /// <summary>
        /// 为指定对象的指定属性设置值。
        /// </summary>
        /// <param name="instance">要设置属性的对象</param>
        /// <param name="memberName">要设置的属性名</param>
        /// <param name="newValue">要设置的值</param>
        public void SetValue(object instance, string memberName, object newValue)
        {
            _setValueDelegate(instance, memberName, newValue == DBNull.Value ? null : newValue);
        }
        /// <summary>
        /// 根据IDataRecord GetModel
        /// </summary>
        /// <param name="dr"></param>
        /// <returns></returns>
        public TResult GetModel(IDataRecord dr, IList<string> columns)
        {
            return _getModelByIDataRecordDelegate(dr, columns);
        }
        /// <summary>
        /// 根据DataRow  GetModel
        /// </summary>
        /// <param name="dr"></param>
        /// <returns></returns>
        public TResult GetModel(DataRow dr, IList<string> columns)
        {
            return _getModelByDataRowDelegate(dr, columns);
        }
        /// <summary>
        /// IDictionary GetModel
        /// </summary>
        /// <param name="dic"></param>
        /// <returns></returns>
        public TResult GetModel(IDictionary<string, object> dic)
        {
            return _getModelByIDictionaryDelegate(dic);
        }
        /// <summary>
        /// 设置属性小写对应列表 用于做映射
        /// 属性名和数据列名不一定要一致  列名保证全部大写 否则会影响性能
        /// </summary>
        /// <returns></returns>
        private Dictionary<string, string> GetProMap()
        {
            Dictionary<string, string> rel = new Dictionary<string, string>();
            foreach (var propertyInfo in _type.GetProperties())
            {
                //rel.Add(propertyInfo.Name.ToLower(), propertyInfo.Name);
                //rel.Add(propertyInfo.Name.ToLower(), GetDbColumnName(propertyInfo));
                var sa = propertyInfo.GetCustomAttributes(true).OfType<SqlSelectAttribute>().FirstOrDefault();
                if (sa != null)
                {
                    rel.Add(propertyInfo.Name.ToLower(), sa.ColName);
                }
                else
                {
                    var sa2 = propertyInfo.GetCustomAttributes(true).OfType<ColumnAttribute>().FirstOrDefault();
                    if (sa2 != null)
                    {
                        rel.Add(propertyInfo.Name.ToLower(), sa2.ColumnName);
                    }
                    else
                    {
                        rel.Add(propertyInfo.Name.ToLower(), propertyInfo.Name);
                    }
                }
            }
            return rel;
        }
        /// <summary>
        /// 设置属性小写对应列表 用于与Column做映射
        /// 属性名和数据列名不一定要一致  列名保证全部大写 否则会影响性能
        /// </summary>
        /// <returns></returns>
        //private Dictionary<string, ColumnAttribute> GetColumnProMap()
        //{
        //    //Dictionary<string, ColumnAttribute> dict = new Dictionary<string, ColumnAttribute>();
        //    //foreach (var propertyInfo in _type.GetProperties())
        //    //{
        //    //    var attribute = propertyInfo.GetCustomAttributes(true).OfType<ColumnAttribute>().FirstOrDefault();
        //    //    if (attribute != null)
        //    //    {
        //    //        dict.Add(propertyInfo.Name.ToLower(), attribute);
        //    //    }
        //    //    else
        //    //    {
        //    //        dict.Add(propertyInfo.Name.ToLower(), null);
        //    //    }
        //    //}
        //    return dict;
        //}
        /// <summary>
        /// 构建读取值函数
        /// </summary>
        /// <returns></returns>
        private Func<object, string, object> GenerateGetValue()
        {
            var instance = Expression.Parameter(typeof(object), "instance");
            var memberName = Expression.Parameter(typeof(string), "memberName");
            var nameHash = Expression.Variable(typeof(int), "nameHash");
            var calHash = Expression.Assign(nameHash, Expression.Call(memberName, typeof(object).GetMethod("GetHashCode")));
            var cases = new List<SwitchCase>();
            foreach (var propertyInfo in _type.GetProperties())
            {
                if (propertyInfo.CanRead)
                {
                    var property = Expression.Property(Expression.Convert(instance, _type), propertyInfo.Name);
                    var propertyHash = Expression.Constant(propertyInfo.Name.GetHashCode(), typeof(int));
                    cases.Add(Expression.SwitchCase(Expression.Convert(property, typeof(object)), propertyHash));
                }
            }
            var switchEx = Expression.Switch(nameHash, Expression.Constant(null), cases.ToArray());
            var methodBody = Expression.Block(typeof(object), new[] { nameHash }, calHash, switchEx);
            return Expression.Lambda<Func<object, string, object>>(methodBody, instance, memberName).Compile();
        }
        /// <summary>
        /// 构建设置属性值函数
        /// </summary>
        /// <returns></returns/
        private Action<object, string, object> GenerateSetValue()
        {
            var instance = Expression.Parameter(typeof(object), "instance");
            var memberName = Expression.Parameter(typeof(string), "memberName");
            var newValue = Expression.Parameter(typeof(object), "newValue");
            var nameHash = Expression.Variable(typeof(int), "nameHash");
            var calHash = Expression.Assign(nameHash, Expression.Call(memberName, typeof(object).GetMethod("GetHashCode")));
            var cases = new List<SwitchCase>();
            foreach (var propertyInfo in _type.GetProperties())
            {
                // 属性必须可写
                //if (!(propertyInfo.CanWrite && IsSimpleType(propertyInfo.PropertyType)))
                if (!propertyInfo.CanWrite)
                {
                    continue;
                }
                var property = Expression.Property(Expression.Convert(instance, _type), propertyInfo.Name);
                var setValue = Expression.Assign(property, Expression.Convert(newValue, propertyInfo.PropertyType));
                var propertyHash = Expression.Constant(propertyInfo.Name.GetHashCode(), typeof(int));
                cases.Add(Expression.SwitchCase(Expression.Convert(setValue, typeof(object)), propertyHash));
            }
            var switchEx = Expression.Switch(nameHash, Expression.Constant(null), cases.ToArray());
            var methodBody = Expression.Block(new[] { nameHash }, calHash, switchEx);
            return Expression.Lambda<Action<object, string, object>>(methodBody, instance, memberName, newValue).Compile();
        }
        /// <summary>
        /// 获得属性的赋值表达式
        /// </summary>
        /// <param name="instance"></param>
        /// <param name="pro"></param>
        /// <param name="value"></param>
        /// <returns></returns>
        private Expression GetSetValueExpression(Expression instance, PropertyInfo pro, Expression getValue)
        {
            bool isNullable = IsNullableType(pro.PropertyType);
            string convertFn = GetConvertFn(pro.PropertyType);
            var tempGetValue = getValue;
            if (pro.PropertyType.IsEnum)
            {
                //枚举特殊处理
                tempGetValue = Expression.Call
                (
                    typeof(Convert).GetMethod("ChangeType", new Type[] { typeof(object), typeof(Type) }),
                    getValue,
                    Expression.Constant(pro.PropertyType.GetEnumUnderlyingType())
                );
            }
            Expression convertValue;
            if (string.IsNullOrEmpty(convertFn))
            {
                convertValue = Expression.Convert(tempGetValue, pro.PropertyType);
            }
            else
            {
                //强制转换
                Type convertsionType = null;
                if (isNullable)
                {
                    convertsionType = new NullableConverter(pro.PropertyType).UnderlyingType;
                    convertValue = Expression.Convert
                    (
                        Expression.Call
                        (
                            typeof(Convert).GetMethod("ChangeType", new Type[] { typeof(object), typeof(Type) }),
                            tempGetValue,
                            Expression.Constant(convertsionType)
                        ),
                        pro.PropertyType
                    );
                }
                else
                {
                    convertsionType = pro.PropertyType;
                    convertValue = Expression.Call
                    (
                        typeof(Convert).GetMethod(convertFn, new Type[] { typeof(object) }),
                        tempGetValue
                    );
                }
            }
            Expression nullAbleExpression;
            if (isNullable)
            {
                nullAbleExpression = Expression.Assign(Expression.Property(instance, pro.Name), Expression.Convert(Expression.Constant(null), pro.PropertyType));
            }
            else
            {
#if DEBUG
                nullAbleExpression = Expression.Assign(Expression.Property(instance, pro.Name), Expression.Convert(Expression.Constant(null), pro.PropertyType));
#else
                nullAbleExpression = Expression.Empty();
#endif
            }
            Expression setValue = Expression.IfThenElse
            (
                Expression.Equal(getValue, Expression.Constant(DBNull.Value)),
                nullAbleExpression,
                Expression.Assign(Expression.Property(instance, pro.Name), convertValue)
            );
            return setValue;
        }
        /// <summary>
        /// DataRow转model 忽略大小写 保持效率
        /// </summary>
        /// <returns></returns>
        private Func<DataRow, IList<string>, TResult> GenerateGetModelByDataRow()
        {
            var variable = new List<ParameterExpression>();
            var expres = new List<Expression>();
            var read = Expression.Parameter(typeof(DataRow), "read");
            var columnNames = Expression.Parameter(typeof(IList<string>), "columnNames");
            var instance = Expression.Variable(_type, "instance");
            var index = Expression.Variable(typeof(int), "index");
            variable.Add(instance);
            variable.Add(index);
            expres.Add(Expression.Assign(instance, Expression.New(_type)));
            PropertyInfo indexerInfo = typeof(DataRow).GetProperty("Item", new[] { typeof(int) });
            foreach (var propertyInfo in _type.GetProperties())
            {
                if (!(propertyInfo.CanWrite && IsSimpleType(propertyInfo.PropertyType)))
                {
                    continue;
                }
                //数据库返回列全部大小 忽略大小写赋值
                string colName = ProMap[propertyInfo.Name.ToLower()].ToUpper();
                var callIndex = Expression.Call(columnNames, typeof(IList<string>).GetMethod("IndexOf"), Expression.Constant(colName));
                var assIndex = Expression.Assign(index, callIndex);
                expres.Add(assIndex);
                var getItem = Expression.MakeIndex
                (
                    read,
                    indexerInfo,
                    new[] { index }
                );
                var setValue = GetSetValueExpression(instance, propertyInfo, getItem);
                var ifAssign = Expression.IfThen
                (
                    Expression.NotEqual(index, Expression.Constant(-1)),
                    setValue
                );
                expres.Add(ifAssign);
            }
            LabelTarget returnTarget = Expression.Label(_type);
            expres.Add(Expression.Return(returnTarget, instance, _type));
            expres.Add(Expression.Label(returnTarget, instance));
            var methodBody = Expression.Block(_type, variable, expres);
            return Expression.Lambda<Func<DataRow, IList<string>, TResult>>(methodBody, read, columnNames).Compile();
        }
        /// <summary>
        /// IDataRecord转model 忽略大小写 保持效率
        /// </summary>
        /// <returns></returns>
        private Func<IDataRecord, IList<string>, TResult> GenerateGetModelByIDataRecord()
        {
            //内部快变量
            var variable = new List<ParameterExpression>();
            //表达式
            var expres = new List<Expression>();
            var dr = Expression.Parameter(typeof(IDataRecord), "dr");
            var columnNames = Expression.Parameter(typeof(IList<string>), "columnNames");
            var instance = Expression.Variable(_type, "instance");
            var index = Expression.Variable(typeof(int), "index");
            variable.Add(instance);
            variable.Add(index);
            //使用默认构造函数创建一个对象 var model = new Model();
            expres.Add(Expression.Assign(instance, Expression.New(_type)));
            foreach (var propertyInfo in _type.GetProperties())
            {
                if (!(propertyInfo.CanWrite && IsSimpleType(propertyInfo.PropertyType)))
                {
                    continue;
                }
                //数据库返回列全部大小 忽略大小写赋值
                string colName = ProMap[propertyInfo.Name.ToLower()].ToUpper();
                //给临时变量index赋值
                var callIndex = Expression.Call(columnNames, typeof(IList<string>).GetMethod("IndexOf"), Expression.Constant(colName));
                var assIndex = Expression.Assign(index, callIndex);
                expres.Add(assIndex);
                var getItem = Expression.Call(dr, typeof(IDataRecord).GetMethod("GetValue"), index);
                var setValue = GetSetValueExpression(instance, propertyInfo, getItem);
                var blok = Expression.IfThen
                (
                    Expression.NotEqual(index, Expression.Constant(-1)),
                    setValue
                );
                expres.Add(blok);
            }
            LabelTarget returnTarget = Expression.Label(_type);
            expres.Add(Expression.Return(returnTarget, instance, _type));
            expres.Add(Expression.Label(returnTarget, instance));
            var methodBody = Expression.Block(_type, variable, expres);
            return Expression.Lambda<Func<IDataRecord, IList<string>, TResult>>(methodBody, dr, columnNames).Compile();
        }
        /// <summary>
        /// IDataRecord转model 忽略大小写 保持效率
        /// </summary>
        /// <returns></returns>
        private Func<IDictionary<string, object>, TResult> GenerateGetModelByIDictionary()
        {
            //内部快变量
            var variable = new List<ParameterExpression>();
            //表达式
            var expres = new List<Expression>();
            var dic = Expression.Parameter(typeof(IDictionary<string, object>), "dic");
            var key = Expression.Variable(typeof(string), "key");
            var instance = Expression.Variable(_type, "instance");
            variable.Add(instance);
            variable.Add(key);
            //使用默认构造函数创建一个对象 var model = new Model();
            expres.Add(Expression.Assign(instance, Expression.New(_type)));
            PropertyInfo indexerInfo = typeof(IDictionary<string, object>).GetProperty("Item", new[] { typeof(string) });
            foreach (var propertyInfo in _type.GetProperties())
            {
                if (!(propertyInfo.CanWrite && IsSimpleType(propertyInfo.PropertyType)))
                {
                    continue;
                }
                //数据库返回列全部大小 忽略大小写赋值
                string colName = ProMap[propertyInfo.Name.ToLower()];
                var assIndex = Expression.Assign(key, Expression.Constant(colName));
                expres.Add(assIndex);
                var getItem = Expression.MakeIndex
                (
                    dic,
                    indexerInfo,
                    new[] { key }
                );
                var containsKey = Expression.Call(dic, typeof(IDictionary<string, object>).GetMethod("ContainsKey"), Expression.Constant(colName));
                Expression setValue = Expression.IfThen
                (
                    containsKey,
                    Expression.Assign(Expression.Property(instance, propertyInfo.Name), Expression.Convert(getItem, propertyInfo.PropertyType))
                );
                expres.Add(setValue);
            }
            LabelTarget returnTarget = Expression.Label(_type);
            expres.Add(Expression.Return(returnTarget, instance, _type));
            expres.Add(Expression.Label(returnTarget, instance));
            var methodBody = Expression.Block(_type, variable, expres);
            return Expression.Lambda<Func<IDictionary<string, object>, TResult>>(methodBody, dic).Compile();
        }
        /// <summary>
        /// 类型是否支持转换
        /// </summary>
        /// <param name="tempType"></param>
        /// <returns></returns>
        static bool IsSimpleType(Type tempType)
        {
            return (
                        tempType.Equals(typeof(Int16))
                        || tempType.Equals(typeof(int))
                        || tempType.Equals(typeof(Int64))
                        || tempType.Equals(typeof(string))
                        || tempType.Equals(typeof(decimal))
                        || tempType.Equals(typeof(double))
                        || tempType.Equals(typeof(DateTime))
                        || tempType.Equals(typeof(float))
                        || tempType.Equals(typeof(DateTimeOffset))
                        || tempType.Equals(typeof(char))
                        || tempType.Equals(typeof(long))
                        || tempType.Equals(typeof(bool))
                        || tempType.Equals(typeof(Int16?))
                        || tempType.Equals(typeof(int?))
                        || tempType.Equals(typeof(Int64?))
                        || tempType.Equals(typeof(decimal?))
                        || tempType.Equals(typeof(double?))
                        || tempType.Equals(typeof(DateTime?))
                        || tempType.Equals(typeof(float?))
                        || tempType.Equals(typeof(DateTimeOffset?))
                        || tempType.Equals(typeof(char?))
                        || tempType.Equals(typeof(long?))
                        || tempType.Equals(typeof(bool?))
                        || tempType.IsEnum
                   //|| IsTopModelType(tempType)
                   );
        }
        /// <summary>
        /// 判断类型是否为可空类型
        /// </summary>
        /// <param name="theType"></param>
        /// <returns></returns>
        static bool IsNullableType(Type theType)
        {
            return (theType.IsGenericType && theType.
              GetGenericTypeDefinition().Equals
              (typeof(Nullable<>)));
        }
        /// <summary>
        /// 需要强转的类型
        /// </summary>
        /// <param name="theType"></param>
        /// <returns></returns>
        static string GetConvertFn(Type theType)
        {
            string convertTo = null;
            string typeFullName = theType.FullName;
            if (IsNullableType(theType))
            {
                typeFullName = theType.GenericTypeArguments[0].FullName;
            }
            switch (typeFullName)
            {
                case "System.Int16":
                    convertTo = "ToInt16";
                    break;
                case "System.Int32":
                    convertTo = "ToInt32";
                    break;
                case "System.Int64":
                    convertTo = "ToInt64";
                    break;
                case "System.Boolean":
                    convertTo = "ToBoolean";
                    break;
                case "System.String":
                    convertTo = "ToString";
                    break;
                default:
                    break;
            }
            return convertTo;
        }
    }
}
using System;
namespace Cis.BaseModel
{
    public interface IBaseModel
    {
        object GetValue(string memberName);
        void SetValue(string memberName, object newValue);
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
namespace Cis.BaseModel.Enum
{
    public enum ConditionType
    {
        /// <summary>
        /// string: null empty
        /// list  : null count=0
        /// datetime: null MinValue
        /// int long decimal Enum : 0
        /// </summary>
        IsNullOrEmpty = 0,
        /// <summary>
        /// 
        /// </summary>
        NotEqualValue = 1
    }
}
namespace Cis.BaseModel.Enum
{
    public enum SqlGetType
    {
        /// <summary>
        /// 用运算符连接
        /// </summary>
        FromFormula = 0,
        /// <summary>
        /// sql来自Dictionary 用 or 连接
        /// </summary>
        FromDictionaryForOr = 1,
        /// <summary>
        /// sql来自Dictionary 用 and 连接
        /// </summary>
        FromDictionaryForAnd = 2
    }
}
using System;
namespace Cis.BaseModel.SqlAttribute
{
    [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)]
    public class SqlAttribute : Attribute
    {
        /// <summary>
        /// 表别名
        /// </summary>
        public string TableAlias { get; set; }
        /// <summary>
        /// 列名
        /// </summary>
        public string ColName { get; set; }
    }
}
using System;
namespace Cis.BaseModel.SqlAttribute
{
    [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)]
    public class SqlJoinAttribute : Attribute
    {
        /// <summary>
        /// {0} 占位符为 参数  value
        /// </summary>
        public string JoinString { get; set; }
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
namespace Cis.BaseModel.SqlAttribute
{
    [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)]
    public class SqlSelectAttribute : SqlAttribute
    {
        /// <summary>
        /// 自定义:{0}名称{1}参数名
        /// </summary>
        public string Format { get; set; }
        //public SqlSelectAttribute(string colName)
        //{
        //    this.ColName = colName;
        //}
    }
}
using Cis.BaseModel.Enum;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
namespace Cis.BaseModel.SqlAttribute
{
    [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)]
    public class SqlWhereAttribute : SqlAttribute
    {
        private string formula = "=";
        /// <summary>
        /// 条件是否必须加 优先级大于 IsSingle
        /// </summary>
        public bool IsRequire { get; set; } = false;
        /// <summary>
        /// 是否独立条件，满足则其他条件失效
        /// </summary>
        public bool IsSingle { get; set; } = false;
        /// <summary>
        /// in notin 的字符串分隔符
        /// </summary>
        public char InSplit { get; set; } = ',';
        /// <summary>
        /// Where查询方式
        /// </summary>
        public string Formula
        {
            get
            {
                return formula;
            }
            set
            {
                var temp = "";
                if (!string.IsNullOrEmpty(value))
                {
                    temp = value.ToLower().Trim();
                }
                formula = temp;
            }
        }
        /// <summary>
        /// Formula为 in notin 时 ‘全部’ 的值
        /// </summary>
        public object Values { get; set; } = null;
        /// <summary>
        /// 拼接条件
        /// </summary>
        public ConditionType ConditionType { get; set; } = ConditionType.IsNullOrEmpty;
        
        /// <summary>
        /// 日期格式  此项不为空的时候 日期真实类型会转为字符串
        /// </summary>
        public string DateTimeFormat { get; set; }
        /// <summary>
        /// 此属性不为空时in not in 使用临时表方案
        /// </summary>
        public string TmpTableName { get; set; }
        /// <summary>
        /// 临时表列名
        /// </summary>
        public string TmpTableColName { get; set; }
    }
}
#region copyright
// <copyright file="CacheExpirationMode.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>????</author>
// <datecreated>2012-12-24</datecreated>
#endregion
namespace Cis.Cache
{
    /// <summary>
    /// The cache expiration mode.
    /// </summary>
    public enum CacheExpirationMode
    {
        /// <summary>
        /// The cache item will not expire.
        /// </summary>
        None,
        /// <summary>
        /// The cache item will expire using the Duration property to calculate
        /// the absolute expiration from DateTimeOffset.Now.
        /// </summary>
        Duration,
        /// <summary>
        /// The cache item will expire using the Duration property as the
        /// sliding expiration.
        /// </summary>
        Sliding,
        /// <summary>
        /// The cache item will expire on the AbsoluteExpiration DateTime.
        /// </summary>
        Absolute
    }
}#region copyright
// <copyright file="CachePolicy.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>????</author>
// <datecreated>2012-12-24</datecreated>
#endregion
namespace Cis.Cache
{
    using System;
    //using System.Runtime.Caching;
    /// <summary>
    /// Represents a set of eviction and expiration details for a specific cache entry.
    /// </summary>
    public class CachePolicy
    {
        private static readonly Lazy<CachePolicy> _current = new Lazy<CachePolicy>(() => new CachePolicy());
        /// <summary>
        /// Gets the default <see cref="CachePolicy"/>.
        /// </summary>
        public static CachePolicy Default
        {
            get { return _current.Value; }
        }
        /// <summary>
        /// Initializes a new instance of the <see cref="CachePolicy"/> class.
        /// </summary>
        public CachePolicy()
        {
            this.Mode = CacheExpirationMode.None;
            this._absoluteExpiration = DateTimeOffset.MaxValue;//ObjectCache.InfiniteAbsoluteExpiration;
            this._slidingExpiration = TimeSpan.Zero;//ObjectCache.NoSlidingExpiration;
            this._duration = TimeSpan.Zero;
        }
        /// <summary>
        /// Gets or sets the cachCacheItemPrioritye expiration mode.
        /// </summary>
        /// <value>The cache expiration mode.</value>
        public CacheExpirationMode Mode { get; set; }
        private DateTimeOffset _absoluteExpiration;
        /// <summary>
        /// Gets or sets a value that indicates a cache entry should be evicted after a specified duration.
        /// </summary>
        public DateTimeOffset AbsoluteExpiration
        {
            get { return this._absoluteExpiration; }
            set
            {
                this._absoluteExpiration = value;
                this.Mode = CacheExpirationMode.Absolute;
            }
        }
        private TimeSpan _slidingExpiration;
        /// <summary>
        /// Gets or sets a value that indicates a cache entry should be evicted if it has not been accessed in a given span of time. 
        /// </summary>
        public TimeSpan SlidingExpiration
        {
            get { return this._slidingExpiration; }
            set
            {
                this._slidingExpiration = value;
                this.Mode = CacheExpirationMode.Sliding;
            }
        }
        private TimeSpan _duration;
        /// <summary>
        /// Gets or sets a value that indicates a cache entry should be evicted after a given span of time. 
        /// </summary>
        public TimeSpan Duration
        {
            get { return this._duration; }
            set
            {
                this._duration = value;
                this.Mode = CacheExpirationMode.Duration;
            }
        }
        /// <summary>
        /// Creates a <see cref="CachePolicy"/> with the absolute expiration.
        /// </summary>
        /// <param name="expirationSpan">The <see cref="TimeSpan"/> used to calculate absolute expiration from now.</param>
        /// <returns>An instance of <see cref="CachePolicy"/>.</returns>
        public static CachePolicy WithDurationExpiration(TimeSpan expirationSpan)
        {
            var policy = new CachePolicy
            {
                Duration = expirationSpan
            };
            return policy;
        }
        /// <summary>
        /// Creates a <see cref="CachePolicy"/> with the absolute expiration.
        /// </summary>
        /// <param name="absoluteExpiration">The absolute expiration.</param>
        /// <returns>An instance of <see cref="CachePolicy"/>.</returns>
        public static CachePolicy WithAbsoluteExpiration(DateTimeOffset absoluteExpiration)
        {
            var policy = new CachePolicy
            {
                AbsoluteExpiration = absoluteExpiration
            };
            return policy;
        }
        /// <summary>
        /// Creates a <see cref="CachePolicy"/> with the sliding expiration.
        /// </summary>
        /// <param name="slidingExpiration">The sliding expiration.</param>
        /// <returns>An instance of <see cref="CachePolicy"/>.</returns>
        public static CachePolicy WithSlidingExpiration(TimeSpan slidingExpiration)
        {
            var policy = new CachePolicy
            {
                SlidingExpiration = slidingExpiration
            };
            return policy;
        }
    }
}
/* ***********************************************
 * author :  汪振
 * function: 全局缓存对象
 * history:  created by wz 2015/08/20
 * ***********************************************/
namespace Cis.Cache
{
    /// <summary>
    /// 全局缓存，GlobalCache
    /// </summary>
    public class GlobalCache
    {
        /// <summary>
        /// cache object
        /// </summary>
        public static readonly ICacheProvider<object> Cache = new LruMemoryCache<object>();
    }
}#region copyright
// <copyright file="ICacheProvider.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-11-07</datecreated>
#endregion
namespace Cis.Cache
{
    using System;
    /// <summary>
    /// An <see langword="interface"/> defining a cache provider.
    /// </summary>
    public interface ICacheProvider<T>
    {
        /// <summary>
        /// Inserts a cache entry into the cache without overwriting any existing cache entry.
        /// </summary>
        /// <param name="cacheKey">A unique identifier for the cache entry.</param>
        /// <param name="value">The object to insert.</param>
        /// <param name="cachePolicy">An object that contains eviction details for the cache entry.</param>
        /// <returns>
        ///   <c>true</c> if insertion succeeded, or <c>false</c> if there is an already an entry in the cache that has the same key as key.
        /// </returns>
        bool Add(string cacheKey, T value, CachePolicy cachePolicy=null);
        /// <summary>
        /// Gets the cache value for the specified key
        /// </summary>
        /// <param name="cacheKey">A unique identifier for the cache entry.</param>
        /// <returns>The cache value for the specified key, if the entry exists; otherwise, <see langword="null"/>.</returns>
        T Get(string cacheKey);
        /// <summary>
        /// Gets the cache value for the specified key that is already in the dictionary or the new value for the key as returned by <paramref name="valueFactory"/>.
        /// </summary>
        /// <param name="cacheKey">A unique identifier for the cache entry.</param>
        /// <param name="valueFactory">The function used to generate a value to insert into cache.</param>
        /// <param name="cachePolicy">A <see cref="CachePolicy"/> that contains eviction details for the cache entry.</param>
        /// <returns>
        /// The value for the key. This will be either the existing value for the key if the key is already in the cache, 
        /// or the new value for the key as returned by <paramref name="valueFactory"/> if the key was not in the cache.
        /// </returns>
        T GetOrAdd(string cacheKey, Func<T> valueFactory, CachePolicy cachePolicy=null);
        /// <summary>
        /// Removes a cache entry from the cache. 
        /// </summary>
        /// <param name="cacheKey">A unique identifier for the cache entry.</param>
        /// <returns>If the entry is found in the cache, the removed cache entry; otherwise, <see langword="null"/>.</returns>
        void Remove(string cacheKey);
        /// <summary>
        /// Inserts a cache entry into the cache overwriting any existing cache entry.
        /// </summary>
        /// <param name="cacheKey">A unique identifier for the cache entry.</param>
        /// <param name="value">The object to insert.</param>
        /// <param name="cachePolicy">A <see cref="CachePolicy"/> that contains eviction details for the cache entry.</param>
        void Set(string cacheKey, T value, CachePolicy cachePolicy=null);
    }
}
   
#region copyright
// <copyright file="LruMemoryCache.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-24</datecreated>
#endregion
namespace Cis.Cache
{
    using System;
    using System.Collections.Concurrent;
    using System.Collections.Generic;
    using System.Linq;
    using System.Security.Principal;
    using System.Text;
    using System.Threading;
    //using Cis.EnsureThat;
    /// <summary>
    /// LRUcache 不支持对单个缓存对象的缓存策略
    /// 非线程安全
    /// </summary>
    public class LruMemoryCache<T> : ICacheProvider<T>
    {
       private class CachedResult
        {
            /// <summary>
            /// 被使用次数，get时增加1
            /// </summary>
            public int Usage;
            public DateTime Timestamp;
            public T Value;
        }
        private readonly int cacheMaxSize;
        private readonly TimeSpan maxDuration;
        private readonly ConcurrentDictionary<string, CachedResult> cache =
            new ConcurrentDictionary<string, CachedResult>();
        /// <summary>
        /// 
        /// </summary>
        /// <param name="maxDuration">过期时间</param>
        /// <param name="maxSize">最大缓存数</param>
        public LruMemoryCache(TimeSpan maxDuration, int maxSize)
        {
            this.maxDuration = maxDuration;
            this.cacheMaxSize = maxSize;
        }
        /// <summary>
        /// 默认最大缓存50000，无过期时间
        /// </summary>
        public LruMemoryCache()
            : this(TimeSpan.MaxValue, 50000)
        {
            
        }
        public bool Add(string cacheKey, T val, CachePolicy cachePolicy=null)
        {
            //LRUcache 不支持对单个缓存对象的缓存策略
            //Ensure.That(cachePolicy).IsNull();
            CachedResult value;
            if (cache.TryGetValue(cacheKey, out value) && (DateTime.UtcNow - value.Timestamp) <= this.maxDuration)
            {
                return false;
            }
            var cachedResult = new CachedResult
            {
                Usage = value == null ? 1 : value.Usage + 1,
                Value = val,
                Timestamp = DateTime.UtcNow
            };
            bool resutlt = cache.TryAdd(cacheKey, cachedResult);
            RemoveExpire(cacheKey);
            return resutlt;
           
        }
        ///// <summary>
        ///// 获取缓存值，如果缓存值为null，也认为有缓存
        ///// </summary>
        ///// <param name="cacheKey"></param>
        ///// <param name="val"></param>
        ///// <returns></returns>
        //private bool TryGet(string cacheKey,out T val)
        //{
        //    CachedResult value;
        //    if (cache.TryGetValue(cacheKey, out value) && (DateTime.UtcNow - value.Timestamp) <= this.maxDuration)
        //    {
                
        //        Interlocked.Increment(ref value.Usage);
        //        val = value.Value;
        //        return true;
        //    }
        //    else
        //    {
        //        val = default(T);
        //        return false;
        //    }
        //}
        public T Get(string cacheKey)
        {
            CachedResult value;
            if (cache.TryGetValue(cacheKey, out value) && (DateTime.UtcNow - value.Timestamp) <= this.maxDuration)
            {
                Interlocked.Increment(ref value.Usage);
                return value.Value;
            }
            else
            {
                return default(T);
            }
        }
        public T GetOrAdd(string cacheKey, Func<T> valueFactory, CachePolicy cachePolicy=null)
        {
            //Ensure.That(cachePolicy).IsNull();
            CachedResult value;
            if (cache.TryGetValue(cacheKey, out value) && (DateTime.UtcNow - value.Timestamp) <= this.maxDuration)
            {
                Interlocked.Increment(ref value.Usage);
                return value.Value;
            }
            else
            {
                T newObj = valueFactory();
                this.Add(cacheKey, newObj, cachePolicy);
                return newObj;
            }
            //if (v == null)
            //{
            //    T newObj = valueFactory();
            //    this.Add(cacheKey, newObj, cachePolicy);
            //    return newObj;
            //}
            //else
            //{
            //    return v;
            //}
        }
       
        public void Remove(string cacheKey)
        {
            CachedResult obj;
            bool r= cache.TryRemove(cacheKey, out obj);
            if(r)
                Interlocked.Decrement(ref obj.Usage);
            //return obj.Value;
        }
      
        //Set does and insert or update, as necessary
        public void Set(string cacheKey, T val, CachePolicy cachePolicy=null)
        {
            //Ensure.That(cachePolicy).IsNull();
            CachedResult value;
            if (cache.TryGetValue(cacheKey, out value) && (DateTime.UtcNow - value.Timestamp) <= this.maxDuration)
            {
                //cache.TryUpdate()
            }
            var cachedResult = new CachedResult
            {
                Usage = value == null ? 1 : value.Usage + 1,
                Value = val,
                Timestamp = DateTime.UtcNow
                
            };
            cache.AddOrUpdate(cacheKey, cachedResult, (_,__) => cachedResult);
            RemoveExpire(cacheKey);
            
        }
      
        private void RemoveExpire(string key)
        {
            if (cache.Count > this.cacheMaxSize)
            {
                foreach (var source in cache
                    .OrderByDescending(x => x.Value.Usage)
                    .ThenBy(x => x.Value.Timestamp)
                    .Skip(this.cacheMaxSize))
                {
                    if (source.Key == key)
                        continue; // we don't want to remove the one we just added
                    CachedResult ignored;
                    cache.TryRemove(source.Key, out ignored);
                }
            }
        }
    }
}
#region copyright
// <copyright file="MemoryCacheProvider.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-24</datecreated>
#endregion
using Microsoft.Extensions.Caching.Memory;
namespace Cis.Cache
{
    using System;
    using System.Collections.Generic;
    using System.Diagnostics;
    using System.Linq;
    //using System.Runtime.Caching;
    /// <summary>
    /// A cache provider based on <see cref="MemoryCache"/>.
    /// </summary>
    public class MemoryCacheProvider : ICacheProvider<object>
    {
        static MemoryCache cache = new MemoryCache(new MemoryCacheOptions());
        private const string _tagKey = "global::tag::{0}";
        /// <summary>
        /// Inserts a cache entry into the cache without overwriting any existing cache entry.
        /// </summary>
        /// <param name="cacheKey">A unique identifier for the cache entry.</param>
        /// <param name="value">The object to insert.</param>
        /// <param name="cachePolicy">An object that contains eviction details for the cache entry.</param>
        /// <returns>
        ///   <c>true</c> if insertion succeeded, or <c>false</c> if there is an already an entry in the cache that has the same key as key.
        /// </returns>
        public bool Add(string cacheKey, object value, CachePolicy cachePolicy)
        {
            object _cache = null;
            if (cache.TryGetValue(cacheKey, out _cache))
            {
                return false;
            }
            else
            {
                this.Set(cacheKey, value, cachePolicy);
                return true;
            }
            /*
            var item = new CacheItem(cacheKey, value);
            var policy = CreateMemoryCacheEntryOptions(cacheKey, cachePolicy);
            //var existing = MemoryCache.Default.AddOrGetExisting(item, policy);
            var existing = cache.AddOrGetExisting(item, policy);
            return existing.Value == null;
            */
        }
        /// <summary>
        /// Gets the cache value for the specified key
        /// </summary>
        /// <param name="cacheKey">A unique identifier for the cache entry.</param>
        /// <returns>
        /// The cache value for the specified key, if the entry exists; otherwise, <see langword="null"/>.
        /// </returns>
        public object Get(string cacheKey)
        {
            //return MemoryCache.Default.Get(cacheKey);
            return cache.Get(cacheKey);
        }
        /// <summary>
        /// Gets the cache value for the specified key that is already in the dictionary or the new value for the key as returned by <paramref name="valueFactory"/>.
        /// </summary>
        /// <param name="cacheKey">A unique identifier for the cache entry.</param>
        /// <param name="valueFactory">The function used to generate a value to insert into cache.</param>
        /// <param name="cachePolicy">A <see cref="CachePolicy"/> that contains eviction details for the cache entry.</param>
        /// <returns>
        /// The value for the key. This will be either the existing value for the key if the key is already in the cache,
        /// or the new value for the key as returned by <paramref name="valueFactory"/> if the key was not in the cache.
        /// </returns>
        public object GetOrAdd(string cacheKey, Func<object> valueFactory, CachePolicy cachePolicy)
        {
            object _cache = null;
            if (cache.TryGetValue(cacheKey, out _cache))
            {
                Debug.WriteLine("Cache Hit : " + cacheKey);
                return _cache;
            }
            //if (MemoryCache.Default.Contains(cacheKey))
            //{
            //    Debug.WriteLine("Cache Hit : " + cacheKey);
            //    return MemoryCache.Default.Get(cacheKey);
            //}
            Debug.WriteLine("Cache Miss: " + cacheKey);
            // get value and add to cache
            object value = valueFactory();
            if (this.Add(cacheKey, value, cachePolicy))
                return value;
            // add failed
            return null;
        }
        /// <summary>
        /// Removes a cache entry from the cache.
        /// </summary>
        /// <param name="cacheKey">A unique identifier for the cache entry.</param>
        /// <returns>
        /// If the entry is found in the cache, the removed cache entry; otherwise, <see langword="null"/>.
        /// </returns>
        public void Remove(string cacheKey)
        {
            //return MemoryCache.Default.Remove(cacheKey);
            cache.Remove(cacheKey);
        }
        /// <summary>
        /// Inserts a cache entry into the cache overwriting any existing cache entry.
        /// </summary>
        /// <param name="cacheKey">A unique identifier for the cache entry.</param>
        /// <param name="value">The object to insert.</param>
        /// <param name="cachePolicy">A <see cref="CachePolicy"/> that contains eviction details for the cache entry.</param>
        /// <returns></returns>
        public void Set(string cacheKey, object value, CachePolicy cachePolicy)
        {
            //var item = new CacheItem(cacheKey, value);
            var policy = CreateMemoryCacheEntryOptions(cacheKey, cachePolicy);
            cache.Set(cacheKey, value, policy);
        }
        internal static MemoryCacheEntryOptions CreateMemoryCacheEntryOptions(string key, CachePolicy cachePolicy)
        {
            var options = new MemoryCacheEntryOptions();
            switch (cachePolicy.Mode)
            {
                case CacheExpirationMode.Sliding:
                    options.SlidingExpiration = cachePolicy.SlidingExpiration;
                    break;
                case CacheExpirationMode.Absolute:
                    options.AbsoluteExpiration = cachePolicy.AbsoluteExpiration;
                    break;
                case CacheExpirationMode.Duration:
                    options.AbsoluteExpiration = DateTimeOffset.Now.Add(cachePolicy.Duration);
                    break;
                default:
                    options.AbsoluteExpiration = DateTimeOffset.MaxValue;
                    break;
            }
            //var changeMonitor = CreateChangeMonitor(key);
            //if (changeMonitor != null)
            //    options.ChangeMonitors.Add(changeMonitor);
            return options;
        }
        //internal static CacheEntryChangeMonitor CreateChangeMonitor(string key)
        //{
        //    //var cache = MemoryCache.Default;
        //    return cache.CreateCacheEntryChangeMonitor(new List<string>() { key });
        //}
    }
}// -----------------------------------------------------------------------
// <copyright file="Capability.cs" company="">
// TODO: Update copyright text.
// </copyright>
// -----------------------------------------------------------------------
namespace Cis.DbLight
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text;
    /// <summary>
    /// 框架或者表支持功能
    /// </summary>
    public class Capability
    {
        /// <summary>
        /// 实体关系
        /// </summary>
        public Relation EntityRelation { get; set; }
    }
    /// <summary>
    /// 实体关系
    /// 
    /// </summary>
    public enum Relation
    {
        //涉及到更新插入，删除。目前这三种操作都只处理简单类型对象，只更新单表。忽略关系
        None,
        ManyToMany,
        ManyToOne,
        OneToMany,
        OneToOne
    }
}
using System;
namespace Cis.DbLight
{
    public class Class1
    {
    }
}
#region copyright
// <copyright file="ColumnMapException.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-19</datecreated>
#endregion
namespace Cis.DbLight
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text;
    /// <summary>
    /// 映射异常
    /// </summary>
    public class ColumnMapException:Exception
    {
        private string col;
        public ColumnMapException(string colName):base(colName)
        {
            // TODO: Complete member initialization
            this.col = colName;
        }
        
       // public ColumnMapException(string column)
    }
}
#region copyright
// <copyright file="ColumnMapperStrategy.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-21</datecreated>
#endregion
namespace Cis.DbLight
{
    /// <summary>
    /// 映射策略
    /// </summary>
    public enum ColumnMapperStrategy
    {
        /// <summary>
        /// 属性名称映射为列
        /// </summary>
        Property,
        /// <summary>
        /// 属性的attribute值映射为列
        /// </summary>
        ColumnAttribute
    }
}
#region copyright
// <copyright file="CustomConverter.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>????</author>
// <datecreated>2012-12-26</datecreated>
#endregion
namespace Cis.DbLight
{
    using System;
    using Cis.Cache;
    /// <summary>
    /// ??????????????????????????
    /// </summary>
    public class  CustomConverter
    {
        private LruMemoryCache<Func<object,string>> toDbStringConverterCache=new LruMemoryCache<Func<object,string>>();
        private LruMemoryCache<Func<object,object>> fromDbValueConverterCache = new LruMemoryCache<Func<object,object>>();
        /// <summary>
        /// ???????????????????????
        /// </summary>
        /// <param name="key">????????</param>
        /// <param name="converter">??????????????????????????sql??????????</param>
        public void AddToDbStringConverter(string key, Func<object,string> converter)
        {
            this.toDbStringConverterCache.Add(key, converter);
        }
        public Func<object,string> GetToDbValueConverter(string key)
        {
            return this.toDbStringConverterCache.Get(key);
        }
        /// <summary>
        /// ????????????????????????
        /// </summary>
        /// <param name="col">??????</param>
        /// <param name="converter">????????????????????????????????????????????????????</param>
        public void AddFromDbValueConverter(string col, Func<object,object> converter)
        {
            this.fromDbValueConverterCache.Add(col, converter);
        }
        public Func<object,object> GetFromDbValueConverter(string col)
        {
            return this.fromDbValueConverterCache.Get(col);
        }
    }
}#region copyright
// <copyright file="DbHelper.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-17</datecreated>
#endregion
using Cis.Log;
namespace Cis.DbLight
{
    using System;
    using System.Data;
    using Cis.Infrastructure;
    using Cis.Infrastructure.Extensions;
    public static class DbHelper
    {
        #region Public Methods and Operators
        /// <summary>
        /// 转换类型，dbnull转换为null
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="obj"></param>
        /// <returns></returns>
        public static T ConvertFromDbVal<T>(object obj)
        {
            if (obj == null || obj == DBNull.Value)
            {
                return default(T); // returns the default value for the type
            }
            else
            {
                return typeof(T).DynamicCast(obj);
            }
        }
        /// <summary>
        /// 基本类型转换,列名不存在不抛出异常
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="row"></param>
        /// <param name="name"></param>
        /// <returns></returns>
        public static T GetColumnValue<T>(IDataRecord row, string name)
        {
            if (typeof(T).IsPrimitive())
            {
                int index;
                if (TryGetColumnIndex(row, name, out index))
                {
                    object t = row.GetValue(index);
                    return ConvertFromDbVal<T>(t);
                }
                return default(T);
                //throw new Exception("不能找到列名："+name);
            }
            throw new Exception("非基本类型不能转换");
        }
       
       
       
     
        /// <summary>
        /// 根据列名获取列的索引，
        /// </summary>
        /// <param name="row"></param>
        /// <param name="name"></param>
        /// <param name="index"></param>
        /// <returns></returns>
        private static bool TryGetColumnIndex(IDataRecord row, string name, out int index)
        {
            try
            {
                index = row.GetOrdinal(name);
                return true;
            }
            catch (Exception)
            {
                index = -1;
                return false;
            }
        }
        /// <summary>
        /// 返回指定列的值，返回false
        /// </summary>
        /// <param name="row"></param>
        /// <param name="name"></param>
        /// <param name="val"></param>
        /// <returns></returns>
        public static bool TryGetColumnValue(IDataRecord row, string name, out object val)
        {
            int index;
            val = null;
            if (TryGetColumnIndex(row, name, out index))
            {
                try
                {
                    val = row.GetValue(index);
                }
                catch (Exception ex)
                {
                    Log.Logger.Log(Level.Error,"列名:"+name+ ex.ToString());
                    val = null;
                    return false;
                }
               
                if (val is DBNull)
                {
                    val = null;
                }
                return true;
            }
            return false;
        }
        ///// <summary>
        ///// 转义字符避免注入
        ///// </summary>
        ///// <param name="strRawText"></param>
        ///// <returns></returns>
        //public static string SqlSafe(string strRawText)
        //{
        //    string strCleanedText = "";
        //    int iCharPos = 0;
        //    while (iCharPos < strRawText.Length)
        //    {
        //        if (strRawText.Substring(iCharPos, 1) == "'")
        //        {
        //            strCleanedText = strCleanedText + "''";
        //            if (iCharPos != strRawText.Length)
        //            {
        //                if (strRawText.Substring(iCharPos + 1, 1) == "'")
        //                {
        //                    iCharPos = iCharPos + 1;
        //                }
        //            }
        //        }
        //        else
        //        {
        //            strCleanedText = strCleanedText + strRawText.Substring(iCharPos, 1);
        //        }
        //        iCharPos++;
        //    }
        //    return strCleanedText.Trim();
        //}
        #endregion
    }
}#region copyright
// <copyright file="DbParameterCreater.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-20</datecreated>
#endregion
namespace Cis.DbLight
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Linq.Expressions;
    using System.Text;
    using Cis.Infrastructure;
    /// <summary>
    /// TODO: Update summary.
    /// </summary>
    public class DbParameterCreater
    {
        /// <summary>
        /// 产生参数key
        /// </summary>
        /// <returns></returns>
        public string GenerateKey<T>(Expression<Func<T>> expression)
        {
            if (expression.Body is MemberExpression)
            {
              //  Expression<Func<TResult>> memberExpression = expression as Expression<Func<T>>;
                //针对属性
                string propertyName = expression.GetPropertySymbol().Replace(".", ""); //防止重名回溯属性父对象
                return propertyName;
            }
            else
            {
                //对其他类型表达式获取key
                MemberExpression memberExpression = expression.GetRightMostMember();
                var memberName= memberExpression.ToPath();
                return memberName;
            }
        }
        public string GenerateKey(Expression expression)
        {
            MemberExpression memberExpression = expression.GetRightMostMember();
            var memberName = memberExpression.ToPath();
            return memberName;
        }
    }
}
#region copyright
// <copyright file="IQuerySession.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-20</datecreated>
#endregion
namespace Cis.DbLight
{
    using System;
    using System.Collections.Generic;
    using System.Data;
    using System.Data.Common;
    using System.Linq.Expressions;
    using Cis.DbLight.Mapper;
    /// <summary>
    ///轻量级数据访问接口,每个数据库操作创建新的conncecion
    /// </summary>
    public interface IQuerySession
    {
        #region Public Properties
        DatabaseInfo DatabaseInfo { get; }
        //DbCommand GetSqlStringCommand(string query);
        /// <summary>
        ///  Gets the DbProviderFactory used by the database instance.
        /// </summary>
        DbProviderFactory DbProviderFactory { get; }
        #endregion
        #region Public Methods and Operators
        DbConnection CreateConnection();
        //DataSet ExecuteDataSet(string commandText);
        //DataSet ExecuteDataSet(string commandText, IDictionary<string, object> dbParams);
        /// <summary>
        /// 执行sql。返回值尽量比不用。返回值依赖于数据库设置
        /// </summary>
        /// <param name="commandText">数据库执行的sql语句，如果使用参数化查询参数名为0.1,2... </param>
        /// <param name="parameterValues"></param>
        /// <returns></returns>
        int ExecuteNonQuery(string commandText, params object[] parameterValues);
        int ExecuteNonQuery(string commandText, IDictionary<string, object> dbParams);
     
        /// <summary>
        ///         Executes the commandText interpreted as specified by the commandType and
        ///     returns an System.Data.IDataReader through which the result can be read.
        ///      It is the responsibility of the caller to close the connection and reader
        ///     when finished.
        /// </summary>
        
        /// <param name="commandText"></param>
        /// <returns></returns>
        IDataReader ExecuteReader(string commandText);
        T ExecuteScalar<T>(string commandText, IDictionary<string, object> dbParameters);
        T ExecuteScalar<T>(string commandText, params object[] parameterValues);
        /// <summary>
        /// 执行数据库操作，返回结果集
        /// </summary>
        /// <typeparam name="TResult">结果类型</typeparam>
        /// <param name="sqlString">参数化sql，参数名为0,1.2...</param>
        /// <param name="parameterValues">传给数据库的查询参数</param>
        /// <returns></returns>
        /// <remarks>
        /// 根据TResult推断使用的结果集映射，如果TResult包含TableAttribute使用ColumnAttributeMapper，否则使用PropertyAsColumnMapper
        /// </remarks>
        IEnumerable<TResult> ExecuteSqlString<TResult>(string sqlString, params object[] parameterValues) where TResult : new();
        /// <summary>
        /// 执行数据库操作，返回结果集
        /// </summary>
        /// <typeparam name="TResult">结果类型</typeparam>
        /// <param name="sqlString">sql语句，可包含查询参数</param>
        /// <param name="dbParams">传给数据库的查询参数，查询参数名称值对，使用DictionaryParameterMapper映射到数据库参数</param>
        /// <returns>返回结果</returns>
        /// <remarks>
        /// 根据TResult推断使用的结果集映射，如果TResult包含TableAttribute使用ColumnAttributeMapper，否则使用PropertyAsColumnMapper
        /// </remarks>
        IEnumerable<TResult> ExecuteSqlString<TResult>(string sqlString, IDictionary<string, object> dbParams) where TResult : new();
        /// <summary>
        /// 执行数据库操作，返回结果集
        /// </summary>
        /// <typeparam name="TResult">结果类型</typeparam>
        /// <param name="commandText">数据库执行的sql语句，如果使用参数化查询参数名为0.1,2... </param>
        /// <param name="rowMapper">数据库列到TResult的映射方式</param>
        /// <param name="parameterValues">查询参数值
        /// <remarks>如果不传，则执行非参数化查询，sqlstring不能包含查询参数；
        /// 如果不为空参数值依次替换sqlstring中的：1，：2等值,:为不同数据库的分隔符如， @ ms sql
        /// </remarks>
        /// </param>
        /// <returns></returns>
        /// <code>
        /// sql: where x.hisid = :0
        /// parameterValues:45
        /// </code>
        IEnumerable<TResult> ExecuteSqlString<TResult>(string commandText, IRowMapper<TResult> rowMapper, params object[] parameterValues);
        /// <summary> Execute the database operation synchronously, returning the System.Collections.Generic.IEnumerable&gt;TResult&lt;
        ///     sequence containing the resulting objects.
        /// </summary>
        /// <typeparam name="TResult"></typeparam>
        /// <param name="commandText">参数化sql</param>
        /// <param name="rowMapper">行映射</param>
        /// <param name="dbParams">参数值,使用DictionaryParameterMapper映射<see cref="DictionaryParameterMapper"/></param>
        /// <returns></returns>
        IEnumerable<TResult> ExecuteSqlString<TResult>(string commandText, IRowMapper<TResult> rowMapper, IDictionary<string, object> dbParams);
        //List<TResult> ExecuteSqlStringInTran<TResult>(string commandText, Mapper.IRowMapper<TResult> rowMapper,
        //                                                     params object[] parameterValues);
        #region 20170503 增加 返回list
        IEnumerable<object> ExecuteList(string commandText, params object[] parameterValues);
        IEnumerable<object> ExecuteList(string commandText, IDictionary<string, object> dbParameters);
        #endregion
        #endregion
    }
}namespace Cis.DbLight
{
    using System;
    using System.Collections.Generic;
    using System.Linq.Expressions;
    using Cis.DbLight.Mapper;
    public interface ITableDao<TDomain>
        where TDomain : class, new()
    {
        #region Public Properties
        //Capability Capability { get; set; }
        string DefaultAlias { get; set; }
        /// <summary>
        /// ???????????
        /// </summary>
        ColumnMapperStrategy DefaultColumnMapperStrategy { get; set; }
        SqlLog SqlLog { get; }
        /// <summary>
        /// column attribute???????
        /// </summary>
        Table TableInfoFromAttr { get; }
        /// <summary>
        /// ??????????
        /// </summary>
        Table TableInfoFromProperty { get; }
       // string TableName { get; set; }
        #endregion
        #region Public Methods and Operators
        /// <summary>
        /// ????????
        /// </summary>
        /// <param name="where"></param>
        /// <param name="columnMapperStrategy"> </param>
        /// <returns></returns>
        int Count(Expression<Func<TDomain, bool>> where, ColumnMapperStrategy columnMapperStrategy);
        int Count(Expression<Func<TDomain, bool>> where);
        /// <summary>
        /// ????????count(*)
        /// </summary>
        /// <returns></returns>
        int Count();
        /// <summary>
        /// ??????count(cols),?????????
        /// </summary>
        /// <typeparam name="TProp"></typeparam>
        /// <param name="expression">??</param>
        /// <returns></returns>
        int Count<TProp>(Expression<Func<TDomain, TProp>> expression);
        /// <summary>
        /// ??????count(cols),?????????
        /// </summary>
        /// <typeparam name="TProp"></typeparam>
        /// <param name="expression"></param>
        /// <param name="where"></param>
        /// <param name="columnMapperStrategy"></param>
        /// <returns></returns>
        int Count<TProp>(Expression<Func<TDomain, TProp>> expression, Expression<Func<TDomain, bool>> where, ColumnMapperStrategy columnMapperStrategy);
        /// <summary>
        /// ???????????
        /// </summary>
        void Delete();
        /// <summary>
        /// 
        /// </summary>
        /// <param name="where">?????????????磺User.Roles.Count==1</param>
        void Delete(Expression<Func<TDomain, bool>> where);
        void Delete(Expression<Func<TDomain, bool>> where, ColumnMapperStrategy columnMapperStrategy);
        void Insert(TDomain domain, ColumnMapperStrategy columnMapperStrategy, List<Expression<Func<TDomain, object>>> cols);
        void Insert(TDomain domain, List<Expression<Func<TDomain, object>>> cols);
        void Insert(TDomain domain, params Expression<Func<TDomain, object>>[] cols);
        /// <summary>
        /// ???????????????б???????????????????
        /// </summary>
        /// <param name="domain"> These objects can be POCOs, Anonymous, NameValueCollections, or Expandos. Objects</param>
        /// <param name="columnMapperStrategy"> </param>
        /// <param name="cols"> </param>
        /// <returns></returns>
        void Save(TDomain domain, ColumnMapperStrategy columnMapperStrategy, List<Expression<Func<TDomain, object>>> cols);
        void Save(TDomain domain, List<Expression<Func<TDomain, object>>> cols);
        void Save(TDomain domain, params Expression<Func<TDomain, object>>[] cols);
        void Save(List<TDomain> domains, params Expression<Func<TDomain, object>>[] cols);
        List<TDomain> Select(Expression<Func<TDomain, bool>> where, ColumnMapperStrategy columnMapperStrategy, Expression<Func<TDomain, object>>[] cols);
        List<TDomain> SelectByExp(Expression<Func<TDomain, bool>> where, params Expression<Func<TDomain, object>>[] cols);
        void Update(TDomain domain, ColumnMapperStrategy columnMapperStrategy, List<Expression<Func<TDomain, object>>> cols);
        void Update(TDomain domain, List<Expression<Func<TDomain, object>>> cols);
        void Update(TDomain domain, params Expression<Func<TDomain, object>>[] cols);
        /// <summary>
        /// ???????????????????档?????????
        /// </summary>
        /// <param name="domains"></param>
        /// <param name="cols"></param>
        //       [System.Runtime.CompilerServices.MethodImpl(
        //System.Runtime.CompilerServices.MethodImplOptions.NoInlining)]
        //void Update(List<TDomain> domains, params Expression<Func<TDomain, object>>[] cols);
        #endregion
    }
}#region copyright
// <copyright file="IWhereQueryTranslator.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>????</author>
// <datecreated>2012-12-31</datecreated>
#endregion
namespace Cis.DbLight
{
    using System.Collections.Generic;
    using System.Linq.Expressions;
    using Cis.DbLight.External;
    public interface IWhereQueryTranslator
    {
        string Translate(Expression expression);
        List<Constraint> GetConstraints();
        IDictionary<string, object> DbParams { get; set; }
        bool IsUseAlias { get; set; }
        Table Table { get; set; }//?????????????????????
        
        ColumnMapperStrategy ColumnMapperStrategy { get; set; }
    }
}#region copyright
// <copyright file="SingleTableDao.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-17</datecreated>
#endregion
using EnsureThat;
namespace Cis.DbLight
{
    using System;
    using System.Collections.Generic;
    using System.Diagnostics;
    using System.Linq;
    using System.Linq.Expressions;
    using System.Reflection;
    using System.Text;
    using Cis.Infrastructure;
    using Cis.Infrastructure.Reflection;
    using Cis.Log;
    using Cis.DbLight.Mapper;
    using Cis.DbLight.TableMetadata;
    using System.Text.RegularExpressions;
    /// <summary>
    /// 查询对象，仅仅单表查询，不生成join sql
    /// 不处理关系，sql是参数化查询sql 
    /// todo 在dao上增加domain属性于列的映射重载（支持多多等）
    /// </summary>
    /// <typeparam name="TDomain">与数据库建立关联的领域对象</typeparam>
    public class SingleTableDao<TDomain> : ITableDao<TDomain>
        where TDomain : class, new()
    {
        #region Fields
        /// <summary>
        /// 子类必须传入。todo ioc or abstract factory
        /// </summary>
        public IQuerySession QuerySession;
        #endregion
        #region Constructors and Destructors
        //
        public SingleTableDao(IQuerySession querySession, ColumnMapperStrategy mapperStrategy = ColumnMapperStrategy.ColumnAttribute)
        {
            this.DefaultColumnMapperStrategy = mapperStrategy;
            this.QuerySession = querySession;
            if (this.DefaultColumnMapperStrategy == ColumnMapperStrategy.ColumnAttribute)
            {
                this.TableInfoFromAttr = this.QuerySession.DatabaseInfo.TablesInfo.LoadTable(this.DefaultColumnMapperStrategy, typeof(TDomain));
                this.tableName = this.TableInfoFromAttr.TableName;
                encodeTableName = tableName;
            }
            else
            {
                this.TableInfoFromProperty = this.QuerySession.DatabaseInfo.TablesInfo.LoadTable(this.DefaultColumnMapperStrategy, typeof(TDomain));
                this.tableName = this.TableInfoFromProperty.TableName;
                encodeTableName = tableName;
                //不是所有属性都是数据库列。查询schema，然后过滤
                //todo 编译时缓存表结构
                Table dbTable = this.QuerySession.DatabaseInfo.TablesInfo.LoadFromSchema(tableName, this.LoadFromSchema);
                Ensure.That(dbTable).IsNotNull();//确保存在表，不存在表属于异常
                Logger.Log(Level.Debug, () =>
                {
                    //属性对应的列不存记录日志，不属于异常
                    //记录删除的列
                    var cols = this.TableInfoFromProperty.Columns.Where((col) => !dbTable.Columns.Exists((c) => c.ColumnName == col.ColumnName));
                    string message = cols.Aggregate<IColumn, string>(null, (current, col) => current + (col.ColumnName + ","));
                    if (message != null)
                        return tableName + "不存在列：" + message;
                    else
                    {
                        return message;
                    }
                });
                this.TableInfoFromProperty.Columns.RemoveAll((col) => !dbTable.Columns.Exists((c) => c.ColumnName == col.ColumnName));
                //if(dbTable==null)
                //{
                //    ///没有属性定义的表
                //    Logger.Log(Level.Debug, "没有通过类名定义的表：" + tableName);
                //    // todo 返回null 需要修改很多，下版本
                //    TableInfoFromProperty= new Table();
                //}
                //else
                //{
                //}
                //列主键信息的复制，如果数据库表结构中有主键则复制
                this.TableInfoFromProperty.Columns.ForEach(col =>
                {
                    var temp = dbTable.Columns.FirstOrDefault(c => c.ColumnName == col.ColumnName);
                    if (temp != null)
                    {
                        if (temp.IsPrimaryKey)
                            col.IsPrimaryKey = temp.IsPrimaryKey;
                        if (temp.IsAutoInsert)
                            col.IsAutoInsert = temp.IsAutoInsert;
                    }
                });
            }
            this.DefaultAlias = this.GetType().Name.ToLowerInvariant();
            this.SqlLog = new SqlLog(this.QuerySession.DatabaseInfo);
        }
        #endregion
        #region Public Properties
        public string DefaultAlias { get; set; }
        /// <summary>
        /// 列默认映射规则
        /// </summary>
        public ColumnMapperStrategy DefaultColumnMapperStrategy { get; set; }
        //public Capability Capability { get; set; }
        public SqlLog SqlLog { get; protected set; }
        /// <summary>
        /// column attribute定义的表结构
        /// </summary>
        public Table TableInfoFromAttr { get; private set; }
        /// <summary>
        /// 属性定义的表结构
        /// </summary>
        public Table TableInfoFromProperty { get; private set; }
        private string tableName;
        private string encodeTableName;
        #endregion
        #region Public Methods and Operators
        private Table LoadFromSchema()
        {
            // todo 判断是否存在表，表不存在时返回null
            List<IColumn> cols = QuerySession.ExecuteSqlString(QuerySession.DatabaseInfo.SqlDialect.SchemaSql, new PropertyEqualColumnMapper<Column>(), tableName).Cast<IColumn>().ToList();
            if (cols.Count == 0)
                return null;
            var table = new Table(cols);
            table.TableName = tableName;
            return table;
        }
        /// <summary>
        /// 数据数量
        /// </summary>
        /// <param name="where">查询条件</param>
        /// <param name="columnMapperStrategy">领域对象到数据库的映射规则</param>
        /// <returns></returns>
        public virtual int Count(Expression<Func<TDomain, bool>> where, ColumnMapperStrategy columnMapperStrategy)
        {
            var sql = new StringBuilder("SELECT COUNT(*) FROM " + this.encodeTableName + " ");
            SqlBuilder sqlBuilder = this.CreateSqlBuilder(sql);
            if (where != null)
                sqlBuilder.AppendByAutoGen(" where ", where, columnMapperStrategy, false);
            return this.QuerySession.ExecuteScalar<int>(sqlBuilder.ToSql(), sqlBuilder.DbParams);
        }
        /// <summary>
        /// 数据数量
        /// </summary>
        /// <param name="where">查询条件</param>
        /// <returns></returns>
        public virtual int Count(Expression<Func<TDomain, bool>> where)
        {
            return this.Count(where, this.DefaultColumnMapperStrategy);
        }
        /// <summary>
        /// 数据数量count(*)
        /// </summary>
        /// <remarks>采用默认映射规则</remarks>
        /// <returns></returns>
        public virtual int Count()
        {
            return this.Count(null, this.DefaultColumnMapperStrategy);
        }
        /// <summary>
        /// 计算非空列行数count(cols)
        /// </summary>
        /// <typeparam name="TProp">对应数据库列的dommian属性名称</typeparam>
        /// <param name="expression">列名称</param>
        /// <returns></returns>
        public int Count<TProp>(Expression<Func<TDomain, TProp>> expression)
        {
            return this.Count(expression, null, DefaultColumnMapperStrategy);
        }
        /// <summary>
        /// 计算非空列行数count(cols)
        /// </summary>
        /// <typeparam name="TProp">对应数据库列的dommian属性名称</typeparam>
        /// <param name="expression">列名称</param>
        /// <param name="where">查询条件</param>
        /// <param name="columnMapperStrategy">映射策略</param>
        /// <returns></returns>
        public virtual int Count<TProp>(Expression<Func<TDomain, TProp>> expression, Expression<Func<TDomain, bool>> where, ColumnMapperStrategy columnMapperStrategy)
        {
            string property = expression.PropertyName();
            Table table = this.GetTable(columnMapperStrategy);
            List<IColumn> dbCol = table.DbColumns;
            var colName = dbCol.FirstOrDefault(col => col.PropertyName == property);
            Ensure.That(colName).IsNotNull();
            var sql = string.Format("SELECT COUNT({0}) FROM {1}", colName.ColumnName, encodeTableName);
            SqlBuilder sqlBuilder = this.CreateSqlBuilder(new StringBuilder(sql));
            if (where != null)
                sqlBuilder.AppendByAutoGen(" where ", where, columnMapperStrategy, false);
            return this.QuerySession.ExecuteScalar<int>(sqlBuilder.ToSql());
        }
        /// <summary>
        /// 删除所有数据
        /// </summary>
        public virtual void Delete()
        {
            var sql = new StringBuilder("delete " + this.encodeTableName + " ");
            this.QuerySession.ExecuteNonQuery(sql.ToString());
        }
        /// <summary>
        /// 删除数据
        /// </summary>
        /// <param name="where">查询条件，不支持实体属性如：User.Roles.Count==1，Roles为实体属性，非简单属性不能生成正确sql，todo</param>
        public virtual void Delete(Expression<Func<TDomain, bool>> where)
        {
            this.Delete(where, this.DefaultColumnMapperStrategy);
        }
        /// <summary>
        /// 删除数据
        /// </summary>
        /// <param name="where">查询条件</param>
        /// <param name="columnMapperStrategy"></param>
        public virtual void Delete(Expression<Func<TDomain, bool>> where, ColumnMapperStrategy columnMapperStrategy)
        {
            Table table = this.GetTable(columnMapperStrategy);
            DeleteBuilder<TDomain> deleteBuilder = new DeleteBuilder<TDomain>(table, QuerySession.DatabaseInfo.SqlDialect);
            if (where != null)
            {
                SqlBuilder deleteSqlBuilder = this.CreateSqlBuilder(null);
                deleteSqlBuilder.AppendByAutoGen("where", where, columnMapperStrategy, false);
                deleteBuilder.SqlBuilder = deleteSqlBuilder;
            }
            this.QuerySession.ExecuteNonQuery(deleteBuilder.GetSql(), deleteBuilder.DbParams);
        }
        /// <summary>
        /// 插入数据，多主键表未测试
        /// </summary>
        /// <param name="domain">要插入数据库的数据</param>
        /// <typeparam name="TDomain">与数据库建立关联的领域对象</typeparam>
        /// <param name="columnMapperStrategy">映射策略</param>
        /// <param name="usedProperies">TDomain中需要插入到数据库的属性，该属性必须对应数据库字段</param>
        private void Insert(TDomain domain, ColumnMapperStrategy columnMapperStrategy, IList<string> usedProperies)
        {
            //  Ensure.That(usedProperies).HasItems();
            Ensure.That(domain).IsNotNull();
            Table table = this.GetTable(columnMapperStrategy);
            InsertBuilder<TDomain> insertBuilder = new InsertBuilder<TDomain>(table, domain, QuerySession.DatabaseInfo.SqlDialect, usedProperies);
            this.QuerySession.ExecuteNonQuery(insertBuilder.GetSql(), insertBuilder.DbParams);
        }
        /// <summary>
        /// 插入数据
        /// </summary>
        /// <param name="domain">要插入数据库的数据</param>
        /// <param name="columnMapperStrategy">映射策略</param>
        /// <param name="entityProperties">TDomain中需要插入到数据库的属性，为空默认所有列</param>
        public virtual void Insert(TDomain domain, ColumnMapperStrategy columnMapperStrategy, List<Expression<Func<TDomain, object>>> entityProperties)
        {
            Ensure.That(entityProperties).IsNotNull();
            // Ensure.That(entityProperties).HasItems();
            string[] usedProperies = entityProperties.Select(expression => expression.PropertyName()).ToArray();
            this.Insert(domain, columnMapperStrategy, usedProperies);
        }
        /// <summary>
        ///插入数据，使用默认映射策略
        /// </summary>
        /// <param name="domain">要插入数据库的数据</param>
        /// <param name="entityProperties">TDomain中需要插入到数据库的属性，，为空默认所有列</param>
        public virtual void Insert(TDomain domain, List<Expression<Func<TDomain, object>>> entityProperties)
        {
            this.Insert(domain, this.DefaultColumnMapperStrategy, entityProperties);
        }
        /// <summary>
        ///插入数据
        /// </summary>
        /// <param name="domain">要插入数据库的数据</param>
        /// <param name="entityProperties">TDomain中需要插入到数据库的属性，该属性必须对应数据库字段.如不传更新所有列</param>
        public virtual void Insert(TDomain domain, params Expression<Func<TDomain, object>>[] entityProperties)
        {
            this.Insert(domain, this.DefaultColumnMapperStrategy, entityProperties.ToList());
        }
        ///// <summary>
        ///// 插入多条数据，使用事务 todo 批量插入更新，sqlserver SqlBulkCopy  oracle odp.net支持 OracleCommand.ArrayBindCount 
        ///// </summary>
        ///// <param name="domains">要插入数据库的数据列表</param>
        ///// <param name="entityProperties">TDomain中需要插入到数据库的属性，该属性必须对应数据库字段.如不传更新所有列</param>
        //public virtual void Insert(List<TDomain> domains, params Expression<Func<TDomain, object>>[] entityProperties)
        //{
        //    //todo c# 4.5 根据调用方法缓存属性。
        //    using (var transactionScope = new TransactionScope(this.QuerySession))
        //    {
        //        foreach (var domain in domains)
        //        {
        //            this.Insert(domain, entityProperties);
        //        }
        //        transactionScope.Complete();
        //    }
        //}
        /// <summary>
        /// 查询数据
        /// </summary>
        /// <param name="where">查询条件</param>
        /// <param name="columnMapperStrategy">映射策略</param>
        /// <param name="usedProperies">TDomain中需要插入到数据库的属性，该属性必须对应数据库字段 ,usedProperies为空时查询所有字段</param>
        /// <returns></returns>
        private List<TDomain> Select(Expression<Func<TDomain, bool>> where, ColumnMapperStrategy columnMapperStrategy, params string[] usedProperies)
        {
            //Ensure.That(usedProperies).HasItems();
            IRowMapper<TDomain> rowMapper = null;
            if (columnMapperStrategy == ColumnMapperStrategy.Property)
                rowMapper = new PropertyEqualColumnMapper<TDomain>();
            else
                rowMapper = new ColumnAttributeMapper<TDomain>();
            Table table = this.GetTable(columnMapperStrategy);
            SelectBuilder<TDomain> selectBuilder = new SelectBuilder<TDomain>(table, QuerySession.DatabaseInfo.SqlDialect, usedProperies);
            SqlBuilder whereSqlBuilder = this.CreateSqlBuilder(null);
            whereSqlBuilder.AppendByAutoGen("where", where, columnMapperStrategy, false);
            selectBuilder.SqlBuilder = whereSqlBuilder;
            return this.QuerySession.ExecuteSqlString(selectBuilder.GetSql(), rowMapper, selectBuilder.DbParams).ToList();
        }
        /// <summary>
        /// 查询数据
        /// </summary>
        /// <param name="where"></param>
        /// <param name="columnMapperStrategy"></param>
        /// <param name="entityProperties">TDomain中需要插入到数据库的属性，为空默认所有列</param>
        /// <returns></returns>
        public virtual List<TDomain> Select(Expression<Func<TDomain, bool>> where, ColumnMapperStrategy columnMapperStrategy, Expression<Func<TDomain, object>>[] entityProperties)
        {
            Ensure.That(entityProperties).IsNotNull();
            // Ensure.That(entityProperties).HasItems();
            string[] usedProperies = entityProperties.Select(expression => expression.PropertyName()).ToArray();
            return this.Select(where, columnMapperStrategy, usedProperies);
        }
        /// <summary>
        /// 查询数据
        /// </summary>
        /// <param name="where"></param>
        /// <param name="entityProperties">TDomain中需要插入到数据库的属性，该属性必须对应数据库字段.如不传更新所有列</param>
        /// <returns></returns>
        public virtual List<TDomain> SelectByExp(Expression<Func<TDomain, bool>> where, params Expression<Func<TDomain, object>>[] entityProperties)
        {
            string[] usedProperies = null;
            if (entityProperties.Any())
            {
                usedProperies = entityProperties.Select(expression => expression.PropertyName()).ToArray();
            }
            return this.Select(where, DefaultColumnMapperStrategy, usedProperies);
        }
        /// <summary>
        /// 查询数据
        /// </summary>
        /// <param name="where">查询条件</param>
        /// <param name="entityPropertiesCreator">属性生成器，返回查询的属性列表</param>
        /// <returns></returns>
        public virtual List<TDomain> Select(Expression<Func<TDomain, bool>> where, Func<string[]> entityPropertiesCreator)
        {
            return this.Select(where, this.DefaultColumnMapperStrategy, entityPropertiesCreator());
        }
        /// <summary>
        /// insert或者update对象列表，如果主键不为空则insert，否则update
        /// </summary>
        /// <param name="domain">要update或者insert的数据</param>
        /// <param name="columnMapperStrategy">映射策略</param>
        /// <param name="entityProperties"></param>
        /// <returns></returns>
        public virtual void Save(TDomain domain, ColumnMapperStrategy columnMapperStrategy, List<Expression<Func<TDomain, object>>> entityProperties)
        {
            Ensure.That(domain).IsNotNull();
            // Ensure.That(entityProperties).HasItems();
            Table table = this.GetTable(columnMapperStrategy);
            IColumn key = table.KeyColumns.FirstOrDefault();
            Ensure.That(key).IsNotNull();
            object keyValue = Reflection.GetPropertyValue(domain, key.PropertyName);
            if (keyValue == null)
            {
                this.Insert(domain, columnMapperStrategy, entityProperties);
            }
            else
            {
                this.Update(domain, columnMapperStrategy, entityProperties);
            }
        }
        /// <summary>
        /// insert或者update对象列表，如果主键不为空则insert，否则update
        /// </summary>
        /// <param name="domain"></param>
        /// <param name="entityProperties">TDomain中需要插入到数据库的属性，为空默认所有列</param>
        public virtual void Save(TDomain domain, List<Expression<Func<TDomain, object>>> entityProperties)
        {
            Ensure.That(domain).IsNotNull();
            //Ensure.That(entityProperties).HasItems();
            this.Save(domain, this.DefaultColumnMapperStrategy, entityProperties);
        }
        /// <summary>
        /// insert或者update对象列表，如果主键不为空则insert，否则update
        /// </summary>
        /// <param name="domain"></param>
        /// <param name="entityProperties">TDomain中需要插入到数据库的属性，为空默认所有列</param>
        public virtual void Save(TDomain domain, params Expression<Func<TDomain, object>>[] entityProperties)
        {
            Ensure.That(domain).IsNotNull();
            //  Ensure.That(entityProperties).HasItems();
            this.Save(domain, this.DefaultColumnMapperStrategy, entityProperties.ToList());
        }
        /// <summary>
        /// insert或者update对象列表，如果主键不为空则insert，否则update
        /// </summary>
        /// <param name="domains"></param>
        /// <param name="entityProperties">TDomain中需要插入到数据库的属性，该属性必须对应数据库字段，不能为空</param>
        public virtual void Save(List<TDomain> domains, params Expression<Func<TDomain, object>>[] entityProperties)
        {
            //todo c# 4.5 根据调用方法缓存属性。
            Ensure.That(domains).HasItems();
            //Ensure.That(entityProperties).HasItems();
            using (var transactionScope = new TransactionScope(this.QuerySession))
            {
                foreach (var domain in domains)
                {
                    this.Save(domain, entityProperties);
                }
                transactionScope.Complete();
            }
        }
        /// <summary>
        /// 根据主键执行update
        /// </summary>
        /// <param name="domain"></param>
        /// <param name="columnMapperStrategy">映射方式 </param>
        /// <param name="usedProperies">TDomain中需要插入到数据库的属性，为空默认所有列</param>
        /// <returns></returns>
        private void InternalUpdate(TDomain domain, ColumnMapperStrategy columnMapperStrategy, IList<string> usedProperies)
        {
            Ensure.That(domain).IsNotNull();
            // Ensure.That(usedProperies).HasItems();
            Table table = this.GetTable(columnMapperStrategy);
            UpdateBuilder<TDomain> updateBuilder = new UpdateBuilder<TDomain>(table, QuerySession.DatabaseInfo.SqlDialect, domain, usedProperies);
            this.QuerySession.ExecuteNonQuery(updateBuilder.GetSql(), updateBuilder.DbParams);
        }
        /// <summary>
        /// 根据条件执行更新
        /// 参考ef接口
        /// context.Categories.Update(c => c.Name.EndsWith("1"), c => new Category() { Name = "Update" });
        /// 第一个参数where
        /// 第二个返回tdomain。对应于TDomain domain
        /// </summary>
        /// <param name="domain"></param>
        /// <param name="columnMapperStrategy"></param>
        /// <param name="where"></param>
        /// <param name="entityProperties"></param>
        public virtual void Update(TDomain domain, ColumnMapperStrategy columnMapperStrategy, Expression<Func<TDomain, bool>> where, List<Expression<Func<TDomain, object>>> entityProperties)
        {
            throw new NotImplementedException();
        }
        /// <summary>
        ///根据主键执行update
        /// </summary>
        /// <param name="domain"></param>
        /// <param name="columnMapperStrategy"></param>
        /// <param name="entityProperties">为空默认所有列</param>
        public virtual void Update(TDomain domain, ColumnMapperStrategy columnMapperStrategy, List<Expression<Func<TDomain, object>>> entityProperties)
        {
            Ensure.That(domain).IsNotNull();
            //Ensure.That(entityProperties).HasItems();
            string[] usedProperies = entityProperties.Select(expression => expression.PropertyName()).ToArray();
            InternalUpdate(domain, columnMapperStrategy, usedProperies);
        }
        /// <summary>
        /// 根据主键执行update
        /// </summary>
        /// <param name="domain"></param>
        /// <param name="entityProperties">为空默认所有列</param>
        public virtual void Update(TDomain domain, List<Expression<Func<TDomain, object>>> entityProperties)
        {
            this.Update(domain, this.DefaultColumnMapperStrategy, entityProperties);
        }
        /// <summary>
        /// 根据主键执行update
        /// </summary>
        /// <param name="domain"></param>
        /// <param name="entityProperties"></param>
        public virtual void Update(TDomain domain, params Expression<Func<TDomain, object>>[] entityProperties)
        {
            //todo 增加关系映射处理。如果多对多...
            this.Update(domain, this.DefaultColumnMapperStrategy, entityProperties.ToList());
        }
        #endregion
        #region Methods
        protected SqlBuilder CreateSqlBuilder(StringBuilder sql)
        {
            var sqlbuilder = new SqlBuilder(this.QuerySession.DatabaseInfo, sql, new Dictionary<string, object>());
            return sqlbuilder;
        }
        protected SqlBuilder CreateSqlBuilder(StringBuilder sql, IDictionary<string, object> dbParams)
        {
            var sqlbuilder = new SqlBuilder(this.QuerySession.DatabaseInfo, sql, dbParams);
            return sqlbuilder;
        }
        protected Table GetTable(ColumnMapperStrategy columnMapperStrategy)
        {
            if (columnMapperStrategy == ColumnMapperStrategy.ColumnAttribute)
            {
                if (this.TableInfoFromAttr != null)
                {
                    return this.TableInfoFromAttr;
                }
                else
                {
                    this.TableInfoFromAttr = this.QuerySession.DatabaseInfo.TablesInfo.LoadTable(columnMapperStrategy, typeof(TDomain));
                    return this.TableInfoFromAttr;
                }
            }
            else
            {
                if (this.TableInfoFromProperty != null)
                {
                    return this.TableInfoFromProperty;
                }
                else
                {
                    this.TableInfoFromProperty = this.QuerySession.DatabaseInfo.TablesInfo.LoadTable(columnMapperStrategy, typeof(TDomain));
                    return this.TableInfoFromProperty;
                }
            }
        }
        #endregion
    }
}#region copyright
// <copyright file="SqlBuilder.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>????</author>
// <datecreated>2012-12-17</datecreated>
#endregion
using EnsureThat;
namespace Cis.DbLight
{
    using System;
    using System.Collections.Generic;
    using System.Linq.Expressions;
    using System.Text;
    using System.Linq;
    using Cis.Infrastructure.Extensions;
    using Cis.Infrastructure;
    /// <summary>
    /// ??????????sql???
    /// </summary>
    public class SqlBuilder
    {
        public DatabaseInfo DatabaseInfo { get; set; }
        private DbParameterCreater dbParameterCreater = new DbParameterCreater();
        private string dbParameterConstant;
        private IDictionary<string, object> dbParams;
        public IDictionary<string, object> DbParams
        {
            get
            {
                return dbParams;
            }
        }
        private readonly StringBuilder sql;
        public SqlBuilder(DatabaseInfo databaseInfo, StringBuilder sql, IDictionary<string, object> dbParams = null)
        {
            DatabaseInfo = databaseInfo;
            dbParameterConstant = DatabaseInfo.SqlDialect.DbParameterConstant;
            this.dbParams = dbParams;
            if (sql == null)
                this.sql = new StringBuilder();
            else
            {
                this.sql = sql;
            }
        }
        #region Public Methods and Operators
        /// <summary>
        /// ?????????sql
        /// </summary>
        /// <param name="property">??????????</param>
        /// <param name="sqlPart">????????sql???????λ???{0}</param>
        ///<remarks></remarks>
        /// <code>AppendWhereNotNull(() => startDate, "and COUNT_MONTH>={0}");</code>
        public SqlBuilder AppendWhereNotNull<TProperty>(Expression<Func<TProperty>> property, string sqlPart)
        {
            if (!(property.Body is MemberExpression) && !(property.Body is MethodCallExpression))
            {
                throw new ArgumentException("propery ?????????MemberExpression????MethodCallExpression");
            }
            Func<bool> condition = null;
            TProperty value = property.Compile()();
           // Ensure.That(value.GetType().IsPrimitive(), "????????????????????");
            
            condition = () => value != null&& value.GetType().IsPrimitive();
            sql.Append(InternalConcatSql(condition, value, property, sqlPart));
            return this;
        }
        //public SqlBuilder AppendWhereNotNullOrEmpty(Expression<Func<string>> property, string sqlPart)
        //{
        //    Func<bool> condition = null;
        //    string value = property.Compile()();
        //    condition = () => !string.IsNullOrEmpty(value);
        //    sql.Append(InternalConcatSql(condition, value, property, sqlPart));
        //    return this;
        //}
        /// <summary>
        /// ?????????sql
        /// </summary>
        /// <param name="property"></param>
        /// <param name="sqlPart"></param>
        /// <param name="valueConverter"></param>
        /// <returns></returns>
        public SqlBuilder AppendWhereNotNullOrEmpty(Expression<Func<string>> property, string sqlPart, string valueConverter = null)
        {
            if (!(property.Body is MemberExpression) && !(property.Body is MethodCallExpression))
            {
                throw new ArgumentException("propery ?????????MemberExpression????MethodCallExpression");
            }
            Func<bool> condition = null;
            string value = property.Compile()();
            if (!string.IsNullOrEmpty(value) && valueConverter != null)
            {
                value = string.Format(valueConverter, value);
            }
            condition = () => !string.IsNullOrEmpty(value);
            sql.Append(InternalConcatSql(condition, value, property, sqlPart));
            return this;
        }
        /// <summary>
        /// ??????-1?????
        /// todo ???????????Append
        /// </summary>
        /// <param name="property"></param>
        /// <param name="sqlPart"></param>
        /// <returns></returns>
        public SqlBuilder AppendWhereNotNullPositive(Expression<Func<string>> property, string sqlPart)
        {
            if (!(property.Body is MemberExpression) && !(property.Body is MethodCallExpression))
            {
                throw new ArgumentException("propery ?????????MemberExpression????MethodCallExpression");
            }
            Func<bool> condition = null;
            string value = property.Compile()();
            condition = () => !string.IsNullOrEmpty(value) && value != "-1";
            sql.Append(InternalConcatSql(condition, value, property, sqlPart));
            return this;
        }
        /// <summary>
        /// ???????sql???,???TDomain???????????????????????????????????????
        /// </summary>
        /// <typeparam name="TDomain">??????????????壬???????????sql</typeparam>
        /// <param name="preString">??????</param>
        /// <param name="property">where?????????????</param>
        /// <param name="mapperStrategy">?????????????????????????</param>
        /// <param name="isUseAlias">?????????????sql </param>
        /// <returns></returns>
        /// <remarks>??</remarks>
        internal SqlBuilder AppendByAutoGen<TDomain>(string preString, Expression<Func<TDomain, bool>> property, ColumnMapperStrategy mapperStrategy, bool isUseAlias = true)
        {
            IWhereQueryTranslator whereQueryTranslator = new WhereQueryTranslator(DatabaseInfo);
            whereQueryTranslator.IsUseAlias = isUseAlias;
            whereQueryTranslator.ColumnMapperStrategy = mapperStrategy;
            whereQueryTranslator.DbParams = dbParams;
            whereQueryTranslator.Table = DatabaseInfo.TablesInfo.LoadTable(mapperStrategy, typeof(TDomain));
            string whereClause = whereQueryTranslator.Translate(property);
            if (!string.IsNullOrEmpty(whereClause))
            {
                whereClause = " " + preString + " " + whereClause;
            }
            sql.Append(whereClause);
            return this;
        }
        /// <summary>
        /// ???? in ??????sql
        /// ??????????string int char????????
        /// </summary>
        /// <param name="property">in ?</param>
        /// <param name="sqlPart">sql ????</param>
        /// <returns></returns>
        public SqlBuilder AppendInWhereHasValue<T>(Expression<Func<List<T>>> property, string sqlPart)
        {
            if (!(property.Body is MemberExpression) && !(property.Body is MethodCallExpression))
            {
                throw new ArgumentException("propery ?????????MemberExpression????MethodCallExpression");
            }
            string partSql = null;
            List<T> value = property.Compile()();
            if (value != null && value.Any() && dbParams != null && property.Body is MemberExpression)
            {
                string name = dbParameterCreater.GenerateKey(property);
                var collectionParams = new StringBuilder(dbParameterConstant);
                var counter = 0;
                foreach (var obj in value)
                {
                    var param = name + counter;
                    //?????????
                    if (!DbParams.ContainsKey(param))
                    {
                        dbParams.Add(param, obj);
                    }
                    //dbParams.Add(param, obj);
                    collectionParams.Append(param);
                    collectionParams.Append(", " + dbParameterConstant);
                    counter++;
                }
                collectionParams.Remove(collectionParams.Length - 3, 3);
                partSql = string.Format(sqlPart + " ", collectionParams);
                sql.Append(partSql);
            }
            return this;
        }
        /// <summary>
        /// ????property list??????????sql??????????1??????=??????1 ????in ??list??????????1000
        /// sqlPart ??????in ?? =
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="property"></param>
        /// <param name="sqlPart"></param>
        /// <returns></returns>
        public SqlBuilder Append<T>(Expression<Func<List<T>>> property, string sqlPart)
        {
            if (!(property.Body is MemberExpression) && !(property.Body is MethodCallExpression))
            {
                throw new ArgumentException("propery ?????????MemberExpression????MethodCallExpression");
            }
            List<T> value = property.Compile()();
            if (value != null && value.Any() && dbParams != null && property.Body is MemberExpression)
            {
                var builder = new StringBuilder();
                var index = sqlPart.IndexOf('(');
                var hasOnlyOne = value.Count == 1;
                sqlPart = sqlPart.Insert(index - 1, hasOnlyOne ? " = " : " in ");
                if(hasOnlyOne)
                {
                    sqlPart = sqlPart.Replace('(', ' ').Replace(')',' ');
                }
                if (value.Count == 1)
                {
                    sql.Append(InternalConcatSql(() => true, value.First(), property, sqlPart));
                }
                else
                {
                    var andIndex = sqlPart.ToLower().IndexOf("and");
                    var tempSqlPart = sqlPart.Substring(andIndex + 3 );
                    string name = dbParameterCreater.GenerateKey(property);
                    var counter = 0;
                    var pageSize = 1000;
                    var pageCount = (int)Math.Ceiling((decimal)value.Count / pageSize);
                    for (int i = 0; i < pageCount; i++)
                    {
                        var collectionParams = new StringBuilder();
                        var pageList = value.Skip((i) * pageSize).Take(pageSize).ToList();
                        if (i > 0)
                        {
                            builder.Append(" or ");
                        }
                        var tempIndex = 0;
                        foreach (var item in pageList)
                        {
                            var param = name + counter;
                            //?????????
                            if (!DbParams.ContainsKey(param))
                            {
                                dbParams.Add(param, item);
                            }
                            if (tempIndex > 0)
                            {
                                collectionParams.Append(",");
                            }
                            collectionParams.AppendFormat("{0}{1}", dbParameterConstant, param);
                            ++counter;
                            tempIndex++;
                        }
                        builder.Append(string.Format(tempSqlPart, collectionParams));                        
                    }
                    if(pageCount > 1)
                    {
                        sql.Append(string.Format(" and ( {0} ) ",builder.ToString()));
                    }
                    else
                    {
                        sql.Append(string.Format(" and {0} ", builder.ToString()));
                    }
                }
            }
            return this;
        }
        /// <summary>
        /// condition?true???????sql
        /// </summary>
        /// <param name="condition">?true??????sql</param>
        /// <param name="property">?</param>
        /// <param name="sqlPart"></param>
        /// <returns></returns>
        public SqlBuilder Append<TProperty>(Func<bool> condition, Expression<Func<TProperty>> property, string sqlPart)
        {
            if (!(property.Body is MemberExpression) && !(property.Body is MethodCallExpression))
            {
                throw new ArgumentException("propery ?????????MemberExpression????MethodCallExpression");
            }
            object value = property.Compile()();
            Ensure.That(value.GetType().IsPrimitive(), "????????????????????");
            sql.Append(InternalConcatSql(condition, value, property, sqlPart));
            return this;
        }
        /// <summary>
        /// ??????????sql??????sql
        /// </summary>
        /// <typeparam name="TProperty"></typeparam>
        /// <param name="property">?</param>
        /// <param name="sqlPart">?????sql</param>
        /// <returns></returns>
        public SqlBuilder Append<TProperty>(Expression<Func<TProperty>> property, string sqlPart)
        {
            if (!(property.Body is MemberExpression) && !(property.Body is MethodCallExpression))
            {
                throw new ArgumentException("propery ?????????MemberExpression????MethodCallExpression");
            }
            Func<bool> condition = null;
            TProperty value = property.Compile()();
            Ensure.That(value.GetType().IsPrimitive(), "????????????????????");
            condition = () => true;
            sql.Append(InternalConcatSql(condition, value, property, sqlPart));
            return this;
        }
        /// <summary>
        /// ??????????sql
        /// </summary>
        /// <param name="sqlPart"></param>
        /// <returns></returns>
        public SqlBuilder Append(StringBuilder sqlPart)
        {
            this.sql.Append(sqlPart);
            return this;
        }
        /// <summary>
        /// condition?true?????????????sql
        /// </summary>
        /// <param name="condition">?true??????sql</param>
        /// <param name="sqlPart"></param>
        /// <returns></returns>
        public SqlBuilder Append(bool condition, string sqlPart)
        {
            if (condition)
            {
                this.sql.Append(sqlPart);
            }
            return this;
        }
        /// <summary>
        /// ??????????sql
        /// </summary>
        /// <param name="sqlPart"></param>
        /// <returns></returns>
        public SqlBuilder Append(string sqlPart)
        {
            this.sql.Append(sqlPart);
            return this;
        }
        /// <summary>
        /// ???sql
        /// </summary>
        /// <returns></returns>
        public string ToSql()
        {
            return sql.ToString();
        }
        public override string ToString()
        {
            return ToSql();
        }
        #endregion
        #region Methods
        /// <summary>
        /// 
        /// </summary>
        /// <typeparam name="TProperty"></typeparam>
        /// <param name="condition"></param>
        /// <param name="value"></param>
        /// <param name="property">??????????????????</param>
        /// <param name="sqlPart"></param>
        /// <returns></returns>
        private string InternalConcatSql<TProperty>(Func<bool> condition, dynamic value, Expression<Func<TProperty>> property, string sqlPart)
        {
            string partSql = null;
            if (property.Body is MemberExpression || property.Body is MethodCallExpression)
            {
                string propertyName = dbParameterCreater.GenerateKey(property);// property.GetPropertySymbol().Replace(".", ""); //????????????????????
                if (condition())
                {
                    partSql = string.Format(sqlPart + " ", dbParameterConstant + propertyName);
                    //?????????
                    if (dbParams != null)
                    {
                        if (!DbParams.ContainsKey(propertyName))
                        {
                            dbParams.Add(propertyName, value);
                        }
                    }
                    return partSql;
                }
                else
                {
                    return null;
                }
            }
            throw new ArgumentException("property ??????????");
        }
        private string InternalConcatSql<TProperty>(Func<bool> condition, Expression<Func<TProperty>> property, string sqlPart)
        {
            string partSql = null;
            if (property.Body is MemberExpression)
            {
                string propertyName = dbParameterCreater.GenerateKey(property);//property.GetPropertySymbol().Replace(".", ""); //????????????????????
                if (condition())
                {
                    partSql = string.Format(sqlPart + " ", dbParameterConstant + propertyName);
                    return partSql;
                }
                else
                {
                    return null;
                }
            }
            throw new ArgumentException("property ??????????");
        }
        #endregion
    }
}#region copyright
// <copyright file="SqlLog.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-17</datecreated>
#endregion
namespace Cis.DbLight
{
    using System;
    using System.Collections.Generic;
    using System.Data;
    using System.Linq.Expressions;
    using System.Text;
    using System.Diagnostics;
    using Cis.Infrastructure;
    using System.Text.RegularExpressions;
    /// <summary>
    /// 根据参数化查询sql，生成可执行sql。不一定与数据库实际执行sql一致
    /// </summary>
    public class SqlLog
    {
        private DatabaseInfo databaseInfo;
        private DbParameterCreater dbParameterCreater=new DbParameterCreater();
        private string parameterConstant;
        public SqlLog(DatabaseInfo databaseInfo)
        {
            this.databaseInfo = databaseInfo;
            parameterConstant = databaseInfo.SqlDialect.DbParameterConstant;
        }
       
        /// <summary>
        /// 参数化查询语句转换为实际sql
        /// </summary>
        /// <param name="sql">参数化sql</param>
        /// <param name="parameters">参数值</param>
        /// <returns></returns>
        public string GetLogSql(string sql, IDictionary<string, object> parameters)
        {
            foreach (var kv in parameters)
            {
                //string regexKey = string.Format(@"{0}{1}(?=[\)\, ]?)", parameterConstant, kv.Key);
                string regexKey = string.Format(@"{0}{1}\b", parameterConstant, kv.Key);
                string part = databaseInfo.DbTypeConverter.ToDbString(kv.Value);
                sql= Regex.Replace(sql, regexKey,part);
              
            }
            return sql;
        }
        /// <summary>
        /// todo
        /// </summary>
        /// <param name="sql"></param>
        /// <param name="parameterValues"></param>
        /// <returns></returns>
        public string GetLogSql(string sql, object[] parameterValues)
        {
            int i = 0;
            foreach (var obj in parameterValues)
            {
                //todo 1,不能替换12的1
                i++;
                string regexKey = string.Format(@"{0}{1}(?=[\)\, ])", parameterConstant,i);
                string part = databaseInfo.DbTypeConverter.ToDbString(obj);
                sql = Regex.Replace(sql, regexKey, part);
            }
            return sql;
        }
        public string GetLogSql<TProperty>(string sql, Expression<Func<TProperty>> property)
        {
            StringBuilder sb = new StringBuilder(sql);
            string propertyName = dbParameterCreater.GenerateKey(property);
            object value = property.Compile()();
            IDictionary<string, object> names = new Dictionary<string, object>();
            names[propertyName] = value;
            return GetLogSql(sql,names);
        }
       
    }
}
#region copyright
// <copyright file="SqlPage.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-17</datecreated>
#endregion
using System.Globalization;
namespace Cis.DbLight
{
    /// <summary>
    ///  对sql进行分页（oracle）
    /// </summary>
    public class SqlPage
    {
        #region Public Methods and Operators
        /// <summary>
        /// 格式化sql语句，做分页
        /// </summary>
        /// <param name="sql"></param>
        /// <param name="pageIndex"></param>
        /// <param name="pageSize"></param>
        /// <returns></returns>
        //public static string PagedSql(string sql, int pageIndex, int pageSize)
        //{
        //    int pageLower;
        //    int pageUpper;
        //    pageLower = pageSize * pageIndex;
        //    pageUpper = pageLower + pageSize;
        //    string strSQL = "SELECT tempSQL.*, count(1) OVER () as mycount FROM ( " + sql + ") tempSQL";
        //    return "SELECT * FROM ( SELECT ROWNUM as numrow, zz.*  from ( " + strSQL + @" ) zz WHERE ROWNUM <=  " + pageUpper + @"  ) WHERE numrow > " + pageLower;
        //}
        //public static string PagedSql(string sql, int pageIndex, int pageSize)
        //{
           
        //}
        private static string GetTotalCountSql(string sql, int pageIndex, int pageSize)
        {
            int pageLower;
            int pageUpper;
            pageLower = pageSize * pageIndex;
            pageUpper = pageLower + pageSize;
            //加总页数sql
            sql =sql.Trim();
            if(sql.StartsWith("select",true,CultureInfo.InvariantCulture))
            {
               sql= sql.Remove(0, 6);
               sql = "select count(*) over () as total, " + sql;
            }
            else
            {
                throw new System.Exception("分页必须为select语句");
            }
            string tt = string.Format(@"select * 
  from (select row_.*, rownum NumRow from ({0}) row_ where rownum <= {1})
 where NumRow > {2}", sql, pageUpper, pageLower);
            return tt;
        }
        /// <summary>
        /// 分页sql ，总记录在total列中
        /// </summary>
        /// <param name="sql"></param>
        /// <param name="pageIndex"></param>
        /// <param name="pageSize"></param>
        /// <returns></returns>
        public static string ContainTotalCountPagedSql(string sql, int pageIndex, int pageSize)
        {
            string pagedsql = GetTotalCountSql(sql, pageIndex, pageSize);
            return pagedsql;
        }
        /// <summary>
        /// 分页，不要传入orderBy，性能不好
        /// </summary>
        /// <param name="sql"></param>
        /// <param name="pageIndex">从0开始 第一页传入0</param>
        /// <param name="pageSize"></param>
        /// <param name="orderBy"></param>
        /// <returns></returns>
        public static string PagedSql(string sql, int pageIndex, int pageSize,string orderBy=null)
        {
            int pageLower;
            int pageUpper;
            pageLower = pageSize * pageIndex;
            pageUpper = pageLower + pageSize;
            return RangedSql(sql, pageLower, pageUpper, orderBy);
        }
        public static string RangedSql(string sql, int start, int end, string orderBy = null)
        {
            int pageLower;
            int pageUpper;
            pageLower = start;
            pageUpper = end;
            if (string.IsNullOrEmpty(orderBy))
            {
                string tt = string.Format(@"select *
  from (select row_.*, rownum NumRow from ({0}) row_ where rownum <= {1})
 where NumRow > {2}", sql, pageUpper, pageLower);
                //                string tt = string.Format(@"SELECT *
                //                        FROM (SELECT rownum AS NumRow,paged.*
                //                                FROM ({0}) paged)
                //                        WHERE NumRow > {1}
                //                        AND NumRow <= {2}", sql, pageLower, pageUpper);
                return tt;
            }
            else
            {
                string tt = string.Format(@"SELECT *
                        FROM (SELECT ROW_NUMBER() OVER(ORDER BY {3}) AS NumRow,paged.*
                                FROM ({0}) paged)
                        WHERE NumRow > {1}
                        AND NumRow <= {2}", sql, pageLower, pageUpper, orderBy);
                //                string tt = string.Format(@"SELECT rownum , paged.*  FROM ({0}) paged
                //                        WHERE r > {1}
                //                        AND r <= {2}", sql, pageLower, pageUpper);
                //                tt += " order by " + orderBy;
                return tt;
            }
            //如果需要排序使用
            //ROW_NUMBER() OVER(ORDER BY ID) AS NumRow
        }
        #endregion
    }
}#region copyright
// <copyright file="Table.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-17</datecreated>
#endregion
namespace Cis.DbLight
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Reflection;
    using Cis.Cache;
    using Cis.Infrastructure;
    using Cis.DbLight.TableMetadata;
    /// <summary>
    /// TODO: Update summary.
    /// </summary>
    public sealed class Table
    {
        private List<IColumn> sqlGenColumns=new List<IColumn>();
        private List<IColumn> primaryColumns = new List<IColumn>();
        private List<IColumn> columns = new List<IColumn>();
        internal Table()
       {
           
       }
       internal Table(List<IColumn> columns)
       {
           this.columns = columns;
       }
        public string TableName { get; set; }
      
       
        /// <summary>
        /// 标记ColumnAttribute的属性列，并不一定在数据库真实存在
        /// </summary>
        public List<IColumn> Columns
        {
            get { return this.columns; }
        }
        /// <summary>
        /// Gets the list of primary key columns.
        /// </summary>
        public List<IColumn> KeyColumns
        {
            get
            {
               return Columns.Where(c => c.IsPrimaryKey).ToList();
            }
        }
        /// <summary>
        /// 真实数据库列
        /// </summary>
        public List<IColumn> DbColumns
        {
            get
            {
                return Columns.Where(c => !c.IsAliasColumn).ToList();
            }
        }
        /// <summary>
        /// Gets a column with given name.
        /// </summary>
        /// <param name="name">name of a column</param>
        /// <returns>column with given name</returns>
        public IColumn GetColumn(string name)
        {
            foreach (IColumn column in this.columns)
            {
                if (column.ColumnName.Equals(name))
                    return column;
            }
            return null;
        }
    }
}
// -----------------------------------------------------------------------
// <copyright file="TableDao.cs" company="">
// TODO: Update copyright text.
// </copyright>
// -----------------------------------------------------------------------
namespace Cis.DbLight
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text;
    /// <summary>
    /// 多表操作基类
    /// </summary>
    public class MultipleTableDao
    {
    }
}
// -----------------------------------------------------------------------
// <copyright file="Transaction.cs" company="">
// TODO: Update copyright text.
// </copyright>
// -----------------------------------------------------------------------
namespace Cis.DbLight
{
    using System;
    using System.Collections.Generic;
    using System.Data.Common;
    using System.Linq;
    using System.Text;
    public class DbTransactionWrapper : IDisposable
    {
        public DbTransactionWrapper(DbTransaction transaction)
        {
            this.DbTransaction = transaction;
        }
        public DbTransaction DbTransaction { get; private set; }
        public bool IsRollBack { get; set; }
        public void Rollback()
        {
            if (!this.IsRollBack)
            {
                this.DbTransaction.Rollback();
            }
        }
        public void Commit()
        {
            this.DbTransaction.Commit();
        }
        public void Dispose()
        {
            this.DbTransaction.Dispose();
        }
    }
    public abstract class Transaction : IDisposable
    {
        [ThreadStatic]
        private static Transaction current;
        public bool Completed { get; private set; }
        public DbTransactionWrapper DbTransactionWrapper { get; protected set; }
        protected Transaction() { }
        public void Rollback()
        {
            this.DbTransactionWrapper.Rollback();
        }
        public DependentTransaction DependentClone()
        {
            return new DependentTransaction(this);
        }
        public void Dispose()
        {
            this.DbTransactionWrapper.Dispose();
        }
        public static Transaction Current
        {
            get { return current; }
            set { current = value; }
        }
    }
    public class CommittableTransaction : Transaction
    {
        public CommittableTransaction(DbTransaction dbTransaction)
        {
            this.DbTransactionWrapper = new DbTransactionWrapper(dbTransaction);
        }
        public void Commit()
        {
           // var con = DbTransactionWrapper.DbTransaction.Connection;
            this.DbTransactionWrapper.Commit();
           //con.Close();
        }
    }
    public class DependentTransaction : Transaction
    {
        public Transaction InnerTransaction { get; private set; }
        internal DependentTransaction(Transaction innerTransaction)
        {
            this.InnerTransaction = innerTransaction;
            this.DbTransactionWrapper = this.InnerTransaction.DbTransactionWrapper;
        }
    }
}
// -----------------------------------------------------------------------
// <copyright file="Class1.cs" company="">
// TODO: Update copyright text.
// </copyright>
// -----------------------------------------------------------------------
namespace Cis.DbLight
{
    using System;
    using System.Collections.Generic;
    using System.Configuration;
    using System.Data.Common;
    using System.Linq;
    using System.Text;
    using IsolationLevel = System.Data.IsolationLevel;
    /// <summary>
    /// 非分布式事务
    /// http://www.cnblogs.com/artech/archive/2012/01/05/custom-transaction-scope.html
    /// </summary>
    public class TransactionScope: IDisposable
    {
        private Transaction transaction = Transaction.Current;
        private DbConnection connection;
        public bool Completed { get; private set; }
        /// <summary>
        /// 
        /// </summary>
        /// <param name="querySession"></param>
        /// <param name="isolationLevel"></param>
        public TransactionScope(IQuerySession querySession,IsolationLevel isolationLevel = IsolationLevel.Unspecified)
        {
            if (null == transaction)
            {
                connection= querySession.CreateConnection();
                connection.Open();
                DbTransaction dbTransaction = connection.BeginTransaction(isolationLevel);
                Transaction.Current = new CommittableTransaction(dbTransaction);
            }
            else
            {
                Transaction.Current = transaction.DependentClone();
            }
        }
        /// <summary>
        /// 
        /// </summary>
        /// <param name="querySession"></param>
        /// <param name="isolationLevel"></param>
        public TransactionScope(DbConnection conn, IsolationLevel isolationLevel = IsolationLevel.Unspecified)
        {
            if (null == transaction)
            {
                connection = conn;
                connection.Open();
                DbTransaction dbTransaction = connection.BeginTransaction(isolationLevel);
                Transaction.Current = new CommittableTransaction(dbTransaction);
            }
            else
            {
                Transaction.Current = transaction.DependentClone();
            }
        }
        public void Complete()
        {
            this.Completed = true;
        }
        public void Dispose()
        {
            Transaction current = Transaction.Current;
            Transaction.Current = transaction;
            if (!this.Completed)
            {
                try
                {
                    current.Rollback();
                }
                catch (Exception ex)
                {
                     #if DEBUG
                    Log.Logger.LogException(ex);
                    #endif
                }
              finally
                {
                    connection.Close();
                }
               
            }
            CommittableTransaction committableTransaction = current as CommittableTransaction;
            if (null != committableTransaction)
            {
                if (this.Completed)
                {
                    try
                    {
                        committableTransaction.Commit();
                    }
                    catch (Exception ex)
                    {
                         #if DEBUG
                        Log.Logger.LogException(ex);
                        #endif
                    }
                    finally
                    {
                        connection.Close();
                    }
                   
                   
                }
                committableTransaction.Dispose();
            }
        }
      
}
}
#region copyright
// <copyright file="WhereQueryTranslator.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>????</author>
// <datecreated>2012-12-21</datecreated>
#endregion
namespace Cis.DbLight
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Linq.Expressions;
    using System.Reflection;
    using System.Text;
    using System.Text.RegularExpressions;
    using Cis.Infrastructure;
    using Cis.Infrastructure.Extensions;
    using Cis.Infrastructure.Reflection;
    using Cis.DbLight.External;
    using Cis.DbLight.TableMetadata;
    using ExpressionVisitor = System.Linq.Expressions.ExpressionVisitor;
    /// <summary>
    /// todo ?????????
    /// </summary>
    public class WhereQueryTranslator : ExpressionVisitor, IWhereQueryTranslator
    {
       // private Constraint currentConstraint1;
        private StringBuilder sb;
        private string orderBy = string.Empty;
     
        private string whereClause = string.Empty;
        private IDictionary<string, object> dbParams = new Dictionary<string, object>();
        public List<Constraint> GetConstraints()
        {
            return binaryCons;
        }
        public Table Table { get; set; }
        private SqlLog sqlLog;
        //public WhereQueryTranslator()
        //{}
        public WhereQueryTranslator(DatabaseInfo databaseInfo)
        {
            this.databaseInfo = databaseInfo;
          
            sqlLog=new SqlLog(databaseInfo);
        }
        public IDictionary<string, object> DbParams
        {
            get { return this.dbParams; }
            set
            {
                dbParams = value;
            }
        }
        public ColumnMapperStrategy ColumnMapperStrategy { get; set; }
       
             /// <summary>
        /// ?????????????????????????
        /// </summary>
        public bool IsUseAlias { get; set; }
        public string WhereClause
        {
            get
            {
                return this.whereClause;
            }
        }
        private DatabaseInfo databaseInfo;
        private DbParameterCreater dbParameterCreater=new DbParameterCreater();
        public DatabaseInfo DatabaseInfo
        {
            get
            {
                return this.databaseInfo;
            }
            set
            {
                this.databaseInfo = value;
            }
        }
       
        public string Translate(Expression expression)
        {
            this.sb = new StringBuilder();
            this.Visit(expression);
            this.whereClause = this.sb.ToString();
            return this.whereClause;
        }
        private static Expression StripQuotes(Expression e)
        {
            while (e.NodeType == ExpressionType.Quote)
            {
                e = ((UnaryExpression)e).Operand;
            }
            return e;
        }
        protected override Expression VisitMethodCall(MethodCallExpression m)
        {
            
            //if (m.Method.DeclaringType == typeof(Queryable) && m.Method.Name == "Where")
            //{
            //    this.Visit(m.Arguments[0]);
            //    LambdaExpression lambda = (LambdaExpression)StripQuotes(m.Arguments[1]);
            //    this.Visit(lambda.Body);
            //    return m;
            //}
             Constraint currentConstraint = this.GetCurrent();//bug ?????visitmethodcall??????conditionBuilder.AppendByAutoGen(null, (User u) => u.UserCode.Contains(userCode),ColumnMapperStrategy.ColumnAttribute,false);
            if (m.Method.Name == "Contains")
            {
                Expression nextExpression = m.Arguments[0];
                string contain=null;
                if(nextExpression is ConstantExpression)
                {
                    ConstantExpression sizeExpression = (ConstantExpression)nextExpression;
                    contain = sizeExpression.Value.ToString();
                }
               
                if (nextExpression is MemberExpression)
                {
                   contain= this.GetValue(nextExpression as MemberExpression) as string;
                }
               
               
                if (!string.IsNullOrEmpty(contain))
                {
                    //?????????????????????????????????
                    isLeft = true;
                    Visit(m.Object);
                    if (leftProperyChian.Count == 1)
                    {
                        string key = currentConstraint.TableAlias+ leftProperyChian[0];
                        sb.AppendFormat(" {0} like {1}",this.GetColumnName(leftProperyChian[0]), this.DatabaseInfo.SqlDialect.DbParameterConstant + key);
                        dbParams[key] = string.Format("%{0}%", contain);
                    }
                    leftProperyChian.Clear();
                    isLeft = false;
                    currentConstraint.ParameterValue = contain;
                    currentConstraint.Comparison = Comparison.Like;
                }
              
            }
            else
            {
                throw new NotSupportedException(string.Format("The method '{0}' is not supported", m.Method.Name)); 
            }
           return m;
        }
        protected override Expression VisitUnary(UnaryExpression u)
        {
            Constraint currentConstraint = this.GetCurrent();
            switch (u.NodeType)
            {
                case ExpressionType.Not:
                    currentConstraint.Comparison=Comparison.IsNot;
                    this.sb.Append(" NOT ");
                    this.Visit(u.Operand);
                    break;
                case ExpressionType.Convert:
                    this.Visit(u.Operand);
                    break;
                default:
                    throw new NotSupportedException(string.Format("The unary operator '{0}' is not supported", u.NodeType));
            }
            return u;
        }
        /// <summary>
        ///
        /// </summary>
        /// <param name="sb"></param>
        /// <returns></returns>
        private bool CanAppend(StringBuilder sb)
        {
            var s = sb.ToString();
            var l = s.LastOrDefault();
            if (s.Length != 0 && l != '(')
            {
                return true;
            }
            return false;
        }
        private List<Constraint> binaryCons = new List<Constraint>();
        private int beCount = 0;//binary ????
        private int i = 0;
        private Constraint GetCurrent()
        {
            if (binaryCons.Count==0)
            {
                binaryCons.Add(new Constraint());
            }
            if (i == 0) i++;
            return binaryCons[i - 1];
        }
        private bool isLeft = true;
        /// <summary>
        /// 
        /// </summary>
        /// <param name="b"></param>
        /// <returns></returns>
        protected override Expression VisitBinary(BinaryExpression b)
        {
            Constraint cons=new Constraint();
            cons.Test = beCount;
            binaryCons.Add(cons);
            beCount++;
            i++;
           // this.sb.Append("(");
            isLeft = true;
            this.Visit(b.Left);
            //??????・???????u.Name???
            if (leftProperyChian.Count==1)
                sb.Append(this.GetColumnName(leftProperyChian[0]));
            Constraint currentConstraint=this.GetCurrent();
            if (this.CanAppend(this.sb))
            {
                
                switch (b.NodeType)
                {
                    case ExpressionType.And:
                        currentConstraint.Condition = ConstraintType.And;
                        this.sb.Append(" AND ");
                        break;
                    case ExpressionType.AndAlso:
                        currentConstraint.Condition = ConstraintType.And;
                        this.sb.Append(" AND ");
                        break;
                    case ExpressionType.Or:
                        currentConstraint.Condition = ConstraintType.Or;
                        this.sb.Append(" OR ");
                        break;
                    case ExpressionType.OrElse:
                        this.sb.Append(" OR ");
                        currentConstraint.Condition = ConstraintType.Or;
                        break;
                    case ExpressionType.Equal:
                        if (this.IsNullConstant(b.Right))
                        {
                            currentConstraint.Comparison = Comparison.Is;
                            this.sb.Append(" IS ");
                        }
                        else
                        {
                            this.sb.Append(" = ");
                            currentConstraint.Comparison = Comparison.Equals;
                        }
                        break;
                    case ExpressionType.NotEqual:
                        if (this.IsNullConstant(b.Right))
                        {
                            this.sb.Append(" IS NOT ");
                            currentConstraint.Comparison = Comparison.IsNot;
                        }
                        else
                        {
                            currentConstraint.Comparison = Comparison.NotEquals;
                            this.sb.Append(" <> ");
                        }
                        break;
                    case ExpressionType.LessThan:
                        this.sb.Append(" < ");
                        currentConstraint.Comparison = Comparison.LessThan;
                        break;
                    case ExpressionType.LessThanOrEqual:
                        this.sb.Append(" <= ");
                        currentConstraint.Comparison = Comparison.LessOrEquals;
                        break;
                    case ExpressionType.GreaterThan:
                        this.sb.Append(" > ");
                        currentConstraint.Comparison = Comparison.GreaterThan;
                        break;
                    case ExpressionType.GreaterThanOrEqual:
                        this.sb.Append(" >= ");
                        currentConstraint.Comparison = Comparison.GreaterOrEquals;
                        break;
                    default:
                        throw new NotSupportedException(string.Format("The binary operator '{0}' is not supported", b.NodeType));
                }
            }
            isLeft = false;
            this.Visit(b.Right);
            i--;//?????????binary
           
            leftProperyChian.Clear();
            rightProperyChian.Clear();
            //??????????????????sql
            //(PatientId = ..)
          //  this.sb.Append(")");
            string reg = @"\([^\(]*?\.\.\)";
            this.sb = new StringBuilder(Regex.Replace(this.sb.ToString(), reg, ""));
            return b;
        }
        protected override Expression VisitParameter(ParameterExpression node)
        {
            //if (node.Type == typeof(TSrc))
            //{
            //    return parameter;
            //}
            //else
            return base.VisitParameter(node);
        }
     
        protected override Expression VisitConstant(ConstantExpression c)
        {
            IQueryable q = c.Value as IQueryable;
            Constraint currentConstraint =this.GetCurrent();
            string key =null;
            if (leftProperyChian.Count != 0)
            {
                key = this.GetKey();
            }
            else
            {
                throw new Exception("?????????????");
            }
            if (q == null && c.Value == null)
            {
                dbParams[key] = null;
                this.sb.Append(this.DatabaseInfo.SqlDialect.DbParameterConstant+key);
            }
            else if (q == null)
            {
                currentConstraint.ParameterValue = c.Value;
               
                switch (Type.GetTypeCode(c.Value.GetType()))
                {
                   
                    case TypeCode.Object:
                        throw new NotSupportedException(string.Format("The constant for '{0}' is not supported", c.Value));
                    default:
                        dbParams[key] = c.Value;
                        this.sb.Append(this.DatabaseInfo.SqlDialect.DbParameterConstant + key);
                        break;
                }
            }
            return c;
        }
        /// <summary>
        /// ??????????????????
        /// </summary>
        /// <param name="properyName"></param>
        /// <returns></returns>
        private string GetColumnName(string properyName)
        {
            Constraint constraint = this.GetCurrent();
            if(constraint.TableAlias!=null)
            {
                return constraint.TableAlias+"."+Table.Columns.Where(col => col.PropertyName == properyName).First().ColumnName;
            }
            else
            {
                return Table.Columns.Where(col => col.PropertyName == properyName).First().ColumnName;
            }
         
           // return properyName;
        }
        private string GetKey()
        {
            string leftmemberPath = null;
            Constraint currentConstraint = this.GetCurrent();
            if (leftProperyChian.Count != 0)
            {
                for (int j = 0; j < leftProperyChian.Count; j++)
                {
                    leftmemberPath += leftProperyChian[j];
                }
                leftmemberPath = leftmemberPath.Replace(".", "");
                if (currentConstraint.TableAlias != null) return currentConstraint.TableAlias + leftmemberPath;
                else
                {
                    return leftmemberPath;
                }
            }
            else
            {
                throw new Exception();
            }
           
           
        }
        
        /// <summary>
        /// ???????????
        /// </summary>
        private  List<string> rightProperyChian=new List<string>();
        /// <summary>
        /// ????????????????????????????
        /// </summary>
        private List<string> leftProperyChian = new List<string>();
        private object GetValue(MemberExpression member)
        {
            var objectMember = Expression.Convert(member, typeof(object));
            var getterLambda = Expression.Lambda<Func<object>>(objectMember);
            var getter = getterLambda.Compile();
            return getter();
        }
       
        private bool innerConstant = false;
        protected override Expression VisitMember(MemberExpression m)
        {
            Constraint constraint = this.GetCurrent();
            if (m.Expression != null && m.Expression.NodeType == ExpressionType.Parameter)
            {
                string columnName = "";
                string properyName = "";
                properyName = m.Member.Name;
                if (this.ColumnMapperStrategy == ColumnMapperStrategy.ColumnAttribute)
                {
                    PropertyInfo propertyInfo = (PropertyInfo)m.Member;
                   
                    var colAttr = propertyInfo.GetCustomAttributes(true).OfType<ColumnAttribute>().FirstOrDefault();
                    columnName = colAttr.ColumnName;
                }
                else
                {
                    columnName = m.Member.Name;
                }
                var parm = m.Expression as ParameterExpression;
                if (IsUseAlias&&parm != null)
                {
                    constraint.TableAlias = parm.Name;
                    columnName = parm.Name + "." + columnName;
                    //this.sb.Append(parm.Name + "." + columnName);
                }
                else
                {
                    //this.sb.Append(columnName);
                }
                if(isLeft)
                {
                    leftProperyChian.Insert(0, properyName);
                }
               
                else
                {
                    //properyChian
                }
                constraint.ColumnName = columnName;
                return m;
            }
            else if (m.Expression != null && m.Expression.NodeType == ExpressionType.MemberAccess)
            {
               // ?????????????????.
                MemberExpression innerMember = (MemberExpression)m.Expression;
                if (isLeft)
                {
                   // this.sb.Append(m.Member.Name);
                    leftProperyChian.Insert(0, m.Member.Name);
                }
                else
                {
                    rightProperyChian.Insert(0, m.Member.Name);
                }
               
                constraint.Test1 += m.Member.Name;
                
                if(innerMember.Expression.NodeType==ExpressionType.Constant)
                {
                  // rightProperyChian.Insert(0, innerMember.Member.Name);
                    innerConstant = true;
                }
                Visit(innerMember);
                if(innerMember.Member is PropertyInfo)
                {
                  
                    //right????・????????filed??????????????????????м??????
                    if (isLeft)
                    {
                        string leftmemberPath = "";
                        if (leftProperyChian.Count != 0)
                        {
                            for (int j = 0; j < leftProperyChian.Count; j++)
                            {
                                leftmemberPath += "." + leftProperyChian[j];
                            }
                            leftmemberPath = leftmemberPath.Remove(0, 1);
                            sb.Append(leftmemberPath);
                        }
                    }
                   
                }
                else
                {
                    if(!isLeft)
                    {
                        object outerObj = GetValue(innerMember);
                        string memberPath = null;
                        string key = null;
                        if (rightProperyChian.Count != 0)
                        {
                            for (int j = 0; j < rightProperyChian.Count; j++)
                            {
                                if (j != 0)
                                {
                                    memberPath += "." + rightProperyChian[j];
                                }
                                key += rightProperyChian[j];
                            }
                        }
                        memberPath = memberPath.Remove(0, 1);
                        var value = Reflection.GetPropertyValueByPath(outerObj, memberPath);
                        this.dbParams[key] = value; //?????ò????????
                        this.sb.Append(this.DatabaseInfo.SqlDialect.DbParameterConstant + key);
                    }
                    else
                    {
                        throw new Exception("????????????filedinfo");
                    }
                   
                    
                    
                }
               
                return m;
            }
            else if (m.Expression != null && m.Expression.NodeType == ExpressionType.Constant)
            {
               // object value=null;
                if (isLeft)
                {
                    throw new Exception("??ò??????????????");
                   // leftProperyChian.Insert(0, m.Member.Name);
                }
                else
                {
                    //????parameter.Order.UserInfo.Name??
                    rightProperyChian.Insert(0, m.Member.Name);
                    constraint.Test1 += m.Member.Name;
                    //????parameter.Order.UserInfo.Name??
                    //?????????express?????????
                    if( !innerConstant)
                    {
                        //???? ????user.ID=userId//userId?filed???????????????
                        var value = GetValue(m);
                        if (value.GetType().IsPrimitive())
                        {
                            if (rightProperyChian.Count == 1)
                            {
                                string key = rightProperyChian[0];
                                this.dbParams[key] = value;
                                sb.Append(this.DatabaseInfo.SqlDialect.DbParameterConstant + key);
                            }
                            else
                            {
                                throw new Exception("????????");
                            }
                        }
                        
                    }
                    innerConstant = false;
                   
                }
              
                return m;
            }
            else
            {
                throw new NotSupportedException(string.Format("The member '{0}' is not supported", m.Member.Name));
            }
           
        }
        protected bool IsNullConstant(Expression exp)
        {
            return (exp.NodeType == ExpressionType.Constant && ((ConstantExpression)exp).Value == null);
        }
        private bool ParseOrderByExpression(MethodCallExpression expression, string order)
        {
            UnaryExpression unary = (UnaryExpression)expression.Arguments[1];
            LambdaExpression lambdaExpression = (LambdaExpression)unary.Operand;
            lambdaExpression = (LambdaExpression)Evaluator.PartialEval(lambdaExpression);
            MemberExpression body = lambdaExpression.Body as MemberExpression;
            if (body != null)
            {
                if (string.IsNullOrEmpty(this.orderBy))
                {
                    this.orderBy = string.Format("{0} {1}", body.Member.Name, order);
                }
                else
                {
                    this.orderBy = string.Format("{0}, {1} {2}", this.orderBy, body.Member.Name, order);
                }
                return true;
            }
            return false;
        }
    
      
    }
}#region copyright
// <copyright file="WhereQueryTranslator.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>????</author>
// <datecreated>2012-12-21</datecreated>
#endregion
namespace Cis.DbLight
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Linq.Expressions;
    using System.Reflection;
    using System.Text;
    using System.Text.RegularExpressions;
    using Cis.Infrastructure;
    using Cis.Infrastructure.Extensions;
    using Cis.Infrastructure.Reflection;
    using Cis.DbLight.External;
    using Cis.DbLight.TableMetadata;
    using ExpressionVisitor = System.Linq.Expressions.ExpressionVisitor;
    /// <summary>
    /// ?°汾
    /// </summary>
    public class WhereQueryTranslator2 : ExpressionVisitor, IWhereQueryTranslator
    {
       // private Constraint currentConstraint1;
        private StringBuilder sb;
        private string orderBy = string.Empty;
     
        private string whereClause = string.Empty;
        private IDictionary<string, object> dbParams = new Dictionary<string, object>();
        public List<Constraint> GetConstraints()
        {
            return binaryCons;
        }
        public Table Table { get; set; }
        private SqlLog sqlLog;
        //public WhereQueryTranslator()
        //{}
        public WhereQueryTranslator2(DatabaseInfo databaseInfo)
        {
            this.databaseInfo = databaseInfo;
          
            sqlLog=new SqlLog(databaseInfo);
        }
        public IDictionary<string, object> DbParams
        {
            get { return this.dbParams; }
            set
            {
                dbParams = value;
            }
        }
        public ColumnMapperStrategy ColumnMapperStrategy { get; set; }
       
             /// <summary>
        /// ?????????????????????????
        /// </summary>
        public bool IsUseAlias { get; set; }
        public string WhereClause
        {
            get
            {
                return this.whereClause;
            }
        }
        private DatabaseInfo databaseInfo;
        private DbParameterCreater dbParameterCreater=new DbParameterCreater();
        public DatabaseInfo DatabaseInfo
        {
            get
            {
                return this.databaseInfo;
            }
            set
            {
                this.databaseInfo = value;
            }
        }
       
        public string Translate(Expression expression)
        {
            this.sb = new StringBuilder();
            this.Visit(expression);
            this.whereClause = this.sb.ToString();
            return this.whereClause;
        }
        private static Expression StripQuotes(Expression e)
        {
            while (e.NodeType == ExpressionType.Quote)
            {
                e = ((UnaryExpression)e).Operand;
            }
            return e;
        }
        protected override Expression VisitMethodCall(MethodCallExpression m)
        {
            
           
             Constraint currentConstraint = this.GetCurrent();//bug ?????visitmethodcall??????conditionBuilder.AppendByAutoGen(null, (User u) => u.UserCode.Contains(userCode),ColumnMapperStrategy.ColumnAttribute,false);
            if (m.Method.Name == "Contains")
            {
                Expression nextExpression = m.Arguments[0];
                string contain=null;
                if(nextExpression is ConstantExpression)
                {
                    ConstantExpression sizeExpression = (ConstantExpression)nextExpression;
                    contain = sizeExpression.Value.ToString();
                }
               
                if (nextExpression is MemberExpression)
                {
                   contain= this.GetValue(nextExpression as MemberExpression) as string;
                }
               
               
                if (!string.IsNullOrEmpty(contain))
                {
                    //?????????????????????????????????
                    isLeft = true;
                    Visit(m.Object);
                    if (leftProperyChian.Count == 1)
                    {
                        sb.AppendFormat(" {0} like {1}",this.GetColumnName(leftProperyChian[0]), this.DatabaseInfo.SqlDialect.DbParameterConstant + leftProperyChian[0]);
                        dbParams[leftProperyChian[0]] = string.Format("%{0}%", contain);
                    }
                    leftProperyChian.Clear();
                    isLeft = false;
                    currentConstraint.ParameterValue = contain;
                    currentConstraint.Comparison = Comparison.Like;
                }
              
            }
            else
            {
                throw new NotSupportedException(string.Format("The method '{0}' is not supported", m.Method.Name)); 
            }
           return m;
        }
        protected override Expression VisitUnary(UnaryExpression u)
        {
            Constraint currentConstraint = this.GetCurrent();
            switch (u.NodeType)
            {
                case ExpressionType.Not:
                    currentConstraint.Comparison=Comparison.IsNot;
                    this.sb.Append(" NOT ");
                    this.Visit(u.Operand);
                    break;
                case ExpressionType.Convert:
                    this.Visit(u.Operand);
                    break;
                default:
                    throw new NotSupportedException(string.Format("The unary operator '{0}' is not supported", u.NodeType));
            }
            return u;
        }
        /// <summary>
        ///
        /// </summary>
        /// <param name="sb"></param>
        /// <returns></returns>
        private bool CanAppend(StringBuilder sb)
        {
            var s = sb.ToString();
            var l = s.LastOrDefault();
            if (s.Length != 0 && l != '(')
            {
                return true;
            }
            return false;
        }
        private List<Constraint> binaryCons = new List<Constraint>();
        private int beCount = 0;//binary ????
        private int i = 0;
        private Constraint GetCurrent()
        {
            if (binaryCons.Count==0)
            {
                binaryCons.Add(new Constraint());
            }
            if (i == 0) i++;
            return binaryCons[i - 1];
        }
        private bool isLeft = true;
        /// <summary>
        /// 
        /// </summary>
        /// <param name="b"></param>
        /// <returns></returns>
        protected override Expression VisitBinary(BinaryExpression b)
        {
            Constraint cons=new Constraint();
            cons.Test = beCount;
            binaryCons.Add(cons);
            beCount++;
            i++;
           // this.sb.Append("(");
            isLeft = true;
            this.Visit(b.Left);
            //??????・???????u.Name???
            if (leftProperyChian.Count==1)
                sb.Append(leftProperyChian[0]);
            Constraint currentConstraint=this.GetCurrent();
            if (this.CanAppend(this.sb))
            {
                
                switch (b.NodeType)
                {
                    case ExpressionType.And:
                        currentConstraint.Condition = ConstraintType.And;
                        this.sb.Append(" AND ");
                        break;
                    case ExpressionType.AndAlso:
                        currentConstraint.Condition = ConstraintType.And;
                        this.sb.Append(" AND ");
                        break;
                    case ExpressionType.Or:
                        currentConstraint.Condition = ConstraintType.Or;
                        this.sb.Append(" OR ");
                        break;
                    case ExpressionType.OrElse:
                        this.sb.Append(" OR ");
                        currentConstraint.Condition = ConstraintType.Or;
                        break;
                    case ExpressionType.Equal:
                        if (this.IsNullConstant(b.Right))
                        {
                            currentConstraint.Comparison = Comparison.Is;
                            this.sb.Append(" IS ");
                        }
                        else
                        {
                            this.sb.Append(" = ");
                            currentConstraint.Comparison = Comparison.Equals;
                        }
                        break;
                    case ExpressionType.NotEqual:
                        if (this.IsNullConstant(b.Right))
                        {
                            this.sb.Append(" IS NOT ");
                            currentConstraint.Comparison = Comparison.IsNot;
                        }
                        else
                        {
                            currentConstraint.Comparison = Comparison.NotEquals;
                            this.sb.Append(" <> ");
                        }
                        break;
                    case ExpressionType.LessThan:
                        this.sb.Append(" < ");
                        currentConstraint.Comparison = Comparison.LessThan;
                        break;
                    case ExpressionType.LessThanOrEqual:
                        this.sb.Append(" <= ");
                        currentConstraint.Comparison = Comparison.LessOrEquals;
                        break;
                    case ExpressionType.GreaterThan:
                        this.sb.Append(" > ");
                        currentConstraint.Comparison = Comparison.GreaterThan;
                        break;
                    case ExpressionType.GreaterThanOrEqual:
                        this.sb.Append(" >= ");
                        currentConstraint.Comparison = Comparison.GreaterOrEquals;
                        break;
                    default:
                        throw new NotSupportedException(string.Format("The binary operator '{0}' is not supported", b.NodeType));
                }
            }
            isLeft = false;
            this.Visit(b.Right);
            i--;//?????????binary
           
            leftProperyChian.Clear();
            rightProperyChian.Clear();
            //??????????????????sql
            //(PatientId = ..)
          //  this.sb.Append(")");
            string reg = @"\([^\(]*?\.\.\)";
            this.sb = new StringBuilder(Regex.Replace(this.sb.ToString(), reg, ""));
            return b;
        }
        protected override Expression VisitParameter(ParameterExpression node)
        {
            //if (node.Type == typeof(TSrc))
            //{
            //    return parameter;
            //}
            //else
            return base.VisitParameter(node);
        }
        protected override Expression VisitConstant(ConstantExpression c)
        {
            IQueryable q = c.Value as IQueryable;
            Constraint currentConstraint =this.GetCurrent();
            string leftmemberPath = null;
            if (leftProperyChian.Count != 0)
            {
                for (int j = 0; j < leftProperyChian.Count; j++)
                {
                    leftmemberPath += leftProperyChian[j];
                }
               leftmemberPath= leftmemberPath.Replace(".", "");
            }
            else
            {
                throw new Exception("?????????????");
            }
            string key = leftmemberPath;
            if (q == null && c.Value == null)
            {
                dbParams[key] = null;
                this.sb.Append(this.DatabaseInfo.SqlDialect.DbParameterConstant+key);
            }
            else if (q == null)
            {
                currentConstraint.ParameterValue = c.Value;
               
                switch (Type.GetTypeCode(c.Value.GetType()))
                {
                   
                    case TypeCode.Object:
                        throw new NotSupportedException(string.Format("The constant for '{0}' is not supported", c.Value));
                    default:
                        dbParams[key] = c.Value;
                        this.sb.Append(this.DatabaseInfo.SqlDialect.DbParameterConstant + key);
                        break;
                }
            }
            return c;
        }
        /// <summary>
        /// ??????????????????
        /// </summary>
        /// <param name="properyName"></param>
        /// <returns></returns>
        private string GetColumnName(string properyName)
        {
           return Table.Columns.Where(col => col.PropertyName == properyName).First().ColumnName;
           // return properyName;
        }
        /// <summary>
        /// ???????????
        /// </summary>
        private  List<string> rightProperyChian=new List<string>();
        /// <summary>
        /// ????????????????????????????
        /// </summary>
        private List<string> leftProperyChian = new List<string>();
        private object GetValue(MemberExpression member)
        {
            var objectMember = Expression.Convert(member, typeof(object));
            var getterLambda = Expression.Lambda<Func<object>>(objectMember);
            var getter = getterLambda.Compile();
            return getter();
        }
       
        private bool innerConstant = false;
        protected override Expression VisitMember(MemberExpression m)
        {
            Constraint constraint = this.GetCurrent();
            if (m.Expression != null && m.Expression.NodeType == ExpressionType.Parameter)
            {
                string columnName = "";
                string properyName = "";
                properyName = m.Member.Name;
                constraint.ProperyName = properyName;
                if (this.ColumnMapperStrategy == ColumnMapperStrategy.ColumnAttribute)
                {
                    PropertyInfo propertyInfo = (PropertyInfo)m.Member;
                   
                    var colAttr = propertyInfo.GetCustomAttributes(true).OfType<ColumnAttribute>().FirstOrDefault();
                    columnName = colAttr.ColumnName;
                    constraint.ColumnName = columnName;
                }
                
                var parm = m.Expression as ParameterExpression;
                if (IsUseAlias&&parm != null)
                {
                    constraint.TableAlias = parm.Name;
                }
                if (isLeft)
                {
                    constraint.LeftProperyChian.Insert(0,properyName);
                    leftProperyChian.Insert(0, properyName);
                }
                else
                {
                    //properyChian
                }
               
                return m;
            }
            else if (m.Expression != null && m.Expression.NodeType == ExpressionType.MemberAccess)
            {
               // ?????????????????.
                MemberExpression innerMember = (MemberExpression)m.Expression;
                if (isLeft)
                {
                    constraint.LeftProperyChian.Insert(0, m.Member.Name);
                    leftProperyChian.Insert(0, m.Member.Name);
                }
                else
                {
                    constraint.RightProperyChian.Insert(0, m.Member.Name);
                    rightProperyChian.Insert(0, m.Member.Name);
                }
               
                 
                if(innerMember.Expression.NodeType==ExpressionType.Constant)
                {
                  // rightProperyChian.Insert(0, innerMember.Member.Name);
                    innerConstant = true;
                }
                Visit(innerMember);
                if(innerMember.Member is PropertyInfo)
                {
                  
                    //right????・????????filed??????????????????????м??????
                    if (isLeft)
                    {
                        string leftmemberPath = "";
                        if (leftProperyChian.Count != 0)
                        {
                            for (int j = 0; j < leftProperyChian.Count; j++)
                            {
                                leftmemberPath += "." + leftProperyChian[j];
                            }
                            leftmemberPath = leftmemberPath.Remove(0, 1);
                            sb.Append(leftmemberPath);
                        }
                    }
                   
                }
                else
                {
                    if(!isLeft)
                    {
                        object outerObj = GetValue(innerMember);
                        string memberPath = null;
                        string key = null;
                        if (rightProperyChian.Count != 0)
                        {
                            for (int j = 0; j < rightProperyChian.Count; j++)
                            {
                                if (j != 0)
                                {
                                    memberPath += "." + rightProperyChian[j];
                                }
                                key += rightProperyChian[j];
                            }
                        }
                        memberPath = memberPath.Remove(0, 1);
                        var value = Reflection.GetPropertyValueByPath(outerObj, memberPath);
                        this.dbParams[key] = value; //?????ò????????
                        this.sb.Append(this.DatabaseInfo.SqlDialect.DbParameterConstant + key);
                        constraint.ParameterValue = value;
                        constraint.ParameterName = key;
                    }
                    else
                    {
                        throw new Exception("????????????filedinfo");
                    }
                   
                    
                    
                }
               
                return m;
            }
            else if (m.Expression != null && m.Expression.NodeType == ExpressionType.Constant)
            {
               // object value=null;
                if (isLeft)
                {
                    throw new Exception("??ò??????????????");
                   // leftProperyChian.Insert(0, m.Member.Name);
                }
                else
                {
                    //????parameter.Order.UserInfo.Name??
                    rightProperyChian.Insert(0, m.Member.Name);
                    constraint.Test1 += m.Member.Name;
                    //????parameter.Order.UserInfo.Name??
                    //?????????express?????????
                    if( !innerConstant)
                    {
                        //???? ????user.ID=userId//userId?filed???????????????
                        var value = GetValue(m);
                        if (value.GetType().IsPrimitive())
                        {
                            if (rightProperyChian.Count == 1)
                            {
                                string key = rightProperyChian[0];
                                this.dbParams[key] = value;
                                sb.Append(this.DatabaseInfo.SqlDialect.DbParameterConstant + key);
                            }
                            else
                            {
                                throw new Exception("????????");
                            }
                        }
                        
                    }
                    innerConstant = false;
                   
                }
              
                return m;
            }
            else
            {
                throw new NotSupportedException(string.Format("The member '{0}' is not supported", m.Member.Name));
            }
           
        }
        protected bool IsNullConstant(Expression exp)
        {
            return (exp.NodeType == ExpressionType.Constant && ((ConstantExpression)exp).Value == null);
        }
        private bool ParseOrderByExpression(MethodCallExpression expression, string order)
        {
            UnaryExpression unary = (UnaryExpression)expression.Arguments[1];
            LambdaExpression lambdaExpression = (LambdaExpression)unary.Operand;
            lambdaExpression = (LambdaExpression)Evaluator.PartialEval(lambdaExpression);
            MemberExpression body = lambdaExpression.Body as MemberExpression;
            if (body != null)
            {
                if (string.IsNullOrEmpty(this.orderBy))
                {
                    this.orderBy = string.Format("{0} {1}", body.Member.Name, order);
                }
                else
                {
                    this.orderBy = string.Format("{0}, {1} {2}", this.orderBy, body.Member.Name, order);
                }
                return true;
            }
            return false;
        }
    
      
    }
}#region copyright
// <copyright file="DatabaseInfo.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-28</datecreated>
#endregion
namespace Cis.DbLight
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text;
    /// <summary>
    /// 数据库信息，每个数据库一个
    /// 
    /// wcf ioc 不好用。。。。。。。
    /// 分两种，每个库与没种库
    /// </summary>
    public class DatabaseInfo
    {
        public DatabaseInfo(string connectionStringName, ISqlDialect dialect)
        {
            SqlDialect = dialect;
            TablesInfo = new TablesInfo(dialect);
            ConnectionStringName = connectionStringName;
           //bTypeConverter=new DbTypeConverter();
            //WhereQueryTranslator=new WhereQueryTranslator();
        }
        //
       // public WhereQueryTranslator WhereQueryTranslator { get; set; }
       
        /// <summary>
        /// 数据库类型每种数据库一个
        /// </summary>
        public ISqlDialect SqlDialect { get; set; }
      
        public string ConnectionStringName { get; set; }
        /// <summary>
        /// 数据库表信息
        /// </summary>
        public TablesInfo TablesInfo { get; private set; }
        /// <summary>
        /// 数据库类型转换，每种数据库一个
        /// </summary>
        public IDbTypeConverter DbTypeConverter { get; set; }
    }
    
}
#region copyright
// <copyright file="IDbTypeConverter.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-28</datecreated>
#endregion
namespace Cis.DbLight
{
    using System;
    using System.Collections.Generic;
    using System.Data;
    using System.Data.Common;
    /// <summary>
    /// Dbtype与clrtype转换
    /// </summary>
    public  interface  IDbTypeConverter
    {
        /// <summary>
        /// 将值转换为sql string
        /// todo 不同数据库不同转换
        /// </summary>
        /// <param name="obj"></param>
        /// <param name="customConverter"></param>
        /// <returns></returns>
        string ToDbString(object obj, Func<object, string> customConverter = null);
        DbType ClrToDbType(Type type);
        Type DbTypeToClr(DbType dbType);
        DbParameter GetDbParameter(DbCommand cmd, string name, object value);
        void AddParam(DbCommand cmd, object value);
        void AddParams(DbCommand cmd, IDictionary<string, object> dbParameters);
        void AddParams(DbCommand cmd, params object[] args);
        IDictionary<string, object> ToDicParams(params object[] args);
    }
}#region copyright
// <copyright file="ISqlDialect.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-28</datecreated>
#endregion
namespace Cis.DbLight
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text;
    /// <summary>
    /// 数据库信息
    /// </summary>
    public interface ISqlDialect
    {
        /// <summary>
        /// 不同数据库的查询参数，如：oracle：
        /// sql server:@
        /// </summary>
        string DbParameterConstant { get; }
        /// <summary>
        /// 查询表结构sql，使用properytocol映射
        /// </summary>
        string SchemaSql { get; }
        /// <summary>
        /// 编码关键字列名,表名
        /// </summary>
        /// <param name="name"></param>
        /// <returns></returns>
        string EncodeName(string name);
    }
   
}
#region copyright
// <copyright file="TablesInfo.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-28</datecreated>
#endregion
namespace Cis.DbLight
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Reflection;
    using Cis.Cache;
    using Cis.Infrastructure;
    using Cis.Infrastructure.Extensions;
    using Cis.DbLight.Mapper;
    using Cis.DbLight.TableMetadata;
    /// <summary>
    /// 数据库中的表信息，每个数据库一个
    /// </summary>
    public class TablesInfo
    {
        #region Constants
        private const string columnAttrMapTableName = "columnAttrTableName*{0}";
        // private const string dtoMapTableName = "dtoTableName*{0}";
        private const string propertyMapTableName = "propertyTableName*{0}";
        private const string dbSchemaMapTableName = "schemaTableName*{0}";
        #endregion
        #region Static Fields
        private static readonly ICacheProvider<Table> tableCache = new LruMemoryCache<Table>();
        private ISqlDialect dialect;
        #endregion
        #region Public Methods and Operators
        public TablesInfo(ISqlDialect dialect)
        {
            this.dialect = dialect;
            //this.schemaSql = schemaSql;
        }
        /// <summary>
        /// 
        /// </summary>
        /// <returns></returns>
        public Table LoadTable(ColumnMapperStrategy columnMapperStrategy, Type type)
        {
            if (columnMapperStrategy == ColumnMapperStrategy.ColumnAttribute)
            {
                return this.LoadFromMetadata(type);
            }
            else
            {
                return this.LoadFromProperty(type);
            }
        }
        public bool IsSupportAttributeMap(Type type)
        {
            TableAttribute tableAttr = type.GetCustomAttributes(true).OfType<TableAttribute>().FirstOrDefault();
            return tableAttr != null;
        }
        public Table LoadFromSchema(string tableName, Func<Table> getTable)
        {
            string key = string.Format(dbSchemaMapTableName, tableName);
            return tableCache.GetOrAdd(key, getTable);
        }
        #endregion
        //public static Table LoadFromDb(string tableName)
        //{
        //    return null;
        //}
        #region Methods
        private Table GetTableFromProperty(Type type)
        {
            var table = new Table();
            table.TableName = type.Name;
            List<PropertyInfo> props = type.GetPrimitivePropertys();
            foreach (PropertyInfo property in props)
            {
                var tt = property.GetCustomAttributes(true);
                PrimaryKeyAttribute columnMaperAttribute = property.GetCustomAttributes(true).OfType<PrimaryKeyAttribute>().FirstOrDefault();
                IColumn t = columnMaperAttribute;
                if (t != null)
                {
                    //主键
                    t.PropertyName = property.Name;
                    t.PropertyType = property.PropertyType;
                    table.Columns.Add(t);
                }
                else
                {
                    table.Columns.Add(new Column { ColumnName = property.Name, PropertyName = property.Name });
                }
            }
            return table;
        }
        private Table GetTableFromAttribute(string tname, Type type)
        {
            var table = new Table();
            table.TableName = tname;
            List<PropertyInfo> props = type.GetPrimitivePropertys();
            foreach (PropertyInfo property in props)
            {
                ColumnAttribute columnMaperAttribute = property.GetCustomAttributes(true).OfType<ColumnAttribute>().FirstOrDefault();
                if (columnMaperAttribute != null)
                {
                    IColumn t = columnMaperAttribute;
                    if (t != null)
                    {
                        t.PropertyName = property.Name;
                        t.PropertyType = property.PropertyType;
                        table.Columns.Add(t);
                    }
                }
                else
                {
                    // Type subType = property.GetType();
                    //if (!subType.IsPrimitive())
                    //{
                    //    Table subTable = Table.LoadFromDomain(subType);
                    //    this.SubTable = subTable;
                    //}
                }
                //if(property)
            }
            return table;
        }
        private Table LoadFromMetadata(Type type)
        {
            TableAttribute tableAttr = type.GetCustomAttributes(true).OfType<TableAttribute>().FirstOrDefault();
            string tname;
            if (tableAttr == null)
            {
                DtoAttribute dto = type.GetCustomAttributes(true).OfType<DtoAttribute>().FirstOrDefault();
                if (dto == null)
                {
                    throw new ArgumentException(string.Format("类型{0}不包含表信息", type));
                }
                else
                {
                    tname = type.Name;
                }
            }
            else
            {
                tname = tableAttr.Name;
            }
            string key = string.Format(columnAttrMapTableName, tname);
            return tableCache.GetOrAdd(key, () => this.GetTableFromAttribute(tname, type));
        }
        /// <summary>
        /// 属性名称作为列名称。无主键等信息
        /// </summary>
        /// <param name="type"></param>
        /// <returns></returns>
        private Table LoadFromProperty(Type type)
        {
            string key = string.Format(propertyMapTableName, type.Name);
            return tableCache.GetOrAdd(key, () => this.GetTableFromProperty(type));
        }
        #endregion
    }
}#region copyright
// <copyright file="DataReaderExtension.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-17</datecreated>
#endregion
namespace Cis.DbLight.Extensions
{
    using System;
    using System.Collections.Generic;
    using System.Data;
    using System.Dynamic;
    using Cis.DbLight.Mapper;
    /// <summary>
    /// TODO: Update summary.
    /// </summary>
    public static class DataReaderExtension
    {
        #region Public Methods and Operators
        /// <summary>
        /// 通过Mapper转换对象
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="rdr"></param>
        /// <param name="mapper"></param>
        /// <returns></returns>
        public static T RecordTo<T>(this IDataReader rdr, IRowMapper<T> mapper) where T : class, new()
        {
            var tt = (IDataRecord)rdr;
            T obj = mapper.MapRow(tt);
            return obj;
        }
        public static List<string> GetColumns (this IDataReader rdr)
        {
            List<string> columnNames = new List<string>();
            for (int i = 0; i < rdr.FieldCount; i++)
            {
                columnNames.Add(rdr.GetName(i));
            }
            return columnNames;
        }
        public static dynamic RecordToExpando(this IDataReader rdr)
        {
            dynamic e = new ExpandoObject();
            var d = e as IDictionary<string, object>;
            for (int i = 0; i < rdr.FieldCount; i++)
            {
                d.Add(rdr.GetName(i), DBNull.Value.Equals(rdr[i]) ? null : rdr[i]);
            }
            return e;
        }
        #endregion
    }
}#region copyright
// <copyright file="DataRecordExtentions.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-18</datecreated>
#endregion
namespace Cis.DbLight.Extensions
{
    using System;
    using System.Collections.Generic;
    using System.Data;
    using System.Linq;
    using System.Text;
    /// <summary>
    /// TODO: Update summary.
    /// </summary>
    public static class DataRecordExtentions
    {
        public static List<string> GetColumns(this IDataRecord record)
        {
            List<string> columnNames = new List<string>();
            for (int i = 0; i < record.FieldCount; i++)
            {
                columnNames.Add(record.GetName(i));
            }
            return columnNames;
        }
    }
}
namespace Cis.DbLight.External
{
    /// <summary>
    /// SQL Comparison Operators
    /// </summary>
    public enum Comparison
    {
        Equals,
        NotEquals,
        Like,
        NotLike,
        GreaterThan,
        GreaterOrEquals,
        LessThan,
        LessOrEquals,
        Blank,
        Is,
        IsNot,
        In,
        NotIn,
        OpenParentheses,
        CloseParentheses,
        BetweenAnd,
        StartsWith,
        EndsWith
    }
}namespace Cis.DbLight.External
{
    using System;
    using System.Collections;
    using System.Collections.Generic;
    using System.ComponentModel;
    using System.Data;
    using Cis.Infrastructure;
    public class Constraint
    {
        /// <summary>
        /// The query that this constraint is operating on
        /// </summary>
        public SqlQuery query;
        public Constraint() { }
        public int Test { get; set; }
      
        #region props
        /// <summary>
        /// Gets or sets the name of the table.
        /// </summary>
        /// <value>The name of the table.</value>
        private string _tableName = String.Empty;
        private ConstraintType condition = ConstraintType.Where;
        private string parameterName;
        /// <summary>
        /// Gets or sets the condition.
        /// </summary>
        /// <value>The condition.</value>
        public ConstraintType Condition
        {
            get { return this.condition; }
            set { this.condition = value; }
        }
        public string TableName
        {
            get { return this._tableName; }
            set { this._tableName = value; }
        }
        /// <summary>
        /// ???????????
        /// </summary>
        private List<string> rightProperyChian = new List<string>();
        /// <summary>
        /// ????????????????????????????
        /// </summary>
        private List<string> leftProperyChian = new List<string>();
        public string Test1 { get; set; }
        public string TableAlias { get; set; }
        /// <summary>
        /// Gets or sets the name of the column.
        /// </summary>
        /// <value>The name of the column.</value>
        public string ColumnName { get; set; }
        public string ProperyName { get; set; }
       
     
        /// <summary>
        /// Gets or sets the comparison.
        /// </summary>
        /// <value>The comparison.</value>
        public Comparison Comparison { get; set; }
        /// <summary>
        /// Gets or sets the parameter value.
        /// </summary>
        /// <value>The parameter value.</value>
        public object ParameterValue { get; set; }
        /// <summary>
        /// Gets or sets the start value.
        /// </summary>
        /// <value>The start value.</value>
        public object StartValue { get; set; }
        /// <summary>
        /// Gets or sets the end value.
        /// </summary>
        /// <value>The end value.</value>
        public object EndValue { get; set; }
        /// <summary>
        /// Gets or sets the in values.
        /// </summary>
        /// <value>The in values.</value>
        public IEnumerable InValues { get; set; }
       
        /// <summary>
        /// Gets or sets the name of the parameter.
        /// </summary>
        /// <value>The name of the parameter.</value>
        public string ParameterName
        {
            get { return this.parameterName ?? this.ColumnName; }
            set { this.parameterName = value; }
        }
        /// <summary>
        /// Gets or sets the type of the db.
        /// </summary>
        /// <value>The type of the db.</value>
        public DbType DbType { get; set; }
        /// <summary>
        /// ???????????
        /// </summary>
        public List<string> RightProperyChian
        {
            get
            {
                return this.rightProperyChian;
            }
            set
            {
                this.rightProperyChian = value;
            }
        }
        /// <summary>
        /// ????????????????????????????
        /// </summary>
        public List<string> LeftProperyChian
        {
            get
            {
                return this.leftProperyChian;
            }
            set
            {
                this.leftProperyChian = value;
            }
        }
        /// <summary>
        /// Gets the comparison operator.
        /// </summary>
        /// <param name="comp">The comp.</param>
        /// <returns></returns>
        public static string GetComparisonOperator(Comparison comp)
        {
            string sOut;
            switch (comp)
            {
                case Comparison.Blank:
                    sOut = SqlComparison.BLANK;
                    break;
                case Comparison.GreaterThan:
                    sOut = SqlComparison.GREATER;
                    break;
                case Comparison.GreaterOrEquals:
                    sOut = SqlComparison.GREATER_OR_EQUAL;
                    break;
                case Comparison.LessThan:
                    sOut = SqlComparison.LESS;
                    break;
                case Comparison.LessOrEquals:
                    sOut = SqlComparison.LESS_OR_EQUAL;
                    break;
                case Comparison.Like:
                    sOut = SqlComparison.LIKE;
                    break;
                case Comparison.NotEquals:
                    sOut = SqlComparison.NOT_EQUAL;
                    break;
                case Comparison.NotLike:
                    sOut = SqlComparison.NOT_LIKE;
                    break;
                case Comparison.Is:
                    sOut = SqlComparison.IS;
                    break;
                case Comparison.IsNot:
                    sOut = SqlComparison.IS_NOT;
                    break;
                case Comparison.OpenParentheses:
                    sOut = "(";
                    break;
                case Comparison.CloseParentheses:
                    sOut = ")";
                    break;
                case Comparison.In:
                    sOut = " IN ";
                    break;
                case Comparison.NotIn:
                    sOut = " NOT IN ";
                    break;
                case Comparison.StartsWith:
                    sOut = SqlComparison.LIKE;
                    break;
                case Comparison.EndsWith:
                    sOut = SqlComparison.LIKE;
                    break;
                default:
                    sOut = SqlComparison.EQUAL;
                    break;
            }
            return sOut;
        }
        #endregion
        /// <summary>
        /// Determines whether the specified <see cref="T:System.Object"/> is equal to the current <see cref="T:System.Object"/>.
        /// </summary>
        /// <param name="obj">The <see cref="T:System.Object"/> to compare with the current <see cref="T:System.Object"/>.</param>
        /// <returns>
        /// true if the specified <see cref="T:System.Object"/> is equal to the current <see cref="T:System.Object"/>; otherwise, false.
        /// </returns>
        /// <exception cref="T:System.NullReferenceException">The <paramref name="obj"/> parameter is null.</exception>
        [EditorBrowsable(EditorBrowsableState.Never)]
        public override bool Equals(object obj)
        {
            if (obj is Constraint)
            {
                Constraint compareTo = (Constraint)obj;
                return compareTo.ParameterName.Matches(this.parameterName) &&
                       compareTo.ParameterValue.Equals(this.ParameterValue);
            }
            return base.Equals(obj);
        }
        /// <summary>
        /// Serves as a hash function for a particular type.
        /// </summary>
        /// <returns>
        /// A hash code for the current <see cref="T:System.Object"/>.
        /// </returns>
        [EditorBrowsable(EditorBrowsableState.Never)]
        public override int GetHashCode()
        {
            return base.GetHashCode();
        }
     
      
    }
}// -----------------------------------------------------------------------
// <copyright file="Class1.cs" company="">
// TODO: Update copyright text.
// </copyright>
// -----------------------------------------------------------------------
namespace Cis.DbLight.External
{
    using System;
    using System.Collections;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text;
    using Cis.Infrastructure;
    using Cis.DbLight.TableMetadata;
    /// <summary>
    /// TODO: Update summary.
    /// </summary>
    public class ConstraintsGenerater : IConstraintsGenerater
    {
        public ConstraintsGenerater(ISqlDialect sqlDialect, Table table)
        {
            this.sqlDialect = sqlDialect;
            this.table = table;
        }
        public IColumn FindColumn(string columnName)
        {
            return table.GetColumn(columnName);
        }
        private ISqlDialect sqlDialect;
        private Table table;
        public string GenerateSql2(List<Constraint> constraints)
        {
            foreach (Constraint c in constraints)
            {
            }
            return null;
        }
        public string GenerateSql(List<Constraint> constraints)
        {
            return null;
        }
    }
    public interface IConstraintsGenerater
    {
        string GenerateSql(List<Constraint> constraints);
    }
}
namespace Cis.DbLight.External
{
    /// <summary>
    /// Where, And, Or
    /// </summary>
    public enum ConstraintType
    {
        /// <summary>
        /// WHERE operator
        /// </summary>
        Where,
        /// <summary>
        /// AND operator
        /// </summary>
        And,
        /// <summary>
        /// OR Operator
        /// </summary>
        Or
    }
}// -----------------------------------------------------------------------
// <copyright file="Class2.cs" company="">
// TODO: Update copyright text.
// </copyright>
// -----------------------------------------------------------------------
namespace Cis.DbLight.External
{
    using System;
    using System.Collections.Generic;
    using System.Collections.ObjectModel;
    using System.Linq;
    using System.Linq.Expressions;
    using System.Text;
    public abstract class ExpressionVisitor
    {
        protected ExpressionVisitor()
        {
        }
        protected virtual Expression Visit(Expression exp)
        {
            if (exp == null)
                return exp;
            switch (exp.NodeType)
            {
                case ExpressionType.Negate:
                case ExpressionType.NegateChecked:
                case ExpressionType.Not:
                case ExpressionType.Convert:
                case ExpressionType.ConvertChecked:
                case ExpressionType.ArrayLength:
                case ExpressionType.Quote:
                case ExpressionType.TypeAs:
                case ExpressionType.UnaryPlus:
                    return this.VisitUnary((UnaryExpression)exp);
                case ExpressionType.Add:
                case ExpressionType.AddChecked:
                case ExpressionType.Subtract:
                case ExpressionType.SubtractChecked:
                case ExpressionType.Multiply:
                case ExpressionType.MultiplyChecked:
                case ExpressionType.Divide:
                case ExpressionType.Modulo:
                case ExpressionType.And:
                case ExpressionType.AndAlso:
                case ExpressionType.Or:
                case ExpressionType.OrElse:
                case ExpressionType.LessThan:
                case ExpressionType.LessThanOrEqual:
                case ExpressionType.GreaterThan:
                case ExpressionType.GreaterThanOrEqual:
                case ExpressionType.Equal:
                case ExpressionType.NotEqual:
                case ExpressionType.Coalesce:
                case ExpressionType.ArrayIndex:
                case ExpressionType.RightShift:
                case ExpressionType.LeftShift:
                case ExpressionType.ExclusiveOr:
                case ExpressionType.Power:
                    return this.VisitBinary((BinaryExpression)exp);
                case ExpressionType.TypeIs:
                    return this.VisitTypeIs((TypeBinaryExpression)exp);
                case ExpressionType.Conditional:
                    return this.VisitConditional((ConditionalExpression)exp);
                case ExpressionType.Constant:
                    return this.VisitConstant((ConstantExpression)exp);
                case ExpressionType.Parameter:
                    return this.VisitParameter((ParameterExpression)exp);
                case ExpressionType.MemberAccess:
                    return this.VisitMemberAccess((MemberExpression)exp);
                case ExpressionType.Call:
                    return this.VisitMethodCall((MethodCallExpression)exp);
                case ExpressionType.Lambda:
                    return this.VisitLambda((LambdaExpression)exp);
                case ExpressionType.New:
                    return this.VisitNew((NewExpression)exp);
                case ExpressionType.NewArrayInit:
                case ExpressionType.NewArrayBounds:
                    return this.VisitNewArray((NewArrayExpression)exp);
                case ExpressionType.Invoke:
                    return this.VisitInvocation((InvocationExpression)exp);
                case ExpressionType.MemberInit:
                    return this.VisitMemberInit((MemberInitExpression)exp);
                case ExpressionType.ListInit:
                    return this.VisitListInit((ListInitExpression)exp);
                default:
                    return this.VisitUnknown(exp);
            }
        }
        protected virtual Expression VisitUnknown(Expression expression)
        {
            throw new Exception(string.Format("Unhandled expression type: '{0}'", expression.NodeType));
        }
        protected virtual MemberBinding VisitBinding(MemberBinding binding)
        {
            switch (binding.BindingType)
            {
                case MemberBindingType.Assignment:
                    return this.VisitMemberAssignment((MemberAssignment)binding);
                case MemberBindingType.MemberBinding:
                    return this.VisitMemberMemberBinding((MemberMemberBinding)binding);
                case MemberBindingType.ListBinding:
                    return this.VisitMemberListBinding((MemberListBinding)binding);
                default:
                    throw new Exception(string.Format("Unhandled binding type '{0}'", binding.BindingType));
            }
        }
        protected virtual ElementInit VisitElementInitializer(ElementInit initializer)
        {
            ReadOnlyCollection<Expression> arguments = this.VisitExpressionList(initializer.Arguments);
            if (arguments != initializer.Arguments)
            {
                return Expression.ElementInit(initializer.AddMethod, arguments);
            }
            return initializer;
        }
        protected virtual Expression VisitUnary(UnaryExpression u)
        {
            Expression operand = this.Visit(u.Operand);
            if (operand != u.Operand)
            {
                return Expression.MakeUnary(u.NodeType, operand, u.Type, u.Method);
            }
            return u;
        }
        protected static BinaryExpression ConvertVbCompareString(BinaryExpression b)
        {
            if (b.Left.NodeType == ExpressionType.Call)
            {
                var compareStringCall = (MethodCallExpression)b.Left;
                if ((compareStringCall.Method.DeclaringType.FullName == "Microsoft.VisualBasic.CompilerServices.Operators")
                    && (compareStringCall.Method.Name == "CompareString"))
                {
                    var arg1 = compareStringCall.Arguments[0];
                    var arg2 = compareStringCall.Arguments[1];
                    switch (b.NodeType)
                    {
                        case ExpressionType.LessThan:
                            return Expression.LessThan(arg1, arg2);
                        case ExpressionType.LessThanOrEqual:
                            return Expression.LessThanOrEqual(arg1, arg2);
                        case ExpressionType.GreaterThan:
                            return Expression.GreaterThan(arg1, arg2);
                        case ExpressionType.GreaterThanOrEqual:
                            return Expression.GreaterThanOrEqual(arg1, arg2);
                        default:
                            return Expression.Equal(arg1, arg2);
                    }
                }
            }
            return b;
        }
        protected virtual Expression VisitBinary(BinaryExpression b)
        {
            b = ConvertVbCompareString(b);
            Expression left = this.Visit(b.Left);
            Expression right = this.Visit(b.Right);
            Expression conversion = this.Visit(b.Conversion);
            if (left != b.Left || right != b.Right || conversion != b.Conversion)
            {
                if (b.NodeType == ExpressionType.Coalesce && b.Conversion != null)
                    return Expression.Coalesce(left, right, conversion as LambdaExpression);
                else
                    return Expression.MakeBinary(b.NodeType, left, right, b.IsLiftedToNull, b.Method);
            }
            return b;
        }
        protected virtual Expression VisitTypeIs(TypeBinaryExpression b)
        {
            Expression expr = this.Visit(b.Expression);
            if (expr != b.Expression)
            {
                return Expression.TypeIs(expr, b.TypeOperand);
            }
            return b;
        }
        protected virtual Expression VisitConstant(ConstantExpression c)
        {
            return c;
        }
        protected virtual Expression VisitConditional(ConditionalExpression c)
        {
            Expression test = this.Visit(c.Test);
            Expression ifTrue = this.Visit(c.IfTrue);
            Expression ifFalse = this.Visit(c.IfFalse);
            if (test != c.Test || ifTrue != c.IfTrue || ifFalse != c.IfFalse)
            {
                return Expression.Condition(test, ifTrue, ifFalse);
            }
            return c;
        }
        protected virtual Expression VisitParameter(ParameterExpression p)
        {
            return p;
        }
        protected virtual Expression VisitMemberAccess(MemberExpression m)
        {
            Expression exp = this.Visit(m.Expression);
            if (exp != m.Expression)
            {
                return Expression.MakeMemberAccess(exp, m.Member);
            }
            return m;
        }
        protected virtual Expression VisitMethodCall(MethodCallExpression m)
        {
            Expression obj = this.Visit(m.Object);
            IEnumerable<Expression> args = this.VisitExpressionList(m.Arguments);
            if (obj != m.Object || args != m.Arguments)
            {
                return Expression.Call(obj, m.Method, args);
            }
            return m;
        }
        protected virtual ReadOnlyCollection<Expression> VisitExpressionList(ReadOnlyCollection<Expression> original)
        {
            if (original != null)
            {
                List<Expression> list = null;
                for (int i = 0, n = original.Count; i < n; i++)
                {
                    Expression p = this.Visit(original[i]);
                    if (list != null)
                    {
                        list.Add(p);
                    }
                    else if (p != original[i])
                    {
                        list = new List<Expression>(n);
                        for (int j = 0; j < i; j++)
                        {
                            list.Add(original[j]);
                        }
                        list.Add(p);
                    }
                }
                if (list != null)
                {
                    return list.AsReadOnly();
                }
            }
            return original;
        }
        protected virtual MemberAssignment VisitMemberAssignment(MemberAssignment assignment)
        {
            Expression e = this.Visit(assignment.Expression);
            if (e != assignment.Expression)
            {
                return Expression.Bind(assignment.Member, e);
            }
            return assignment;
        }
        protected virtual MemberMemberBinding VisitMemberMemberBinding(MemberMemberBinding binding)
        {
            IEnumerable<MemberBinding> bindings = this.VisitBindingList(binding.Bindings);
            if (bindings != binding.Bindings)
            {
                return Expression.MemberBind(binding.Member, bindings);
            }
            return binding;
        }
        protected virtual MemberListBinding VisitMemberListBinding(MemberListBinding binding)
        {
            IEnumerable<ElementInit> initializers = this.VisitElementInitializerList(binding.Initializers);
            if (initializers != binding.Initializers)
            {
                return Expression.ListBind(binding.Member, initializers);
            }
            return binding;
        }
        protected virtual IEnumerable<MemberBinding> VisitBindingList(ReadOnlyCollection<MemberBinding> original)
        {
            List<MemberBinding> list = null;
            for (int i = 0, n = original.Count; i < n; i++)
            {
                MemberBinding b = this.VisitBinding(original[i]);
                if (list != null)
                {
                    list.Add(b);
                }
                else if (b != original[i])
                {
                    list = new List<MemberBinding>(n);
                    for (int j = 0; j < i; j++)
                    {
                        list.Add(original[j]);
                    }
                    list.Add(b);
                }
            }
            if (list != null)
                return list;
            return original;
        }
        protected virtual IEnumerable<ElementInit> VisitElementInitializerList(ReadOnlyCollection<ElementInit> original)
        {
            List<ElementInit> list = null;
            for (int i = 0, n = original.Count; i < n; i++)
            {
                ElementInit init = this.VisitElementInitializer(original[i]);
                if (list != null)
                {
                    list.Add(init);
                }
                else if (init != original[i])
                {
                    list = new List<ElementInit>(n);
                    for (int j = 0; j < i; j++)
                    {
                        list.Add(original[j]);
                    }
                    list.Add(init);
                }
            }
            if (list != null)
                return list;
            return original;
        }
        protected virtual Expression VisitLambda(LambdaExpression lambda)
        {
            Expression body = this.Visit(lambda.Body);
            if (body != lambda.Body)
            {
                return Expression.Lambda(lambda.Type, body, lambda.Parameters);
            }
            return lambda;
        }
        protected virtual NewExpression VisitNew(NewExpression nex)
        {
            IEnumerable<Expression> args = this.VisitExpressionList(nex.Arguments);
            if (args != nex.Arguments)
            {
                if (nex.Members != null)
                    return Expression.New(nex.Constructor, args, nex.Members);
                else
                    return Expression.New(nex.Constructor, args);
            }
            return nex;
        }
        protected virtual Expression VisitMemberInit(MemberInitExpression init)
        {
            NewExpression n = this.VisitNew(init.NewExpression);
            IEnumerable<MemberBinding> bindings = this.VisitBindingList(init.Bindings);
            if (n != init.NewExpression || bindings != init.Bindings)
            {
                return Expression.MemberInit(n, bindings);
            }
            return init;
        }
        protected virtual Expression VisitListInit(ListInitExpression init)
        {
            NewExpression n = this.VisitNew(init.NewExpression);
            IEnumerable<ElementInit> initializers = this.VisitElementInitializerList(init.Initializers);
            if (n != init.NewExpression || initializers != init.Initializers)
            {
                return Expression.ListInit(n, initializers);
            }
            return init;
        }
        protected virtual Expression VisitNewArray(NewArrayExpression na)
        {
            IEnumerable<Expression> exprs = this.VisitExpressionList(na.Expressions);
            if (exprs != na.Expressions)
            {
                if (na.NodeType == ExpressionType.NewArrayInit)
                {
                    return Expression.NewArrayInit(na.Type.GetElementType(), exprs);
                }
                else
                {
                    return Expression.NewArrayBounds(na.Type.GetElementType(), exprs);
                }
            }
            return na;
        }
        protected virtual Expression VisitInvocation(InvocationExpression iv)
        {
            IEnumerable<Expression> args = this.VisitExpressionList(iv.Arguments);
            Expression expr = this.Visit(iv.Expression);
            if (args != iv.Arguments || expr != iv.Expression)
            {
                return Expression.Invoke(expr, args);
            }
            return iv;
        }
    }
}
// -----------------------------------------------------------------------
// <copyright file="Class1.cs" company="">
// TODO: Update copyright text.
// </copyright>
// -----------------------------------------------------------------------
namespace Cis.DbLight.External
{
    using System.Data;
    using System.Text;
    /// <summary>
    /// Summary for the SqlComparison class
    /// </summary>
    public class SqlComparison
    {
        public const string BLANK = " ";
        public const string EQUAL = " = ";
        public const string GREATER = " > ";
        public const string GREATER_OR_EQUAL = " >= ";
        public const string IS = " IS ";
        public const string IS_NOT = " IS NOT ";
        public const string LESS = " < ";
        public const string LESS_OR_EQUAL = " <= ";
        public const string LIKE = " LIKE ";
        public const string NOT_EQUAL = " <> ";
        public const string NOT_LIKE = " NOT LIKE ";
    }
   
}
namespace Cis.DbLight.External
{
    using System;
    using System.Collections.Generic;
    using System.Data;
    using Cis.DbLight.TableMetadata;
    public class SqlQuery// : ISqlQuery
    {
      
        public List<Constraint> Constraints = new List<Constraint>();
        internal DbType GetConstraintDbType(string tableName, string Name, object constraintValue)
        {
            return DbType.String;
        }
        public string[] SelectColumnList = new string[0];
    }
}#region copyright
// <copyright file="ColumnAttributeMapper.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-17</datecreated>
#endregion
namespace Cis.DbLight.Mapper
{
    using System;
    using System.Collections.Generic;
    using System.Data;
    using System.Linq;
    using System.Reflection;
    using Cis.Infrastructure;
    using Cis.Infrastructure.Reflection;
    using Cis.Log;
    using Cis.DbLight.Extensions;
    using Cis.DbLight.TableMetadata;
    
    /// <summary>
    /// 通过类型上的ColumnMaperAttribute映射,对于复杂类型的属性通过MetaData#ItemName映射。
    /// </summary>
    /// <remarks>#指明映射时：属性名称作为列名，并且作为属性分隔符</remarks>
    public class ColumnAttributeMapper<T> : IRowMapper<T>
        where T :  new()
    {
        #region Fields
    //    private string sql;
    //public ColumnAttributeMapper(string sql)
    //{
    //    this.sql = sql;
    //}
        public ColumnAttributeMapper(TablesInfo tablesInfo)
        {
            this.TablesInfo = tablesInfo;
        }
        public ColumnAttributeMapper()
    {
       
    }
        //protected IDictionary<string, string> ColumnToProperty = new Dictionary<string, string>();
        protected List<IColumn>  Columns=new List<IColumn>();
        #endregion
        #region Public Methods and Operators
        public T MapRow(IDataRecord row)
        {
            var mappedObj = new T();
           
            if (this.Columns.Count == 0)
            {
                var tableColumns= this.InitTableMetadata(typeof(T));
                foreach (var col in row.GetColumns())
                {
                    if(col.Contains("#"))
                    {
                        var spl = col.Split('#').Where(s=>!string.IsNullOrEmpty(s)).ToList();
                        if(spl.Count==1)
                        {
                            //处理Item#列，列通过属性映射而不是attribute
                            Columns.Add(new Column() { ColumnName = col, PropertyName = spl.First(), IsComplex = false, IsAliasColumn = true });
                        }
                        else
                        {
                            //处理Item#Id列，列通过属性映射而不是attribute
                            Columns.Add(new Column() { ColumnName = col, PropertyName = col, IsComplex = true, IsAliasColumn = true });
                        }
                       
                    }
                    else
                    {
                        //通过attribute映射的不区分大小写。oracle中不区分。sqlserver？？是否区分
                        var cols= tableColumns.Where(c => c.ColumnName.ToUpperInvariant() == col.ToUpperInvariant()).ToList();
                        if(cols.Count!=0)
                        {
                            foreach (var tableCol in cols)
                            {
                                Columns.Add(tableCol);
                            }
                        }
                        else
                        {
#if DEBUG
                            throw new System.Exception(string.Format("ColumnAttributeMapper:列{0}在对象{1}中没有对应的属性", col, typeof(T)));
#endif
                            Logger.Log(Level.Trace, string.Format("ColumnAttributeMapper:列{0}在对象{1}中没有对应的属性", col, typeof(T)));
                                   
                        }
                        //var tableCol = tableColumns.FirstOrDefault(c => c.ColumnName.ToUpperInvariant() == col.ToUpperInvariant());
                        //if(tableCol==null)
                        //{
                        //    //表的元数据中没有定义列
                        //    Logger.Log(Level.Trace, string.Format("ColumnAttributeMapper:列{0}在对象{1}中没有对应的属性", col, typeof(T)));
                        //    //throw new ColumnMapException(col);
                        //}
                        //else
                        //{
                        //    Columns.Add(tableCol);
                        //}
                    }
                }
                
            }
            if (this.Columns.Count != 0)
            {
                foreach (var column in this.Columns)
                {
                    
                    object value;
                    if(column.IsComplex)
                    {
                        if (DbHelper.TryGetColumnValue(row, column.ColumnName, out value))
                        {
                            var propertyPath = column.PropertyName.Replace("#", ".");
                            Reflection.SetPropertyValueByPath(mappedObj, value, propertyPath);
                        }
                    }
                    else
                    {
                        if (DbHelper.TryGetColumnValue(row, column.ColumnName, out value))
                        {
                           
                            Reflection.SetPropertyValue(mappedObj, value, column.PropertyName);
                        }
                    }
                }
            }
            return mappedObj;
        }
        public TablesInfo TablesInfo { get; set; }
        #endregion
        #region Methods
        private List<IColumn> InitTableMetadata(Type type)
        {
            Table tableMetadate = TablesInfo.LoadTable(ColumnMapperStrategy.ColumnAttribute,type);
          
            return  tableMetadate.Columns;
         
        }
        #endregion
    }
}#region copyright
// <copyright file="DictionaryParameterMapper.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>????</author>
// <datecreated>2012-12-17</datecreated>
#endregion
namespace Cis.DbLight.Mapper
{
    using System;
    using System.Collections.Generic;
    using System.Data.Common;
    using System.Linq.Expressions;
    using Cis.Infrastructure;
    using Cis.Infrastructure.Extensions;
    using Cis.DbLight.Extensions;
    
    /// <summary>
    /// Dictionary???????
    /// </summary>
    public class DictionaryParameterMapper : IParameterMapper
    {
        public DictionaryParameterMapper(IDbTypeConverter dbTypeConverter)
        {
            this.dbTypeConverter = dbTypeConverter;
        }
        private IDbTypeConverter dbTypeConverter;
        public void AssignParameters(DbCommand command, object[] parameterValues)
        {
            IDictionary<string,object> names = parameterValues[0] as Dictionary<string,object>;
            dbTypeConverter.AddParams(command,names);
        }
        
    }
    
   
    //public class PrimitiveObjectParameterMapper : IParameterMapper
    //{
        
    //    public void AssignParameters(DbCommand command, object[] parameterValues)
    //    {
    //       Func<object> f=  (Func<object>)parameterValues[0];
    //       var property = f.ToExpression();
    //       string propertyName = property.GetPropertySymbol().Replace(".", ""); 
    //       object value = property.Compile()();
    //       IDictionary<string, object> names =new Dictionary<string, object>();
    //        names[propertyName] = value;
    //        command.AddParams(names);
    //    }
    //}
}#region copyright
// <copyright file="IParameterMapper.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>????</author>
// <datecreated>2012-12-20</datecreated>
#endregion
namespace Cis.DbLight.Mapper
{
    using System.Data.Common;
    /// <summary>
    /// ???????
    /// </summary>
    public interface IParameterMapper
    {
        //
        // Parameters:
        //   command:
        //
        //   parameterValues:
        void AssignParameters(DbCommand command, object[] parameterValues);
    }
}#region copyright
// <copyright file="IRowMapper.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-20</datecreated>
#endregion
namespace Cis.DbLight.Mapper
{
    using System;
    using System.Data;
    /// <summary>
   /// 将查询结果映射为对象
   /// </summary>
   /// <typeparam name="TResult"></typeparam>
    public interface IRowMapper<out TResult>
    {
        
        /// <summary>
        /// When implemented by a class, returns a new TResult based on row.
        /// </summary>
        /// <param name="row"> The System.Data.IDataRecord to map.</param>
        /// <returns>The instance of TResult that is based on row.</returns>
        TResult MapRow(IDataRecord row);
        /// <summary>
        /// 增加自定义转换，todo 复杂列（eee#bb）转换
        /// </summary>
        /// <param name="convert"></param>
        //void AddCustomConverter(Converter convert);
        /// <summary>
        /// 表信息，每个数据库一个
        /// </summary>
        TablesInfo TablesInfo { get; set; }
    }
    public class ColumnConverter
    {
        public string ColumnName { get; set; }
        public string PropertyPath { get; set; }
        /// <summary>
        /// 数据库值转换为对象值
        /// </summary>
        public Func<object> Convert { get; set; }
    }
}
using System;
using System.Collections.Generic;
using System.Data;
using System.IO;
using System.Linq;
using System.Text;
using Newtonsoft.Json;
using Cis.Log;
using Cis.DbLight.Extensions;
namespace Cis.DbLight.Mapper
{
    public class JsonMapper : IRowMapper<StringBuilder>
    {
        /// <summary>
        /// 需要映射的属性名称
        /// </summary>
        protected List<string> ObjProperties = new List<string>();
        public StringBuilder MapRow(IDataRecord row)
        {
            StringBuilder sb = new StringBuilder();
            StringWriter sw = new StringWriter(sb);
            
           
            using (JsonWriter writer = new JsonTextWriter(sw))
            {
                writer.WriteStartObject();
                foreach (var col in row.GetColumns())
                {
                    object value;
                    if (DbHelper.TryGetColumnValue(row, col, out value))
                    {
                        writer.WritePropertyName(col);
                        writer.WriteValue(value);
                    }
                }
               
                writer.WriteEndObject();
            }
            return sb;
        }
        public TablesInfo TablesInfo { get; set; }
    }
}
#region copyright
// <copyright file="PropertyAsColumnMapper.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-17</datecreated>
#endregion
namespace Cis.DbLight.Mapper
{
    using System.Collections.Generic;
    using System.Data;
    using System.Linq;
    using Cis.Infrastructure;
    using Cis.Infrastructure.Extensions;
    using Cis.Infrastructure.Reflection;
    using Cis.Log;
    using Cis.DbLight.Extensions;
    
    /// <summary>
    /// 属性名称做为列名映射
    /// </summary>
    /// <remarks>只支持基本类型属性</remarks>
    public class PropertyEqualColumnMapper<T> : IRowMapper<T>
        where T :  new()
    {
        #region Constructors and Destructors
        /// <summary>
        /// 需要映射的属性名称
        /// </summary>
        protected List<string> ObjProperties = new List<string>();
        /// <summary>
        /// 第一次通过反射读取，速度为自定义映射的2倍，300条记录为12毫秒，自定义为7毫秒左右
        /// </summary>
        public PropertyEqualColumnMapper()
        {
        }
        public TablesInfo TablesInfo { get; set; }
        public virtual T MapRow(IDataRecord row)
        {
            var mappedObj = new T();
            if (this.ObjProperties.Count == 0)
            {
                var propertys = typeof(T).GetPrimitivePropertys().Select(p => p.Name).ToList();
                foreach (var col in row.GetColumns())
                {
                    var tableCol = propertys.FirstOrDefault(p => p.ToUpperInvariant() == col.ToUpperInvariant());
                    if (tableCol == null)
                    {
#if DEBUG
                        throw new System.Exception(string.Format("PropertyEqualColumnMapper:列{0}在对象{1}中没有对应的属性", col, typeof(T)));
#endif
#pragma warning disable CS0162 // 检测到无法访问的代码
                        Logger.Log(Level.Trace, string.Format("PropertyEqualColumnMapper:列{0}在对象{1}中没有对应的属性", col, typeof(T)));
#pragma warning restore CS0162 // 检测到无法访问的代码
                    }
                    else
                    {
                        ObjProperties.Add(tableCol);
                    }
                }
            }
            if (this.ObjProperties.Count != 0)
            {
                foreach (string objProperty in this.ObjProperties)
                {
                    object value;
                    if (DbHelper.TryGetColumnValue(row, objProperty, out value))
                    {
                        Reflection.SetPropertyValue(mappedObj, value, objProperty);
                    }
                }
            }
            return mappedObj;
        }
        #endregion
    }
}// -----------------------------------------------------------------------
// <copyright file="DeletBuilder.cs" company="">
// TODO: Update copyright text.
// </copyright>
// -----------------------------------------------------------------------
namespace Cis.DbLight
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text;
    using Cis.Log;
    using Cis.DbLight.TableMetadata;
    /// <summary>
    /// TODO: Update summary.
    /// </summary>
    public class DeleteBuilder<TDomain> : QueryBuilderBase
    {
        #region Fields
       
        private const string deletSqlTemplate = "DELETE FROM {0} ";
        #endregion
        #region Constructors and Destructors
         public DeleteBuilder(Table table,ISqlDialect sqlDialect, IDictionary<string, object> dbParams = null)
         {
             SqlDialect = sqlDialect;
            this.Table = table;
            this.DbParams = dbParams ?? new Dictionary<string, object>();
            this.sql = new StringBuilder();
        }
        #endregion
        #region Public Properties
        public string TableAlias { get; set; }
     
        #endregion
        #region Public Methods and Operators
        protected override void Build()
        {
            var sb = new StringBuilder(string.Format(deletSqlTemplate, this.EncodeName(this.Table.TableName)));
            this.sql.Append(sb);
        }
        public string CreateSql()
        {
            var sb = new StringBuilder(string.Format(deletSqlTemplate, this.EncodeName(this.Table.TableName)));
            return sb.ToString();
        }
        #endregion
    }
}
// copyright file="InsertBuilder.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>Your Name</author>
// <datecreated>2014-12-08</datecreated>
using Cis.Log;
namespace Cis.DbLight
{
    using System.Collections.Generic;
    using System.Linq;
    using System.Text;
    using Cis.Infrastructure.Reflection;
    using Cis.DbLight.TableMetadata;
    /// <summary>
    /// TODO: 增加where。join
    /// where +join ==sqlbuiler 
    /// </summary>
    public class InsertBuilder<TDomain> : QueryBuilderBase
    {
     
        #region Fields
        private const string insertTemplate = "INSERT INTO {0} ({1}) \r\n VALUES ({2})";
        private IList<string> usedProperies;
        private TDomain domain;
        #endregion
        #region Constructors and Destructors
        public InsertBuilder(Table table,TDomain domain,ISqlDialect sqlDialect, IList<string> usedProperies=null, IDictionary<string, object> dbParams = null)
        {
            SqlDialect = sqlDialect;
            this.Table = table;
            this.domain = domain;
            this.usedProperies = usedProperies;
            this.DbParams = dbParams ?? new Dictionary<string, object>();
            this.sql = new StringBuilder();
        }
        #endregion
        #region Public Properties
    
      
        #endregion
        #region Public Methods and Operators
        
        protected override void Build()
        {
            List<IColumn> dbCol = this.Table.DbColumns;
            if (this.usedProperies != null && this.usedProperies.Count != 0)
            {
                dbCol = dbCol.Where(col => this.usedProperies.Contains(col.PropertyName) || col.IsPrimaryKey).ToList();
#if DEBUG
                if (usedProperies != null)
                {
                    var cols = dbCol.Where(col => !usedProperies.Contains(col.PropertyName)).ToList();
                    for (int i = 0; i < cols.Count; i++)
                    {
                        if (cols[i].IsAutoInsert || cols[i].IsSqlGenColumn)
                        {
                            cols.RemoveAt(i);
                        }
                    }
                   
                    string message = cols.Aggregate<IColumn, string>(null, (current, col) => current + (col.ColumnName + ","));
                    if (message != null)
                        throw new System.Exception("insert有不包含列的属性" + message);
                }
#endif
            }
            var sbKeys = new StringBuilder();
            var sbVals = new StringBuilder();
            foreach (IColumn col in dbCol)
            {
                if (col.IsAutoInsert)
                {
                    continue;
                }
                if (!col.IsSqlGenColumn)
                {
                    sbKeys.AppendFormat("{0},", EncodeName(col.ColumnName));
                    sbVals.AppendFormat(SqlDialect.DbParameterConstant + "{0},", col.ColumnName);
                    this.DbParams.Add(col.ColumnName, Reflection.GetPropertyValue(domain, col.PropertyName));
                }
                else
                {
                    sbKeys.AppendFormat("{0},", EncodeName(col.ColumnName));
                    sbVals.AppendFormat("{0},", col.GetSql());
                }
            }
            string keys = sbKeys.ToString().Substring(0, sbKeys.Length - 1);
            string vals = sbVals.ToString().Substring(0, sbVals.Length - 1);
            this.sql.Append(string.Format(insertTemplate, this.EncodeName(this.Table.TableName), keys, vals));
        }
        //public string CreateSql()
        //{
        //    List<IColumn> dbCol = this.Table.DbColumns;
        //    if (this.usedProperies != null && this.usedProperies.Count != 0)
        //    {
        //        dbCol = dbCol.Where(col => this.usedProperies.Contains(col.PropertyName) || col.IsPrimaryKey).ToList();
        //    }
        //    var sbKeys = new StringBuilder();
        //    var sbVals = new StringBuilder();
        //    int i = 0;
        //    foreach (IColumn col in dbCol)
        //    {
        //        if (col.IsAutoInsert)
        //        {
        //            continue;
        //        }
        //        if (!col.IsSqlGenColumn)
        //        {
        //            sbKeys.AppendFormat("{0},", EncodeName(col.ColumnName));
        //            sbVals.AppendFormat(SqlDialect.DbParameterConstant + "{0},", i);
        //            i++;
        //            //this.DbParams.Add(col.PropertyName, Reflection.GetPropertyValue(domain, col.PropertyName));
        //        }
        //        else
        //        {
        //            sbKeys.AppendFormat("{0},", EncodeName(col.ColumnName));
        //            sbVals.AppendFormat("{0},", col.GetSql());
        //        }
        //    }
        //    string keys = sbKeys.ToString().Substring(0, sbKeys.Length - 1);
        //    string vals = sbVals.ToString().Substring(0, sbVals.Length - 1);
        //    this.sql.Append(string.Format(insertTemplate, this.EncodeName(this.Table.TableName), keys, vals));
        //    return sql.ToString();
        //}
        public string CreateSql()
        {
            List<IColumn> dbCol = new List<IColumn>();
            if (this.usedProperies != null && this.usedProperies.Count != 0)
            {
                var allColumn = this.Table.DbColumns;
                var primaryCols = allColumn.FindAll(c => c.IsPrimaryKey);
                dbCol.AddRange(primaryCols);
                foreach (var usedPropery in this.usedProperies)
                {
                    var col = allColumn.Find(c => c.PropertyName == usedPropery && !c.IsPrimaryKey);
                    if (col != null)
                    {
                        dbCol.Add(col);
                    }
                }
                //dbCol = dbCol.Where(col => this.usedProperies.Contains(col.PropertyName) || col.IsPrimaryKey).ToList();
            }
            var sbKeys = new StringBuilder();
            var sbVals = new StringBuilder();
            int i = 0;
            foreach (IColumn col in dbCol)
            {
                if (col.IsAutoInsert)
                {
                    continue;
                }
                if (!col.IsSqlGenColumn)
                {
                    sbKeys.AppendFormat("{0},", EncodeName(col.ColumnName));
                    sbVals.AppendFormat(SqlDialect.DbParameterConstant + "{0},", i);
                    i++;
                    //this.DbParams.Add(col.PropertyName, Reflection.GetPropertyValue(domain, col.PropertyName));
                }
                else
                {
                    sbKeys.AppendFormat("{0},", EncodeName(col.ColumnName));
                    sbVals.AppendFormat("{0},", col.GetSql());
                }
            }
            string keys = sbKeys.ToString().Substring(0, sbKeys.Length - 1);
            string vals = sbVals.ToString().Substring(0, sbVals.Length - 1);
            this.sql.Append(string.Format(insertTemplate, this.EncodeName(this.Table.TableName), keys, vals));
            return sql.ToString();
        }
        #endregion
    }
}namespace Cis.DbLight
{
    using System.Collections.Generic;
    using System.Text;
    public abstract class QueryBuilderBase
    {
        #region Fields
        protected StringBuilder sql;
        #endregion
        #region Public Properties
        public ISqlDialect SqlDialect { get; set; }
        public IDictionary<string, object> DbParams { get; protected set; }
        public SqlBuilder SqlBuilder { get; set; }
        public Table Table { get; set; }
        #endregion
        #region Public Methods and Operators
        public string EncodeName(string name)
        {
            return SqlDialect.EncodeName(name);
        }
        public string GetSql()
        {
            this.Build();
            if (this.SqlBuilder != null)
            {
                this.sql.Append(this.SqlBuilder.ToSql());
                foreach (var dbParam in this.SqlBuilder.DbParams)
                {
                    this.DbParams.Add(dbParam);
                }
            }
            return this.sql.ToString();
        }
        #endregion
        #region Methods
        protected abstract void Build();
        #endregion
    }
}// -----------------------------------------------------------------------
// <copyright file="SelectBuilder.cs" company="">
// TODO: Update copyright text.
// </copyright>
// -----------------------------------------------------------------------
using System.Diagnostics.CodeAnalysis;
namespace Cis.DbLight
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text;
    using Cis.Infrastructure.Reflection;
    using Cis.Log;
    using Cis.DbLight.Mapper;
    using Cis.DbLight.TableMetadata;
    /// <summary>
    /// TODO: Update summary.
    /// </summary>
    /// <typeparam name="TDomain"> 可以映射到数据库表的实体类 </typeparam>
    public class SelectBuilder<TDomain> : QueryBuilderBase
    {
        #region Fields
        private string selectTemplate = "select {0} from {1} ";
        #endregion
        #region Constructors and Destructors
        public SelectBuilder(Table table, ISqlDialect sqlDialect, IList<string> usedProperies = null, IDictionary<string, object> dbParams = null)
        {
            this.SqlDialect = sqlDialect;
            this.usedProperies = usedProperies;
            this.Table = table;
            this.DbParams = dbParams ?? new Dictionary<string, object>();
            this.sql = new StringBuilder();
        }
        #endregion
        #region Public Properties
        public string TableAlias { get; set; }
        private IList<string> usedProperies;
        #endregion
        #region Public Methods and Operators
        protected override void Build()
        {
            List<IColumn> dbCol = Table.DbColumns;
            string colNames = " ";
            if (usedProperies != null && usedProperies.Count != 0)
            {
                dbCol = dbCol.Where(col => usedProperies.Contains(col.PropertyName)).ToList();
                //#if DEBUG
                //                if (usedProperies != null)
                //                {
                //                    var cols = dbCol.Where(col => !usedProperies.Contains(col.PropertyName)).ToList();
                //                    string message = cols.Aggregate<IColumn, string>(null, (current, col) => current + (col.ColumnName + ","));
                //                    if (message != null)
                //                        throw new System.Exception("insert有不包含列的属性");
                //                }
                //#endif
                //Logger.Log(Level.Debug,()=>
                //    { 
                //        var cols = dbCol.Where(col => !usedProperies.Contains(col.PropertyName)).ToList();
                //        string message = cols.Aggregate<IColumn, string>(null, (current, col) => current + (col.ColumnName + ","));
                //        if (message != null)
                //            return "数据库不存在列：" + message;
                //        else
                //        {
                //            return message;
                //        }
                //    });
                if (dbCol.Count != 0)
                {
                    colNames = dbCol.Aggregate(colNames, (current, column) => current + (EncodeName(column.ColumnName) + ","));
                    colNames = colNames.Remove(colNames.Length - 1);
                }
                else
                {
                    colNames = "*";
                }
            }
            var sb = new StringBuilder(string.Format(this.selectTemplate, colNames, this.EncodeName(this.Table.TableName)));
            this.sql.Append(sb);
        }
        public string CreateSql()
        {
            List<IColumn> dbCol = Table.DbColumns;
            string colNames = " ";
            if (usedProperies != null && usedProperies.Count != 0)
            {
                dbCol = dbCol.Where(col => usedProperies.Contains(col.PropertyName)).ToList();
                //#if DEBUG
                //                if (usedProperies != null)
                //                {
                //                    var cols = dbCol.Where(col => !usedProperies.Contains(col.PropertyName)).ToList();
                //                    string message = cols.Aggregate<IColumn, string>(null, (current, col) => current + (col.ColumnName + ","));
                //                    if (message != null)
                //                        throw new System.Exception("insert有不包含列的属性");
                //                }
                //#endif
                //Logger.Log(Level.Debug,()=>
                //    { 
                //        var cols = dbCol.Where(col => !usedProperies.Contains(col.PropertyName)).ToList();
                //        string message = cols.Aggregate<IColumn, string>(null, (current, col) => current + (col.ColumnName + ","));
                //        if (message != null)
                //            return "数据库不存在列：" + message;
                //        else
                //        {
                //            return message;
                //        }
                //    });
                if (dbCol.Count != 0)
                {
                    colNames = dbCol.Aggregate(colNames, (current, column) => current + (EncodeName(column.ColumnName) + ","));
                    colNames = colNames.Remove(colNames.Length - 1);
                }
                else
                {
                    colNames = "*";
                }
            }
            var sb = new StringBuilder(string.Format(this.selectTemplate, colNames, this.EncodeName(this.Table.TableName)));
            sb.Append(" WHERE ");
            return sb.ToString();
        }
        #endregion
    }
}
// -----------------------------------------------------------------------
// <copyright file="UpdataBuilder.cs" company="">
// TODO: Update copyright text.
// </copyright>
// -----------------------------------------------------------------------
using EnsureThat;
namespace Cis.DbLight
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text;
    
    using Cis.Infrastructure.Reflection;
    using Cis.DbLight.TableMetadata;
    public class UpdateBuilder<TDomain> : QueryBuilderBase
    {
       
        #region Fields
       
        private string updateTemplate = "UPDATE {0} SET {1} WHERE {2} ";
        private TDomain domain;
        #endregion
        #region Constructors and Destructors
        public UpdateBuilder(Table table,ISqlDialect sqlDialect, TDomain domain,IList<string> usedProperies=null, IDictionary<string, object> dbParams = null)
        {
            SqlDialect = sqlDialect;
            this.domain = domain;
            this.usedProperies = usedProperies;
            this.Table = table;
            this.DbParams = dbParams ?? new Dictionary<string, object>();
            this.sql = new StringBuilder();
        }
        #endregion
        #region Public Properties
        public string TableAlias { get; set; }
      
        private IList<string> usedProperies;
        #endregion
        #region Public Methods and Operators
        protected override void Build()
        {
         
            List<IColumn> dbCol = Table.DbColumns;
            if (usedProperies!=null&&usedProperies.Count != 0)
            {
                dbCol = dbCol.Where(col => usedProperies.Contains(col.PropertyName) || col.IsPrimaryKey).ToList();
#if DEBUG
                if (usedProperies != null)
                {
                    var cols = dbCol.Where(col => !usedProperies.Contains(col.PropertyName)).ToList();
                    for (int i = 0; i < cols.Count; i++)
                    {
                        if (cols[i].IsAutoInsert || cols[i].IsSqlGenColumn)
                        {
                            cols.RemoveAt(i);
                        }
                    }
                    string message = cols.Aggregate<IColumn, string>(null, (current, col) => current + (col.ColumnName + ","));
                    if (message != null)
                        throw new System.Exception("insert有不包含列的属性" + message);
                }
#endif
            }
            var sbKeys = new StringBuilder();
            var sbWhere = new StringBuilder();
            Ensure.That(dbCol.Exists(col => col.IsPrimaryKey), "Entity must contain a primary key").IsTrue();
            foreach (IColumn col in dbCol)
            {
                if (!col.IsPrimaryKey)
                {
                    sbKeys.AppendFormat("{0} = {1}{2}, \r\n", EncodeName(col.ColumnName), SqlDialect.DbParameterConstant, col.PropertyName);
                    DbParams.Add(col.PropertyName, Reflection.GetPropertyValue(domain, col.PropertyName));
                }
                else
                {
                    sbWhere.AppendFormat(" {0} = {1}{2} \r\n and", EncodeName(col.ColumnName), SqlDialect.DbParameterConstant, col.PropertyName);
                    DbParams.Add(col.PropertyName, Reflection.GetPropertyValue(domain, col.PropertyName));
                }
            }
            string keys = sbKeys.ToString().Substring(0, sbKeys.Length - 4); //去掉, \r\n
            string where = sbWhere.ToString().Substring(0, sbWhere.Length - 4);
            string tsql = string.Format(this.updateTemplate, this.EncodeName(this.Table.TableName), keys, where);
            this.sql.Append(tsql);
        }
        public string CreateSql()
        {
            List<IColumn> dbCol = new List<IColumn>();
            if (this.usedProperies != null && this.usedProperies.Count != 0)
            {
                var allColumn = this.Table.DbColumns;
                foreach (var usedPropery in this.usedProperies)
                {
                    var col = allColumn.Find(c => c.PropertyName == usedPropery);
                    if (col != null)
                    {
                        dbCol.Add(col);
                    }
                }
             
            }
          
            var sbKeys = new StringBuilder();
            int i = 0;
           // Ensure.That(dbCol.Exists(col => col.IsPrimaryKey), "Entity must contain a primary key").IsTrue();
            foreach (IColumn col in dbCol)
            {
                sbKeys.AppendFormat("{0} = {1}{2}, \r\n", EncodeName(col.ColumnName), SqlDialect.DbParameterConstant, i);
                i++;
            }
            string keys = sbKeys.ToString().Substring(0, sbKeys.Length - 4); //去掉, \r\n
            string tsql = string.Format(this.updateTemplate, this.EncodeName(this.Table.TableName), keys, "");
            return tsql;
        }
       
        #endregion
    }
}
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data;
using System.Data.Common;
using System.Linq;
using System.Text;
using Cis.Log;
using Cis.DbLight.Mapper;
using Oracle.ManagedDataAccess.Client;
namespace Cis.DbLight.Oracle
{
    public class BatchOracleHelper
    {
        private readonly DbProviderFactory _database;
        private OracleQuerySession qs;
        public BatchOracleHelper(IQuerySession querySession)
        {
            qs = (OracleQuerySession)querySession;
            _database = qs.DbProviderFactory;
        }
        public DbProviderFactory OracleDatabase
        {
            get { return _database; }
        }
        private OracleParameter GetOracleParameter2(KeyValuePair<int, object[]> pair)
        {
            var dbType = GetOracleDbType(pair.Value);
            OracleParameter parameter = new OracleParameter(string.Format("{0}", pair.Key), dbType);
            parameter.Direction = ParameterDirection.Input;
            parameter.OracleDbTypeEx = dbType;
            parameter.Value = GetBatchParamValues(pair.Value);
            return parameter;
        }
        private OracleParameter GetOracleParameter(KeyValuePair<int, object[]> pair)
        {
            OracleParameter parameter = new OracleParameter();
            parameter.ParameterName = string.Format("{0}", pair.Key);
            Type type = pair.Value[0].GetType();
            parameter.OracleDbTypeEx = GetOracleDbType(pair.Value);
            parameter.Value = GetValue(pair.Value, type);
            return parameter;
        }
        private object[] GetValue(object[] arry, Type type)
        {
            if (type.IsEnum)
            {
                object[] result = new object[arry.Length];
                for (int i = 0; i < arry.Length; i++)
                {
                    result[i] = (char)(int)arry[i];
                }
                return result;
            }
            else if (type == typeof(bool))
            {
                object[] result = new object[arry.Length];
                for (int i = 0; i < arry.Length; i++)
                {
                    bool v = (bool)arry[i];
                    if (v)
                        result[i] = "1";
                    else
                        result[i] = "0";
                }
                return result;
            }
            return arry;
        }
        private object[] GetBatchParamValues(object[] arry)
        {
            object value = new object();
            foreach (var o in arry)
            {
                if (o != null)
                {
                    value = o;
                    break;
                }
            }
            var type = value.GetType();
            if (type.IsEnum)
            {
                object[] result = new object[arry.Length];
                for (int i = 0; i < arry.Length; i++)
                {
                    // result[i] = (char)(int)arry[i];
                    result[i] = Convert.ToString((int)arry[i], 16);
                }
                return result;
            }
            else if (type == typeof(bool))
            {
                object[] result = new object[arry.Length];
                for (int i = 0; i < arry.Length; i++)
                {
                    bool v = (bool)arry[i];
                    if (v)
                        result[i] = "1";
                    else
                        result[i] = "0";
                }
                return result;
            }
            return arry;
        }
        /// <summary>
        /// 批量插入或者批量更新大数据
        /// </summary>
        /// <param name="insertOrUpdateSql">插入或者更新的sql语句</param>
        /// <param name="columnRowData">插入或者更新的参数对应的value的值</param>
        /// <returns></returns>
        public int BatchInsertOrUpdate(string insertOrUpdateSql, Dictionary<int, object[]> columnRowData)
        {
            var iResult = 0;
            if (columnRowData.Count > 0)
            {
                //columnRowData = ConvertNullValues(columnRowData);
                using (var cmd = this.GetOracleCommand(insertOrUpdateSql))
                {
                    // 绑定批处理的行数
                    cmd.ArrayBindCount = columnRowData.Values.First().Length; // 很重要
                    cmd.BindByName = true;
                    cmd.CommandType = CommandType.Text;
                    cmd.CommandText = insertOrUpdateSql;
                    cmd.CommandTimeout = 600; // 10分钟
                    foreach (var objectse in columnRowData)
                    {
                        cmd.Parameters.Add(GetOracleParameter2(objectse));
                    }
                    // 执行批处理
                    if (null != Transaction.Current)
                    {
                        cmd.Connection = Transaction.Current.DbTransactionWrapper.DbTransaction.Connection as OracleConnection;
                        cmd.Transaction = Transaction.Current.DbTransactionWrapper.DbTransaction as OracleTransaction;
                        iResult = cmd.ExecuteNonQuery();
                    }
                    else
                    {
                        using (var conn = qs.OpenConnection())
                        {
                            cmd.Connection = conn;
                            iResult = cmd.ExecuteNonQuery();
                        }
                    }
#if DEBUG
					LogOperateDone(cmd);
#endif
                    WriteLog(Level.Debug, cmd);
                    return iResult;
                }
            }
            return iResult;
        }
        /// <summary>
        /// 查询
        /// </summary>
        /// <param name="sql"></param>
        /// <param name="columnRowData"></param>
        /// <returns></returns>
        public List<TResult> Query<TResult>(string sql, Dictionary<int, object[]> columnRowData, Mapper.IRowMapper<TResult> rowMapper)
        {
            // var iResult = 0;
            List<TResult> data = new List<TResult>();
            rowMapper.TablesInfo = qs.DatabaseInfo.TablesInfo;
            if (columnRowData.Count > 0)
            {
                //columnRowData = ConvertNullValues(columnRowData);
                using (var cmd = this.GetOracleCommand(sql))
                {
                    // 绑定批处理的行数
                    cmd.ArrayBindCount = columnRowData.Values.First().Length; // 很重要
                    cmd.BindByName = true;
                    cmd.CommandType = CommandType.Text;
                    cmd.CommandText = sql;
                    cmd.CommandTimeout = 600; // 10分钟
                    foreach (var objectse in columnRowData)
                    {
                        cmd.Parameters.Add(GetOracleParameter2(objectse));
                    }
                    // 执行批处理
                    if (null != Transaction.Current)
                    {
                        cmd.Connection = Transaction.Current.DbTransactionWrapper.DbTransaction.Connection as OracleConnection;
                        cmd.Transaction = Transaction.Current.DbTransactionWrapper.DbTransaction as OracleTransaction;
                        using (var reader = cmd.ExecuteReader())
                        {
                            //
                            reader.FetchSize = reader.RowSize * 2000;
                            if (reader.HasRows)
                            {
                                var r = reader.Cast<IDataRecord>();
                                foreach (var dataRecord in r)
                                {
                                    var t = rowMapper.MapRow(dataRecord);
                                    data.Add(t);
                                }
                            }
                        }
                    }
                    else
                    {
                        using (var conn = qs.OpenConnection())
                        {
                            cmd.Connection = conn;
                            using (var reader = cmd.ExecuteReader())
                            {
                                if (reader.HasRows)
                                {
                                    var r = reader.Cast<IDataRecord>();
                                    foreach (var dataRecord in r)
                                    {
                                        var t = rowMapper.MapRow(dataRecord);
                                        data.Add(t);
                                    }
                                }
                            }
                        }
                    }
#if DEBUG
					LogOperateDone(cmd);
#endif
                    WriteLog(Level.Debug, cmd);
                    return data;
                }
            }
            return data;
        }
        /// <summary>
        /// 记录odp.net 执行的操作的第一行数据
        /// </summary>
        /// <param name="cmd"></param>
        private void LogOperateDone(OracleCommand cmd)
        {
            var sb = new StringBuilder(cmd.CommandText);
            for (int i = 0; i < cmd.Parameters.Count; i++)
            {
                var objects = cmd.Parameters[i].Value as object[];
                if (objects != null)
                {
                    var firstOrDefault = objects.FirstOrDefault();
                    if (firstOrDefault != null)
                        sb.Replace(":" + i + "", string.Format("'{0}'", firstOrDefault.ToString()));
                }
            }
            Log.Logger.Log(Level.Debug, " 批量执行“" + ((object[])(cmd.Parameters[0].Value)).Count() + "”条，行①:  " + sb.ToString());
        }
        /// <summary>
        /// 级别为Dug 时，记录批量处理的日志
        /// </summary>
        /// <param name="logLevel"></param>
        /// <param name="cmd"></param>
        private void WriteLog(Level logLevel, OracleCommand cmd)
        {
            if (logLevel == Level.Debug)
            {
                WriteLog(cmd);
            }
        }
        /// <summary>
        /// 记录日志
        /// </summary>
        /// <param name="cmd"></param>
        private void WriteLog(OracleCommand cmd)
        {
            if (cmd.Parameters != null && cmd.Parameters.Count > 0)
            {
                var builder = new StringBuilder();
                var rowsCount = (cmd.Parameters[0].Value as object[]).Length;
                var columnsCount = cmd.Parameters.Count;
                for (var rowIndex = 0; rowIndex < rowsCount; rowIndex++)
                {
                    var cmdText = cmd.CommandText;
                    for (var columnIndex = 0; columnIndex < columnsCount; columnIndex++)
                    {
                        var value = cmd.Parameters[columnIndex].Value as object[];
                        if (value != null)
                        {
                            cmdText = cmdText.Replace(string.Format(":{0}", columnIndex), ConvertDbValue(cmd.Parameters[columnIndex].OracleDbTypeEx, value[rowIndex]));
                        }
                    }
                    builder.AppendFormat("{0};\r\n", cmdText);
                }
                Logger.Log(Level.Debug, " 批量执行“" + cmd.ArrayBindCount + "”条，行:\r\n Sql语句如下：\r\n" + builder);
            }
        }
        /// <summary>
        /// 转变常用的DbType
        /// </summary>
        /// <param name="oracleDbType"></param>
        /// <param name="value"></param>
        /// <returns></returns>
        private string ConvertDbValue(OracleDbType oracleDbType, object value)
        {
            switch (oracleDbType)
            {
                case OracleDbType.Varchar2:
                case OracleDbType.NVarchar2:
                case OracleDbType.Char:
                case OracleDbType.NChar:
                    value = string.Format("'{0}'", value);
                    break;
                case OracleDbType.Date:
                case OracleDbType.TimeStamp:
                    value = string.Format("to_date('{0}','yyyy-MM-dd HH24:mi:ss') ", value);
                    break;
                case OracleDbType.Int16:
                case OracleDbType.Int32:
                case OracleDbType.Int64:
                case OracleDbType.Decimal:
                    break;
                default:
                    value = string.Format("'{0}'", value);
                    break;
            }
            return value?.ToString() ?? string.Empty;
        }
        //   public OracleDataReader ExecuteReader(string commandText, IDictionary<int, object> dbParameters)
        //   {
        //       using (var cmd = this.GetOracleCommand(commandText))
        //       {
        //           cmd.BindByName = true;
        //           cmd.CommandText = commandText;
        //           cmd.CommandType = CommandType.Text;
        //           if (dbParameters != null && dbParameters.Keys.Count > 0)
        //           {
        //               foreach (var key in dbParameters.Keys)
        //               {
        //                   var dbType = GetOracleDbType(dbParameters[key]);
        //                   using (var oraParam = new OracleParameter(string.Format("{0}", key), dbType))
        //                   {
        //                       oraParam.Direction = ParameterDirection.Input;
        //                       oraParam.OracleDbTypeEx = dbType;
        //                       oraParam.Value = dbParameters[key];
        //                       cmd.Parameters.Add(oraParam);
        //                   }
        //               }
        //           }
        //           if (null != Transaction.Current)
        //           {
        //               cmd.Connection = Transaction.Current.DbTransactionWrapper.DbTransaction.Connection as OracleConnection;
        //               return cmd.ExecuteReader();
        //           }
        //           else
        //           {
        //using (var conn = qs.OpenConnection())
        //{
        //	cmd.Connection = conn;
        //	return cmd.ExecuteReader();
        //}
        //           }
        //       }
        //   }
        /// <summary>
        /// 根据数据类型获取OracleDbType
        /// </summary>
        /// <param name="value"></param>
        /// <returns></returns>
        private static OracleDbType GetOracleDbType(object value)
        {
            OracleDbType dataType = OracleDbType.Varchar2;
            Type type = value.GetType();
            if (type.IsEnum)
            {
                return OracleDbType.Char;
            }
            if (value is string)
            {
                dataType = OracleDbType.Varchar2;
                if (value.ToString().Length > 2000)
                {
                    dataType = OracleDbType.Clob;
                }
            }
            else if (value is DateTime)
            {
                dataType = OracleDbType.TimeStamp;
            }
            else if (value is int || value is short)
            {
                dataType = OracleDbType.Int32;
            }
            else if (value is long)
            {
                dataType = OracleDbType.Int64;
            }
            else if (value is decimal || value is double || value is float)
            {
                dataType = OracleDbType.Decimal;
            }
            else if (value is Guid)
            {
                dataType = OracleDbType.Varchar2;
            }
            else if (value is bool)
            {
                dataType = OracleDbType.Byte;
            }
            else if (value is byte || value is byte[])
            {
                dataType = OracleDbType.Clob;
            }
            else if (value is char)
            {
                dataType = OracleDbType.Char;
            }
            return dataType;
        }
        private static OracleDbType GetOracleDbType(object[] values)
        {
            object value = new object();
            foreach (var o in values)
            {
                if (o != null)
                {
                    value = o;
                    break;
                }
            }
            if (value is string)
            {
                int temp = value.ToString().Length;
                foreach (var item in values)
                {
                    if (item.ToString().Length > temp)
                    {
                        value = item;
                        temp = value.ToString().Length;
                    }
                }
            }
            return GetOracleDbType(value);
        }
        private OracleCommand GetOracleCommand(string sql)
        {
            var oraclCommand = new OracleConnection(qs.ConnectionString).CreateCommand();
            oraclCommand.CommandText = sql;
            oraclCommand.BindByName = true;
            return oraclCommand;
        }
    }
}
using System;
namespace Cis.DbLight.Oracle
{
    public class Class1
    {
    }
}
using Cis.Infrastructure;
using Cis.Log;
using Oracle.ManagedDataAccess.Client;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Linq.Expressions;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
namespace Cis.DbLight.Oracle
{
    public class DbTool
    {
        public static OracleDbType GetOracleDbType(object value)
        {
            var dataType = OracleDbType.NVarchar2;
            if (value is Enum)
            {
                dataType = OracleDbType.Char;
            }
            else if (value is string)
            {
                dataType = OracleDbType.Varchar2;
                if (value.ToString().Length > 2000)
                {
                    dataType = OracleDbType.Clob;
                }
            }
            else if (value is DateTime)
            {
                dataType = OracleDbType.TimeStamp;
            }
            else if (value is int || value is short)
            {
                dataType = OracleDbType.Int32;
            }
            else if (value is long)
            {
                dataType = OracleDbType.Int64;
            }
            else if (value is decimal || value is double || value is float)
            {
                dataType = OracleDbType.Decimal;
            }
            else if (value is Guid)
            {
                dataType = OracleDbType.Varchar2;
            }
            else if (value is bool)
            {
                dataType = OracleDbType.Byte;
            }
            else if (value is byte || value is byte[])
            {
                dataType = OracleDbType.Clob;
            }
            else if (value is char)
            {
                dataType = OracleDbType.Char;
            }
            return dataType;
        }
        public static OracleDbType GetOracleDbType(object[] values)
        {
            object value = new object();
            foreach (var o in values)
            {
                if (o != null)
                {
                    value = o;
                    break;
                }
            }
            return GetOracleDbType(value);
        }
        public static List<string> GetColumns(IDataRecord record)
        {
            List<string> columnNames = new List<string>();
            for (int i = 0; i < record.FieldCount; i++)
            {
                //.ToUpper()可忽略大小写转换
                columnNames.Add(record.GetName(i).ToUpper());
            }
            return columnNames;
        }
        public static string ToDbString(object obj, Func<object, string> customConverter = null)
        {
            if (obj == null)
                return "NULL";
            Type type = obj.GetType();
            if (type == typeof(string))
            {
                string s = obj as string;
                return String.Format("'{0}'", s.Replace("'", "''"));
            }
            if (type == typeof(DateTime))
            {
                DateTime d = (DateTime)obj;
                return String.Format("to_date('{0}', 'dd/mm/yyyy hh24:mi')", d.ToString("dd/MM/yyyy HH:mm"));
            }
            if (type == typeof(bool))
            {
                bool v = (bool)obj;
                if (v) return "1";
                else return "0";
            }
            if (type == typeof(byte[]))
            {
                return Encoding.Default.GetString(obj as byte[]);
            }
            //
            if (type.IsEnum)
            {
                return Convert.ToInt32(obj).ToString();
            }
            return obj.ToString();
        }
        public static string GetLogSql(string sql, OracleParameterCollection parameters)
        {
            foreach (OracleParameter kv in parameters)
            {
                string regexKey = string.Format(@"{0}{1}(?=[\)\, ]?)", ":", kv.ParameterName);
                string part = ToDbString(kv.Value);
                sql = Regex.Replace(sql, regexKey, part);
            }
            return sql;
        }
        /// <summary>
        /// 处理空值 只处理string与日期。其他必须有调用方传入
        /// TODO 空值插入dbnull
        /// </summary>
        /// <param name="type"></param>
        /// <returns></returns>
        public static object GetDefaultValue(Type type)
        {
            if (type == typeof(string))
            {
                return "";
            }
            if (type == typeof(DateTime?))
            {
                return DateTime.Now;
            }
            if (type == typeof(int?) || type == typeof(decimal?) || type == typeof(long?) || type == typeof(float?))
            {
                return 0;
            }
            throw new ArgumentException("批量操作遇到不能处理的空值");
        }
        /// <summary>
        /// 记录odp.net 执行的操作的第一行数据
        /// </summary>
        /// <param name="cmd"></param>
        public static void LogOperateDone(OracleCommand cmd)
        {
            if (cmd.ArrayBindCount > 0)
            {
                var sb = new StringBuilder(cmd.CommandText);
                for (int i = 0; i < cmd.Parameters.Count; i++)
                {
                    var objects = cmd.Parameters[i].Value;
                    var pName = cmd.Parameters[i].ParameterName;
                    if (objects != null)
                    {
                        if (objects.GetType().IsArray)
                        {
                            var tempArr = objects as object[];
                            sb.Replace(":" + pName + "", string.Format("'{0}'", tempArr[0].ToString()));
                        }
                        else
                        {
                            sb.Replace(":" + pName + "", string.Format("'{0}'", objects.ToString()));
                        }
                    }
                }
                Log.Logger.Log(Level.Debug, " 批量执行“" + ((object[])(cmd.Parameters[0].Value)).Count() + "”条，行①:  " + sb.ToString());
            }
        }
        /// <summary>
        /// 级别为Dug 时，记录批量处理的日志
        /// </summary>
        /// <param name="logLevel"></param>
        /// <param name="cmd"></param>
        public static void WriteLog(Level logLevel, OracleCommand cmd)
        {
            if (logLevel == Level.Debug)
            {
                WriteLog(cmd);
            }
        }
        /// <summary>
        /// 记录日志
        /// </summary>
        /// <param name="cmd"></param>
        public static void WriteLog(OracleCommand cmd)
        {
            if (cmd.Parameters != null && cmd.Parameters.Count > 0)
            {
                var builder = new StringBuilder();
                var rowsCount = cmd.ArrayBindCount;
                var columnsCount = cmd.Parameters.Count;
                for (var rowIndex = 0; rowIndex < rowsCount; rowIndex++)
                {
                    var cmdText = cmd.CommandText;
                    for (var columnIndex = 0; columnIndex < columnsCount; columnIndex++)
                    {
                        var value = cmd.Parameters[columnIndex].Value;
                        if (value != null)
                        {
                            if (value.GetType().IsArray)
                            {
                                var tempArr = value as object[];
                                cmdText = cmdText.Replace(string.Format(":{0}", cmd.Parameters[columnIndex].ParameterName), ConvertDbValue(cmd.Parameters[columnIndex].OracleDbTypeEx, tempArr[rowIndex]));
                            }
                            else
                            {
                                cmdText = cmdText.Replace(string.Format(":{0}", cmd.Parameters[columnIndex].ParameterName), ConvertDbValue(cmd.Parameters[columnIndex].OracleDbTypeEx, value));
                            }
                        }
                    }
                    builder.AppendFormat("{0};\r\n", cmdText);
                }
                Logger.Log(Level.Debug, " 批量执行“" + cmd.ArrayBindCount + "”条，行:\r\n Sql语句如下：\r\n" + builder);
            }
        }
        /// <summary>
        /// 转变常用的DbType
        /// </summary>
        /// <param name="oracleDbType"></param>
        /// <param name="value"></param>
        /// <returns></returns>
        private static string ConvertDbValue(OracleDbType oracleDbType, object value)
        {
            switch (oracleDbType)
            {
                case OracleDbType.Varchar2:
                case OracleDbType.NVarchar2:
                case OracleDbType.Char:
                case OracleDbType.NChar:
                    value = string.Format("'{0}'", value);
                    break;
                case OracleDbType.Date:
                case OracleDbType.TimeStamp:
                    value = string.Format("to_date('{0}','yyyy-MM-dd HH24:mi:ss') ", value);
                    break;
                case OracleDbType.Int16:
                case OracleDbType.Int32:
                case OracleDbType.Int64:
                case OracleDbType.Decimal:
                    break;
                default:
                    value = string.Format("'{0}'", value);
                    break;
            }
            return value.ToString();
        }
        /// <summary>
        /// 获取SQL数据
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="domains"></param>
        /// <param name="cols"></param>
        /// <returns></returns>
        public static Dictionary<string, object[]> GetData<T>(IList<T> domains, Expression<Func<T, object>>[] cols) where T : class
        {
            Dictionary<string, object[]> columnRowData = new Dictionary<string, object[]>();
            foreach (var expression in cols)
            {
                object[] objs = domains.Select(expression.Compile()).ToArray();
                var type = expression.GetRightMostMember().Type;
                for (int j = 0; j < objs.Length; j++)
                {
                    if (objs[j] == null)
                    {
#if DEBUG
                        throw new ArgumentNullException(expression.PropertyName(), "批量更新包含空值");
#endif
                        //objs[j] = (object)DBNull.Value;
                        objs[j] = DbTool.GetDefaultValue(type);
                    }
                }
                var key = expression.PropertyName();
                if (!columnRowData.ContainsKey(key))
                {
                    columnRowData.Add(key, objs);
                }
            }
            return columnRowData;
        }
        public static object[] GetParamValues(object[] arry)
        {
            object value = new object();
            foreach (var o in arry)
            {
                if (o != null)
                {
                    value = o;
                    break;
                }
            }
            var type = value.GetType();
            if (type.IsEnum)
            {
                object[] result = new object[arry.Length];
                for (int i = 0; i < arry.Length; i++)
                {
                    // result[i] = (char)(int)arry[i];
                    result[i] = Convert.ToString((int)arry[i], 16);
                }
                return result;
            }
            else if (type == typeof(bool))
            {
                object[] result = new object[arry.Length];
                for (int i = 0; i < arry.Length; i++)
                {
                    bool v = (bool)arry[i];
                    if (v)
                        result[i] = "1";
                    else
                        result[i] = "0";
                }
                return result;
            }
            return arry;
        }
        public static object GetParamValue(object value)
        {
            var type = value.GetType();
            if (value == null)
            {
                return DBNull.Value;
            }
            else if (type.IsEnum)
            {
                return Convert.ToString((int)value, 16);
            }
            else if (type == typeof(bool))
            {
                bool v = (bool)value;
                if (v) { return "1"; }
                else { return "0"; }
            }
            else
            {
                return value;
            }
        }
    }
}
#region copyright
// <copyright file="OracleDbTypeConverter.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-28</datecreated>
#endregion
namespace Cis.DbLight.Oracle
{
    using System;
    using System.Collections.Generic;
    using System.Data;
    using System.Data.Common;
    using System.Linq;
    using System.Text;
    
    /// <summary>
    /// TODO: Update summary.
    /// </summary>
    public class OracleDbTypeConverter : IDbTypeConverter
    {
        public virtual string ToDbString(object obj, Func<object, string> customConverter = null)
        {
            if (obj == null)
                return "NULL";
            Type type = obj.GetType();
            if (type == typeof(string))
            {
                string s = obj as string;
                return String.Format("'{0}'", s.Replace("'", "''"));
            }
            if (type == typeof(DateTime))
            {
                DateTime d = (DateTime)obj;
                return String.Format("to_date('{0}', 'dd/mm/yyyy hh24:mi')", d.ToString("dd/MM/yyyy HH:mm"));
            }
            if (type == typeof(bool))
            {
                bool v = (bool)obj;
                if (v) return "1";
                else return "0";
            }
            //
            if (type.IsEnum)
            {
                return Convert.ToInt32(obj).ToString();
            }
            return obj.ToString();
        }
        public virtual string FormatDbType(IDbDataParameter prm)
        {
            IDbDataParameter p = prm as IDbDataParameter;
            if (p.Value == null || p.Value == DBNull.Value)
                return "NULL";
            switch (p.DbType)
            {
                case DbType.AnsiString:
                case DbType.AnsiStringFixedLength:
                case DbType.String:
                case DbType.StringFixedLength:
                    string s = p.Value as string;
                    return String.Format("'{0}'", s.Replace("'", "''"));
                case DbType.Binary:
                    byte[] b = p.Value as byte[];
                    return HexString(b);
                case DbType.Date:
                case DbType.DateTime:
                case DbType.DateTime2:
                    DateTime d = (DateTime)p.Value;
                    return String.Format("to_date('{0}', 'dd/mm/yyyy hh24:mi')", d.ToString("dd/MM/yyyy HH:mm"));
                default:
                    return p.Value.ToString();
            }
        }
        protected string HexString(byte[] bytes)
        {
            StringBuilder sb = new StringBuilder();
            for (int i = 0; i < bytes.Length; i++)
                sb.AppendFormat("{0:X2}", bytes[i]);
            return sb.ToString();
        }
        //http://www.devart.com/dotconnect/oracle/docs/DataTypeMapping.html
        //http://docs.oracle.com/html/B10961_01/features.htm#1024984
        //每个数据库提供程序有不同的映射方式，ms oracle client 与odp.oracle client不同
        //因此默认实现不自定义映射
        public virtual DbType ClrToDbType(Type type)
        {
            throw new NotImplementedException();
        }
        public virtual Type DbTypeToClr(DbType dbType)
        {
            throw new NotImplementedException();
        }
        public virtual DbParameter GetDbParameter(DbCommand cmd, string name, object value)
        {
            // OracleParameter parameter=
            DbParameter parameter = cmd.CreateParameter();
            parameter.ParameterName = name;
            if (value == null)
            {
                //ms oracle cilent 必须显示转换
                parameter.Value = DBNull.Value;
            }
            else
            {
                var type = value.GetType();
                if (type.IsEnum)
                {
                   // parameter.Value = (int)value;
                    parameter.Value = Convert.ToString((int)value, 16);
                }
                else if (type == typeof(bool))
                {
                    bool v = (bool)value;
                    if (v) parameter.Value = "1";
                    else parameter.Value = "0";
                }
                else if (type == typeof(DateTime))
                {
                    parameter.Value = value;
                    parameter.DbType = DbType.Date;
                }
                else
                {
                    parameter.Value = value;
                }
            }
            return parameter;
        }
        public void AddParam(DbCommand cmd, object value)
        {
            var name = string.Format(":{0}", cmd.Parameters.Count);
            DbParameter p = this.GetDbParameter(cmd, name, value);
            cmd.Parameters.Add(p);
        }
        public void AddParams(DbCommand cmd, IDictionary<string, object> dbParameters)
        {
            //dbtype 根据clr 类型推断
            //I think it was working earlier with ODT.NET without null-checks, but have not confirmed it. Apparently System.Data.OracleClient is dropping parameters with null-value.
            //http://stackoverflow.com/questions/5678905/ora-01008-with-all-variables-bound
            foreach (var kv in dbParameters)
            {
                DbParameter parameter = this.GetDbParameter(cmd, kv.Key, kv.Value);
                cmd.Parameters.Add(parameter);
            }
        }
        public IDictionary<string, object> ToDicParams(params object[] args)
        {
            IDictionary<string, object> dbs = new Dictionary<string, object>();
            int i = 0;
            foreach (object item in args)
            {
                dbs.Add(i.ToString(), item);
                i++;
            }
            return dbs;
        }
        public void AddParams(DbCommand cmd, params object[] args)
        {
            foreach (object item in args)
            {
                AddParam(cmd, item);
            }
        }
    }
}
#region copyright
// <copyright file="OracleDialect.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-20</datecreated>
#endregion
namespace Cis.DbLight.Oracle
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text;
    /// <summary>
    /// TODO: Update summary.
    /// </summary>
    public class OracleDialect : ISqlDialect
    {
        public string DbParameterConstant
        {
            get
            {
                return ":";
            }
        }
        public string SchemaSql
        {
            get
            {
                return "select COLUMN_NAME as ColumnName,'0' as IsAliasColumn   from   user_tab_columns  where table_name  =Upper(:0)";
            }
        }
        public string EncodeName(string name)
        {
            return string.Format("{0}", name);
        }
        //public string EncodeChar
        //{
        //    //如果关键字做为表名，列名需要编码。区分大小写
        //    //get { return (@"""{0}"""); }
        //    get { return ("{0}"); }
        //}
    }
}
using System;
using System.Collections.Generic;
using Cis.Infrastructure;
using System.Data;
using Oracle.ManagedDataAccess.Client;
using System.Threading.Tasks;
using System.Linq;
using System.Linq.Expressions;
using System.Text;
using Cis.Log;
using Cis.DbLight;
namespace Cis.DbLight.Oracle
{
    /// <summary>
    /// 数据库操作类
    /// 参照微软DbHelper  并修改为单例模式实现  简化数据库支持：Oracle
    /// 作者：MJL  2015-03-25
    /// </summary>
    public class OracleHelper
    {
        private LogHelper log = new LogHelper(typeof(OracleHelper));
        private static object obj = new object();
        private static OracleHelper instance = null;
        [ThreadStatic]
        private OracleConnection conn;
        public static OracleHelper Instance
        {
            get
            {
                if (instance == null)
                {
                    lock (obj)
                    {
                        if (instance == null)
                        {
                            instance = new OracleHelper();
                        }
                    }
                }
                return new OracleHelper();
            }
        }
        public OracleConnection CreateConnection(string connectionString = null)
        {
            if (conn == null)
            {
                string connStr = "";
                //TODO 原global的dbkey 这里要改一下
                string dbKey = "";
                var dbConnections = ConfigHelper.Instance.GetSection("DBConnectionString");
                if (string.IsNullOrEmpty(dbKey))
                {
                    if (dbConnections.Count > 0)
                    {
                        connStr = dbConnections.First().Value;
                    }
                    else
                    {
                        connStr = ConfigHelper.Instance.Get("shenHeDb");
                    }
                }
                else
                {
                    connStr = dbConnections[dbKey];
                }
                if (string.IsNullOrEmpty(connStr))
                {
                    connStr = ConfigHelper.Instance.Get("drgsDb");
                }
                string oldStr = connectionString ?? connStr;
                string trueConn = new Infrastructure.SymmetricMethod().Decrypto(oldStr);
                conn = new OracleConnection(string.IsNullOrEmpty(trueConn) ? oldStr : trueConn);
            }
            //return new OracleConnection(connectionString ?? ConfigurationManager.AppSettings["DefaultConn"]);
            return conn;
        }
        public OracleCommand GetStoredProcCommond(string storedProcedure, string connectionString = null)
        {
            OracleCommand cmd = CreateConnection(connectionString).CreateCommand();
            cmd.CommandText = storedProcedure;
            cmd.CommandType = CommandType.StoredProcedure;
            cmd.BindByName = true;
            return cmd;
        }
        public OracleCommand GetSqlStringCommond(string sqlQuery, string connectionString = null)
        {
            OracleCommand cmd = CreateConnection(connectionString).CreateCommand();
            if (null != Transaction.Current)
            {
                cmd = (Transaction.Current.DbTransactionWrapper.DbTransaction.Connection as OracleConnection).CreateCommand();
            }
            else
            {
                cmd = CreateConnection(connectionString).CreateCommand();
            }
            cmd.CommandText = sqlQuery;
            cmd.CommandType = CommandType.Text;
            cmd.BindByName = true;
            //if (null != Transaction.Current)
            //{
            //    cmd.Connection = Transaction.Current.DbTransactionWrapper.DbTransaction.Connection as OracleConnection;
            //    cmd.Transaction = Transaction.Current.DbTransactionWrapper.DbTransaction as OracleTransaction;
            //}
            return cmd;
        }
        #region 增加参数
        public void AddParameterCollection(OracleCommand cmd, IEnumerable<OracleParameter> paramCollection)
        {
            foreach (OracleParameter param in paramCollection)
            {
                cmd.Parameters.Add(param);
            }
        }
        public void AddInParameters(OracleCommand cmd, IDictionary<string, object> dicParams)
        {
            foreach (var param in dicParams)
            {
                this.AddInParameter(cmd, param.Key, param.Value);
            }
        }
        public void AddBatchInParameters<T>(OracleCommand cmd, IList<T> domains, params Expression<Func<T, object>>[] cols) where T : class
        {
            Dictionary<string, object[]> columnRowData = DbTool.GetData(domains, cols);
            if (columnRowData.Count > 0)
            {
                string[] dbColumns = columnRowData.Keys.ToArray();
                // 绑定批处理的行数
                cmd.ArrayBindCount = columnRowData.Values.First().Length; // 很重要
                cmd.CommandTimeout = 600; // 10分钟
                foreach (string colName in dbColumns)
                {
                    this.AddBatchInParameter(cmd, colName, columnRowData[colName]);
                }
            }
        }
        public void AddBatchInParameters(OracleCommand cmd, Dictionary<string, object[]> columnRowData)
        {
            if (columnRowData.Count > 0)
            {
                string[] dbColumns = columnRowData.Keys.ToArray();
                // 绑定批处理的行数
                cmd.ArrayBindCount = columnRowData.Values.First().Length; // 很重要
                cmd.CommandTimeout = 600; // 10分钟
                foreach (string colName in dbColumns)
                {
                    this.AddBatchInParameter(cmd, colName, columnRowData[colName]);
                }
            }
        }
        public void AddOutParameter(OracleCommand cmd, string parameterName)
        {
            OracleParameter dbParameter = cmd.CreateParameter();
            dbParameter.OracleDbType = OracleDbType.NVarchar2;
            dbParameter.ParameterName = parameterName;
            dbParameter.Size = 4096;
            dbParameter.Direction = ParameterDirection.Output;
            cmd.Parameters.Add(dbParameter);
        }
        public void AddOutParameter(OracleCommand cmd, string parameterName, OracleDbType dbType, int size)
        {
            OracleParameter dbParameter = cmd.CreateParameter();
            dbParameter.OracleDbType = dbType;
            dbParameter.ParameterName = parameterName;
            dbParameter.Size = size;
            dbParameter.Direction = ParameterDirection.Output;
            cmd.Parameters.Add(dbParameter);
        }
        public void AddInParameter(OracleCommand cmd, string parameterName, object value)
        {
            OracleParameter dbParameter = new OracleParameter();
            dbParameter.ParameterName = parameterName;
            //dbParameter.OracleDbType = DbTool.GetOracleDbType(value);
            dbParameter.OracleDbTypeEx = DbTool.GetOracleDbType(value);
            dbParameter.Value = DbTool.GetParamValue(value);
            dbParameter.Direction = ParameterDirection.Input;
            cmd.Parameters.Add(dbParameter);
        }
        public void AddBatchInParameter(OracleCommand cmd, string parameterName, object[] value)
        {
            if (value.Length > 0)
            {
                // 绑定批处理的行数
                cmd.ArrayBindCount = value.Length; // 很重要
                cmd.CommandTimeout = 600; // 10分钟
                OracleParameter dbParameter = new OracleParameter();
                dbParameter.ParameterName = parameterName;
                //dbParameter.OracleDbType = DbTool.GetOracleDbType(value);
                dbParameter.OracleDbTypeEx = DbTool.GetOracleDbType(value);
                dbParameter.Value = DbTool.GetParamValue(value);
                dbParameter.Direction = ParameterDirection.Input;
                cmd.Parameters.Add(dbParameter);
            }
        }
        public void AddBatchInParameter(OracleCommand cmd, string parameterName, object value, int paramLength = 0)
        {
            var arrLen = cmd.ArrayBindCount;
            if (paramLength > 0)
            {
                arrLen = paramLength;
            }
            var arrValue = new object[arrLen];
            for (int i = 0; i < arrLen; i++)
            {
                arrValue[i] = value;
            }
            AddBatchInParameter(cmd, parameterName, arrValue);
        }
        public void AddInOutParameter(OracleCommand cmd, string parameterName, object value)
        {
            OracleParameter dbParameter = cmd.CreateParameter();
            dbParameter.OracleDbType = DbTool.GetOracleDbType(value);
            dbParameter.ParameterName = parameterName;
            dbParameter.Value = DbTool.GetParamValue(value);
            dbParameter.Direction = ParameterDirection.InputOutput;
            cmd.Parameters.Add(dbParameter);
        }
        public void AddReturnParameter(OracleCommand cmd, string parameterName, OracleDbType dbType)
        {
            OracleParameter dbParameter = cmd.CreateParameter();
            dbParameter.OracleDbType = dbType;
            dbParameter.ParameterName = parameterName;
            dbParameter.Direction = ParameterDirection.ReturnValue;
            cmd.Parameters.Add(dbParameter);
        }
        public OracleParameter GetParameter(OracleCommand cmd, string parameterName)
        {
            return cmd.Parameters[parameterName];
        }
        #endregion
        #region 执行
        public DataTable ExecuteDataTable(OracleCommand cmd)
        {
            DataTable dataTable = new DataTable();
            try
            {
                log.Debug(DbTool.GetLogSql(cmd.CommandText, cmd.Parameters));
                if (null == Transaction.Current)
                {
                    cmd.Connection.Open();
                }
                OracleDataAdapter da = new OracleDataAdapter(cmd);
                da.Fill(dataTable);
            }
            catch (System.Exception ex)
            {
                dataTable = null;
                log.Error("ExecuteDataTable", ex);
                throw ex;
            }
            finally
            {
                if (null == Transaction.Current && cmd.Connection != null && cmd.Connection.State != ConnectionState.Closed)
                {
                    cmd.Connection.Close();
                    cmd.Connection.Dispose();
                }
            }
            return dataTable;
        }
        public Task<DataTable> ExecuteDataTableAsync(OracleCommand cmd)
        {
            DependentTransaction dependentTransaction = Transaction.Current.DependentClone();
            return new Task<DataTable>((object tran) =>
            {
                DataTable rel = null;
                Transaction.Current = tran as Transaction;
                try
                {
                    rel = ExecuteDataTable(cmd);
                }
                catch (System.Exception ex)
                {
                    throw ex;
                }
                finally
                {
                    Transaction.Current = null;
                }
                return rel;
            }, dependentTransaction);
        }
        public int ExecuteNonQuery(OracleCommand cmd)
        {
            int ret = -1;
            try
            {
                if (cmd.ArrayBindCount > 0)
                {
#if DEBUG
                    DbTool.LogOperateDone(cmd);
#endif
                    DbTool.WriteLog(Level.Debug, cmd);
                }
                else
                {
                    log.Debug(DbTool.GetLogSql(cmd.CommandText, cmd.Parameters));
                }
                //执行批处理
                if (null == Transaction.Current)
                {
                    cmd.Connection.Open();
                }
                ret = cmd.ExecuteNonQuery();
            }
            catch (System.Exception ex)
            {
                log.Error("ExecuteNonQuery", ex);
                throw ex;
            }
            finally
            {
                if (null == Transaction.Current && cmd.Connection != null && cmd.Connection.State != ConnectionState.Closed)
                {
                    cmd.Connection.Close();
                    cmd.Connection.Dispose();
                }
            }
            return ret;
        }
        public Task<int> ExecuteNonQueryAsync(OracleCommand cmd)
        {
            DependentTransaction dependentTransaction = Transaction.Current.DependentClone();
            return new Task<int>((object tran) =>
            {
                int rel = -1;
                Transaction.Current = tran as Transaction;
                try
                {
                    rel = ExecuteNonQuery(cmd);
                }
                catch (System.Exception ex)
                {
                    throw ex;
                }
                finally
                {
                    Transaction.Current = null;
                }
                return rel;
            }, dependentTransaction);
        }
        public object ExecuteScalar(OracleCommand cmd)
        {
            object ret = null;
            try
            {
                log.Debug(DbTool.GetLogSql(cmd.CommandText, cmd.Parameters));
                if (null == Transaction.Current)
                {
                    cmd.Connection.Open();
                }
                ret = cmd.ExecuteScalar();
            }
            catch (System.Exception ex)
            {
                ret = null;
                log.Error("ExecuteScalar", ex);
                throw ex;
            }
            finally
            {
                if (null == Transaction.Current && cmd.Connection != null && cmd.Connection.State != ConnectionState.Closed)
                {
                    cmd.Connection.Close();
                    cmd.Connection.Dispose();
                }
            }
            return ret;
        }
        public Task<object> ExecuteScalarAsync(OracleCommand cmd)
        {
            DependentTransaction dependentTransaction = Transaction.Current.DependentClone();
            return new Task<object>((object tran) =>
            {
                object rel = null;
                Transaction.Current = tran as Transaction;
                try
                {
                    rel = ExecuteScalar(cmd);
                }
                catch (System.Exception ex)
                {
                    throw ex;
                }
                finally
                {
                    Transaction.Current = null;
                }
                return rel;
            }, dependentTransaction);
        }
        /// <summary>
        /// 谨慎使用 Reader记得关闭
        /// </summary>
        /// <param name="cmd"></param>
        /// <returns></returns>
        private OracleDataReader ExecuteReader(OracleCommand cmd)
        {
            log.Debug(DbTool.GetLogSql(cmd.CommandText, cmd.Parameters));
            if (null == Transaction.Current)
            {
                cmd.Connection.Open();
                return cmd.ExecuteReader(CommandBehavior.CloseConnection);
            }
            return cmd.ExecuteReader();
        }
        /// <summary>
        /// 批量更新 自带事物处理
        /// </summary>
        /// <typeparam name="T">实体类型</typeparam>
        /// <param name="insertOrUpdateSql">SQL执行模板</param>
        /// <param name="domains">实体</param>
        /// <param name="cols">需要更新的列</param>
        /// <returns></returns>
        public int BatchExecute<T>(string insertOrUpdateSql, IList<T> domains, params Expression<Func<T, object>>[] cols) where T : class
        {
            var cmd = GetSqlStringCommond(insertOrUpdateSql);
            this.AddBatchInParameters<T>(cmd, domains, cols);
            return this.ExecuteNonQuery(cmd);
        }
        public Task<int> BatchExecuteAsync<T>(string insertOrUpdateSql, IList<T> domains, params Expression<Func<T, object>>[] cols) where T : class
        {
            DependentTransaction dependentTransaction = Transaction.Current.DependentClone();
            return new Task<int>((object tran) =>
            {
                int rel = -1;
                Transaction.Current = tran as Transaction;
                try
                {
                    rel = BatchExecute<T>(insertOrUpdateSql, domains, cols);
                }
                catch (System.Exception ex)
                {
                    throw ex;
                }
                finally
                {
                    Transaction.Current = null;
                }
                return rel;
            }, dependentTransaction);
        }
        /// <summary>
        /// 批量更新 自带事物处理
        /// </summary>
        /// <param name="insertOrUpdateSql">SQL执行模板</param>
        /// <param name="columnRowData">数据对象</param>
        /// <returns></returns>
        public int BatchExecute(string insertOrUpdateSql, Dictionary<string, object[]> columnRowData)
        {
            var iResult = 0;
            if (columnRowData.Count > 0)
            {
                var cmd = this.GetSqlStringCommond(insertOrUpdateSql);
                this.AddBatchInParameters(cmd, columnRowData);
                iResult = this.ExecuteNonQuery(cmd);
            }
            return iResult;
        }
        public Task<int> BatchExecuteAsync(string insertOrUpdateSql, Dictionary<string, object[]> columnRowData)
        {
            DependentTransaction dependentTransaction = Transaction.Current.DependentClone();
            return new Task<int>((object tran) =>
            {
                int rel = -1;
                Transaction.Current = tran as Transaction;
                try
                {
                    rel = BatchExecute(insertOrUpdateSql, columnRowData);
                }
                catch (System.Exception ex)
                {
                    throw ex;
                }
                finally
                {
                    Transaction.Current = null;
                }
                return rel;
            }, dependentTransaction);
        }
        /// <summary>
        /// 批量插入
        /// </summary>
        /// <typeparam name="T">实体类型</typeparam>
        /// <param name="domains">实体</param>
        /// <param name="cols">插入的列</param>
        /// <returns></returns>
        public int BatchInsert<T>(IList<T> domains, params Expression<Func<T, object>>[] cols) where T : class
        {
            List<string> usedProperies = cols.Select(expression => expression.PropertyName()).ToList();
            string sql = OracleSqlBuilder.InsertBuilder<T>(usedProperies);
            var cmd = this.GetSqlStringCommond(sql);
            this.AddBatchInParameters<T>(cmd, domains, cols);
            return this.ExecuteNonQuery(cmd);
        }
        public Task<int> BatchInsertAsync<T>(IList<T> domains, params Expression<Func<T, object>>[] cols) where T : class
        {
            DependentTransaction dependentTransaction = Transaction.Current.DependentClone();
            return new Task<int>((object tran) =>
            {
                int rel = -1;
                Transaction.Current = tran as Transaction;
                try
                {
                    rel = BatchInsert<T>(domains, cols);
                }
                catch (System.Exception ex)
                {
                    throw ex;
                }
                finally
                {
                    Transaction.Current = null;
                }
                return rel;
            }, dependentTransaction);
        }
        /// <summary>
        /// 批量更新
        /// </summary>
        /// <typeparam name="T">实体类型</typeparam>
        /// <param name="domains">实体</param>
        /// <param name="where">更新条件</param>
        /// <param name="cols">涉及的列</param>
        /// <returns></returns>
        public int BatchUpdate<T>(IList<T> domains, string where, params Expression<Func<T, object>>[] cols) where T : class
        {
            List<string> usedProperies = cols.Select(expression => expression.PropertyName()).ToList();
            string sql = OracleSqlBuilder.UpateBuilder<T>(where, usedProperies);
            var cmd = this.GetSqlStringCommond(sql);
            this.AddBatchInParameters<T>(cmd, domains, cols);
            return this.ExecuteNonQuery(cmd);
        }
        public Task<int> BatchUpdateAsync<T>(IList<T> domains, string where, params Expression<Func<T, object>>[] cols) where T : class
        {
            DependentTransaction dependentTransaction = Transaction.Current.DependentClone();
            return new Task<int>((object tran) =>
            {
                int rel = -1;
                Transaction.Current = tran as Transaction;
                try
                {
                    rel = BatchUpdate<T>(domains, where, cols);
                }
                catch (System.Exception ex)
                {
                    throw ex;
                }
                finally
                {
                    Transaction.Current = null;
                }
                return rel;
            }, dependentTransaction);
        }
        /// <summary>
        /// 批量删除
        /// </summary>
        /// <typeparam name="T">实体类型</typeparam>
        /// <param name="domains">实体</param>
        /// <param name="cols">删除涉及的列</param>
        /// <returns></returns>
        public int BatchDelete<T>(IList<T> domains, string where, params Expression<Func<T, object>>[] cols) where T : class
        {
            List<string> usedProperies = cols.Select(expression => expression.PropertyName()).ToList();
            string sql = OracleSqlBuilder.DeleteBuilder<T>(where);
            var cmd = this.GetSqlStringCommond(sql);
            this.AddBatchInParameters<T>(cmd, domains, cols);
            return this.ExecuteNonQuery(cmd);
        }
        public Task<int> BatchDeleteAsync<T>(IList<T> domains, string where, params Expression<Func<T, object>>[] cols) where T : class
        {
            DependentTransaction dependentTransaction = Transaction.Current.DependentClone();
            return new Task<int>((object tran) =>
            {
                int rel = -1;
                Transaction.Current = tran as Transaction;
                try
                {
                    rel = BatchDelete<T>(domains, where, cols);
                }
                catch (System.Exception ex)
                {
                    throw ex;
                }
                finally
                {
                    Transaction.Current = null;
                }
                return rel;
            }, dependentTransaction);
        }
        public T ExecuteModel<T>(OracleCommand cmd) where T : class
        {
            T t = default(T);
            OracleDataReader reader = null;
            try
            {
                log.Debug(DbTool.GetLogSql(cmd.CommandText, cmd.Parameters));
                if (null == Transaction.Current)
                {
                    cmd.Connection.Open();
                }
                reader = cmd.ExecuteReader();
                if (reader.Read())
                {
                    t = Cis.BaseModel.DeserializeObject.CreateItem<T>(reader);
                }
            }
            catch (System.Exception ex)
            {
                log.Error("ExecuteModel", ex);
                throw ex;
            }
            finally
            {
                if (reader != null)
                {
                    reader.Close();
                    reader.Dispose();
                }
                if (null == Transaction.Current && cmd.Connection != null && cmd.Connection.State != ConnectionState.Closed)
                {
                    cmd.Connection.Close();
                    cmd.Connection.Dispose();
                }
            }
            return t;
        }
        public Task<T> ExecuteModelAsync<T>(OracleCommand cmd) where T : class
        {
            DependentTransaction dependentTransaction = Transaction.Current.DependentClone();
            return new Task<T>((object tran) =>
            {
                T rel = null;
                Transaction.Current = tran as Transaction;
                try
                {
                    rel = ExecuteModel<T>(cmd);
                }
                catch (System.Exception ex)
                {
                    throw ex;
                }
                finally
                {
                    Transaction.Current = null;
                }
                return rel;
            }, dependentTransaction);
        }
        /// <summary>
        /// 转换字段可区分大小写
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="cmd"></param>
        /// <returns></returns>
        public List<T> ExecuteList<T>(OracleCommand cmd) where T : class
        {
            //return Cis.BaseModel.DeserializeObject.ConvertTo<T>(ExecuteDataTable(cmd)) as List<T>;
            List<T> list = null;
            OracleDataReader reader = null;
            try
            {
                log.Debug(DbTool.GetLogSql(cmd.CommandText, cmd.Parameters));
                if (null == Transaction.Current)
                {
                    cmd.Connection.Open();
                    reader = cmd.ExecuteReader(CommandBehavior.CloseConnection);
                }
                else
                {
                    reader = cmd.ExecuteReader();
                }
                var columns = DbTool.GetColumns(reader);
                list = new List<T>();
                while (reader.Read())
                {
                    list.Add(Cis.BaseModel.DeserializeObject.CreateItem<T>(reader, columns));
                }
            }
            catch (System.Exception ex)
            {
                log.Error("ExecuteList", ex);
                list = null;
                throw ex;
            }
            finally
            {
                if (reader != null)
                {
                    reader.Close();
                    reader.Dispose();
                }
                if (null == Transaction.Current && cmd.Connection != null && cmd.Connection.State != ConnectionState.Closed)
                {
                    cmd.Connection.Close();
                    cmd.Connection.Dispose();
                }
            }
            return list;
        }
        public Task<List<T>> ExecuteListAsync<T>(OracleCommand cmd) where T : class
        {
            DependentTransaction dependentTransaction = Transaction.Current.DependentClone();
            return new Task<List<T>>((object tran) =>
            {
                List<T> rel = null;
                Transaction.Current = tran as Transaction;
                try
                {
                    rel = ExecuteList<T>(cmd);
                }
                catch (System.Exception ex)
                {
                    throw ex;
                }
                finally
                {
                    Transaction.Current = null;
                }
                return rel;
            }, dependentTransaction);
        }
        /// <summary>
        /// 插入临时表数据
        /// </summary>
        /// <param name="colName"></param>
        /// <param name="values"></param>
        public void AddTempTable(IEnumerable<object> values, string colName, string tableName = "Global_Temp_Search")
        {
            string sql = string.Format("insert into {0}({1}) values(:{1})", tableName, colName);
            var cmd = this.GetSqlStringCommond(sql);
            this.AddBatchInParameter(cmd, colName, values.ToArray());
            this.ExecuteNonQuery(cmd);
        }
        #endregion
        //#region 执行事务
        ////public DataSet ExecuteDataSet(OracleCommand cmd, Trans t)
        ////{
        ////    cmd.Connection = t.DbConnection;
        ////    cmd.Transaction = t.DbTrans;
        ////    DbProviderFactory dbfactory = DbProviderFactories.GetFactory(DbHelper.dbProviderName);
        ////    DbDataAdapter dbDataAdapter = dbfactory.CreateDataAdapter();
        ////    dbDataAdapter.SelectCommand = cmd;
        ////    DataSet ds = new DataSet();
        ////    dbDataAdapter.Fill(ds);
        ////    return ds;
        ////}
        ////public DataTable ExecuteDataTable(DbCommand cmd, Trans t)
        ////{
        ////    cmd.Connection = t.DbConnection;
        ////    cmd.Transaction = t.DbTrans;
        ////    DbProviderFactory dbfactory = DbProviderFactories.GetFactory(DbHelper.dbProviderName);
        ////    DbDataAdapter dbDataAdapter = dbfactory.CreateDataAdapter();
        ////    dbDataAdapter.SelectCommand = cmd;
        ////    DataTable dataTable = new DataTable();
        ////    dbDataAdapter.Fill(dataTable);
        ////    return dataTable;
        ////}
        //public OracleDataReader ExecuteReader(OracleCommand cmd, Trans t)
        //{
        //    log.Debug(DbTool.GetLogSql(cmd.CommandText, cmd.Parameters));
        //    cmd.Connection.Close();
        //    cmd.Connection = t.DbConnection;
        //    cmd.Transaction = t.DbTrans;
        //    OracleDataReader reader = cmd.ExecuteReader();
        //    DataTable dt = new DataTable();
        //    return reader;
        //}
        //public int ExecuteNonQuery(OracleCommand cmd, Trans t)
        //{
        //    log.Debug(DbTool.GetLogSql(cmd.CommandText, cmd.Parameters));
        //    cmd.Connection.Close();
        //    cmd.Connection = t.DbConnection;
        //    cmd.Transaction = t.DbTrans;
        //    int ret = cmd.ExecuteNonQuery();
        //    return ret;
        //}
        //public object ExecuteScalar(OracleCommand cmd, Trans t)
        //{
        //    log.Debug(DbTool.GetLogSql(cmd.CommandText, cmd.Parameters));
        //    cmd.Connection.Close();
        //    cmd.Connection = t.DbConnection;
        //    cmd.Transaction = t.DbTrans;
        //    object ret = cmd.ExecuteScalar();
        //    return ret;
        //}
        //#endregion
    }
}

using System.Security;
using System.Security.Permissions;
namespace Cis.DbLight.Oracle
{
    using System;
    using System.Collections.Generic;
    using System.Configuration;
    using System.Data;
    using System.Data.Common;
    using System.Linq;
    using System.Linq.Expressions;
    using Cis.Log;
    using Cis.DbLight.Mapper;
    using Cis.DbLight.TableMetadata;
    using global::Oracle.ManagedDataAccess.Client;
    using Infrastructure;
    /// <summary>
    /// 通过企业库实现的oracleDatabase
    /// ExecuteSqlString 不支持 Transcop(由于ExecuteSqlString内部使用企业库方法，无法使用command执行，也许可以通过ParameterMapperAdapter的command实现事物支持）
    /// 
    /// </summary>
    public class OracleQuerySession : IQuerySession
    {
        #region Fields
        protected DbProviderFactory dbProviderFactory;
        protected DatabaseInfo databaseInfo;
        protected DbParameterCreater dbParameterCreater;
        protected SqlLog sqlLog;
        #endregion
        #region Constructors and Destructors
        public OracleQuerySession(DatabaseInfo databaseInfo)
        {
            this.databaseInfo = databaseInfo;
            this.dbParameterCreater = new DbParameterCreater();
            #region "连接字符串解密"
            //苗建龙 修改
            var connectionStrings = Cis.Infrastructure.ConfigHelper.Instance.Get(databaseInfo.ConnectionStringName)
                                    ?? ConfigHelper.Instance.GetSection("DBConnectionString")[databaseInfo.ConnectionStringName];
#if DEBUG
            connectionString = new Infrastructure.SymmetricMethod().Decrypto(connectionStrings) ?? connectionStrings;
#else
            connectionString = new Infrastructure.SymmetricMethod().Decrypto(connectionStrings);
#endif
            #endregion
            this.sqlLog = new SqlLog(databaseInfo);
        }
        #endregion
        private string connectionString;
        #region Public Properties
        public string ConnectionString
        {
            get
            {
                return connectionString;
            }
        }
        public DatabaseInfo DatabaseInfo
        {
            get
            {
                return this.databaseInfo;
            }
        }
        public DbProviderFactory DbProviderFactory
        {
            get
            {
                return this.dbProviderFactory;
            }
        }
        #endregion
        #region Public Methods and Operators
        /// <summary>
        /// 
        /// </summary>
        /// <returns></returns>
        //private void TestODp()
        //{
        //    using (OracleConnection oracleCon = new OracleConnection(""))
        //    {
        //        oracleCon.Open();
        //        using (OracleCommand oracleCom = oracleCon.CreateCommand())
        //        {
        //            oracleCom.CommandType = CommandType.Text;
        //            for (int i = 0; i < ds.Tables[0].Rows.Count; i++)
        //            {
        //                //从 DataSet 逐条检索数据并且存储到 Oracle 数据表 Employee 
        //                string sqlStr = String.Format(
        //                    "INSERT INTO EMPLOYEE(EMPID,EMPNAME,EMPSEX,EMPSALARY) " +
        //                    "VALUES({0},'{1}','{2}',{3})",
        //                    ds.Tables[0].Rows[i][0],
        //                    ds.Tables[0].Rows[i][1],
        //                    ds.Tables[0].Rows[i][2],
        //                    ds.Tables[0].Rows[i][3]);
        //                oracleCom.CommandText = sqlStr;
        //                oracleCom.ExecuteNonQuery();
        //            }
        //        }
        //    }
        //}
        public int ExecuteNonQuery(string commandText, params object[] parameterValues)
        {
            //commandText = commandText.Replace(":", databaseInfo.SqlDialect.DbParameterConstant);
            IDictionary<string, object> dbp = this.databaseInfo.DbTypeConverter.ToDicParams(parameterValues);
            int result = ExecuteNonQuery(commandText, dbp);
            return result;
        }
        public int ExecuteNonQuery(string commandText, IDictionary<string, object> dbParameters)
        {
            // commandText = commandText.Replace(":", databaseInfo.SqlDialect.DbParameterConstant);
            DbCommand command = this.CreateCommand(commandText);
            this.databaseInfo.DbTypeConverter.AddParams(command, dbParameters);
            Logger.Log(Level.Debug, this.sqlLog.GetLogSql(commandText, dbParameters));
            if (null != Transaction.Current)
            {
                command.Connection = Transaction.Current.DbTransactionWrapper.DbTransaction.Connection;
                command.Transaction = Transaction.Current.DbTransactionWrapper.DbTransaction;
                return command.ExecuteNonQuery();
            }
            else
            {
                //由企业库处理分布式事务
                using (var conn = OpenConnection())
                {
                    command.Connection = conn;
                    return command.ExecuteNonQuery();
                }
            }
        }
        /// <summary>
        ///
        /// </summary>
        /// <param name="commandText"></param>
        /// <returns></returns>
        public IDataReader ExecuteReader(string commandText)
        {
            // 事务没测试
            DbCommand command = this.CreateCommand(commandText);
            Logger.Log(Level.Debug, commandText);
            if (null != Transaction.Current)
            {
                command.Connection = Transaction.Current.DbTransactionWrapper.DbTransaction.Connection;
                command.Transaction = Transaction.Current.DbTransactionWrapper.DbTransaction;
                return command.ExecuteReader();
            }
            else
            {
                //由企业库处理分布式事务
                using (var conn = OpenConnection())
                {
                    command.Connection = conn;
                    return command.ExecuteReader();
                }
            }
        }
        public T ExecuteScalar<T>(string commandText, params object[] parameterValues)
        {
            // commandText = commandText.Replace(":", databaseInfo.SqlDialect.DbParameterConstant);
            IDictionary<string, object> dbp = this.databaseInfo.DbTypeConverter.ToDicParams(parameterValues);
            return ExecuteScalar<T>(commandText, dbp);
        }
        public T ExecuteScalar<T>(string commandText, IDictionary<string, object> dbParameters)
        {
            DbCommand command = this.CreateCommand(commandText);
            this.databaseInfo.DbTypeConverter.AddParams(command, dbParameters);
            Logger.Log(Level.Debug, this.sqlLog.GetLogSql(commandText, dbParameters));
            object result = null;
            if (null != Transaction.Current)
            {
                command.Connection = Transaction.Current.DbTransactionWrapper.DbTransaction.Connection;
                command.Transaction = Transaction.Current.DbTransactionWrapper.DbTransaction;
                result = command.ExecuteScalar();
            }
            else
            {
                //由企业库处理分布式事务
                using (var conn = OpenConnection())
                {
                    command.Connection = conn;
                    result = command.ExecuteScalar();
                }
            }
            return DbHelper.ConvertFromDbVal<T>(result);
        }
        /// <summary>
        /// 
        /// </summary>
        /// <typeparam name="TResult"></typeparam>
        /// <param name="commandText"></param>
        /// <param name="parameterValues"></param>
        /// <returns></returns>
        public IEnumerable<TResult> ExecuteSqlString<TResult>(string commandText, params object[] parameterValues)
            where TResult : new()
        {
            // commandText = commandText.Replace(":", databaseInfo.SqlDialect.DbParameterConstant);
            Mapper.IRowMapper<TResult> rowMapper = this.GetRowMapper<TResult>();
            return this.ExecuteSqlString(commandText, rowMapper, parameterValues);
        }
        public IEnumerable<TResult> ExecuteSqlString<TResult>(string commandText, IDictionary<string, object> dbParameters)
            where TResult : new()
        {
            //commandText = commandText.Replace(":", databaseInfo.SqlDialect.DbParameterConstant);
            Mapper.IRowMapper<TResult> rowMapper = this.GetRowMapper<TResult>();
            return this.ExecuteSqlString(commandText, rowMapper, dbParameters);
        }
        public IEnumerable<TResult> ExecuteSqlString<TResult>(string commandText, Mapper.IRowMapper<TResult> rowMapper, params object[] parameterValues)
        {
            IDictionary<string, object> dbp = this.databaseInfo.DbTypeConverter.ToDicParams(parameterValues);
            return ExecuteSqlString(commandText, rowMapper, dbp);
        }
        public IEnumerable<TResult> ExecuteSqlString<TResult>(string commandText, Mapper.IRowMapper<TResult> rowMapper, IDictionary<string, object> dbParameters)
        {
            rowMapper.TablesInfo = this.DatabaseInfo.TablesInfo;
            DbCommand command = this.CreateCommand(commandText);
            if (dbParameters != null && dbParameters.Count != 0)
            {
                //IDictionary<string, object> dbParameters = this.databaseInfo.DbTypeConverter.ToDicParams(parameterValues);
                this.databaseInfo.DbTypeConverter.AddParams(command, dbParameters);
                Logger.Log(Level.Debug, this.sqlLog.GetLogSql(commandText, dbParameters));
            }
            else
            {
                Logger.Log(Level.Debug, commandText);
            }
            List<TResult> data = new List<TResult>();
            if (null != Transaction.Current)
            {
                command.Connection = Transaction.Current.DbTransactionWrapper.DbTransaction.Connection;
                command.Transaction = Transaction.Current.DbTransactionWrapper.DbTransaction;
                using (var reader = command.ExecuteReader() as OracleDataReader)
                {
                    //reader.FetchSize = reader.RowSize * 2000;
                    if (reader.HasRows)
                    {
                        var r = reader.Cast<IDataRecord>();
                        foreach (var dataRecord in r)
                        {
                            var t = rowMapper.MapRow(dataRecord);
                            data.Add(t);
                        }
                    }
                }
            }
            else
            {
                //由企业库处理分布式事务
                using (var conn = OpenConnection())
                {
                    command.Connection = conn;
                    using (var reader = command.ExecuteReader() as OracleDataReader)
                    {
                        Log.Logger.Log(Level.Debug, reader.RowSize.ToString());
                        Log.Logger.Log(Level.Debug, reader.FetchSize.ToString());
                        //reader.FetchSize = reader.RowSize * 2000;
                        if (reader.HasRows)
                        {
                            var r = reader.Cast<IDataRecord>();
                            foreach (var dataRecord in r)
                            {
                                var t = rowMapper.MapRow(dataRecord);
                                data.Add(t);
                            }
                        }
                    }
                }
            }
            return data;
        }
        #region 20170503 增加 返回list
        public IEnumerable<object> ExecuteList(string commandText, params object[] parameterValues)
        {
            IDictionary<string, object> dbp = this.databaseInfo.DbTypeConverter.ToDicParams(parameterValues);
            return this.ExecuteList(commandText, dbp);
        }
        public IEnumerable<object> ExecuteList(string commandText, IDictionary<string, object> dbParameters)
        {
            DbCommand command = this.CreateCommand(commandText);
            if (dbParameters != null && dbParameters.Count != 0)
            {
                //IDictionary<string, object> dbParameters = this.databaseInfo.DbTypeConverter.ToDicParams(parameterValues);
                this.databaseInfo.DbTypeConverter.AddParams(command, dbParameters);
                Logger.Log(Level.Debug, this.sqlLog.GetLogSql(commandText, dbParameters));
            }
            else
            {
                Logger.Log(Level.Debug, commandText);
            }
            List<object> data = new List<object>();
            if (null != Transaction.Current)
            {
                command.Connection = Transaction.Current.DbTransactionWrapper.DbTransaction.Connection;
                command.Transaction = Transaction.Current.DbTransactionWrapper.DbTransaction;
                using (var reader = command.ExecuteReader() as OracleDataReader)
                {
                    //reader.FetchSize = reader.RowSize * 2000;
                    if (reader.HasRows)
                    {
                        var r = reader.Cast<IDataRecord>();
                        foreach (var dataRecord in r)
                        {
                            data.Add(dataRecord.GetValue(0));
                        }
                    }
                }
            }
            else
            {
                //由企业库处理分布式事务
                using (var conn = OpenConnection())
                {
                    command.Connection = conn;
                    using (var reader = command.ExecuteReader() as OracleDataReader)
                    {
                        Log.Logger.Log(Level.Debug, reader.RowSize.ToString());
                        Log.Logger.Log(Level.Debug, reader.FetchSize.ToString());
                        //reader.FetchSize = reader.RowSize * 2000;
                        if (reader.HasRows)
                        {
                            var r = reader.Cast<IDataRecord>();
                            foreach (var dataRecord in r)
                            {
                                data.Add(dataRecord.GetValue(0));
                            }
                        }
                    }
                }
            }
            return data;
        }
        #endregion
        /// <summary>
        /// 创建Command,connection 未指定
        /// </summary>
        /// <param name="query"></param>
        /// <returns></returns>
        private OracleCommand CreateCommand(string query)
        {
            var oraclCommand = new OracleConnection(connectionString).CreateCommand();
            oraclCommand.CommandText = query;
            oraclCommand.BindByName = true;
            return oraclCommand;
        }
        public DbConnection CreateConnection()
        {
            return new OracleConnection(connectionString);
        }
        public OracleConnection OpenConnection()
        {
            var conn = new OracleConnection(connectionString);
            conn.Open();
            return conn as OracleConnection;
        }
        #endregion
        #region Methods
        private Mapper.IRowMapper<TResult> GetRowMapper<TResult>() where TResult : new()
        {
            Type type = typeof(TResult);
            Mapper.IRowMapper<TResult> rowMapper;
            TableAttribute tableAttr = type.GetCustomAttributes(true).OfType<TableAttribute>().FirstOrDefault();
            if (tableAttr == null)
            {
                rowMapper = new PropertyEqualColumnMapper<TResult>();
            }
            else
            {
                rowMapper = new ColumnAttributeMapper<TResult>(this.DatabaseInfo.TablesInfo);
            }
            return rowMapper;
        }
        #endregion
    }
}using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Linq.Expressions;
using System.Text;
using System.Text.RegularExpressions;
using Cis.Infrastructure;
using Cis.Log;
using EnsureThat;
namespace Cis.DbLight.Oracle
{
    public class OracleSingleTableDao<TDomain> : SingleTableDao<TDomain> where TDomain : class, new()
    {
        public OracleSingleTableDao(IQuerySession querySession, ColumnMapperStrategy mapperStrategy = ColumnMapperStrategy.ColumnAttribute) : base(querySession, mapperStrategy)
        {
        }
        /// <summary>
        /// 批量更新,sequence Id 不需要处理，domain上加attribute
        /// domian中可空类型string与datetime默认更新为""与当前日期 ,其他可空类型必须传入有效值
        /// </summary>
        /// <param name="domains">domain 列表</param>
        /// <param name="cols">需要插入的列</param>
        public virtual int BatchInsert(List<TDomain> domains, params Expression<Func<TDomain, object>>[] cols)
        {
            if (domains.Count == 0)
            {
                return 0;
            }
            BatchOracleHelper oracleHelper = new BatchOracleHelper(QuerySession);
            var columnRowData = GetData(domains, cols);
            string[] usedProperies = cols.Select(expression => expression.PropertyName()).ToArray();
            Table table = GetTable(this.DefaultColumnMapperStrategy);
            InsertBuilder<TDomain> insertBuilder = new InsertBuilder<TDomain>(table, domains[0], QuerySession.DatabaseInfo.SqlDialect, usedProperies);
            string sql = insertBuilder.CreateSql();
            return oracleHelper.BatchInsertOrUpdate(sql, columnRowData);
        }
        public virtual int Update(TDomain domain, string where, params Expression<Func<TDomain, object>>[] cols)
        {
            Ensure.That(domain != null).IsTrue();
            List<TDomain> domains = new List<TDomain>() { domain };
            return BatchUpdate(domains, where, cols);
        }
        /// <summary>
        ///批量更新 domian中可空类型string与datetime默认更新为""与当前日期 ,其他可空类型必须传入有效值
        /// </summary>
        /// <param name="domains">待更新domains</param>
        /// <param name="where">where sql 字句,如：ID=:5 ,数字为cols 参数 从0开始的index值</param>
        /// <param name="cols">需要更新列与where字句值，where字句在最后</param>
        /// <remarks></remarks>
        public virtual int BatchUpdate(List<TDomain> domains, string where, params Expression<Func<TDomain, object>>[] cols)
        {
            if (domains.Count == 0)
            {
                return 0;
            }
            Expression<Func<TDomain, object>>[] setCols = new Expression<Func<TDomain, object>>[20];
            if (!string.IsNullOrEmpty(where))
            {
                var whereCount = Regex.Matches(where, @":\d+");
                var count = int.Parse(whereCount[whereCount.Count - 1].Value.TrimStart(':')) + 1;
                if (count != cols.Count())
                {
                    throw new ArgumentException("cols 参数长度与 sql中需要绑定的值不一致");
                }
                Ensure.That(whereCount.Count != 0).IsTrue();
                if (cols.Count() < whereCount.Count)
                {
                    throw new ArgumentException("where 字句中的   ：数字  参数个数不正确");
                }
                var t = int.Parse(whereCount[0].Value.TrimStart(':'));
                setCols = cols.Take(t).ToArray();
            }
            else
            {
                setCols = cols;
            }
            BatchOracleHelper oracleHelper = new BatchOracleHelper(QuerySession);
            var columnRowData = GetData(domains, cols);
            string[] usedProperies = setCols.Select(expression => expression.PropertyName()).ToArray();//性能不高
            Table table = GetTable(this.DefaultColumnMapperStrategy);
            UpdateBuilder<TDomain> updateBuilder = new UpdateBuilder<TDomain>(table, QuerySession.DatabaseInfo.SqlDialect, domains[0], usedProperies);
            // private string updateTemplate = "UPDATE {0} SET {1} WHERE {2} ";
            var sql = updateBuilder.CreateSql() + where;
            if (string.IsNullOrEmpty(where))
            {
                sql = sql.Substring(0, sql.Length - 7);
            }
            return oracleHelper.BatchInsertOrUpdate(sql, columnRowData);
        }
        /// <summary>
        /// 执行删除
        /// </summary>
        /// <param name="domain"></param>
        /// <param name="whereSql"></param>
        /// <param name="colFilter"></param>
        /// <returns></returns>
        /// <example>Delete(user,"Id=:0",u=>u.ID);</example>
        public virtual int Delete(TDomain domain, string whereSql, params Expression<Func<TDomain, object>>[] colFilter)
        {
            return BatchDelete(new List<TDomain>() { domain }, whereSql, colFilter);
        }
        /// <summary>
        /// 执行批量删除
        /// </summary>
        /// <param name="domains">需要删除的domain</param>
        /// <param name="whereSql">where sql 子句</param>
        /// <param name="colFilter">where 列</param>
        /// <returns></returns>
        public virtual int BatchDelete(List<TDomain> domains, string whereSql, params Expression<Func<TDomain, object>>[] colFilter)
        {
            if (domains.Count == 0)
            {
                return 0;
            }
            BatchOracleHelper oracleHelper = new BatchOracleHelper(QuerySession);
            Table table = GetTable(this.DefaultColumnMapperStrategy);
            DeleteBuilder<TDomain> builder = new DeleteBuilder<TDomain>(table, QuerySession.DatabaseInfo.SqlDialect);
            var sql = builder.CreateSql() + "where " + whereSql;
            var columnRowData = GetData(domains, colFilter);
            return oracleHelper.BatchInsertOrUpdate(sql, columnRowData);
        }
        /// <summary>
        /// 批量查询。where不允许空
        /// </summary>
        /// <typeparam name="TResult"></typeparam>
        /// <param name="domains"></param>
        /// <param name="where">where 子句 绑定索引从0 开始</param>
        /// <param name="rowMapper"></param>
        /// <param name="cols"></param>
        /// <returns></returns>
        public virtual List<TResult> Query<TResult>(List<TDomain> domains, string where, Mapper.IRowMapper<TResult> rowMapper, params Expression<Func<TDomain, object>>[] cols)
        {
            if (domains.Count == 0)
            {
                return null;
            }
            Expression<Func<TDomain, object>>[] selectCols = new Expression<Func<TDomain, object>>[20];
            Expression<Func<TDomain, object>>[] whereCols = new Expression<Func<TDomain, object>>[20];
            if (!string.IsNullOrEmpty(where))
            {
                var whereCount = Regex.Matches(where, @":\d+");
                Ensure.That(whereCount.Count != 0).IsTrue();
                var t = int.Parse(whereCount[whereCount.Count - 1].Value.TrimStart(':')) + 1;
                int s = cols.Length - t;
                selectCols = cols.Take(s).ToArray();
                whereCols = cols.Skip(s).ToArray();
            }
            else
            {
                //苗建龙 添加System.前缀
                throw new System.Exception("where 条件不允许为空");
            }
            BatchOracleHelper oracleHelper = new BatchOracleHelper(QuerySession);
            var columnRowData = GetData(domains, whereCols);
            string[] usedProperies = selectCols.Select(expression => expression.PropertyName()).ToArray();//性能不高
            Table table = GetTable(this.DefaultColumnMapperStrategy);
            SelectBuilder<TDomain> selectBuilder = new SelectBuilder<TDomain>(table, QuerySession.DatabaseInfo.SqlDialect, usedProperies);
            // private string updateTemplate = "UPDATE {0} SET {1} WHERE {2} ";
            var sql = selectBuilder.CreateSql() + where;
            if (string.IsNullOrEmpty(where))
            {
                sql = sql.Substring(0, sql.Length - 7);
            }
            return oracleHelper.Query(sql, columnRowData, rowMapper);
            // throw new NotImplementedException();
        }
        private Dictionary<int, object[]> GetData(List<TDomain> domains, Expression<Func<TDomain, object>>[] cols)
        {
            Dictionary<int, object[]> columnRowData = new Dictionary<int, object[]>();
            int i = 0;
            foreach (var expression in cols)
            {
                object[] objs = domains.Select(expression.Compile()).ToArray();
                var type = expression.GetRightMostMember().Type;
                for (int j = 0; j < objs.Length; j++)
                {
                    if (objs[j] == null)
                    {
#if DEBUG
                        throw new ArgumentNullException(expression.PropertyName(), "批量更新包含空值");
#endif
                        //objs[j] = (object)DBNull.Value;
                        objs[j] = GetDefaultValue(type);
                    }
                }
                columnRowData.Add(i, objs);
                i++;
            }
            return columnRowData;
        }
        /// <summary>
        /// 处理空值 只处理string与日期。其他必须有调用方传入
        /// TODO 空值插入dbnull
        /// </summary>
        /// <param name="type"></param>
        /// <returns></returns>
        public virtual object GetDefaultValue(Type type)
        {
            if (type == typeof(string))
            {
                return "";
            }
            if (type == typeof(DateTime?))
            {
                return DateTime.Now;
            }
            if (type == typeof(int?) || type == typeof(decimal?) || type == typeof(long?) || type == typeof(float?))
            {
                return 0;
            }
            //if (type==typeof(bool?))
            //{
            //    return false;
            //}
            throw new ArgumentException("批量操作遇到不能处理的空值");
        }
        /// <summary>
        /// 插入临时表数据
        /// </summary>
        /// <param name="values"></param>
        /// <param name="colName"></param>
        /// <param name="tableName"></param>
        public int AddTempTable(IEnumerable<object> values, string colName, string tableName = "Global_Temp_Search")
        {
            BatchOracleHelper oracleHelper = new BatchOracleHelper(QuerySession);
            string sql = string.Format("insert into {0}({1}) values(:0)", tableName, colName);
            Dictionary<int, object[]> columnRowData = new Dictionary<int, object[]>();
            columnRowData.Add(0, values.ToArray());
            return oracleHelper.BatchInsertOrUpdate(sql, columnRowData);
        }
    }
}
using Cis.DbLight.TableMetadata;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Linq.Expressions;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
namespace Cis.DbLight.Oracle
{
    public class OracleSqlBuilder
    {
        private const string insertTemplate = "INSERT INTO {0} ({1}) \r\n VALUES ({2})";
        private const string updateTemplate = "UPDATE {0} SET {1} WHERE {2}";
        private const string deleteTemplate = "DELETE FROM {0} WHERE {1}";
        private static Dictionary<string, ColumnAttribute> GetColumnProMap(Type _type)
        {
            Dictionary<string, ColumnAttribute> dict = new Dictionary<string, ColumnAttribute>();
            foreach (var propertyInfo in _type.GetProperties())
            {
                var attribute = propertyInfo.GetCustomAttributes(true).OfType<ColumnAttribute>().FirstOrDefault();
                if (attribute != null)
                {
                    dict.Add(propertyInfo.Name.ToLower(), attribute);
                }
                else
                {
                    dict.Add(propertyInfo.Name.ToLower(), null);
                }
            }
            return dict;
        }
        /// <summary>
        /// 构建插入SQL
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="usedProperies"></param>
        /// <returns></returns>
        public static string InsertBuilder<T>(List<string> usedProperies) where T : class
        {
            string strColumns = "", strValues = "";
            StringBuilder columns = new StringBuilder();
            StringBuilder values = new StringBuilder();
            //获取表名
            TableAttribute table = typeof(T).GetCustomAttributes(true).OfType<TableAttribute>().FirstOrDefault();
            //获取属性名与数据库字段的对象关系
            var proMap = GetColumnProMap(typeof(T));
            //获取主键,如果没有指定插入，则自动添加
            var columnAttributes = proMap.Values.ToList();
            var primaryCols = columnAttributes.FindAll(c => c.IsPrimaryKey);
            foreach (var priCols in primaryCols)
            {
                if (!usedProperies.Contains(priCols.ColumnName, StringComparer.OrdinalIgnoreCase))
                {
                    usedProperies.Add(priCols.ColumnName);
                }
            }
            //构造插入列和值，判断是不是是数据库自动插入和自动生成列
            foreach (var item in usedProperies)
            {
                if (proMap.ContainsKey(item.ToLower()))
                {
                    IColumn col = proMap[item.ToLower()];
                    if (col.IsAutoInsert)
                    {
                        continue;
                    }
                    columns.AppendFormat("{0},", col.ColumnName);
                    if (!col.IsSqlGenColumn)
                    {
                        values.AppendFormat(":{0},", item);
                    }
                    else
                    {
                        values.AppendFormat("{0},", col.GetSql());
                    }
                }
            }
            if (columns.Length > 0)
            {
                strColumns = columns.ToString().Substring(0, columns.Length - 1);
                strValues = values.ToString().Substring(0, values.Length - 1);
            }
            return string.Format(insertTemplate, table.Name, strColumns, strValues);
        }
        /// <summary>
        /// 构建更新SQL
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="where"></param>
        /// <param name="usedProperies"></param>
        /// <returns></returns>
        public static string UpateBuilder<T>(string where, List<string> usedProperies) where T : class
        {
            List<string> cols = new List<string>();
            TableAttribute table = typeof(T).GetCustomAttributes(true).OfType<TableAttribute>().FirstOrDefault();
            var proMap = GetColumnProMap(typeof(T));
            var whereCount = Regex.Matches(where, @":\S+[\s\)]?");
            var count = whereCount.Count;
            if (count < 1)
            {
                throw new ArgumentException("update 没有 where 条件.");
            }
            for (int i = 0; i < usedProperies.Count - count; i++)
            {
                var item = usedProperies[i];
                if (proMap.ContainsKey(item.ToLower()))
                {
                    var temp = proMap[item.ToLower()].ColumnName + "=:" + item;
                    if (!cols.Contains(temp))
                    {
                        cols.Add(temp);
                    }
                }
            }
            return string.Format(updateTemplate, table.Name, string.Join(",", cols), where);
        }
        /// <summary>
        /// 构建删除SQL
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="usedProperies"></param>
        /// <returns></returns>
        public static string DeleteBuilder<T>(string where) where T : class
        {
            TableAttribute table = typeof(T).GetCustomAttributes(true).OfType<TableAttribute>().FirstOrDefault();
            return string.Format(deleteTemplate, table.Name, where);
        }
    }
}
#region copyright
// <copyright file="AliasAttribute.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-17</datecreated>
#endregion
namespace Cis.DbLight.TableMetadata
{
    using System;
    /// <summary>
    /// 属性映射为别名,非真实列。update，insert 不处理这种类型的列 
    /// todo 是否去掉此attribute ，保持简单
    /// </summary>
    /// <remarks>尽量通过 column as alias，而不是通过attribute固定在domain中</remarks>
    [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)]
    public class AliasAttribute : ColumnAttribute
    {
        #region Constructors and Destructors
        public AliasAttribute(string aliasName)
            : base(aliasName,false,false,true)
        {
        }
        #endregion
        #region Public Properties
        public string AliasName
        {
            get
            {
                return this.ColumnName;
            }
            set
            {
                this.ColumnName = value;
            }
        }
        #endregion
    }
}using System;
namespace Cis.DbLight.TableMetadata
{
    public class Class1
    {
    }
}
#region copyright
// <copyright file="Column.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-18</datecreated>
#endregion
namespace Cis.DbLight.TableMetadata
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text;
    /// <summary>
    /// TODO: Update summary.
    /// </summary>
    public class Column : IColumn
    {
        private string columnName;
        
        
        ///// <summary>
        ///// 编码后的列名，防止列名与关键字相同[]
        ///// </summary>
        //public string EncodeColumnName
        //{
        //    get
        //    {
        //        return "[" + columnName + "]";
        //    }
        //}
        public string ColumnName
        {
            get
            {
                return this.columnName;
            }
            set
            {
              
                this.columnName = value;
            }
        }
        public bool IsComplex { get; set; }
        public string PropertyName { get; set; }
        public Type PropertyType { get; set; }
        public bool IsPrimaryKey { get; set; }
        public bool IsSqlGenColumn { get; set; }
        public bool IsAliasColumn { get; set; }
        public bool IsAutoInsert { get; set; }
        public string GetSql()
        {
            return ColumnName;
        }
        public override string ToString()
        {
            return this.GetSql();
        }
       
    }
}
#region copyright
// <copyright file="ColumnAttribute.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-17</datecreated>
#endregion
namespace Cis.DbLight.TableMetadata
{
    using System;
    /// <summary>
    /// 映射属性名称到列名
    /// </summary>
    //[Serializable]
    [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)]
    public class ColumnAttribute : Attribute, IColumn
    {
        #region Fields
        protected bool isPrimaryKey;
        protected bool isSqlGenColumn;
        protected bool isAliasColumn;
        #endregion
        #region Constructors and Destructors
        /// <summary>
        /// 编码后的列名，防止列名与关键字相同[]
        /// </summary>
        public string EncodeColumnName
        {
            get
            {
                return "[" + ColumnName + "]";
            }
        }
        public ColumnAttribute(string columnName):this(columnName,false,false,false)
        {
            
        }
        protected ColumnAttribute(string columnName, bool isPrimaryKey, bool isSqlGenColumn, bool isAliasColumn)
        {
            this.isPrimaryKey = isPrimaryKey;
            this.isSqlGenColumn = isSqlGenColumn;
            this.isAliasColumn = isAliasColumn;
            this.ColumnName = columnName;
        }
        /// <summary>
        /// 本对象中存在的列名
        /// </summary>
        public string ColumnName { get; set; }
        #endregion
        #region Public Properties
        public Type PropertyType { get; set; }
        public bool IsPrimaryKey
        {
            get
            {
                return this.isPrimaryKey;
            }
            set
            {
                this.isPrimaryKey = value;
            }
        }
        public bool IsSqlGenColumn
        {
            get
            {
                return this.isSqlGenColumn;
            }
            set
            {
                this.isSqlGenColumn = value;
            }
        }
        public bool IsComplex { get; set; }
        /// <summary>
        /// 列对应的属性名称
        /// </summary>
        public string PropertyName { get; set; }
       // public object DefaultValue { get; set; }
        #endregion
        #region Public Methods and Operators
        public virtual string GetSql()
        {
            return this.EncodeColumnName;
        }
        public override string ToString()
        {
            return this.GetSql();
        }
        #endregion
        public bool IsAliasColumn
        {
            get
            {
                return this.isAliasColumn;
            }
            set
            {
                this.isAliasColumn = value;
            }
           
        }
        public bool IsAutoInsert { get; set; }
    }
}#region copyright
// <copyright file="IColumn.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-17</datecreated>
#endregion
using System;
namespace Cis.DbLight.TableMetadata
{
    /// <summary>
    /// TODO: Update summary.
    /// </summary>
    public interface IColumn
    {
        /// <summary>
        ///// 编码后的列名，防止列名与关键字相同[]
        ///// </summary>
        // string EncodeColumnName { get; }
         string ColumnName { get; set; }
         string PropertyName { get; set; }
        //domain 中定义，如果数据库定义了默认值则domain中指定相同值。update inset时，也更新，不做区分
       //  object DefaultValue { get; set; }
         bool IsPrimaryKey { get; set; }
        //sequenc
        /// <summary>
        /// 列值是否通过数据库产生
        /// </summary>
        bool IsSqlGenColumn { get; set; }
        /// <summary>
        /// 新增时，是否需要框架处理此列。自动增长列不需要框架处理
        /// </summary>
        bool IsAutoInsert { get; set; }
        /// <summary>
        /// 列是否是别名，别名列不是数据库中是实际列
        /// </summary>
         bool IsAliasColumn { get; set; }
        //通过convention
        /// <summary>
         /// 复杂类型，不是真实列IsAliasColumn=true
        /// </summary>
        bool IsComplex{ get; set; }
        /// <summary>
         /// 返回列名，对于IsSqlGenColumn，返回sql语句
        /// </summary>
        /// <returns></returns>
        string GetSql();
        Type PropertyType { get; set; }
    }
}
#region copyright
// <copyright file="PrimaryKeyAttribute.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-26</datecreated>
#endregion
namespace Cis.DbLight.TableMetadata
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text;
    /// <summary>
    /// 主键
    /// 通过属性名称映射与通过attribute映射都需要知道数据库主键，update用到
    /// </summary>
    [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)]
    public abstract class PrimaryKeyAttribute:ColumnAttribute
    {
        protected PrimaryKeyAttribute(string columnName, bool isSqlGenColumn)
            : base(columnName, true, isSqlGenColumn, false)
        {
            
        }
    }
    /// <summary>
    /// sqlserver 自动增长列
    /// </summary>
    public class AutoGenerateIdAttribute : PrimaryKeyAttribute
    {
        public AutoGenerateIdAttribute(string columnName)
            : base(columnName,true)
        {
            IsAutoInsert = true;
        }
        /// <summary>
        /// 返回null
        /// </summary>
        /// <returns></returns>
        public override string GetSql()
        {
            return null;
        }
    }
    /// <summary>
    ///主键通过赋值方式产生
    /// </summary>
    [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)]
    public class AssignIdAttribute : PrimaryKeyAttribute
    {
        public AssignIdAttribute(string columnName)
            : base(columnName, false)
        {
        }
    }
}
#region copyright
// <copyright file="SequenceIdAttribute.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-17</datecreated>
#endregion
namespace Cis.DbLight.TableMetadata
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text;
    /// <summary>
    /// 主键通过Sequence方式产生
    /// </summary>
    [AttributeUsage(AttributeTargets.Property,AllowMultiple = false)]
    public class SequenceIdAttribute : PrimaryKeyAttribute
    {
        /// <summary>
        /// 
        /// </summary>
        /// <param name="columnName"></param>
        /// <param name="sequence"></param>
        public SequenceIdAttribute(string columnName, string sequence)
            : base(columnName, true)
        {
            this.Sequence = sequence;
        }
        /// <summary>
        /// oracle Sequece name，使用sequence产生iD
        /// </summary>
        public string Sequence { get; set; }
        public override string GetSql()
        {
            return Sequence;
        }
    }
   
}
#region copyright
// <copyright file="TableAttribute.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-12-17</datecreated>
#endregion
namespace Cis.DbLight.TableMetadata
{
    using System;
    using System.Collections.Generic;
    /// <summary>
    /// 表信息
    /// </summary>
    [AttributeUsage(AttributeTargets.Class | AttributeTargets.Struct, Inherited = false, AllowMultiple = false)]
    public class TableAttribute : Attribute
    {
        #region Fields
        
        #endregion
        #region Constructors and Destructors
        public TableAttribute(string name)
        {
            this.Name = name;
        }
        #endregion
        #region Public Properties
        public string Name { get; set; }
        #endregion
    }
    /// <summary>
    /// Dto信息
    /// </summary>
    [AttributeUsage(AttributeTargets.Class | AttributeTargets.Struct, Inherited = false, AllowMultiple = false)]
    public class DtoAttribute : Attribute
    {
        public DtoAttribute()
        {
           
        }
    }
}using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
namespace Cis.DbLight.TableMetadata.External
{
    /// <summary>
    /// 组合属性
    /// </summary>
    [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)]
    public class CompositeAttribute : Attribute
    {
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
namespace Cis.DbLight.TableMetadata.External
{
    /// <summary>
    /// 一对多关系
    /// </summary>
    [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)]
    public class OneToManyAttribute : RelationId
    {
        /// <summary>
        /// </summary>
        /// <param name="columnName">本实体中的列名</param>
        /// <param name="relationColumnName">关系实体中的相应列名</param>
        public OneToManyAttribute(string columnName, string relationColumnName)
            : base(columnName)
        {
            this.ColumnName = columnName;
            this.RelationColumnName = relationColumnName;
        }
        /// <summary>
        /// 关联表列的名称
        /// </summary>
        public string RelationColumnName { get; set; }
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
namespace Cis.DbLight.TableMetadata.External
{
    /// <summary>
    /// 一对一
    /// </summary>
    [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)]
    public class OneToOneAttribute : RelationId
    {
        /// <summary>
        /// 一对一关系
        /// </summary>
        /// <param name="columnName">本实体类列名</param>
        /// <param name="relationColumnName">关联实体类列名</param>
        public OneToOneAttribute(string columnName, string relationColumnName)
            : base(columnName)
        {
            this.ColumnName = columnName;
            this.RelationColumnName = relationColumnName;
        }
        /// <summary>
        /// 关联表列的名称
        /// </summary>
        public string RelationColumnName { get; set; }
    }
}
// -----------------------------------------------------------------------
// <copyright file="Class1.cs" company="">
// TODO: Update copyright text.
// </copyright>
// -----------------------------------------------------------------------
namespace Cis.DbLight.TableMetadata.External
{
    using System;
    /// <summary>
    /// 不支持，仅支持自动加载、自动更新删除插入时才有意义。如果使用会被当做ColumnAttribute处理，无关系含义
    /// 关系键：建立与其他表的关联,如外键  
    /// </summary>
    [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)]
    public class RelationId : ColumnAttribute
    {
        public RelationId(string columnName)
            : base(columnName, false, false, false)
        {
            
        }
        //public string PropertyName { get; set; }
    }
    [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)]
    public class ManyToOne : RelationId
    {
        /// <summary>
        /// 
        /// </summary>
        /// <param name="columnName">本实体中的列名</param>
        /// <param name="relationColumnName">关系实体中的相应列名</param>
        public ManyToOne(string columnName, string relationColumnName)
            : base(columnName)
        {
            this.RelationColumnName = relationColumnName;
            //this.RelationTable = relationTableName;
        }
        public string RelationColumnName { get; set; }
        //public string PropertyName { get; set; }
    }
    [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)]
    public class OneToMany : RelationId
    {
        /// <summary>
        /// 
        /// </summary>
        /// <param name="columnName">本实体中的列名</param>
        /// <param name="relationColumnName">关系实体中的相应列名</param>
        public OneToMany(string columnName, string relationColumnName)
            : base(columnName)
        {
            this.RelationColumnName = relationColumnName;
            //this.RelationTable = relationTableName;
        }
        public string RelationColumnName { get; set; }
        /// <summary>
        /// 关系表名称
        /// </summary>
        public string RelationTable { get; set; }
    }
    /// <summary>
    /// 只支持只有键值的关系表。
    /// 否则需要将关系表映射为实体，不需要manytomany映射
    /// </summary>
    [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)]
    public class ManyToMany : RelationId
    {
        /// <summary>
        /// 
        /// </summary>
        /// <param name="columnName">本实体中的列名</param>
        /// <param name="relationColumnName">关系实体中的相应列名</param>
        /// <param name="relationTableName">关系表名</param>
        public ManyToMany(string columnName, string relationColumnName,string relationTableName)
            : base(columnName)
        {
            this.RelationColumnName = relationColumnName;
            this.RelationTable = relationTableName;
        }
        public string RelationColumnName { get; set; }
        /// <summary>
        /// 关系表名称
        /// </summary>
        public string RelationTable { get; set; }
        //public string PropertyName { get; set; }
    }
    //关系涉及到两端的导航性。如order.User ,User.Orders,如果映射涉及到许多自动生成sql，容易影响性能
    //一端导航性如：order.User 
    //无导航性如order.UserInfoID
    //同时使用UserInfoID与UserInfo，不使用导航时使用UserInfoID，性能最好。需要导航时，使用UserInfo。UserInfoID优先级高
    //只使用UserInfo。不使用导航时，UserInfo.ID。多实例化一个对象。
    //只使用UserInfoID，不支持导航
    /**************/
    //关系映射推荐用法：
    //不使用自动关系加载支持:自动关系加载可以通过aop实现
    //同时使用UserInfoID与UserInfo。默认只加载serInfoID， 关系的导航对象通过到手动加载,RelationId也不需要。而非自动。
}
using Cis.Infrastructure.Reflection;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
namespace Cis.Excel
{
    public static class AearExcelModelFactory
    {
        public static T GetAreaExcelModel<T>(string area) where T : new()
        {
            if (string.IsNullOrEmpty(area))
                return new T();
            var name = typeof(T).Name;
            Type type = Type.GetType(string.Format("Cis.Excel.{0}.{0}{1}", area, name));
            if (type == null)
                return new T();
            else
            {
                var dao = Reflection.CreateInstance(type);
                if (dao == null)
                    return new T();
                else
                {
                    return (T)dao;
                }
            }
        }
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
namespace Cis.Excel
{
    public class ChildModel
    {
        /// <summary>
        ///子模板所在行数
        /// </summary>
        public int RowNumber { get; set; }
        /// <summary>
        /// 数据数量
        /// </summary>
        public int DataCount { get; set; }
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.IO;
using System.Threading.Tasks;
using System.Xml;
using NPOI.HSSF.UserModel;
using NPOI.SS.UserModel;
using Cis.Log;
namespace Cis.Excel
{
    public class CopyModel
    {
        /// <summary>
        /// 根据模板生成EXCEL文件
        /// </summary>
        /// <param name="modelPath">模板所在路劲</param>
        /// <param name="filePath">Excel文件路劲</param>
        /// <param name="param">参数</param>
        public MemoryStream BuildExcel(string modelPath, List<ModelParameter> paramList)
        {
            try
            {
                HSSFWorkbook tsmpWorkbook = this.BuildWorkbook(modelPath, paramList);
                MemoryStream ms = new MemoryStream();
                tsmpWorkbook.Write(ms);
                ms.Flush();
                ms.Position = 0;
                return ms;
            }
            catch (Exception ex)
            {
                Logger.Log(Level.Error, ex.ToString());
                return null;
            }
        }
        
        /// <summary>
        /// 根据模板生成XmlDocument
        /// </summary>
        /// <param name="modelPath"></param>
        /// <param name="paramList"></param>
        /// <returns></returns>
        public XmlDocument BuildXmlDoc(string modelPath, List<ModelParameter> paramList)
        {
            try
            {
                HSSFWorkbook tsmpWorkbook = this.BuildWorkbook(modelPath, paramList);
                
                return new ExcelConverter().XlsToXmlDocument(tsmpWorkbook);
            }
            catch (Exception ex)
            {
                Logger.Log(Level.Error, ex.ToString());
                return null;
            }
        }
        #region  私有方法
        /// <summary>
        /// 根据模板生成workbook
        /// </summary>
        /// <param name="modelPath">模板所在路径</param>
        /// <param name="paramList">模板替换参数</param>
        /// <returns></returns>
        private HSSFWorkbook BuildWorkbook(string modelPath, List<ModelParameter> paramList)
        {
            try
            {
                Dictionary<int, int> childModels = new Dictionary<int, int>();
                //处理子模板参数，由模板中的所在行数转换为实际所在行数
                foreach (var t in paramList)
                {
                    childModels.Clear();
                    if (t.SubModels != null && t.SubModels.Count > 1)
                    {
                        foreach (var dc in t.SubModels)
                        {
                            
                            if (dc.Value.DataCount == 0)
                            {
                                foreach(var d in t.SubModels)
                                {
                                    if (d.Key > dc.Key)
                                    {
                                        d.Value.RowNumber -= 1;
                                    }
                                }
                            }
                            else
                            {
                                foreach (var d in t.SubModels)
                                {
                                    if (d.Key > dc.Key)
                                    {
                                        d.Value.RowNumber += dc.Value.DataCount-1;
                                    }
                                }
                            }
                            childModels.Add(dc.Value.RowNumber,dc.Value.DataCount);
                            t.ChildModels = childModels;
                        }
                    }
                }
                HSSFWorkbook tsmpWorkbook = new HSSFWorkbook();
                //把指定路劲下的Excel模板文件读入到workbook变量里
                HSSFWorkbook wk = null;
                using (FileStream fs = File.Open(modelPath, FileMode.Open, FileAccess.Read, FileShare.ReadWrite))
                {
                    wk = new HSSFWorkbook(fs);
                    fs.Close();
                }
                //遍历每个模板参数并生成响应的Sheet
                foreach (ModelParameter p in paramList)
                {
                    var keys = p.KeyValues.Keys;
                    var cpSheet = wk.GetSheet(p.ModelName) as HSSFSheet;
                    cpSheet.CopyTo(tsmpWorkbook, p.SheetName, true, true);
                    //遍历所有sheet页并根据字典中的值更新相应的单元格
                    var sheet = tsmpWorkbook.GetSheet(p.SheetName);
                    for (int j = 0; j < sheet.LastRowNum; j++)
                    {
                        var row = sheet.GetRow(j);
                        //拷贝子模板并生成相应数据
                        if (p.ChildModels!=null&&p.ChildModels.Keys.Contains(j))
                        {
                            if (p.ChildModels[j] == 0)
                            {
                                sheet.ShiftRows(j+1,sheet.LastRowNum,-1);
                            }
                            else
                            {
                                for (int s = 1; s < p.ChildModels[j]; s++)
                                {
                                    var newRow = sheet.CopyRow(j, j + s);
                                    for (int h = 0; h < newRow.LastCellNum; h++)
                                    {
                                        var cell = newRow.GetCell(h);
                                        if (cell != null)
                                        {
                                            string cellvalue = this.GetCellStringValue(cell) + s;
                                            if (keys.Contains(cellvalue))
                                            {
                                                var value = p.KeyValues[cellvalue];
                                                if (value != null)
                                                    cell.SetCellValue(value);
                                            }
                                            else
                                            {
                                                //如果单元格内容中有嵌套key,则解析并替换key的值
                                                string pattern = @"\{.*?\}";
                                                Regex regex = new Regex(pattern, RegexOptions.IgnoreCase);
                                                MatchCollection matches = regex.Matches(cellvalue);
                                                foreach (Match match in matches)
                                                {
                                                    string olderValue = match.Value;
                                                    string key = match.Value.Trim('{', '}');
                                                    if (keys.Contains(key))
                                                        cellvalue = cellvalue.Replace(olderValue, Convert.ToString(p.KeyValues[key]));
                                                }
                                                cell.SetCellValue(cellvalue);
                                            }
                                        }
                                    }
                                }
                            }
                            
                        }
                        //处理行数据
                        for (int k = 0; k < row.LastCellNum; k++)
                        {
                            var cell = row.GetCell(k);
                            if (cell != null)
                            {
                                string cellvalue = this.GetCellStringValue(cell);
                                if (keys.Contains(cellvalue))
                                {
                                    var value = p.KeyValues[cellvalue];
                                    if (value != null)
                                        cell.SetCellValue(value);
                                }
                                else
                                {
                                    //如果单元格内容中有嵌套key,则解析并替换key的值
                                    string pattern = @"\{.*?\}";
                                    Regex regex = new Regex(pattern, RegexOptions.IgnoreCase);
                                    MatchCollection matches = regex.Matches(cellvalue);
                                    foreach (Match match in matches)
                                    {
                                        string olderValue = match.Value;
                                        string key = match.Value.Trim('{', '}');
                                        if (keys.Contains(key))
                                            cellvalue = cellvalue.Replace(olderValue, Convert.ToString(p.KeyValues[key]));
                                    }
                                    cell.SetCellValue(cellvalue);
                                }
                            }
                        }
                    }
                }
                return tsmpWorkbook;
            }
            catch (Exception ex)
            {
                Logger.Log(Level.Error, ex.ToString());
                return null;
            }
        }
        /// <summary>
        /// 获取Excel单元格string类型的值
        /// </summary>
        /// <param name="cell"></param>
        /// <returns></returns>
        private string GetCellStringValue(ICell cell)
        {
            string tempValue = "";
            switch (cell.CellType)
            {
                case CellType.Blank:
                    break;
                case CellType.Boolean:
                    tempValue = cell.BooleanCellValue.ToString();
                    break;
                case CellType.Error:
                    break;
                case CellType.Formula:
                    tempValue = cell.CellFormula.ToString();
                    break;
                case CellType.Numeric:
                    tempValue = cell.NumericCellValue.ToString();
                    break;
                case CellType.String:
                    tempValue = cell.StringCellValue.ToString();
                    break;
                case CellType.Unknown:
                    break;
                default:
                    break;
            }
            return tempValue;
        }
        #endregion  私有方法
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
namespace Cis.Excel
{
    public enum EnumCellType
    {
        Left =0,
        Center =1,
        Right =2
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
namespace Cis.Excel
{
    public enum EnumDataType
    {
        Default = 0,
        Number = 1,
        Text = 2,
        General = 3
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
namespace Cis.Excel
{
    public enum EnumExcelModel
    {
        Comm =0,
        BillInfo =1 
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
namespace Cis.Excel
{
    public enum EnumVerticalType
    {
        Top =0,
        Center =1,
        Below =2
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
namespace Cis.Excel
{
    public class ExcelCell
    {
        #region 字段
        private int cellCount = 1;
        private int cellRowCount = 1;
        private bool isAddBording = true;
        private EnumDataType dataType = EnumDataType.Default;
        private int digit = 0;
        #endregion
        #region 属性
        /// <summary>
        /// 单元格值
        /// </summary>
        public string CellValue { get; set; }
        /// <summary>
        /// 是否为标题
        /// </summary>
        public bool IsTitle{get;set;}
        /// <summary>
        /// 是否为标题
        /// </summary>
        public bool IsCaption { get; set; }
        /// <summary>
        /// 是否为报表表头
        /// </summary>
        public bool IsReportTitle { get; set; }
        /// <summary>
        /// 需要合并的行数
        /// </summary>
        public int CellRowCount
        {
            get { return this.cellRowCount; }
            set
            {
                this.cellRowCount = value;
            }
        }
        
        /// <summary>
        /// 合并单元格数
        /// </summary>
        public int CellCount
        {
            get { return this.cellCount; }
            set { this.cellCount = value; }
        }
        /// <summary>
        /// 相对于该单元的标题行在第几行
        /// </summary>
        public int RowNumber{get;set;}
        /// <summary>
        /// 起始单元格
        /// </summary>
        public int CellNumber{get;set;}
        /// <summary>
        /// 单元格样式枚举
        /// </summary>
        public EnumCellType CellType { get; set; } = EnumCellType.Left;
        /// <summary>
        /// 是否添加边框
        /// </summary>
        public Boolean IsAddBording
        {
            get { return this.isAddBording; }
            set
            {
                if (this.isAddBording != value)
                {
                    this.isAddBording = value;       
                }
            }
        }
        /// <summary>
        /// 单元格数据类型
        /// </summary>
        public EnumDataType DataType
        {
            get { return this.dataType; }
            set
            {
                if (this.dataType != value)
                {
                    this.dataType = value;
                }
            }
        }
        /// <summary>
        /// 单元格小数位数
        /// </summary>
        public int Digit
        {
            get { return this.digit; }
            set { this.digit = value; }
        }
        public bool IsRMB { get; set; }
        /// <summary>
        /// 字体大小
        /// </summary>
        public short FontSize { get; set; } = 10;
        /// <summary>
        /// 垂直方向样式
        /// </summary>
        public EnumVerticalType VerticalType { get; set; } = EnumVerticalType.Center;
        #endregion
    }
}
#region copyright
// <copyright file="ExcelConverter"  company="CIS"> 
// Copyright (c) CIS. All Right Reserved
// </copyright>
// <author>hankk</author>
// <datecreated>2017/12/26 8:56:05</datecreated>
#endregion
using NPOI.HSSF.UserModel;
using NPOI.SS.UserModel;
using NPOI.XSSF.UserModel;
using System;
using System.Collections.Generic;
using System.Data;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Xml;
using NPOI.SS.Converter;
namespace Cis.Excel
{
    public class ExcelConverter
    {
        public DataSet GetDataSet(string path, int skipRows)
        {
            using (DataSet ds = new DataSet())
            {
                using (FileStream fileStream = new FileStream(path, FileMode.Open, FileAccess.Read))
                {
                    try
                    {
                        IWorkbook workbook = null;  //???IWorkbook????  
                        if (path.IndexOf(".xlsx") > 0) // 2007?汾  
                        {
                            workbook = new XSSFWorkbook(fileStream);  //xlsx???????workbook  
                        }
                        else if (path.IndexOf(".xls") > 0) // 2003?汾  
                        {
                            workbook = new HSSFWorkbook(fileStream);  //xls???????workbook  
                        }
                        var sheetCount = workbook.NumberOfSheets;
                        for (int i = 0; i < sheetCount; ++i)
                        {
                            ISheet sheet = workbook.GetSheetAt(i);
                            DataTable dt = GetDataTable(sheet, skipRows);
                            ds.Tables.Add(dt);
                        }
                    }
                    catch (System.Exception ex)
                    {
                        throw;
                    }
                    return ds;
                }
            }
        }
        private DataTable GetDataTable(ISheet sheet, int skipRows)
        {
            using (DataTable dt = new DataTable())
            {
                IRow firstRow = sheet.GetRow(0 + skipRows);
                int cellCount = GetCellCount(sheet);
                for (int i = 0; i < cellCount; i++)
                {
                    if (firstRow.GetCell(i) != null)
                    {
                        dt.Columns.Add(firstRow.GetCell(i).StringCellValue ?? string.Format("F{0}", i + 1), typeof(string));
                    }
                    else
                    {
                        dt.Columns.Add(string.Format("F{0}", i + 1), typeof(string));
                    }
                }
                for (int i = 1 + skipRows; i <= sheet.LastRowNum; i++)
                {
                    IRow row = sheet.GetRow(i);
                    DataRow dr = dt.NewRow();
                    FillDataRow(row, ref dr);
                    dt.Rows.Add(dr);
                }
                dt.TableName = sheet.SheetName;
                return dt;
            }
        }
        private void FillDataRow(IRow row, ref DataRow dr)
        {
            if (row != null)
            {
                for (int j = 0; j < dr.Table.Columns.Count; j++)
                {
                    ICell cell = row.GetCell(j);
                    if (cell != null)
                    {
                        switch (cell.CellType)
                        {
                            case CellType.Blank:
                                dr[j] = DBNull.Value;
                                break;
                            case CellType.Boolean:
                                dr[j] = cell.BooleanCellValue;
                                break;
                            case CellType.Numeric:
                                if (DateUtil.IsCellDateFormatted(cell))
                                {
                                    dr[j] = cell.DateCellValue;
                                }
                                else
                                {
                                    dr[j] = cell.NumericCellValue;
                                }
                                break;
                            case CellType.String:
                                dr[j] = cell.StringCellValue;
                                break;
                            case CellType.Error:
                                dr[j] = cell.ErrorCellValue;
                                break;
                            case CellType.Formula:
                                // cell = evaluator.EvaluateInCell(cell) as HSSFCell;
                                dr[j] = cell.ToString();
                                break;
                            default:
                                throw new NotSupportedException(string.Format("Catched unhandle CellType[{0}]", cell.CellType));
                        }
                    }
                }
            }
        }
        private static int GetCellCount(ISheet sheet)
        {
            int firstRowNum = sheet.FirstRowNum;
            int cellCount = 0;
            for (int i = sheet.FirstRowNum; i <= sheet.LastRowNum; ++i)
            {
                IRow row = sheet.GetRow(i);
                if (row != null && row.LastCellNum > cellCount)
                {
                    cellCount = row.LastCellNum;
                }
            }
            return cellCount;
        }
        /// <summary>
        /// xls?html
        /// </summary>
        /// <param name="workbook"></param>
        /// <returns></returns>
        public XmlDocument XlsToXmlDocument(IWorkbook workbook, ExcelToHtmlConverter excelToHtmlConverter = null)
        {
            if (excelToHtmlConverter == null)
            {
                excelToHtmlConverter = new ExcelToHtmlConverter();
                
                //set output parameter
                excelToHtmlConverter.OutputColumnHeaders = false;
                excelToHtmlConverter.OutputHiddenColumns = false;
                excelToHtmlConverter.OutputHiddenRows = false;
                excelToHtmlConverter.OutputLeadingSpacesAsNonBreaking = false;
                excelToHtmlConverter.OutputRowNumbers = false;
                excelToHtmlConverter.UseDivsToSpan = false;
            }
            //process the excel file
            excelToHtmlConverter.ProcessWorkbook(workbook);
            //output the html file
            return excelToHtmlConverter.Document;
        }
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
namespace Cis.Excel
{
    public class ExcelParameters
    {
        #region 字段
        private int maxSheet = 5;
        private int sheetSize = 10000;
        #endregion
        /// <summary>
        ///gridExcel参数
        /// </summary>
        public List<GridExcelParam> GridExcelParam { get; set; }
        /// <summary>
        /// SingleExcel参数
        /// </summary>
        public SingleExcelParam SingleExcelParam { get; set; }
        /// <summary>
        /// 多个Sheet参数列表
        /// </summary>
        public List<MultipleExcelParam> MultipleExcelParam { get; set; }
        /// <summary>
        /// 一个workBook的最大Sheet数
        /// </summary>
        public int MaxSheet
        {
            get { return this.maxSheet; }
            set { this.maxSheet = value; }
        }
        /// <summary>
        /// 一个Sheet最大行数
        /// 默认是10000
        /// </summary>
        public int SheetSize
        {
            get { return this.sheetSize; }
            set { this.sheetSize = value; }
        }
        /// <summary>
        /// 文件保存路劲
        /// </summary>
        public string FilePath { get; set; }
    }
}
using System;
using System.Collections.Generic;
using System.IO;
using NPOI.HSSF.UserModel;
using Cis.Log;
namespace Cis.Excel
{
    public class ExcelProcess
    {
        #region 私有成员
        private  List<HSSFWorkbook> workbooks = new List<HSSFWorkbook>();
        private int maxSheet;
        private int sheetSize;
        private int beginSheet =1;
        #endregion
        #region 私有方法
        /// <summary>
        /// 获取Excel流
        /// </summary>
        /// <param name="workbook"></param>
        /// <returns></returns>
        private MemoryStream GetExcelStream(ExcelParameters param)
        {
            if (param.SingleExcelParam != null)
                this.CreateSingleExcel(param.SingleExcelParam, this.workbooks[0]);
            if (param.GridExcelParam != null && param.GridExcelParam.Count > 0)
            {
                foreach (GridExcelParam gp in param.GridExcelParam)
                {
                    gp.Excel.CreateExcel(gp, this.workbooks);
                }
            }
            if (param.MultipleExcelParam != null && param.MultipleExcelParam.Count > 0)
            {
                new MultipleExcel().CreateExcel(param.MaxSheet, this.workbooks, param.MultipleExcelParam);
            }
            MemoryStream ms = new MemoryStream();
            workbooks.ForEach(p => p.Write(ms));
            ms.Flush();
            ms.Position = 0;
            return ms;
        }
        /// <summary>
        /// 创建就诊信息Excel
        /// </summary>
        /// <param name="singleSource"></param>
        private void CreateSingleExcel(SingleExcelParam source,HSSFWorkbook book)
        {
            if (source == null || book == null)
                return;
            SingleExcel excel = new SingleExcel();
            excel.Param.SheetName = source.SheetName;
            excel.Param.SingleSource = source.SingleCells;
            excel.Param.WorkBook = book;
            excel.Param.Caption = source.Caption;
            excel.Param.CellWides = source.CellWides;
            excel.Param.CaptionCellCount = source.CaptionCellCount;
            this.beginSheet = excel.CreateSheet();
        }
        /// <summary>
        /// 获取ExcelWorkBooks
        /// </summary>
        /// <param name="sources"></param>
        private void GetExcelWorkBooks(ExcelParameters param)
        {
            try
            {
                IExcel Excel = AearExcelModelFactory.GetAreaExcelModel<GridExcel>("");
                int num = 0;
                if (param.SingleExcelParam == null && param.GridExcelParam == null)
                    return;
                if (param.SingleExcelParam != null)
                    num++;
                if (param.GridExcelParam != null && param.GridExcelParam.Count > 0)
                    foreach (GridExcelParam p in param.GridExcelParam)
                    {
                        p.BeginSheet = num;
                        num += ((p.DataSource.Count + param.SheetSize) - 1) / param.SheetSize;
                        p.EndSheet = num - 1;
                        p.MaxSheet = param.MaxSheet;
                        p.SheetSize = param.SheetSize;
                        p.Excel = Excel;
                    }
                decimal temnum = (decimal)num / maxSheet;
                int wbNum = (int)Math.Ceiling(temnum);
                for (int i = 0; i < wbNum; i++)
                {
                    workbooks.Add(new HSSFWorkbook());
                }
            }
            catch (Exception ex)
            {
                Logger.Log(Level.Error,ex.ToString());
            }
            
        }
        /// <summary>
        /// 获取Book数量
        /// </summary>
        /// <param name="param"></param>
        private void GetMultipleWorkBooks(ExcelParameters param)
        {
            try
            {
                if (param.MultipleExcelParam != null && param.MultipleExcelParam.Count > 0)
                {
                    int index = 1;
                    foreach (var p in param.MultipleExcelParam)
                    {
                        p.BookIndex = (index + param.MaxSheet - 1)/param.MaxSheet-1;
                        index++;
                    }
                    //for (int i = 0; i < param.MultipleExcelParam.Count; i++)
                    //{
                    //    workbooks.Add(new HSSFWorkbook());
                    //}
                    decimal temnum = (decimal)(param.MultipleExcelParam.Count+param.MaxSheet-1)/ maxSheet;
                    int wbNum = (int)Math.Ceiling(temnum);
                    for (int i = 0; i < wbNum; i++)
                    {
                        workbooks.Add(new HSSFWorkbook());
                    }
                }
            }
            catch (Exception ex)
            {
                Logger.Log(Level.Error, ex.ToString());
            }
        }
        /// <summary>
        /// 获取文件流
        /// </summary>
        private MemoryStream GetWorkBookStream(HSSFWorkbook workbook)
        {
            using (MemoryStream ms = new MemoryStream())
            {
                workbook.Write(ms);
                ms.Flush();
                ms.Position = 0;
                return ms;
            }
        }
        /// <summary>
        /// 获取Excel流
        /// </summary>
        /// <returns></returns>
        private void GetMultipleStream(ExcelParameters param)
        {
            if (param.MultipleExcelParam != null)
                new MultipleExcel().CreateExcel(param.MaxSheet, this.workbooks, param.MultipleExcelParam);
            for (int i = 0; i < this.workbooks.Count; i++)
            {
                HSSFWorkbook bk = workbooks[i];
                MemoryStream ms = this.GetWorkBookStream(bk);
                string name = param.FilePath + param.MultipleExcelParam[i].SheetName + ".xls";
                using (FileStream fs = new FileStream(name, FileMode.Create, FileAccess.Write))
                {
                    byte[] data = ms.ToArray();
                    fs.Write(data, 0, data.Length);
                    fs.Flush();
                    data = null;
                }
            }
        }
        #endregion
        #region 对外接口
        /// <summary>
        /// 生成Excel
        /// </summary>
        /// <param name="param"></param>
        public MemoryStream BuildExcel(ExcelParameters param)
        {
            try
            {
                this.maxSheet = param.MaxSheet;
                this.sheetSize = param.SheetSize;
                this.GetExcelWorkBooks(param);
                return this.GetExcelStream(param);
            }
            catch (Exception ex)
            {
                Logger.Log(Level.Error, ex.ToString());
                throw;
            }
        }
        public void BuildMultipleExcel(ExcelParameters param)
        {
            try
            {
                this.maxSheet = param.MaxSheet;
                this.sheetSize = param.SheetSize;
                this.GetMultipleWorkBooks(param);
                this.GetMultipleStream(param);
            }
            catch (Exception ex)
            {
                Logger.Log(Level.Error, ex.ToString());
                throw;
            }
        }
        /// <summary>
        /// 获取Multiple类型excel的文件流
        /// </summary>
        /// <param name="param"></param>
        /// <returns></returns>
        public MemoryStream GetMultipleExcelStream(ExcelParameters param)
        {
            try
            {
                this.maxSheet = param.MaxSheet;
                this.sheetSize = param.SheetSize;
                this.GetMultipleWorkBooks(param);
                return this.BuildMultipleStream(param);
            }
            catch (Exception ex)
            {
                Logger.Log(Level.Error, ex.ToString());
                throw;
            }
        }
        /// <summary>
        /// 获取MultipleStream 有返回值
        /// </summary>
        /// <returns></returns>
        private MemoryStream BuildMultipleStream(ExcelParameters param)
        {
            if (param.MultipleExcelParam != null)
            {
                new MultipleExcel().CreateExcel(param.MaxSheet, this.workbooks, param.MultipleExcelParam);
            }
            MemoryStream ms = new MemoryStream();
            workbooks.ForEach(p => p.Write(ms));
            ms.Flush();
            ms.Position = 0;
            return ms;
        }
        #endregion 
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using NPOI.HSSF.Util;
using NPOI.SS.UserModel;
using NPOI.HSSF.UserModel;
namespace Cis.Excel
{
    public class ExcelStyle
    {
        #region SingleExcelType
        /// <summary>
        /// 标题
        /// </summary>
        /// <param name="wb"></param>
        /// <returns></returns>
        public static ICellStyle GetSingleHeadStyle(IWorkbook wb)
        {
            ICellStyle headStyle = wb.CreateCellStyle();
            headStyle.Alignment = HorizontalAlignment.Center;
            headStyle.VerticalAlignment = VerticalAlignment.Center;
            headStyle.BorderTop = BorderStyle.Thin;
            headStyle.BottomBorderColor = HSSFColor.Black.Index;
            headStyle.BorderLeft = BorderStyle.Thin;
            headStyle.LeftBorderColor = HSSFColor.Black.Index;
            headStyle.BorderBottom = BorderStyle.Thin;
            headStyle.BottomBorderColor = HSSFColor.Black.Index;
            headStyle.BorderRight = BorderStyle.Thin;
            headStyle.RightBorderColor = HSSFColor.Black.Index;
            headStyle.DataFormat = HSSFDataFormat.GetBuiltinFormat("@");
            IFont font = wb.CreateFont();
            font.FontName = "宋体";
            font.FontHeightInPoints = 16;
            //font.Boldweight = 600;
            font.Color = HSSFColor.Black.Index;
            headStyle.SetFont(font);
            return headStyle;
        }
        /// <summary>
        /// 获取标题样式
        /// </summary>
        /// <param name="wb"></param>
        /// <param name="param"></param>
        /// <returns></returns>
        public static ICellStyle GetHeadStyleByParam(IWorkbook wb, ExcelStyleParam param)
        {
            ICellStyle headStyle = wb.CreateCellStyle();
            if (param.Horizontal.Equals(EnumCellType.Left))
                headStyle.Alignment = HorizontalAlignment.Left;
            if (param.Horizontal.Equals(EnumCellType.Right))
                headStyle.Alignment = HorizontalAlignment.Right;
            if (param.Horizontal.Equals(EnumCellType.Center))
                headStyle.Alignment = HorizontalAlignment.Center;
            if (param.Vertcial.Equals(EnumVerticalType.Top))
                headStyle.VerticalAlignment = VerticalAlignment.Top;
            if (param.Vertcial.Equals(EnumVerticalType.Center))
                headStyle.VerticalAlignment = VerticalAlignment.Center;
            if (param.Vertcial.Equals(EnumVerticalType.Below))
                headStyle.VerticalAlignment = VerticalAlignment.Bottom;
            if (param.IsAddBording)
            {
                headStyle.BorderTop = BorderStyle.Thin;
                headStyle.TopBorderColor = HSSFColor.Black.Index;
                headStyle.BorderRight = BorderStyle.Thin;
                headStyle.RightBorderColor = HSSFColor.Black.Index;
                headStyle.BorderBottom = BorderStyle.Thin;
                headStyle.BottomBorderColor = HSSFColor.Black.Index;
                headStyle.BorderLeft = BorderStyle.Thin;
                headStyle.LeftBorderColor = HSSFColor.Black.Index;
            }
            headStyle.DataFormat = HSSFDataFormat.GetBuiltinFormat("@");
            IFont font = wb.CreateFont();
            font.FontName = "宋体";
            font.FontHeightInPoints = param.FontSize;
            font.Boldweight = 600;
            font.Color = HSSFColor.Black.Index;
            headStyle.SetFont(font);
            return headStyle;
        }
        public static ICellStyle GetSingleHeadNoBordingStyle(IWorkbook wb)
        {
            ICellStyle headStyle = wb.CreateCellStyle();
            headStyle.Alignment = HorizontalAlignment.Center;
            headStyle.VerticalAlignment = VerticalAlignment.Center;
            headStyle.DataFormat = HSSFDataFormat.GetBuiltinFormat("@");
            IFont font = wb.CreateFont();
            font.FontName = "宋体";
            font.FontHeightInPoints = 16;
            //font.Boldweight = 600;
            font.Color = HSSFColor.Black.Index;
            headStyle.SetFont(font);
            return headStyle;
        }
        /// <summary>
        /// 列头样式
        /// </summary>
        /// <param name="wb"></param>
        /// <returns></returns>
        public static ICellStyle GetSingleTielStyle(IWorkbook wb)
        {
            ICellStyle headStyle = wb.CreateCellStyle();
            headStyle.Alignment = HorizontalAlignment.Left;
            IFont font = wb.CreateFont();
            font.FontName = "宋体";
            font.FontHeightInPoints = 12;
            font.Boldweight = 600;
            font.Color = HSSFColor.Black.Index;
            headStyle.SetFont(font);
            return headStyle;
        }
        public static ICellStyle GetBordingSingleTielStyle(IWorkbook wb)
        {
            ICellStyle headStyle = wb.CreateCellStyle();
            headStyle.Alignment = HorizontalAlignment.Left;
            headStyle.VerticalAlignment = VerticalAlignment.Center;
            headStyle.BorderTop = BorderStyle.Thin;
            headStyle.TopBorderColor = HSSFColor.Black.Index;
            headStyle.BorderRight = BorderStyle.Thin;
            headStyle.RightBorderColor = HSSFColor.Black.Index;
            headStyle.BorderBottom = BorderStyle.Thin;
            headStyle.BottomBorderColor = HSSFColor.Black.Index;
            headStyle.BorderLeft = BorderStyle.Thin;
            headStyle.LeftBorderColor = HSSFColor.Black.Index;
            headStyle.DataFormat = HSSFDataFormat.GetBuiltinFormat("@");
            IFont font = wb.CreateFont();
            font.FontName = "宋体";
            font.FontHeightInPoints = 10;
            //font.Boldweight = 600;
            font.Color = HSSFColor.Black.Index;
            headStyle.SetFont(font);
            return headStyle;
        }
        /// <summary>
        /// 获取标题样式
        /// </summary>
        /// <param name="wb"></param>
        /// <param name="param"></param>
        /// <returns></returns>
        public static ICellStyle GetTitleStyleByParam(IWorkbook wb, ExcelStyleParam param)
        {
            ICellStyle headStyle = wb.CreateCellStyle();
            if (param.Horizontal.Equals(EnumCellType.Left))
                headStyle.Alignment = HorizontalAlignment.Left;
            if (param.Horizontal.Equals(EnumCellType.Right))
                headStyle.Alignment = HorizontalAlignment.Right;
            if (param.Horizontal.Equals(EnumCellType.Center))
                headStyle.Alignment = HorizontalAlignment.Center;
            if (param.Vertcial.Equals(EnumVerticalType.Top))
                headStyle.VerticalAlignment = VerticalAlignment.Top;
            if (param.Vertcial.Equals(EnumVerticalType.Center))
                headStyle.VerticalAlignment = VerticalAlignment.Center;
            if (param.Vertcial.Equals(EnumVerticalType.Below))
                headStyle.VerticalAlignment = VerticalAlignment.Bottom;
            if (param.IsAddBording)
            {
                headStyle.BorderTop = BorderStyle.Thin;
                headStyle.TopBorderColor = HSSFColor.Black.Index;
                headStyle.BorderRight = BorderStyle.Thin;
                headStyle.RightBorderColor = HSSFColor.Black.Index;
                headStyle.BorderBottom = BorderStyle.Thin;
                headStyle.BottomBorderColor = HSSFColor.Black.Index;
                headStyle.BorderLeft = BorderStyle.Thin;
                headStyle.LeftBorderColor = HSSFColor.Black.Index;
            }
            headStyle.DataFormat = HSSFDataFormat.GetBuiltinFormat("@");
            IFont font = wb.CreateFont();
            font.FontName = "宋体";
            font.FontHeightInPoints = param.FontSize;
            //font.Boldweight = 600;
            font.Color = HSSFColor.Black.Index;
            headStyle.SetFont(font);
            return headStyle;
        }
        /// <summary>
        /// 获取右侧显示样式
        /// </summary>
        /// <param name="wb"></param>
        /// <returns></returns>
        public static ICellStyle GetRightDataStyle(IWorkbook wb)
        {
            ICellStyle dataStyle = wb.CreateCellStyle();
            dataStyle.Alignment = HorizontalAlignment.Right;
            dataStyle.VerticalAlignment = VerticalAlignment.Center;
            //数据单元格的边框设置
            dataStyle.BorderTop = BorderStyle.Thin;
            dataStyle.TopBorderColor = HSSFColor.Black.Index;
            dataStyle.BorderRight = BorderStyle.Thin;
            dataStyle.RightBorderColor = HSSFColor.Black.Index;
            dataStyle.BorderBottom = BorderStyle.Thin;
            dataStyle.BottomBorderColor = HSSFColor.Black.Index;
            dataStyle.BorderLeft = BorderStyle.Thin;
            dataStyle.LeftBorderColor = HSSFColor.Black.Index;
            dataStyle.WrapText = true;
            //数据字体设置
            IFont datafont = wb.CreateFont();
            datafont.FontHeightInPoints = 10;//字号
            dataStyle.SetFont(datafont);
            return dataStyle;
        }
        /// <summary>
        /// 左侧显示
        /// </summary>
        /// <param name="wb"></param>
        /// <returns></returns>
        public static ICellStyle GetLeftDataStyle(IWorkbook wb)
        {
            ICellStyle dataStyle = wb.CreateCellStyle();
            dataStyle.Alignment = HorizontalAlignment.Left;
            dataStyle.VerticalAlignment = VerticalAlignment.Center;
            //数据单元格的边框设置
            dataStyle.BorderTop = BorderStyle.Thin;
            dataStyle.TopBorderColor = HSSFColor.Black.Index;
            dataStyle.BorderRight = BorderStyle.Thin;
            dataStyle.RightBorderColor = HSSFColor.Black.Index;
            dataStyle.BorderBottom = BorderStyle.Thin;
            dataStyle.BottomBorderColor = HSSFColor.Black.Index;
            dataStyle.BorderLeft = BorderStyle.Thin;
            dataStyle.LeftBorderColor = HSSFColor.Black.Index;
            dataStyle.WrapText = true;
            dataStyle.DataFormat = HSSFDataFormat.GetBuiltinFormat("@");
            //数据字体设置
            IFont datafont = wb.CreateFont();
            datafont.FontName = "宋体";
            datafont.FontHeightInPoints = 10;//字号
            dataStyle.SetFont(datafont);
            return dataStyle;
        }
        /// <summary>
        /// 根据参数获取单元格样式
        /// </summary>
        /// <param name="param"></param>
        /// <returns></returns>
        public static ICellStyle GetDataStyleByParam(IWorkbook wb,ExcelStyleParam param)
        {
            ICellStyle dataStyle = wb.CreateCellStyle();
            if(param.Horizontal.Equals(EnumCellType.Left))
                dataStyle.Alignment = HorizontalAlignment.Left;
            if (param.Horizontal.Equals(EnumCellType.Right))
                dataStyle.Alignment = HorizontalAlignment.Right;
            if (param.Horizontal.Equals(EnumCellType.Center))
                dataStyle.Alignment = HorizontalAlignment.Center;
            if(param.Vertcial.Equals(EnumVerticalType.Top))
                dataStyle.VerticalAlignment = VerticalAlignment.Top;
            if (param.Vertcial.Equals(EnumVerticalType.Center))
                dataStyle.VerticalAlignment = VerticalAlignment.Center;
            if (param.Vertcial.Equals(EnumVerticalType.Below))
                dataStyle.VerticalAlignment = VerticalAlignment.Bottom;
            //数据单元格的边框设置
            if (param.IsAddBording)
            {
                dataStyle.BorderTop = BorderStyle.Thin;
                dataStyle.TopBorderColor = HSSFColor.Black.Index;
                dataStyle.BorderRight = BorderStyle.Thin;
                dataStyle.RightBorderColor = HSSFColor.Black.Index;
                dataStyle.BorderBottom = BorderStyle.Thin;
                dataStyle.BottomBorderColor = HSSFColor.Black.Index;
                dataStyle.BorderLeft = BorderStyle.Thin;
                dataStyle.LeftBorderColor = HSSFColor.Black.Index;
            }
            
            dataStyle.WrapText = true;
            dataStyle.DataFormat = HSSFDataFormat.GetBuiltinFormat("@");
            //数据字体设置
            IFont datafont = wb.CreateFont();
            datafont.FontName = "宋体";
            datafont.FontHeightInPoints = param.FontSize;//字号
            dataStyle.SetFont(datafont);
            return dataStyle;
        }
        /// <summary>
        /// 居中显示
        /// </summary>
        /// <param name="wb"></param>
        /// <returns></returns>
        public static ICellStyle GetCenterDataStyle(IWorkbook wb)
        {
            ICellStyle dataStyle = wb.CreateCellStyle();
            dataStyle.Alignment = HorizontalAlignment.Center;
            dataStyle.VerticalAlignment = VerticalAlignment.Center;
            //数据单元格的边框设置
            dataStyle.BorderTop = BorderStyle.Thin;
            dataStyle.TopBorderColor = HSSFColor.Black.Index;
            dataStyle.BorderRight = BorderStyle.Thin;
            dataStyle.RightBorderColor = HSSFColor.Black.Index;
            dataStyle.BorderBottom = BorderStyle.Thin;
            dataStyle.BottomBorderColor = HSSFColor.Black.Index;
            dataStyle.BorderLeft = BorderStyle.Thin;
            dataStyle.LeftBorderColor = HSSFColor.Black.Index;
            dataStyle.WrapText = true;
            dataStyle.DataFormat = HSSFDataFormat.GetBuiltinFormat("@");
            //数据字体设置
            IFont datafont = wb.CreateFont();
            datafont.FontHeightInPoints = 10;//字号
            dataStyle.SetFont(datafont);
            return dataStyle;
        }
        /// <summary>
        /// 获取右侧显示样式
        /// </summary>
        /// <param name="wb"></param>
        /// <returns></returns>
        public static ICellStyle GetNoBordingRightDataStyle(IWorkbook wb)
        {
            ICellStyle dataStyle = wb.CreateCellStyle();
            dataStyle.Alignment = HorizontalAlignment.Right;
            dataStyle.VerticalAlignment = VerticalAlignment.Center;
            dataStyle.DataFormat = HSSFDataFormat.GetBuiltinFormat("@");
            //数据单元格的边框设置
            dataStyle.WrapText = true;
            //数据字体设置
            IFont datafont = wb.CreateFont();
            datafont.FontHeightInPoints = 10;//字号
            dataStyle.SetFont(datafont);
            return dataStyle;
        }
        /// <summary>
        /// 左侧显示
        /// </summary>
        /// <param name="wb"></param>
        /// <returns></returns>
        public static ICellStyle GetNoBordingLeftDataStyle(IWorkbook wb)
        {
            ICellStyle dataStyle = wb.CreateCellStyle();
            dataStyle.Alignment = HorizontalAlignment.Left;
            dataStyle.VerticalAlignment = VerticalAlignment.Center;
            dataStyle.DataFormat = HSSFDataFormat.GetBuiltinFormat("@");
            //数据单元格的边框设置
            dataStyle.WrapText = true;
            //数据字体设置
            IFont datafont = wb.CreateFont();
            datafont.FontHeightInPoints = 10;//字号
            dataStyle.SetFont(datafont);
            return dataStyle;
        }
        /// <summary>
        /// 居中显示
        /// </summary>
        /// <param name="wb"></param>
        /// <returns></returns>
        public static ICellStyle GetNoBordingCenterStyle(IWorkbook wb)
        {
            ICellStyle dataStyle = wb.CreateCellStyle();
            dataStyle.Alignment = HorizontalAlignment.Center;
            dataStyle.VerticalAlignment = VerticalAlignment.Center;
            dataStyle.WrapText = true;
            dataStyle.DataFormat = HSSFDataFormat.GetBuiltinFormat("@");
            //数据字体设置
            IFont datafont = wb.CreateFont();
            datafont.FontHeightInPoints = 10;//字号
            dataStyle.SetFont(datafont);
            return dataStyle;
        }
        /// <summary>
        /// 获取数据Cell样式
        /// </summary>
        /// <param name="wb"></param>
        /// <param name="type"></param>
        /// <returns></returns>
        public static ICellStyle GetSingleDataCellType(IWorkbook wb, EnumCellType type)
        {
            if (type.Equals(EnumCellType.Right))
                return GetRightDataCellStyle(wb);
            if (type.Equals(EnumCellType.Center))
                return GetCenterDataStyle(wb);
            return GetLeftDataStyle(wb);
        }
        /// <summary>
        /// 获取无边框的数据样式
        /// </summary>
        /// <param name="wb"></param>
        /// <param name="type"></param>
        /// <returns></returns>
        public static ICellStyle GetNoBordingSingleDataCellType(IWorkbook wb, EnumCellType type)
        {
            if (type.Equals(EnumCellType.Right))
                return GetNoBordingRightDataStyle(wb);
            if (type.Equals(EnumCellType.Center))
                return GetNoBordingCenterStyle(wb);
            return GetNoBordingLeftDataStyle(wb);
        }
        public static ICellStyle GetNoBordingSingleHeadStyle(IWorkbook wb)
        {
            ICellStyle headStyle = wb.CreateCellStyle();
            headStyle.Alignment = HorizontalAlignment.Center;
            headStyle.VerticalAlignment = VerticalAlignment.Center;
            headStyle.DataFormat = HSSFDataFormat.GetBuiltinFormat("@");
            IFont font = wb.CreateFont();
            font.FontName = "宋体";
            font.FontHeightInPoints = 16;
            font.Boldweight = 600;
            font.Color = HSSFColor.Black.Index;
            headStyle.SetFont(font);
            return headStyle;
        }
        public static ICellStyle GetNoBordingDataCellStyle(IWorkbook wb)
        {
            ICellStyle dataStyle = wb.CreateCellStyle();
            dataStyle.Alignment = HorizontalAlignment.Left;
            dataStyle.VerticalAlignment = VerticalAlignment.Center;
            dataStyle.DataFormat = HSSFDataFormat.GetBuiltinFormat("@");
            //数据单元格的边框设置
            dataStyle.WrapText = true;
            //数据字体设置
            IFont datafont = wb.CreateFont();
            datafont.FontHeightInPoints = 10;//字号
            dataStyle.SetFont(datafont);
            return dataStyle;
        }
        #endregion
        #region GridExcelStyle
        /// <summary>
        /// 列头样式
        /// </summary>
        /// <param name="wb"></param>
        /// <returns></returns>
        public static ICellStyle GetTielStyle(IWorkbook wb)
        {
            ICellStyle titleStyle = wb.CreateCellStyle();
            titleStyle.Alignment = HorizontalAlignment.Center;
            titleStyle.FillForegroundColor = HSSFColor.White.Index;
            titleStyle.FillPattern = FillPattern.SolidForeground;
            titleStyle.BorderTop = BorderStyle.Thin;
            titleStyle.TopBorderColor = HSSFColor.Black.Index;
            titleStyle.BorderBottom = BorderStyle.Thin;
            titleStyle.BottomBorderColor = HSSFColor.Black.Index;
            titleStyle.BorderLeft = BorderStyle.Thin;
            titleStyle.LeftBorderColor = HSSFColor.Black.Index;
            titleStyle.BorderRight = BorderStyle.Thin;
            titleStyle.RightBorderColor = HSSFColor.Black.Index;
            IFont font = wb.CreateFont();
            font.FontName = "宋体";
            font.FontHeightInPoints = 11;
            font.Boldweight = 600;
            font.Color = HSSFColor.Black.Index;
            titleStyle.SetFont(font);
            return titleStyle;
        }
        /// <summary>
        ///统计列值样式
        /// </summary>
        /// <param name="wb"></param>
        /// <returns></returns>
        public static ICellStyle GetExcelCountValueStyle(IWorkbook wb)
        {
            ICellStyle rejectValueStyle = wb.CreateCellStyle();
            rejectValueStyle.Alignment = HorizontalAlignment.Right;
            IFont font = wb.CreateFont();
            font.FontName = "宋体";
            font.FontHeightInPoints = 10;
            font.Boldweight = 400;
            font.Color = HSSFColor.Black.Index;
            rejectValueStyle.SetFont(font);
            return rejectValueStyle;
        }
        /// <summary>
        /// 统计列样式
        /// </summary>
        /// <param name="wb"></param>
        /// <returns></returns>
        public static ICellStyle GetExcelCountStyle(IWorkbook wb)
        {
            ICellStyle rejectValueStyle = wb.CreateCellStyle();
            rejectValueStyle.Alignment = HorizontalAlignment.Left;
            IFont font = wb.CreateFont();
            font.FontName = "宋体";
            font.FontHeightInPoints = 10;
            font.Boldweight = 400;
            font.Color = HSSFColor.Black.Index;
            rejectValueStyle.SetFont(font);
            return rejectValueStyle;
        }
        /// <summary>
        /// 获取数据样式
        /// </summary>
        /// <param name="wb"></param>
        /// <returns></returns>
        public static ICellStyle GetDataCellStyle(IWorkbook wb)
        {
            ICellStyle dataStyle = wb.CreateCellStyle();
            dataStyle.Alignment = HorizontalAlignment.Left;
            //数据单元格的边框设置
            dataStyle.BorderTop = BorderStyle.Thin;
            dataStyle.TopBorderColor = HSSFColor.Black.Index;
            dataStyle.BorderRight = BorderStyle.Thin;
            dataStyle.RightBorderColor = HSSFColor.Black.Index;
            dataStyle.BorderBottom = BorderStyle.Thin;
            dataStyle.BottomBorderColor = HSSFColor.Black.Index;
            dataStyle.BorderLeft = BorderStyle.Thin;
            dataStyle.LeftBorderColor = HSSFColor.Black.Index;
            dataStyle.WrapText = true;
            //数据字体设置
            IFont datafont = wb.CreateFont();
            datafont.FontHeightInPoints = 10;//字号
            dataStyle.SetFont(datafont);
            return dataStyle;
        }
        /// <summary>
        /// 右侧显示
        /// </summary>
        /// <param name="wb"></param>
        /// <returns></returns>
        public static ICellStyle GetRightDataCellStyle(IWorkbook wb)
        {
            ICellStyle dataStyle = wb.CreateCellStyle();
            dataStyle.Alignment = HorizontalAlignment.Right;
            dataStyle.VerticalAlignment = VerticalAlignment.Center;
            //数据单元格的边框设置
            dataStyle.BorderTop = BorderStyle.Thin;
            dataStyle.TopBorderColor = HSSFColor.Black.Index;
            dataStyle.BorderRight = BorderStyle.Thin;
            dataStyle.RightBorderColor = HSSFColor.Black.Index;
            dataStyle.BorderBottom = BorderStyle.Thin;
            dataStyle.BottomBorderColor = HSSFColor.Black.Index;
            dataStyle.BorderLeft = BorderStyle.Thin;
            dataStyle.LeftBorderColor = HSSFColor.Black.Index;
            dataStyle.WrapText = true;
            // dataStyle.DataFormat = HSSFDataFormat.GetBuiltinFormat("@");
            //数据字体设置
            IFont datafont = wb.CreateFont();
            datafont.FontHeightInPoints = 10;//字号
            dataStyle.SetFont(datafont);
            return dataStyle;
        }
        /// <summary>
        /// 获取单元格样式
        /// </summary>
        /// <param name="wb"></param>
        /// <param name="type"></param>
        /// <returns></returns>
        public static ICellStyle GetGridDataCellType(IWorkbook wb, EnumCellType type)
        {
            if (type.Equals(EnumCellType.Right))
                return GetRightDataCellStyle(wb);
            if (type.Equals(EnumCellType.Center))
                return GetCenterDataStyle(wb);
            return GetLeftDataStyle(wb);
        }
        #endregion
        #region 
        /// <summary>
        /// 根据参数设置单元格样式
        /// </summary>
        /// <param name="wb"></param>
        /// <param name="cellType"></param>
        /// <param name="dataType"></param>
        /// <param name="IsBording"></param>
        /// <param name="digit"></param>
        /// <returns></returns>
        public static ICellStyle GetDataCellStyleByParam(IWorkbook wb, EnumCellType cellType, EnumDataType dataType, bool IsBording, int digit)
        {
            ICellStyle dataStyle = wb.CreateCellStyle();
            dataStyle.VerticalAlignment = VerticalAlignment.Center;
            dataStyle.WrapText = true;
            //设置单元格水平样式
            if (cellType == EnumCellType.Left)
                dataStyle.Alignment = HorizontalAlignment.Left;
            if (cellType == EnumCellType.Right)
                dataStyle.Alignment = HorizontalAlignment.Right;
            if (cellType == EnumCellType.Center)
                dataStyle.Alignment = HorizontalAlignment.Center;
            //设置单元格外围边框
            if (IsBording)
            {
                dataStyle.BorderTop = BorderStyle.Thin;
                dataStyle.TopBorderColor = HSSFColor.Black.Index;
                dataStyle.BorderRight = BorderStyle.Thin;
                dataStyle.RightBorderColor = HSSFColor.Black.Index;
                dataStyle.BorderBottom = BorderStyle.Thin;
                dataStyle.BottomBorderColor = HSSFColor.Black.Index;
                dataStyle.BorderLeft = BorderStyle.Thin;
                dataStyle.LeftBorderColor = HSSFColor.Black.Index;
            }
            if (dataType == EnumDataType.Number && digit > 0)
            {
                IDataFormat format = wb.CreateDataFormat();
                dataStyle.DataFormat = format.GetFormat("0.".PadRight(digit + 2, '0'));
            }
            //单元格设置成文本样式
            //if (dataType == EnumDataType.Text)
            //    dataStyle.DataFormat = HSSFDataFormat.GetBuiltinFormat("@");
            //单元格设置成数值样式并指定小数位
            //if (dataType == EnumDataType.Number && digit >0)
            //{
            //    string dataFormat = "0.";
            //    for (int i = 0; i < digit; i++)
            //    {
            //        dataFormat += dataFormat +"0";
            //    }
            //    dataStyle.DataFormat = HSSFDataFormat.GetBuiltinFormat(dataFormat);
            //}
            //数据字体设置
            IFont datafont = wb.CreateFont();
            datafont.FontHeightInPoints = 10;//字号
            dataStyle.SetFont(datafont);
            return dataStyle;
        }
        #endregion
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
namespace Cis.Excel
{
    public struct ExcelStyleParam
    {
        /// <summary>
        /// 是否添加边框
        /// </summary>
        public bool IsAddBording { get; set; }
        /// <summary>
        /// 文本类型
        /// </summary>
        public EnumDataType DataType { get; set; }
        /// <summary>
        /// 小数精度
        /// </summary>
        public int Digit { get; set; } 
        /// <summary>
        /// 字体大小
        /// </summary>
        public short FontSize { get; set; }
        /// <summary>
        /// 水平样式
        /// </summary>
        public EnumCellType Horizontal { get; set; } 
        /// <summary>
        /// 垂直样式
        /// </summary>
        public EnumVerticalType Vertcial { get; set; }
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
namespace Cis.Excel
{
    public class GridEndParam
    {
        /// <summary>
        /// 相对于统计行来说的 从1开始
        /// </summary>
        public int RowIndex { get; set; }
        /// <summary>
        /// 从序号列算起 0 开始
        /// </summary>
        public int ColumnIndex { get; set; }
        public string Value { get; set; }
    }
}
using System;
using System.Collections.Generic;
using NPOI.SS.UserModel;
using NPOI.HSSF.UserModel;
using NPOI.HSSF.Util;
using NPOI.SS.Util;
using System.Globalization;
using Cis.Log;
using System.Linq;
namespace Cis.Excel
{
    public class GridExcel : IExcel
    {
        #region 字段
        private int titleRowNum = 1;
        private InnerParameter param = new InnerParameter();
        private CultureInfo ci = new CultureInfo("zh-cn");
        protected int BeginCell { get; set; }
        protected int EndCell { get; set; }
        protected int RowIndex { get; set; }
        #endregion
        #region 属性
        /// <summary>
        /// 生成参数
        /// </summary>
        internal InnerParameter Param
        {
            get { return this.param; }
            set { this.param = value; }
        }
        private ICellStyle CaptionStyle { get; set; }
        private ICellStyle TitleStyle { get; set; }
        #endregion
        #region 方法
        /// <summary>
        /// 画EXCEL标题
        /// </summary>
        public virtual void DrawCaption()
        {
            if (!string.IsNullOrEmpty(Param.CaptionName))
            {
                IRow headeRow = Param.Sheet.CreateRow(0);
                CellRangeAddress region = new CellRangeAddress(0, 0, 0, Param.TitleList.Count);
                Param.Sheet.AddMergedRegion(region);
                ICell cell = headeRow.CreateCell(0);
                cell.SetCellValue(Param.CaptionName);
                for (int i = region.FirstRow; i <= region.LastRow; i++)
                {
                    IRow row = HSSFCellUtil.GetRow(i, Param.Sheet);
                    for (int j = region.FirstColumn; j <= region.LastColumn; j++)
                    {
                        ICell singleCell = HSSFCellUtil.GetCell(row, (short)j);
                        singleCell.CellStyle = this.CaptionStyle;
                    }
                }
            }
        }
        /// <summary>
        /// 画EXCEL列头
        /// </summary>
        public virtual void DrawColumnTitle()
        {
            //ICellStyle titleCellStyle = ExcelStyle.GetTielStyle(Param.Workbook);
            int i = this.Param.IsShowNumber? 0:-1;
            IRow titleRow = Param.Sheet.CreateRow(this.titleRowNum);
            if(this.Param.IsShowNumber)
            {
                ICell firstCell = titleRow.CreateCell(i);
                firstCell.SetCellValue("序号");
                firstCell.CellStyle = this.TitleStyle;
            }
            if (Param.TitleList != null && Param.TitleList.Count > 0)
            {
                foreach (var et in this.Param.TitleList)
                {
                    i++;
                    ICell tileCell = titleRow.CreateCell(i);
                    tileCell.CellStyle = this.TitleStyle;
                    tileCell.SetCellValue(et.TitleName);
                    this.Param.Sheet.SetColumnWidth(i, 20 * 256);
                    if (!et.TitleWide.Equals(0))
                        this.Param.Sheet.SetColumnWidth(i, et.TitleWide * 256);
                }
            }
        }
        /// <summary>
        /// 填充数据
        /// </summary>
        public virtual void DrawDataCell()
        {
            ICellStyle CenterCellStyle = ExcelStyle.GetGridDataCellType(this.Param.Workbook, EnumCellType.Center);
            ICellStyle LeftCellStyle = ExcelStyle.GetGridDataCellType(this.Param.Workbook, EnumCellType.Left);
            ICellStyle RightCellStyle = ExcelStyle.GetGridDataCellType(this.Param.Workbook, EnumCellType.Right);
            var countFileds = from p in this.Param.TitleList where p.IsCount select p;
            var isCount = (countFileds != null&&countFileds.Count() > 0) ? true : false;
            int rowIndex = 1;
            for (int i = Param.SheetSize * Param.SheetIndex; i < Param.Soucelist.Count && i < (Param.SheetIndex + 1) * Param.SheetSize; i++)
            {
                IRow dataRow = Param.Sheet.CreateRow(this.titleRowNum + rowIndex);
                if (this.Param.IsShowNumber)
                {
                    ICell firstCell = dataRow.CreateCell(0);
                    firstCell.CellStyle = LeftCellStyle;
                    firstCell.SetCellValue(i + 1);
                }
                int j = this.Param.IsShowNumber ? 1 : 0;
                foreach (var tl in Param.TitleList)
                {
                    ICell dataCell = dataRow.CreateCell(j);
                    dataCell.CellStyle = tl.CellStyle;
                    Object ob = ReflectionHelper.GetPropertyValue(Param.Soucelist[i], tl.TitleValue);
                    if (tl.DataType == EnumDataType.Number && tl.Digit > 0 && ob.ToString() != string.Empty)
                    {
                        double dbv = Convert.ToDouble(ob);
                        dbv = System.Math.Round(dbv, tl.Digit);
                        dataCell.SetCellValue(dbv);
                    }
                    else
                    {
                        string obValue = ob.ToString();
                        if(!string.IsNullOrEmpty(obValue))
                           dataCell.SetCellValue(tl.IsRMB ? "￥" + obValue : obValue);
                    }
                    if (tl.IsCount)
                    {
                        object temp = ReflectionHelper.GetPropertyValue(Param.Soucelist[i], tl.TitleValue);
                        if (!string.IsNullOrWhiteSpace(temp?.ToString()))
                        {
                            tl.CountValue += Convert.ToDecimal(temp);
                        }
                    }
                    j++;
                }
                rowIndex++;
            }
            if (Param.IsLastPage&&isCount)
            {
              
                ICellStyle cStyle = ExcelStyle.GetExcelCountStyle(Param.Workbook);
                ICellStyle vStyle = ExcelStyle.GetExcelCountValueStyle(Param.Workbook);
                int countNum = this.titleRowNum + rowIndex;
                IRow tRow = this.Param.Sheet.CreateRow(countNum);
                this.BeginCell = 0;
                this.EndCell = 0;
                ICell countCell = tRow.CreateCell(0);
                countCell.CellStyle = RightCellStyle;
                countCell.SetCellValue("合计：");
                int j = 1;
                this.BeginCell = j;
                this.EndCell = j;
                foreach (var tl in this.Param.TitleList)
                {
                    if (tl.IsCount)
                    {
                        this.BeginCell = j;
                    }
                    ICell tCell = tRow.CreateCell(this.BeginCell);
                    tCell.CellStyle = RightCellStyle;
                    if (tl.IsCount)
                    {
                        if (tl.DataType == EnumDataType.Number && tl.Digit > 0)
                        {
                            double dbv = Convert.ToDouble(tl.CountValue);
                            dbv = System.Math.Round(dbv, tl.Digit);
                            tCell.SetCellValue(dbv);
                        }
                        else
                        {
                            if (tl.IsRMB)
                            {
                                if(!string.IsNullOrEmpty(tl.CountValue.ToString()))
                                    tCell.SetCellValue("￥" + tl.CountValue.ToString());
                            }   
                            else
                                tCell.SetCellValue(tl.CountValue.ToString());
                        }
                
                    }
                    CellRangeAddress region = new CellRangeAddress(countNum,countNum, this.BeginCell, j);
                    this.Param.Sheet.AddMergedRegion(region);
                    for (int i = region.FirstRow; i <= region.LastRow; i++)
                    {
                        IRow row = HSSFCellUtil.GetRow(i, this.Param.Sheet);
                        for (int t = region.FirstColumn; t <= region.LastColumn; t++)
                        {
                            ICell singleCell = HSSFCellUtil.GetCell(row, (short)j);
                            singleCell.CellStyle = RightCellStyle;
                        }
                    }
                    if (tl.IsCount)
                        this.BeginCell = j + 1;
                    j++;
                }
                rowIndex++;  
            }
            this.RowIndex = rowIndex;
        }
        /// <summary>
        /// 画结尾样式
        /// </summary>
        /// <param name="beginRow"></param>
        /// <param name="dataIndex"></param>
        public void DrawEnding()
        {
            if (this.Param.GridEndingList != null && Param.GridEndingList.Count > 0)
            {
                var countFileds = from p in this.Param.TitleList where p.IsCount select p;
                var isCount = (countFileds != null && countFileds.Count() > 0) ? true : false;
                ICellStyle CenterCellStyle = ExcelStyle.GetGridDataCellType(this.Param.Workbook, EnumCellType.Center);
                ICellStyle LeftCellStyle = ExcelStyle.GetGridDataCellType(this.Param.Workbook, EnumCellType.Left);
                ICellStyle RightCellStyle = ExcelStyle.GetGridDataCellType(this.Param.Workbook, EnumCellType.Right);
                var rowCount = (from s in Param.GridEndingList orderby s.RowIndex descending select s.RowIndex).FirstOrDefault();
                int beginRow = this.RowIndex + this.titleRowNum;
                for (int i = 0; i < rowCount; i++)
                {
                    int j = this.Param.IsShowNumber ? 0 : -1;
                    IRow tRow = this.Param.Sheet.CreateRow(beginRow + i);
                    if (this.Param.IsShowNumber)
                    {
                        ICell firstCell = tRow.CreateCell(j);
                        firstCell.CellStyle = LeftCellStyle;
                        firstCell.SetCellValue(this.Param.Soucelist.Count + i + (isCount ? 2 : 1));
                    }
                    foreach (var tl in this.Param.TitleList)
                    {
                        j++;
                        ICell dataCell = tRow.CreateCell(j);
                        dataCell.CellStyle = CenterCellStyle;
                        string value = (from t in this.Param.GridEndingList where t.RowIndex == i + 1 && t.ColumnIndex == j select t.Value).FirstOrDefault();
                        value = value == null ? "" : value;
                        dataCell.SetCellValue(value);
                    }
                }
            }
        }
        /// <summary>
        /// 创建一个Sheet
        /// </summary>
        public virtual void CreateSheet()
        {
            Param.Sheet = (HSSFSheet)Param.Workbook.CreateSheet(this.Param.SheetName);
            try
            {
                if (Param.Soucelist.Count > 0)
                {
                    foreach (var tl in Param.TitleList)
                    {
                        tl.CellStyle = ExcelStyle.GetDataCellStyleByParam(this.Param.Workbook, tl.CellType, tl.DataType, true, tl.Digit);
                    }
                    this.DrawCaption();
                    this.DrawColumnTitle();
                    this.DrawDataCell();
                    this.DrawEnding();
                }
            }
            catch (Exception ex)
            {
                Logger.Log(Level.Error, ex.ToString());
                throw;
            }
        }
        /// <summary>
        /// 创建Excel
        /// </summary>
        /// <param name="param"></param>
        /// <param name="books"></param>
        public void CreateExcel(GridExcelParam param, List<HSSFWorkbook> books)
        {
            this.Param.Soucelist = param.DataSource;
            this.Param.SheetSize = param.SheetSize;
            this.Param.TitleList = param.TitleList;
            this.Param.CaptionName = param.CaptionName;
            this.Param.GridEndingList = param.GridEndingList;
            this.Param.IsShowNumber = param.IsShowNumber;
            try
            {
                if (param.DataSource != null && param.DataSource.Count > 0)
                {
                    for (int i = 0; i <= param.EndSheet - param.BeginSheet; i++)
                    {
                        var temp = (decimal)(param.BeginSheet + i) / param.MaxSheet;
                        int bookNum = (int)Math.Ceiling(temp);
                        if (bookNum == 0)
                            bookNum = 1;
                        if (this.Param.Workbook != books[bookNum - 1])
                        {
                            this.Param.Workbook = books[bookNum - 1];
                            this.CaptionStyle = param.IsCaptionNoBording? ExcelStyle.GetSingleHeadNoBordingStyle(Param.Workbook): ExcelStyle.GetSingleHeadStyle(Param.Workbook);
                            this.TitleStyle = ExcelStyle.GetTielStyle(Param.Workbook);
                        }
                        if (i == 0)
                        {
                            this.Param.SheetName = param.SheetName;
                        }
                        else
                        {
                            this.Param.SheetName = param.SheetName + i;
                        }
                        this.Param.SheetIndex = i;
                        if (i == param.EndSheet - param.BeginSheet)
                            this.Param.IsLastPage = true;
                        this.CreateSheet();
                    }
                }
            }
            catch (Exception ex)
            {
                Logger.Log(Level.Error, ex.ToString());
                throw;
            }
        }
        #endregion
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
namespace Cis.Excel
{
    public class GridExcelParam
    {
        #region 字段
        private int maxSheet = 5;
        private int sheetSize = 10000;
        private bool isShowNumber= true;
        #endregion
        #region 属性
        /// <summary>
        /// 列表数据
        /// </summary>
        public dynamic DataSource { get; set; }
        /// <summary>
        /// Grid列头
        /// </summary>
        public List<GridTitle> TitleList { get; set; }
        /// <summary>
        /// grid结尾样式
        /// </summary>
        public List<GridEndParam> GridEndingList { get; set; }
        /// <summary>
        /// Excel标题
        /// </summary>
        public string CaptionName { get; set; }
        /// <summary>
        /// 标题是否不需要外边框
        /// </summary>
        public bool IsCaptionNoBording { get; set; }
        /// <summary>
        /// Sheet名称
        /// </summary>
        public string SheetName { get; set; }
        /// <summary>
        /// 是否显示序号
        /// </summary>
        public bool IsShowNumber
        {
            get { return this.isShowNumber; }
            set { this.isShowNumber = value; }
        }
        /// <summary>
        /// GridExcel
        /// </summary>
        internal IExcel Excel { get; set; }
        /// <summary>
        /// 开始Sheet
        /// </summary>
        internal int BeginSheet { get; set; }
        /// <summary>
        /// 结束Sheet 
        /// </summary>
        internal int EndSheet { get; set; }
        /// <summary>
        /// 一个workBook的最大Sheet数
        /// </summary>
        internal int MaxSheet
        {
            get { return this.maxSheet; }
            set { this.maxSheet = value; }
        }
        /// <summary>
        /// 一个Sheet最大行数
        /// 默认是10000
        /// </summary>
        internal int SheetSize
        {
            get { return this.sheetSize; }
            set { this.sheetSize = value; }
        }
        #endregion
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using NPOI.SS.UserModel;
using NPOI.HSSF.UserModel;
using NPOI.HSSF.Util;
using NPOI.SS.Util;
namespace Cis.Excel
{
    public class GridTitle
    {
        private EnumDataType dataType = EnumDataType.Default;
        private EnumCellType cellType = EnumCellType.Left;
        private int digit = 0;
        /// <summary>
        /// 列头显示
        /// </summary>
        public string TitleName { get; set; }
        /// <summary>
        /// 列值
        /// </summary>
        public string TitleValue { get; set; }
        /// <summary>
        /// 列宽
        /// </summary>
        public int TitleWide { get; set; }
        /// <summary>
        /// 是否为统计列
        /// </summary>
        public bool IsCount { get; set; }
        /// <summary>
        /// 是否需要添加人民币符号
        /// </summary>
        public bool IsRMB { get; set; }
        /// <summary>
        /// 单元水平样式类型
        /// </summary>
        public EnumCellType CellType
        {
            get { return this.cellType; }
            set { this.cellType = value; }
        }
        /// <summary>
        /// 统计金额
        /// </summary>
        internal decimal CountValue { get; set; }
        /// <summary>
        ///单元格数据类型
        /// </summary>
        public EnumDataType DataType
        {
            get { return this.dataType; }
            set { this.dataType = value; }
        }
        /// <summary>
        /// 小数位数
        /// </summary>
        public int Digit
        {
            get { return this.digit; }
            set { this.digit = value; }
        }
        public ICellStyle CellStyle { get; set; }
        
        
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using NPOI.SS.UserModel;
using NPOI.HSSF.UserModel;
using NPOI.HSSF.Util;
using NPOI.SS.Util;
using NPOI.Util;
namespace Cis.Excel
{
    public interface IExcel 
    {
        /// <summary>
        /// 创建Excel
        /// </summary>
        void CreateExcel(GridExcelParam param, List<HSSFWorkbook> books);
        //画Sheet标题
        void DrawCaption();
        //画Sheet列头
        void DrawColumnTitle();
        //创建一个Sheet
        void CreateSheet();
        //填充数据
        void DrawDataCell();  
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using NPOI.SS.UserModel;
using NPOI.HSSF.UserModel;
using NPOI.HSSF.Util;
using NPOI.SS.Util;
using NPOI.Util;
namespace Cis.Excel
{
    internal class InnerParameter
    {
        /// <summary>
        /// 数据源
        /// </summary>
        public dynamic Soucelist { get; set; }
        /// <summary>
        /// 当前生成Sheet
        /// </summary>
        public HSSFSheet  Sheet { get; set; }
        /// <summary>
        /// 当前生成的WorkBook
        /// </summary>
        public HSSFWorkbook Workbook { get; set; }
        /// <summary>
        /// 列头
        /// </summary>
        public List<GridTitle> TitleList { get; set; }
        /// <summary>
        /// grid结尾样式
        /// </summary>
        public List<GridEndParam> GridEndingList { get; set; }
        /// <summary>
        /// 是否为最后页
        /// </summary>
        public bool IsLastPage { get; set; }       
        /// <summary>
        /// Sheet名称
        /// </summary>
        public string SheetName { get; set; }
        /// <summary>
        /// 行号
        /// </summary>
        //protected int TitleRowNum = 0;
        /// <summary>
        /// 标题
        /// </summary>
        public string CaptionName { get; set; }
        /// <summary>
        /// 一个Sheet的数据行数
        /// </summary>
        public int SheetSize { get; set; }
        /// <summary>
        /// 当前Sheet号
        /// </summary>
        public int SheetIndex { get; set; }
        /// <summary>
        /// 统计信息是否显示在上方
        /// </summary>
        public bool IsCountTop { get; set; }
        /// <summary>
        /// 是否显示行号
        /// </summary>
        public bool IsShowNumber { get; set; }
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
namespace Cis.Excel
{
    public class ModelParameter
    {
        /// <summary>
        /// 模板所在的Sheet名称
        /// </summary>
        public string ModelName { get; set; }
        /// <summary>
        /// 模板生成后的Sheet名称
        /// </summary>
        public string SheetName { get; set; }
        /// <summary>
        /// 模板value字典
        /// </summary>
        public Dictionary<string, dynamic> KeyValues { get; set; }
       /// <summary>
       ///子模板参数 
       ///1：子模板所在行RowNumber,
       ///2:子模板数据行Count 
       ///3：子模板的数据源字典的Key值计算方法：首行数据的key和模板中保持一致,其余的模板key的末尾追加数字N，N的起始值为1，每行加1；
       /// </summary>
        internal Dictionary<int, int> ChildModels { get; set; }
        /// <summary>
        /// 参数 int：子模板在主版本的先后顺序
        /// ChildModel 1：RowNumber：子模板在主模板的所在行数 2：DataCount：子模板的数据行数，无数据为0
        /// </summary>
        public Dictionary<int, ChildModel>SubModels { get; set; }
    }
}
using System;
using System.Collections.Generic;
using NPOI.SS.UserModel;
using NPOI.HSSF.UserModel;
using NPOI.HSSF.Util;
using NPOI.SS.Util;
using System.Globalization;
using Cis.Log;
using System.Text.RegularExpressions;
namespace Cis.Excel
{
    public class MultipleExcel
    {
        private int captionCellCount;
        private IRow cellRow;
        private int rowNum = -1;
        private List<int> cellWides = new List<int>();
        private ICellStyle TitleStyle { get; set; }
        private ICellStyle CaptionStyle { get; set; }
        /// <summary>
        /// 有边框左侧显示
        /// </summary>
        private ICellStyle BordingLeftStyle { get; set; }
        /// <summary>
        /// 有边框居中显示
        /// </summary>
        private ICellStyle BordingCenterStyle { get; set; }
        /// <summary>
        /// 有边框居右显示
        /// </summary>
        private ICellStyle BordingRightStyle { get; set; }
        /// <summary>
        /// 无边框
        /// </summary>
        private ICellStyle NoBordingLeftStyle { get; set; }
        /// <summary>
        /// 无边框居中显示
        /// </summary>
        private ICellStyle NoBordingCenterStyle { get; set; }
        /// <summary>
        /// 无边框居右显示
        /// </summary>
        private ICellStyle NoBordingRightStyle { get; set; }
        /// <summary>
        /// 合并单元格样式
        /// </summary>
        private ICellStyle RegionStyle { get; set; }
        /// <summary>
        /// 当前工作簿
        /// </summary>
        private HSSFWorkbook WorkBook { get; set; }
        private Dictionary<ExcelStyleParam, ICellStyle> DataTypeDictionary;
        /// <summary>
        /// 当前Sheet
        /// </summary>
        private HSSFSheet Sheet { get; set; }
        /// <summary>
        /// 创建Excel
        /// </summary>
        /// <param name="param"></param>
        /// <param name="books"></param>
        public void CreateExcel(int maxSheet, List<HSSFWorkbook> books, List<MultipleExcelParam> mparams)
        {
            try
            {
                if (mparams != null && mparams.Count > 0 && books != null && books.Count > 0)
                {
                    int i = 0;
                    foreach (MultipleExcelParam param in mparams)
                    {
                        if (this.WorkBook != books[param.BookIndex])
                        {
                            this.WorkBook = books[param.BookIndex];
                            //this.TitleStyle = ExcelStyle.GetSingleTielStyle(this.WorkBook);
                            //this.CaptionStyle = ExcelStyle.GetNoBordingSingleHeadStyle(this.WorkBook);
                            //this.BordingLeftStyle = ExcelStyle.GetLeftDataStyle(this.WorkBook);
                            //this.BordingCenterStyle = ExcelStyle.GetCenterDataStyle(this.WorkBook);
                            //this.BordingRightStyle = ExcelStyle.GetRightDataCellStyle(this.WorkBook);
                            //this.NoBordingLeftStyle = ExcelStyle.GetNoBordingLeftDataStyle(this.WorkBook);
                            //this.NoBordingCenterStyle = ExcelStyle.GetNoBordingCenterStyle(this.WorkBook);
                            //this.NoBordingRightStyle = ExcelStyle.GetNoBordingRightDataStyle(this.WorkBook);
                            //this.RegionStyle = ExcelStyle.GetNoBordingDataCellStyle(this.WorkBook);
                            this.DataTypeDictionary = new Dictionary<ExcelStyleParam, ICellStyle>();
                        }
                        this.CreateSheet(param);
                        i++;
                    }
                }
            }
            catch (Exception ex)
            {
                Logger.Log(Level.Error, ex.ToString());
                throw;
            }
        }
        /// <summary>
        /// 创建Sheet
        /// </summary>
        /// <param name="param"></param>
        private void CreateSheet(MultipleExcelParam param)
        {
            this.Sheet = (HSSFSheet)this.WorkBook.CreateSheet(param.SheetName);
            this.captionCellCount = param.CaptionCellCount;
            if (param.CellWides != null && param.CellWides.Count > 0)
                this.cellWides = param.CellWides;
            this.SetExcelCaptionWides();
            try
            {
                if (param != null)
                {
                    int index = 0;
                    foreach (ExcelCell cell in param.DataCells)
                    {
                        if (this.rowNum != cell.RowNumber)
                        {
                            this.rowNum = cell.RowNumber;
                            this.cellRow = this.Sheet.CreateRow(this.rowNum);
                            this.cellRow.Height = param.RowHights == null ? (short)(20 * 200) : (short)(20 * param.RowHights[index]);
                            index++;
                        }
                        this.DrawCell(cell);
                    }
                }
            }
            catch (Exception ex)
            {
                Logger.Log(Level.Error, ex.ToString());
                throw;
            }
        }
        #region 私有方法
        /// <summary>
        /// 画标题
        /// </summary>
        private void DrawCaption(ExcelCell caption)
        {
            if (!string.IsNullOrEmpty(caption.CellValue))
            {
                CellRangeAddress region = new CellRangeAddress(this.rowNum, this.rowNum, 0, this.cellWides.Count - 1);
                this.Sheet.AddMergedRegion(region);
                ICell cell = this.cellRow.CreateCell(0);
                cell.SetCellValue(caption.CellValue);
                var cellParam = this.GetCellParam(caption);
                cell.CellStyle = ExcelStyle.GetHeadStyleByParam(this.WorkBook,cellParam);
                if (caption.IsAddBording)
                    for (int i = region.FirstRow; i <= region.LastRow; i++)
                    {
                        IRow row = HSSFCellUtil.GetRow(i, this.Sheet);
                        for (int j = region.FirstColumn; j <= region.LastColumn; j++)
                        {
                            ICell singleCell = HSSFCellUtil.GetCell(row, (short)j);
                            singleCell.CellStyle = cell.CellStyle;
                        }
                    }
            }
        }
        /// <summary>
        /// 画标题
        /// </summary>
        private void DrawTitle(ExcelCell cell)
        {
            ICell c = this.cellRow.CreateCell(cell.CellNumber);
            c.SetCellValue(cell.CellValue);
            var cellParam = this.GetCellParam(cell);
            c.CellStyle = ExcelStyle.GetTitleStyleByParam(this.WorkBook, cellParam);
            this.Sheet.AddMergedRegion(new CellRangeAddress(this.rowNum, this.rowNum, cell.CellNumber, cell.CellNumber + cell.CellCount - 1));
        }
        /// <summary>
        /// 画单元格
        /// </summary>
        private void DrawCell(ExcelCell cell)
        {
            if (cell.IsCaption)
                this.DrawCaption(cell);
            else if (cell.IsTitle)
                this.DrawTitle(cell);
            else
            {
                //this.cellRow = this.Sheet.CreateRow(cell.RowNumber);
                CellRangeAddress region = new CellRangeAddress(this.rowNum - cell.CellRowCount + 1, this.rowNum, cell.CellNumber, cell.CellNumber + cell.CellCount - 1);
                ICell cl = this.cellRow.CreateCell(cell.CellNumber);
                var cellParam = this.GetCellParam(cell);
                if (!DataTypeDictionary.ContainsKey(cellParam))
                {
                    var tempStype = this.WorkBook.CreateCellStyle();
                    var style = ExcelStyle.GetDataStyleByParam(this.WorkBook,cellParam);
                    tempStype.CloneStyleFrom(style);
                    this.DataTypeDictionary.Add(cellParam, tempStype);
                }
                cl.CellStyle = this.DataTypeDictionary[cellParam];
                if (cell.DataType == EnumDataType.Number && cell.Digit > 0)
                {
                    double dbv = Convert.ToDouble(cell.CellValue);
                    dbv = System.Math.Round(dbv, cell.Digit);
                    var format = this.WorkBook.CreateDataFormat();
                    cl.CellStyle.DataFormat = format.GetFormat("0.".PadRight(cell.Digit + 2, '0'));
                    cl.SetCellValue(dbv);
                    //string[] arr = dbv.ToString().Split('.');
                    //// 以点分隔出小数部分
                    //if (arr.Length > 1)
                    //{
                    //    // 把数字都替换成0，即是保留的位数格式
                    //    var precision = "0." + Regex.Replace(arr[1], @"\d", "0");
                    //    var format = this.WorkBook.CreateDataFormat();
                    //    cl.CellStyle.DataFormat = format.GetFormat("0.".PadRight(cell.Digit + 2, '0'));
                    //}
                }
                else if (cell.DataType == EnumDataType.Number && cell.Digit == 0)
                {
                    double dbv = Convert.ToDouble(cell.CellValue);
                    dbv = System.Math.Round(dbv, cell.Digit);
                    cl.SetCellValue(dbv);
                }
                else if (cell.IsRMB)
                {
                    cl.SetCellValue("￥" + cell.CellValue);
                }
                else if (cell.DataType == EnumDataType.General)
                {
                    var format = this.WorkBook.CreateDataFormat();
                    cl.CellStyle.DataFormat = format.GetFormat("G/通用格式");
                    cl.SetCellValue(cell.CellValue);
                }
                else
                {
                    cl.SetCellValue(cell.CellValue);
                }
                this.Sheet.SetColumnWidth(cell.CellNumber, this.cellWides[cell.CellNumber] * 256);
                if (cell.CellCount > 1 || cell.CellRowCount > 1)
                {
                    this.Sheet.AddMergedRegion(region);
                    for (int i = region.FirstRow; i <= region.LastRow; i++)
                    {
                        IRow row = HSSFCellUtil.GetRow(i, this.Sheet);
                        for (int j = region.FirstColumn; j <= region.LastColumn; j++)
                        {
                            ICell singleCell = HSSFCellUtil.GetCell(row, (short)j);
                            singleCell.CellStyle = cl.CellStyle;
                        }
                    }
                }
            }
        }
        /// <summary>
        /// 获取数据单元格样式
        /// </summary>
        /// <param name="cellNumber"></param>
        /// <returns></returns>
        private ICellStyle GetCellDataStyle(ExcelCell cell)
        {
            if (cell.IsAddBording)
            {
                if (cell.CellType.Equals(EnumCellType.Right))
                    return this.BordingRightStyle;
                if (cell.CellType.Equals(EnumCellType.Center))
                    return this.BordingCenterStyle;
                return this.BordingLeftStyle;
            }
            else
            {
                if (cell.CellType.Equals(EnumCellType.Right))
                    return this.NoBordingRightStyle;
                if (cell.CellType.Equals(EnumCellType.Center))
                    return this.NoBordingCenterStyle;
                return this.NoBordingLeftStyle;
            }
        }
        /// <summary>
        /// 获取合并单元格的数据显示
        /// </summary>
        /// <returns></returns>
        private ICellStyle GetRegionCellDataStyle()
        {
            return this.RegionStyle;
        }
        /// <summary>
        /// 设置标题列宽度
        /// </summary>
        private void SetExcelCaptionWides()
        {
            if (this.captionCellCount <= 0)
                this.captionCellCount = 6;
            if (this.cellWides != null && this.cellWides.Count > 0)
            {
                while (this.cellWides.Count < this.captionCellCount)
                {
                    this.cellWides.AddRange(this.cellWides);
                }
            }
            else
            {
                for (int i = 0; i < this.captionCellCount; i++)
                    this.cellWides.Add(20);
            }
        }
        /// <summary>
        /// 获取单元格样式结构
        /// </summary>
        /// <param name="cell"></param>
        /// <returns></returns>
        private ExcelStyleParam GetCellParam(ExcelCell cell)
        {
            return new ExcelStyleParam() { IsAddBording = cell.IsAddBording, DataType = cell.DataType, Digit = cell.Digit,FontSize = cell.FontSize,Horizontal = cell.CellType,Vertcial = cell.VerticalType };
        }
        #endregion
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
namespace Cis.Excel
{
    public class MultipleExcelParam
    {
        /// <summary>
        /// 标题占用的单元格数
        /// </summary>
        public int CaptionCellCount { get; set; }
        /// <summary>
        /// 单元格宽度，
        /// </summary>
        public List<int> CellWides { get; set; }
        /// <summary>
        /// 数据源
        /// </summary>
        public List<ExcelCell> DataCells { get; set; }
        /// <summary>
        /// sheet名称
        /// </summary>
        public string SheetName { get; set; }
        /// <summary>
        /// Excel的高度
        /// </summary>
        public List<short> RowHights { get; set; }
        /// <summary>
        /// 所在workBook 
        /// </summary>
        public int BookIndex { get; set; }
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Reflection;
namespace Cis.Excel
{
    public static class ReflectionHelper
    {
        /// <summary>
        /// 判断属性是否存在
        /// </summary>
        /// <param name="propertyName"></param>
        /// <param name="srcObject"></param>
        /// <returns></returns>
        public static bool Exists(string propertyName, object srcObject)
        {
            if (srcObject == null)
            {
                throw new ArgumentNullException("srcObject");
            }
            if ((propertyName == null) || (propertyName == String.Empty) || (propertyName.Length == 0))
            {
                throw new ArgumentException("Property name cannot be empty or null.");
            }
            PropertyInfo propInfoSrcObj = srcObject.GetType().GetProperty(propertyName);
            return (propInfoSrcObj != null);
        }
        /// <summary>
        /// 根据属性名称获取属性值
        /// </summary>
        /// <param name="srcObject"></param>
        /// <param name="propertyName"></param>
        /// <returns></returns>
        public static object GetPropertyValue(object srcObject, string propertyName)
        {
            if (srcObject == null)
            {
                throw new ArgumentNullException("srcObject");
            }
            if ((propertyName == null) || (propertyName == String.Empty) || (propertyName.Length == 0))
            {
                throw new ArgumentException("Property name cannot be empty or null.");
            }
            if (srcObject is Newtonsoft.Json.Linq.JObject)
            {
                return (srcObject as Newtonsoft.Json.Linq.JObject)[propertyName];
            }
            PropertyInfo propertyInfo = srcObject.GetType().GetProperty(propertyName);
            object value = propertyInfo.GetValue(srcObject, null);
            if (value == null)
                value = string.Empty;
            return value;
        }
    }
}
using System;
using System.Collections.Generic;
using NPOI.SS.UserModel;
using NPOI.HSSF.UserModel;
using NPOI.HSSF.Util;
using NPOI.SS.Util;
using System.Linq;
namespace Cis.Excel
{
    public class SingleExcel 
    {
        #region 字段
        HSSFSheet sheet;
        private int rowNum;
        private SingleParam param = new SingleParam();
        private List<int> cellWides = new List<int>();
        private string captionName { get; set; }
        private IRow cellRow;
        #endregion
        #region 属性
        internal SingleParam Param
        {
            get { return this.param; }
            set { this.param = value; }
        }
        internal Dictionary<string, ICellStyle> DataStyles = new Dictionary<string, ICellStyle>();
        #endregion 
        #region 方法
        /// <summary>
        /// 创建Sheet
        /// </summary>
        public int CreateSheet()
        {
            this.sheet = (HSSFSheet)this.Param.WorkBook.CreateSheet(this.Param.SheetName);
            this.AddDataStyles(this.Param.WorkBook);
            this.captionName = this.Param.Caption;
            this.SetExcelCaptionWides();
            this.DrawCaption();
            foreach (ExcelCell cell in this.Param.SingleSource)
            {
                if (cell.IsTitle)
                {
                    this.DrawTitle(cell);
                }
                else if (cell.IsReportTitle)
                {
                    this.DrawReportTitle(cell);
                }
                else
                {
                    this.DrawCell(cell);
                }
            }
            return 1;
        }
        #endregion
        #region 私有方法
        /// <summary>
        /// 画标题
        /// </summary>
        private void DrawCaption()
        {
            if (!string.IsNullOrEmpty(captionName))
            {
                IRow headeRow = this.sheet.CreateRow(0);
                CellRangeAddress region = new CellRangeAddress(0, 0, 0, this.cellWides.Count - 1);
                this.sheet.AddMergedRegion(region);
                ICell cell = headeRow.CreateCell(0);
                cell.SetCellValue(captionName);
                for (int i = region.FirstRow; i <= region.LastRow; i++)
                {
                    IRow row = HSSFCellUtil.GetRow(i, this.sheet);
                    for (int j = region.FirstColumn; j <= region.LastColumn; j++)
                    {
                        ICell singleCell = HSSFCellUtil.GetCell(row,(short)j);
                        singleCell.CellStyle = ExcelStyle.GetSingleHeadStyle(this.param.WorkBook);
                    }
                }             
            }
        }
        /// <summary>
        /// 画标题
        /// </summary>
        private void DrawTitle(ExcelCell cell)
        {
            IRow headeRow = this.sheet.CreateRow(cell.RowNumber);
            this.rowNum = cell.RowNumber;
            ICell cl = headeRow.CreateCell(0);
            ICell c = headeRow.CreateCell(0);
            c.SetCellValue(cell.CellValue);
            c.CellStyle = ExcelStyle.GetSingleTielStyle(this.Param.WorkBook);
            this.sheet.AddMergedRegion(new CellRangeAddress(cell.RowNumber, cell.RowNumber, 0, this.cellWides.Count - 1));
        }
        /// <summary>
        /// 画单元格
        /// </summary>
        private void DrawCell(ExcelCell cell)
        {
            if (cell.RowNumber != this.rowNum)
            {
                this.cellRow = this.sheet.CreateRow(cell.RowNumber);
                this.rowNum = cell.RowNumber;
            }
            CellRangeAddress region = new CellRangeAddress(this.rowNum, this.rowNum, cell.CellNumber, cell.CellNumber + cell.CellCount - 1);
            ICell cl = this.cellRow.CreateCell(cell.CellNumber);
            if (cell.DataType == EnumDataType.Number && cell.Digit > 0)
            {
                double dbv = Convert.ToDouble(cell.CellValue);
                dbv = System.Math.Round(dbv, cell.Digit);
                cl.SetCellValue(dbv);
            }
            else if(cell.IsRMB)
            {
                cl.SetCellValue("￥" + cell.CellValue);
            }
            else
            {
                 cl.SetCellValue(cell.CellValue);
            }
            cl.CellStyle = this.GetCellDataStyle(cell);         
            this.sheet.SetColumnWidth(cell.CellNumber, this.cellWides[cell.CellNumber] * 256);
            if (cell.CellCount > 1)
            {
                this.sheet.AddMergedRegion(region);
                for (int i = region.FirstRow; i <= region.LastRow; i++)
                {
                    IRow row = HSSFCellUtil.GetRow(i, this.sheet);
                    for (int j = region.FirstColumn; j <= region.LastColumn; j++)
                    {
                        ICell singleCell = HSSFCellUtil.GetCell(row, (short)j);
                        singleCell.CellStyle = this.GetRegionCellDataStyle();
                    }
                }  
            }
            
                          
        }
        /// <summary>
        /// 获取数据单元格样式
        /// </summary>
        /// <param name="cellNumber"></param>
        /// <returns></returns>
        //private ICellStyle GetCellDataStyle(ExcelCell cell)
        //{
        //    return ExcelStyle.GetSingleDataCellType(this.Param.WorkBook, cell.CellType); ;
        //}
        /// <summary>
        /// 获取合并单元格的数据显示
        /// </summary>
        /// <returns></returns>
        private ICellStyle GetRegionCellDataStyle()
        {
            ICellStyle style = ExcelStyle.GetDataCellStyle(this.Param.WorkBook);
            return style;
        }
        /// <summary>
        /// 设置标题列宽度
        /// </summary>
        private void SetExcelCaptionWides()
        {
            if (this.Param.CaptionCellCount <= 0)
                this.Param.CaptionCellCount = 6;
            if (this.Param.CellWides != null && this.Param.CellWides.Count > 0)
            {
                while (this.cellWides.Count < this.Param.CaptionCellCount)
                {
                    this.cellWides.AddRange(this.Param.CellWides);
                }
            }
            else
            {
                for (int i = 0; i < this.param.CaptionCellCount; i++)
                    this.cellWides.Add(20);
            }
        }
        /// <summary>
        /// 画报表的表头，涉及到行合并和列合并
        /// </summary>
        /// <param name="cell"></param>
        private void DrawReportTitle(ExcelCell cell)
        {
            if (this.cellRow == null)
                this.cellRow = this.sheet.CreateRow(cell.RowNumber);
            if (cell.RowNumber != this.rowNum)
            {
                this.cellRow = this.sheet.CreateRow(cell.RowNumber);
                this.rowNum = cell.RowNumber;
            }
            CellRangeAddress region = new CellRangeAddress(this.rowNum-cell.CellRowCount+1,cell.RowNumber, cell.CellNumber- cell.CellCount+1, cell.CellNumber);
            ICell cl = this.cellRow.CreateCell(cell.CellNumber);
            cl.SetCellValue(cell.CellValue);
            cl.CellStyle = this.GetCellDataStyle(cell);
            this.sheet.SetColumnWidth(cell.CellNumber, this.cellWides[cell.CellNumber] * 256);
            if (cell.CellCount > 1||cell.CellRowCount >1)
            {
                this.sheet.AddMergedRegion(region);
                for (int i = region.FirstRow; i <= region.LastRow; i++)
                {
                    IRow row = HSSFCellUtil.GetRow(i, this.sheet);
                    for (int j = region.FirstColumn; j <= region.LastColumn; j++)
                    {
                        ICell singleCell = HSSFCellUtil.GetCell(row, (short)j);
                        singleCell.CellStyle = this.GetCellDataStyle(cell);
                    }
                }
            }
        }
        /// <summary>
        /// 添加数据样式字典
        /// </summary>
        /// <param name="wb"></param>
        private void AddDataStyles(IWorkbook wb)
        {
            this.DataStyles.Clear();
            this.DataStyles.Add("left",ExcelStyle.GetLeftDataStyle(wb));
            this.DataStyles.Add("right", ExcelStyle.GetRightDataCellStyle(wb));
            this.DataStyles.Add("center", ExcelStyle.GetCenterDataStyle(wb));
        }
        public ICellStyle GetCellDataStyle(ExcelCell cell)
        {
            if (cell.CellType == EnumCellType.Left)
                return this.DataStyles["left"];
            else if (cell.CellType == EnumCellType.Right)
                return this.DataStyles["right"];
            else
                return this.DataStyles["center"];
        }
        #endregion
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
namespace Cis.Excel
{
    public class SingleExcelParam
    {
        /// <summary>
        /// 标题
        /// </summary>
        public string Caption { get; set; }
        /// <summary>
        /// 标题占用的单元格数
        /// </summary>
        public int CaptionCellCount { get; set; }
        /// <summary>
        /// 单元格宽度，
        /// </summary>
        public List<int> CellWides { get; set; }
        /// <summary>
        /// 数据源
        /// </summary>
        public List<ExcelCell> SingleCells { get; set; }
        /// <summary>
        /// sheet名称
        /// </summary>
        public string SheetName { get; set; }
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using NPOI.HSSF.UserModel;
using NPOI.SS.UserModel;
using System.IO;
using Cis.Log;
namespace Cis.Excel
{
    public class SingleModel
    {
        /// <summary>
        /// 根据Excel模板生成Excel文件
        /// </summary>
        /// <param name="modelPath">模板地址</param>
        /// <param name="excelPath">Excel文件</param>
        /// <param name="values">字典的key对应Excel模板中的Key Key必须能唯一标识单元格,value为将要添加的数据</param>
        public MemoryStream BuildExcel(string modelPath,Dictionary<string,dynamic> values)
        {
            try
            {
                //把指定路劲下的Excel模板文件读入到workbook变量里
                var keys = values.Keys;
                HSSFWorkbook wk = null;
                using (FileStream fs = File.Open(modelPath, FileMode.Open, FileAccess.Read, FileShare.ReadWrite))
                {
                    wk = new HSSFWorkbook(fs);
                    fs.Close();
                }
                //遍历所有sheet页并根据字典中的值更新相应的单元格
                int sheetNumbers = wk.Workbook.NumSheets;
                for (int i = 0; i < sheetNumbers; i++)
                {
                    string sheetName = wk.Workbook.GetSheetName(i);
                    var sheet = wk.GetSheet(sheetName);
                    for (int j = 0; j < sheet.LastRowNum; j++)
                    {
                        var row = sheet.GetRow(j);
                        for (int k = 0; k < row.LastCellNum; k++)
                        {
                            var cell = row.GetCell(k);
                            if (cell != null)
                            {
                                string cellvalue = this.GetCellStringValue(cell);
                                if (keys.Contains(cellvalue))
                                {
                                    var value = values[cellvalue];
                                    if (value != null)
                                        cell.SetCellValue(value);
                                }
                                else
                                {
                                    //如果单元格内容中有嵌套key,则解析并替换key的值
                                    string pattern = @"\{.*?\}";
                                    Regex regex = new Regex(pattern, RegexOptions.IgnoreCase);
                                    MatchCollection matches = regex.Matches(cellvalue);
                                    foreach (Match match in matches)
                                    {
                                        string olderValue = match.Value;
                                        string key = match.Value.Trim('{', '}');
                                        if (keys.Contains(key))
                                          cellvalue = cellvalue.Replace(olderValue,Convert.ToString(values[key]));
                                    }
                                    cell.SetCellValue(cellvalue);
                                }   
                            }
                        }
                    }
                }
                MemoryStream ms = new MemoryStream();
                wk.Write(ms);
                ms.Flush();
                ms.Position = 0;
                return ms;
            }
            catch (Exception ex)
            {
                Logger.Log(Level.Error, ex.ToString());
                return null;
            }
            
        }
        #region  私有方法
        /// <summary>
        /// 获取Excel单元格string类型的值
        /// </summary>
        /// <param name="cell"></param>
        /// <returns></returns>
        private string GetCellStringValue(ICell cell)
        {
            string tempValue = "";
            switch (cell.CellType)
            {
                case CellType.Blank:
                    break;
                case CellType.Boolean:
                    tempValue = cell.BooleanCellValue.ToString();
                    break;
                case CellType.Error:
                    break;
                case CellType.Formula:
                    tempValue = cell.CellFormula.ToString();
                    break;
                case CellType.Numeric:
                    tempValue = cell.NumericCellValue.ToString();
                    break;
                case CellType.String:
                    tempValue = cell.StringCellValue.ToString();
                    break;
                case CellType.Unknown:
                    break;
                default:
                    break;
            }
            return tempValue;
        }
        #endregion  私有方法
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using NPOI.SS.UserModel;
using NPOI.HSSF.UserModel;
using NPOI.SS.Util;
using NPOI.Util;
namespace Cis.Excel
{
    internal class SingleParam 
    {
        /// <summary>
        /// 工作簿
        /// </summary>
        public HSSFWorkbook WorkBook { get; set; }
        /// <summary>
        /// 数据源
        /// </summary>
        public List<ExcelCell> SingleSource { get; set; }
        /// <summary>
        /// Sheet名称
        /// </summary>
        public string SheetName { get; set; }
        /// <summary>
        /// 标题
        /// </summary>
        public string Caption { get; set; }
        /// <summary>
        /// 标题单元格宽度
        /// </summary>
        public int CaptionCellCount { get; set; }
        /// <summary>
        /// 单元格宽度列表
        /// </summary>
        public List<int> CellWides { get; set; }
    }
}
#region copyright
// <copyright file="Exception.cs" company="cis"> 
// Copyright (c) cis. All Right Reserved
// </copyright>
// <author>孙强</author>
// <datecreated>2018-04-20</datecreated>
#endregion
namespace Cis.Exception
{
    using System;
    using System.Runtime.Serialization;
    /// <summary>
    /// 列不存在的异常类
    /// </summary>
    [Serializable]
    public class ColumnNotExistException : System.Exception
    {
        #region Constructors and Destructors
        public ColumnNotExistException()
        {
        }
        public ColumnNotExistException(string message)
            : base(message)
        {
        }
        public ColumnNotExistException(string message, Exception inner)
            : base(message, inner)
        {
        }
        protected ColumnNotExistException(SerializationInfo info, StreamingContext context)
            : base(info, context)
        {
        }
        #endregion
    }
}
#region copyright
// <copyright file="DataAccessExcepton.cs" company="cis"> 
// Copyright (c) cis. All Right Reserved
// </copyright>
// <author>孙强</author>
// <datecreated>2018-04-20</datecreated>
#endregion
namespace Cis.Exception
{
    using System;
    using System.Runtime.Serialization;
    [Serializable]
    public class DataAccessExcepton : Exception
    {
        #region Constructors and Destructors
        public DataAccessExcepton()
        {
        }
        public DataAccessExcepton(string message)
            : base(message)
        {
        }
        public DataAccessExcepton(string message, Exception inner)
            : base(message, inner)
        {
        }
        protected DataAccessExcepton(SerializationInfo info, StreamingContext context)
            : base(info, context)
        {
        }
        #endregion
    }
}
#region copyright
// <copyright file="NotSupportExpressionException.cs" company="cis"> 
// Copyright (c) cis. All Right Reserved
// </copyright>
// <author>孙强</author>
// <datecreated>2018-04-20</datecreated>
#endregion
namespace Cis.Exception
{
    using System;
    using System.Runtime.Serialization;
    /// <summary>
    /// 不支持的表达式异常类
    /// </summary>
    [Serializable]
    public class NotSupportExpressionException : System.Exception
    {
        #region Constructors and Destructors
        public NotSupportExpressionException()
        {
        }
        public NotSupportExpressionException(string message)
            : base(message)
        {
        }
        public NotSupportExpressionException(string message, Exception inner)
            : base(message, inner)
        {
        }
        protected NotSupportExpressionException(SerializationInfo info, StreamingContext context)
            : base(info, context)
        {
        }
        #endregion
    }
}
using Cis.Fm.Auth.Dto;
using Newtonsoft.Json;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
namespace Cis.Fm.Auth
{
    public class OAuthAgent
    {
        public OAuthUser GetOauthUser(string baseApiUrl, BackParam backParams, string transNo)
        {
            if (transNo == null)
            {
                throw new Exception("非法回调登录页");
            }
            if (Convert.ToInt64(transNo) != backParams.TransNo)
            {
                throw new Exception("非法会话");
            }
            WebApiAgent agent = new WebApiAgent();
            var oAuthUser = agent.Send<OAuthUser>(baseApiUrl + "/user/GetUserInfo", backParams.Ticket);
            return oAuthUser;
        }
    }
}
using Cis.Fm.Tools;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Web;
namespace Cis.Fm.Auth
{
    public class OAuthHelper
    {
        private static Encoding encoding = Encoding.UTF8;
        private static byte[] aesKey = SecurityHelper.GetAesKey("8CB5CDA1742572A487D9401E1268947E");
        public static string EncryptParams(string ps)
        {
            var compByte = ZipHelper.Compress(encoding.GetBytes(ps));
            var enc = SecurityHelper.AesEncrypt(compByte, aesKey);
            
            return HttpUtility.UrlEncode(Convert.ToBase64String(enc));
        }
        public static string DecryptParams(string ps)
        {
            var encByte = Convert.FromBase64String(ps);
            var compByte = SecurityHelper.AesDecrypt(encByte, aesKey);
            var deCompByte = ZipHelper.Decompress(compByte);
            return encoding.GetString(deCompByte);
        }
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
namespace Cis.Fm.Auth.Dto
{
    public class BackParam
    {
        public string Url { get; set; }
        public string Ticket { get; set; }
        public long TransNo { get; set; }
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
namespace Cis.Fm.Auth.Dto
{
    public class LoginParam
    {
        public string AppId { get; set; }
        public string AppName { get; set; }
        public string Url { get; set; }
        public string BackUrl { get; set; }
        public string LogoImgUrl { get; set; }
        
        public long TransNo { get; set; }
    }
}
namespace Cis.Fm.Auth.Dto
{
    /// <summary>
    /// 用户信息
    /// </summary>
    public class OAuthUser
    {
        /// <summary>
        /// 主键,标识列,序列 就这样
        /// </summary>
        public string Id { get; set; }
        /// <summary>
        /// 用户编码
        /// </summary>
        public string Code { get; set; }
        /// <summary>
        /// 用户名称
        /// </summary>
        public string Name { get; set; }
        /// <summary>
        /// 机构编码
        /// </summary>
        public string OrgId { get; set; }
        /// <summary>
        /// 机构名称
        /// </summary>
        public string OrgName { get; set; }
        /// <summary>
        /// 是否内置角色 1：是0：否
        /// </summary>
        public string IsSysFlag { get; set; }
        /// <summary>
        /// 附加用户信息 用于子系统用户权限
        /// </summary>
        public string Append { get; set; }
        /// <summary>
        /// 用户工号
        /// </summary>
        public string WorkNo { get; set; }
        /// <summary>
        /// 用户类型
        /// </summary>
        public string UserType { get; set; }
        /// <summary>
        /// 用户登录码 验证用户是否已重新登录
        /// </summary>
        public string LoginKey { get; set; }
    }
}
using System;
using System.Collections.Generic;

namespace Abp.Configuration.Startup
{
    /// <summary>
    ///
    /// </summary>
    internal class FmStartupConfiguration : IFmStartupConfiguration
    {
        ///// <summary>
        ///// Reference to the IocManager.
        ///// </summary>
        //public IWindsorContainer WindsorContainer { get; }
        ///// <summary>
        ///// Private constructor for singleton pattern.
        ///// </summary>
        //public FmStartupConfiguration(IWindsorContainer windsorContainer)
        //{
        //    WindsorContainer = WindsorContainer;
        //}
    }
}using System;

namespace Abp.Configuration.Startup
{
    /// <summary>
    /// 
    /// </summary>
    public interface IFmStartupConfiguration
    {
        ///// <summary>
        ///// Gets the IOC manager associated with this configuration.
        ///// </summary>
        //IWindsorContainer WindsorContainer { get; }
    }
}using System;
using System.Collections.Generic;
using System.Text;
namespace Cis.Fm.FileSystem
{
    public interface IFsManager
    {
    }
}
using System;
namespace Cis.Fm.Rpc
{
    public class AuthorizationInfo
    {
        /// <summary>
        /// 应用编号
        /// </summary>
        public string AppId { get; set; }
        /// <summary>
        /// 是否启用签名验证
        /// </summary>
        public bool IsSign { get; set; }
        /// <summary>
        /// 是否启用aes数据加密
        /// </summary>
        public bool IsEncrypt { get; set; }
        /// <summary>
        /// aes密钥
        /// </summary>
        public string EncryptKey { get; set; }
        /// <summary>
        /// 是否启用双向数据压缩
        /// </summary>
        public bool IsCompress { get; set; }
        /// <summary>
        /// 授权凭据
        /// </summary>
        public string AccessToken { get; set; }
        /// <summary>
        /// 授权时间
        /// </summary>
        public DateTime AccessTime { get; set; }
        /// <summary>
        /// 凭据过期时间
        /// </summary>
        public DateTime ExpiryTime { get; set; }
    }
}
using Microsoft.AspNetCore.Http;
namespace Cis.Fm.Rpc
{
    public interface IClientAgent
    {
        string Execute(IRequestInfo reqInfo);
        string Execute(string url);
        string Execute(string url, HttpRequest request);
        T Execute<T>(IRequestInfo reqInfo) where T : new();
        T Execute<T>(string url) where T : new();
        T Execute<T>(string url, HttpRequest request) where T : new();
    }
}
using Microsoft.AspNetCore.Http;
using System;
using System.Collections.Generic;
using System.Text;
namespace Cis.Fm.Rpc
{
    public interface IRequestInfo
    {
        string Url { get; set; }
        string Method { get; set; }
        AuthorizationInfo AuthorizationInfo { get; set; }
        Dictionary<string, string> Headers { get; set; }
        Dictionary<string, string> Forms { get; set; }
        Dictionary<string, string> Querys { get; set; }
        string UserInfo { get; set; }
        IRequestInfo AddHeader(string key, string value);
        IRequestInfo AddForm(string key, string value);
        IRequestInfo AddQuery(string key, string value);
        IRequestInfo AddUserInfo(string userInfo);
        IRequestInfo AddAuthorizationInfo(AuthorizationInfo authorizationInfo);
        IRequestInfo AddRequestInfo(HttpRequest request);
    }
}
namespace Cis.Fm.Rpc
{
    public class ServiceConfig
    {
        /// <summary>
        /// 服务名称
        /// </summary>
        public string ServiceName { get; set; }
        /// <summary>
        /// 服务地址
        /// </summary>
        public string ApiUrl { get; set; }
        /// <summary>
        /// 认证地址
        /// </summary>
        public string AuthorizationUrl { get; set; }
        /// <summary>
        /// 
        /// </summary>
        public string AppId { get; set; }
        /// <summary>
        /// 
        /// </summary>
        public string ApiKey { get; set; }
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
namespace Cis.Fm.Rpc.Dto
{
    public class ApiRequest
    {
        /// <summary>
        /// 服务名称
        /// </summary>
        public string ServiceName { get; set; }
        /// <summary>
        /// 路由编号
        /// </summary>
        public string RouteId { get; set; }
        /// <summary>
        /// 签名算法
        /// None|RsaWithMd5
        /// </summary>
        public string SignType { get; set; } = "None";
        /// <summary>
        /// 加密算法
        /// None|Aes|Rsa
        /// </summary>
        public string EncrypType { get; set; } = "None";
        /// <summary>
        /// 是否压缩 GZip
        /// true|false
        /// </summary>
        public bool IsCompress { get; set; } = false;
        /// <summary>
        /// 传输对象
        /// </summary>
        public ApiRequestBody Body { get; set; }
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
namespace Cis.Fm.Rpc.Dto
{
    public class ApiRequestBody
    {
        /// <summary>
        /// 凭据
        /// </summary>
        public string Authorization { get; set; }
        /// <summary>
        /// 流水号
        /// </summary>
        public long TransNo { get; set; }
        /// <summary>
        /// 签名
        /// </summary>
        public string Sign { get; set; }
        
        /// <summary>
        /// 请求体
        /// </summary>
        public object Body { get; set; }
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
namespace Cis.Fm.Rpc.Dto
{
    public class ApiResponse
    {
        /// <summary>
        /// 签名算法
        /// None|RsaWithMd5
        /// </summary>
        public string SignType { get; set; } = "None";
        /// <summary>
        /// 加密算法
        /// None|Aes|Rsa
        /// </summary>
        public string EncrypType { get; set; } = "None";
        /// <summary>
        /// 是否压缩 GZip
        /// true|false
        /// </summary>
        public bool IsCompress { get; set; } = false;
        /// <summary>
        /// 返回码
        /// 0：成功 1：解压失败 2：解密失败 3：签名验证失败
        /// </summary>
        public int Code { get; set; }
        /// <summary>
        /// 返回消息
        /// </summary>
        public string Msg { get; set; }
        /// <summary>
        /// 传输对象
        /// </summary>
        public ApiResponseBody Body { get; set; }
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
namespace Cis.Fm.Rpc.Dto
{
    public class ApiResponseBody
    {
        /// <summary>
        /// 流水号
        /// </summary>
        public long TransNo { get; set; }
        /// <summary>
        /// 签名
        /// </summary>
        public string Sign { get; set; }
        /// <summary>
        /// 请求体 AjaxResponse
        /// </summary>
        public string Body { get; set; }
    }
}
namespace Cis.Fm.Rpc.Dto
{
    public abstract class Error 
    {
        protected Error(string message, double code)
        {
            Message = message;
            Code = code;
        }
        public string Message { get; private set; }
        public double Code { get; private set; }
        public override string ToString()
        {
            return Message;
        }
    }
}
using System.Collections.Generic;
namespace Cis.Fm.Rpc.Dto
{
    public class ErrorResponse : Response
    {
        public ErrorResponse(Error error) 
            : base(new List<Error>{error})
        {
        }
        public ErrorResponse(List<Error> errors) 
            : base(errors)
        {
        }
    }
}
using System.Collections.Generic;
namespace Cis.Fm.Rpc.Dto
{
#pragma warning disable SA1649 // File name must match first type name
    public class ErrorResponse<T> : Response<T>
#pragma warning restore SA1649 // File name must match first type name
    {
        public ErrorResponse(Error error) 
            : base(new List<Error> {error})
        {            
        }
        public ErrorResponse(List<Error> errors) 
            : base(errors)
        {
        }
    }
}
namespace Cis.Fm.Rpc.Dto
{
    public class OkResponse : Response
    {
        public OkResponse()
        {
        }
    }
}namespace Cis.Fm.Rpc.Dto
{
#pragma warning disable SA1649 // File name must match first type name
    public class OkResponse<T> : Response<T>
#pragma warning restore SA1649 // File name must match first type name
    {
        public OkResponse(T data) : base(data)
        {
        }
    }
}
using System.Collections.Generic;
namespace Cis.Fm.Rpc.Dto
{
    public abstract class Response
    {
        protected Response()
        {
            Errors = new List<Error>();
        }
        protected Response(List<Error> errors)
        {
            Errors = errors ?? new List<Error>();
        } 
        public List<Error> Errors { get; }
        public bool IsError => Errors.Count > 0;
    }
}
using System.Collections.Generic;
namespace Cis.Fm.Rpc.Dto
{
#pragma warning disable SA1649 // File name must match first type name
    public abstract class Response<T> : Response
#pragma warning restore SA1649 // File name must match first type name
    {
        protected Response(T data)
        {
            Data = data;
        }
        protected Response(List<Error> errors) : base(errors)
        {
        }
        public T Data { get; private set; }        
    }
} 
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
namespace Cis.Fm.Tools
{
    /// <summary>
    /// 枚举处理工具类
    /// </summary>
    public class EnumHelper
    {
    }
}
//#region copyright
//// <copyright file="RedisCacheHelper"  company="CIS"> 
//// Copyright (c) CIS. All Right Reserved
//// </copyright>
//// <author>hechaoyuan</author>
//// <datecreated>2018/2/28 10:53:18</datecreated>
//#endregion
//using System;
//using System.Collections.Generic;
//using System.Configuration;
//using System.Linq;
//using System.Text;
//using System.Threading.Tasks;
//using ServiceStack.Redis;
//namespace Cis.Fm.Tools
//{
//    public class RedisCacheHelper
//    {
//        private static readonly PooledRedisClientManager pool = null;
//        private static readonly string[] redisHosts = null;
//        public static int RedisMaxReadPool = int.Parse(ConfigurationManager.AppSettings["redis_max_read_pool"]);
//        public static int RedisMaxWritePool = int.Parse(ConfigurationManager.AppSettings["redis_max_write_pool"]);
//        static RedisCacheHelper()
//        {
//            var redisHostStr = ConfigurationManager.AppSettings["redis_server_session"];
//            if (!string.IsNullOrEmpty(redisHostStr))
//            {
//                redisHosts = redisHostStr.Split(',');
//                if (redisHosts.Length > 0)
//                {
//                    pool = new PooledRedisClientManager(redisHosts, redisHosts,
//                        new RedisClientManagerConfig()
//                        {
//                            MaxWritePoolSize = RedisMaxWritePool,
//                            MaxReadPoolSize = RedisMaxReadPool,
//                            AutoStart = true
//                        });
//                }
//            }
//        }
//        public static void ChangeDb(int index)
//        {
//            if (pool != null)
//            {
//                using (var r = pool.GetClient())
//                {
//                    if (r != null)
//                    {
//                        r.Db = index;
//                    }
//                }
//            }
//        }
//        public static void Add<T>(string key, T value, DateTime expiry)
//        {
//            if (value == null)
//            {
//                return;
//            }
//            if (expiry <= DateTime.Now)
//            {
//                Remove(key);
//                return;
//            }
//            try
//            {
//                if (pool != null)
//                {
//                    using (var r = pool.GetClient())
//                    {
//                        if (r != null)
//                        {
//                            r.SendTimeout = 1000;
//                            r.Set(key, value, expiry - DateTime.Now);
//                        }
//                    }
//                }
//            }
//            catch (Exception ex)
//            {
//                string msg = string.Format("{0}:{1}??????!{2}", "cache", "?", key);
//            }
//        }
//        public static void Add<T>(string key, T value, TimeSpan slidingExpiration)
//        {
//            if (value == null)
//            {
//                return;
//            }
//            if (slidingExpiration.TotalSeconds <= 0)
//            {
//                Remove(key);
//                return;
//            }
//            try
//            {
//                if (pool != null)
//                {
//                    using (var r = pool.GetClient())
//                    {
//                        if (r != null)
//                        {
//                            r.SendTimeout = 1000;
//                            r.Set(key, value, slidingExpiration);
//                        }
//                    }
//                }
//            }
//            catch (Exception ex)
//            {
//                string msg = string.Format("{0}:{1}??????!{2}", "cache", "?", key);
//            }
//        }
//        public static T Get<T>(string key)
//        {
//            if (string.IsNullOrEmpty(key))
//            {
//                return default(T);
//            }
//            T obj = default(T);
//            try
//            {
//                if (pool != null)
//                {
//                    using (var r = pool.GetClient())
//                    {
//                        if (r != null)
//                        {
//                            r.SendTimeout = 1000;
//                            obj = r.Get<T>(key);
//                        }
//                    }
//                }
//            }
//            catch (Exception ex)
//            {
//                string msg = string.Format("{0}:{1}??????!{2}", "cache", "???", key);
//            }
//            return obj;
//        }
//        public static IEnumerable<string> GetKeys(string param)
//        {
//            IEnumerable<string> keys = new List<string>();
//            try
//            {
//                if (pool != null)
//                {
//                    using (var r = pool.GetClient())
//                    {
//                        if (r != null)
//                        {
//                            r.SendTimeout = 1000;
//                            keys = r.SearchKeys(param);
//                        }
//                    }
//                }
//            }
//            catch (Exception ex)
//            {
//                string msg = string.Format("{0}:{1}??????!{2}", "cache", "???", param);
//            }
//            return keys;
//        }
//        public static void Remove(string key)
//        {
//            try
//            {
//                if (pool != null)
//                {
//                    using (var r = pool.GetClient())
//                    {
//                        if (r != null)
//                        {
//                            r.SendTimeout = 1000;
//                            r.Remove(key);
//                        }
//                    }
//                }
//            }
//            catch (Exception ex)
//            {
//                string msg = string.Format("{0}:{1}??????!{2}", "cache", "???", key);
//            }
//        }
//        public static bool Exists(string key)
//        {
//            try
//            {
//                if (pool != null)
//                {
//                    using (var r = pool.GetClient())
//                    {
//                        if (r != null)
//                        {
//                            r.SendTimeout = 1000;
//                            return r.ContainsKey(key);
//                        }
//                    }
//                }
//            }
//            catch (Exception ex)
//            {
//                string msg = string.Format("{0}:{1}??????!{2}", "cache", "??????", key);
//            }
//            return false;
//        }
//    }
//}
using System;
using System.Collections.Generic;
using System.Text;
using System.Net;
using System.Net.Security;
using System.Security.Cryptography.X509Certificates;
using System.IO;
using System.Net.Http;
using System.Threading.Tasks;
namespace Cis.Fm.Tools
{
    /// <summary>
    /// 苗建龙 2017-12-14
    /// </summary>
    public class RequestHelper
    {
        public static string GetHtml(string url)
        {
            var handler = new HttpClientHandler()
            {
                AutomaticDecompression = DecompressionMethods.GZip
            };
            //创建HttpClient（注意传入HttpClientHandler）
            using (var http = new HttpClient(handler))
            {
                HttpResponseMessage response = http.GetAsync(url).Result;
                //确保HTTP成功状态值
                response.EnsureSuccessStatusCode();
                //await异步读取最后的JSON（注意此时gzip已经被自动解压缩了，因为上面的AutomaticDecompression = DecompressionMethods.GZip）
                var content = response.Content.ReadAsStringAsync().Result;
                return content;
            }
        }
        public static string PostHtml(string url, Dictionary<string, string> formParams = null)
        {
            var handler = new HttpClientHandler()
            {
                AutomaticDecompression = DecompressionMethods.GZip
            };
            //创建HttpClient（注意传入HttpClientHandler）
            using (var http = new HttpClient(handler))
            {
                //使用FormUrlEncodedContent做HttpContent
                var f = new FormUrlEncodedContent(formParams ?? new Dictionary<string, string>());
                HttpResponseMessage response = http.PostAsync(url, f).Result;
                //确保HTTP成功状态值
                response.EnsureSuccessStatusCode();
                //await异步读取最后的JSON（注意此时gzip已经被自动解压缩了，因为上面的AutomaticDecompression = DecompressionMethods.GZip）
                var content = response.Content.ReadAsStringAsync().Result;
                return content;
            }
        }
    }
}
using System;
using System.IO;
using System.Security.Cryptography;
using System.Text;
using System.Xml;
namespace Cis.Fm.Tools
{
    public static class RsaExtention
    {
        public static void FromXmlStringForCore(this RSA rsa, string xmlString)
        {
            RSAParameters parameters = new RSAParameters();
            XmlDocument xmlDoc = new XmlDocument();
            xmlDoc.LoadXml(xmlString);
            if (xmlDoc.DocumentElement.Name.Equals("RSAKeyValue"))
            {
                foreach (XmlNode node in xmlDoc.DocumentElement.ChildNodes)
                {
                    switch (node.Name)
                    {
                        case "Modulus": parameters.Modulus = Convert.FromBase64String(node.InnerText); break;
                        case "Exponent": parameters.Exponent = Convert.FromBase64String(node.InnerText); break;
                        case "P": parameters.P = Convert.FromBase64String(node.InnerText); break;
                        case "Q": parameters.Q = Convert.FromBase64String(node.InnerText); break;
                        case "DP": parameters.DP = Convert.FromBase64String(node.InnerText); break;
                        case "DQ": parameters.DQ = Convert.FromBase64String(node.InnerText); break;
                        case "InverseQ": parameters.InverseQ = Convert.FromBase64String(node.InnerText); break;
                        case "D": parameters.D = Convert.FromBase64String(node.InnerText); break;
                    }
                }
            }
            else
            {
                throw new Exception("Invalid XML RSA key.");
            }

            rsa.ImportParameters(parameters);
        }

        public static string ToXmlStringForCore(this RSA rsa, bool includePrivateParameters)
        {
            RSAParameters parameters = rsa.ExportParameters(includePrivateParameters);

            if (includePrivateParameters)
            {
                return string.Format("<RSAKeyValue><Modulus>{0}</Modulus><Exponent>{1}</Exponent><P>{2}</P><Q>{3}</Q><DP>{4}</DP><DQ>{5}</DQ><InverseQ>{6}</InverseQ><D>{7}</D></RSAKeyValue>",
                    Convert.ToBase64String(parameters.Modulus),
                    Convert.ToBase64String(parameters.Exponent),
                    Convert.ToBase64String(parameters.P),
                    Convert.ToBase64String(parameters.Q),
                    Convert.ToBase64String(parameters.DP),
                    Convert.ToBase64String(parameters.DQ),
                    Convert.ToBase64String(parameters.InverseQ),
                    Convert.ToBase64String(parameters.D));
            }
            return string.Format("<RSAKeyValue><Modulus>{0}</Modulus><Exponent>{1}</Exponent></RSAKeyValue>",
                    Convert.ToBase64String(parameters.Modulus),
                    Convert.ToBase64String(parameters.Exponent));
        }

    }
    public class SecurityHelper
    {
        private static readonly byte[] IvBytes = { 0x01, 0x23, 0x45, 0x67, 0x89, 0xAB, 0xCD, 0xEF };
        /// <summary>
        /// 默认编码
        /// </summary>
        public static Encoding DefaultEncoding { get; } = Encoding.UTF8;
        #region 通用加密算法
        /// <summary>
        /// 哈希加密算法
        /// </summary>
        /// <param name="hashAlgorithm"> 所有加密哈希算法实现均必须从中派生的基类 </param>
        /// <param name="input"> 待加密的字符串 </param>
        /// <param name="encoding"> 字符编码，为 null 时采用默认编码（UTF-8） </param>
        /// <returns></returns>
        private static string HashEncrypt(HashAlgorithm hashAlgorithm, string input, Encoding encoding = null)
        {
            encoding = encoding ?? DefaultEncoding;
            var data = hashAlgorithm.ComputeHash(encoding.GetBytes(input));
            return BitConverter.ToString(data).Replace("-", "");
        }
        /// <summary>
        /// 验证哈希值
        /// </summary>
        /// <param name="hashAlgorithm"> 所有加密哈希算法实现均必须从中派生的基类 </param>
        /// <param name="unhashedText"> 未加密的字符串 </param>
        /// <param name="hashedText"> 经过加密的哈希值 </param>
        /// <param name="encoding"> 字符编码 </param>
        /// <returns></returns>
        private static bool VerifyHashValue(HashAlgorithm hashAlgorithm, string unhashedText, string hashedText,
            Encoding encoding = null)
        {
            return string.Equals(HashEncrypt(hashAlgorithm, unhashedText, encoding), hashedText,
                StringComparison.OrdinalIgnoreCase);
        }
        #endregion 通用加密算法
        #region MD5 算法
        /// <summary>
        /// MD5 加密
        /// </summary>
        /// <param name="input"> 待加密的字符串 </param>
        /// <param name="encoding"> 字符编码 </param>
        /// <returns></returns>
        public static string Md5Encrypt(string input, Encoding encoding = null)
        {
            return HashEncrypt(MD5.Create(), input, encoding);
        }
        /// <summary>
        /// 验证 MD5 值
        /// </summary>
        /// <param name="input"> 未加密的字符串 </param>
        /// <param name="encoding"> 字符编码 </param>
        /// <returns></returns>
        public static bool VerifyMd5Value(string input, Encoding encoding = null)
        {
            return VerifyHashValue(MD5.Create(), input, Md5Encrypt(input, encoding), encoding);
        }
        #endregion MD5 算法
        #region SHA1 算法
        /// <summary>
        /// SHA1 加密
        /// </summary>
        /// <param name="input"> 要加密的字符串 </param>
        /// <param name="encoding"> 字符编码，为 null 时取默认值 </param>
        /// <returns></returns>
        public static string Sha1Encrypt(string input, Encoding encoding = null)
        {
            return HashEncrypt(SHA1.Create(), input, encoding);
        }
        /// <summary>
        /// 验证 SHA1 值
        /// </summary>
        /// <param name="input"> 未加密的字符串 </param>
        /// <param name="encoding"> 字符编码 </param>
        /// <returns></returns>
        public static bool VerifySha1Value(string input, Encoding encoding = null)
        {
            return VerifyHashValue(SHA1.Create(), input, Sha1Encrypt(input, encoding), encoding);
        }
        #endregion SHA1 算法
        #region SHA256 算法
        /// <summary>
        /// SHA256 加密
        /// </summary>
        /// <param name="input"> 要加密的字符串 </param>
        /// <param name="encoding"> 字符编码 </param>
        /// <returns></returns>
        public static string Sha256Encrypt(string input, Encoding encoding = null)
        {
            return HashEncrypt(SHA256.Create(), input, encoding);
        }
        /// <summary>
        /// 验证 SHA256 值
        /// </summary>
        /// <param name="input"> 未加密的字符串 </param>
        /// <param name="encoding"> 字符编码 </param>
        /// <returns></returns>
        public static bool VerifySha256Value(string input, Encoding encoding = null)
        {
            return VerifyHashValue(SHA256.Create(), input, Sha256Encrypt(input, encoding), encoding);
        }
        #endregion SHA256 算法
        #region SHA384 算法
        /// <summary>
        /// SHA384 加密
        /// </summary>
        /// <param name="input"> 要加密的字符串 </param>
        /// <param name="encoding"> 字符编码 </param>
        /// <returns></returns>
        public static string Sha384Encrypt(string input, Encoding encoding = null)
        {
            return HashEncrypt(SHA384.Create(), input, encoding);
        }
        /// <summary>
        /// 验证 SHA384 值
        /// </summary>
        /// <param name="input"> 未加密的字符串 </param>
        /// <param name="encoding"> 字符编码 </param>
        /// <returns></returns>
        public static bool VerifySha384Value(string input, Encoding encoding = null)
        {
            return VerifyHashValue(SHA256.Create(), input, Sha384Encrypt(input, encoding), encoding);
        }
        #endregion SHA384 算法
        #region SHA512 算法
        /// <summary>
        /// SHA512 加密
        /// </summary>
        /// <param name="input"> 要加密的字符串 </param>
        /// <param name="encoding"> 字符编码 </param>
        /// <returns></returns>
        public static string Sha512Encrypt(string input, Encoding encoding = null)
        {
            return HashEncrypt(SHA512.Create(), input, encoding);
        }
        /// <summary>
        /// 验证 SHA512 值
        /// </summary>
        /// <param name="input"> 未加密的字符串 </param>
        /// <param name="encoding"> 字符编码 </param>
        /// <returns></returns>
        public static bool VerifySha512Value(string input, Encoding encoding = null)
        {
            return VerifyHashValue(SHA512.Create(), input, Sha512Encrypt(input, encoding), encoding);
        }
        #endregion SHA512 算法
        #region HMAC-MD5 加密
        /// <summary>
        /// HMAC-MD5 加密
        /// </summary>
        /// <param name="input"> 要加密的字符串 </param>
        /// <param name="key"> 密钥 </param>
        /// <param name="encoding"> 字符编码 </param>
        /// <returns></returns>
        public static string HmacMd5Encrypt(string input, string key, Encoding encoding = null)
        {
            encoding = encoding ?? DefaultEncoding;
            return HashEncrypt(new HMACMD5(encoding.GetBytes(key)), input, encoding);
        }
        #endregion HMAC-MD5 加密
        #region HMAC-SHA1 加密
        /// <summary>
        /// HMAC-SHA1 加密
        /// </summary>
        /// <param name="input"> 要加密的字符串 </param>
        /// <param name="key"> 密钥 </param>
        /// <param name="encoding"> 字符编码 </param>
        /// <returns></returns>
        public static string HmacSha1Encrypt(string input, string key, Encoding encoding = null)
        {
            encoding = encoding ?? DefaultEncoding;
            return HashEncrypt(new HMACSHA1(encoding.GetBytes(key)), input, encoding);
        }
        #endregion HMAC-SHA1 加密
        #region HMAC-SHA256 加密
        /// <summary>
        /// HMAC-SHA256 加密
        /// </summary>
        /// <param name="input"> 要加密的字符串 </param>
        /// <param name="key"> 密钥 </param>
        /// <param name="encoding"> 字符编码 </param>
        /// <returns></returns>
        public static string HmacSha256Encrypt(string input, string key, Encoding encoding = null)
        {
            if (encoding == null)
                encoding = DefaultEncoding;
            return HashEncrypt(new HMACSHA256(encoding.GetBytes(key)), input, encoding);
        }
        #endregion HMAC-SHA256 加密
        #region HMAC-SHA384 加密
        /// <summary>
        /// HMAC-SHA384 加密
        /// </summary>
        /// <param name="input"> 要加密的字符串 </param>
        /// <param name="key"> 密钥 </param>
        /// <param name="encoding"> 字符编码 </param>
        /// <returns></returns>
        public static string HmacSha384Encrypt(string input, string key, Encoding encoding = null)
        {
            encoding = encoding ?? DefaultEncoding;
            return HashEncrypt(new HMACSHA384(encoding.GetBytes(key)), input, encoding);
        }
        #endregion HMAC-SHA384 加密
        #region HMAC-SHA512 加密
        /// <summary>
        /// HMAC-SHA512 加密
        /// </summary>
        /// <param name="input"> 要加密的字符串 </param>
        /// <param name="key"> 密钥 </param>
        /// <param name="encoding"> 字符编码 </param>
        /// <returns></returns>
        public static string HmacSha512Encrypt(string input, string key, Encoding encoding = null)
        {
            encoding = encoding ?? DefaultEncoding;
            return HashEncrypt(new HMACSHA512(encoding.GetBytes(key)), input, encoding);
        }
        #endregion HMAC-SHA512 加密
        #region 对称加密算法
        #region Des 加解密
        /// <summary>
        /// DES 加密
        /// </summary>
        /// <param name="input"> 待加密的字符串 </param>
        /// <param name="key"> 密钥（8位） </param>
        /// <param name="encoding">编码，为 null 取默认值</param>
        /// <returns></returns>
        public static string DesEncrypt(string input, string key, Encoding encoding = null)
        {
            encoding = encoding ?? DefaultEncoding;
            try
            {
                var keyBytes = encoding.GetBytes(key);
                //var ivBytes = Encoding.UTF8.GetBytes(iv);
                var des = DES.Create();
                des.Mode = CipherMode.ECB; //兼容其他语言的 Des 加密算法
                des.Padding = PaddingMode.Zeros; //自动补 0
                using (var ms = new MemoryStream())
                {
                    var data = encoding.GetBytes(input);
                    using (var cs =
                        new CryptoStream(ms, des.CreateEncryptor(keyBytes, IvBytes), CryptoStreamMode.Write))
                    {
                        cs.Write(data, 0, data.Length);
                        cs.FlushFinalBlock();
                    }
                    return Convert.ToBase64String(ms.ToArray());
                }
            }
            catch
            {
                return input;
            }
        }
        /// <summary>
        /// DES 解密
        /// </summary>
        /// <param name="input"> 待解密的字符串 </param>
        /// <param name="key"> 密钥（8位） </param>
        /// <param name="encoding">编码，为 null 时取默认值</param>
        /// <returns></returns>
        public static string DesDecrypt(string input, string key, Encoding encoding = null)
        {
            encoding = encoding ?? DefaultEncoding;
            try
            {
                var keyBytes = Encoding.UTF8.GetBytes(key);
                //var ivBytes = Encoding.UTF8.GetBytes(iv);
                var des = DES.Create();
                des.Mode = CipherMode.ECB; //兼容其他语言的Des加密算法
                des.Padding = PaddingMode.Zeros; //自动补0
                using (var ms = new MemoryStream())
                {
                    var data = Convert.FromBase64String(input);
                    using (var cs =
                        new CryptoStream(ms, des.CreateDecryptor(keyBytes, IvBytes), CryptoStreamMode.Write))
                    {
                        cs.Write(data, 0, data.Length);
                        cs.FlushFinalBlock();
                    }
                    return encoding.GetString(ms.ToArray());
                }
            }
            catch
            {
                return input;
            }
        }
        #endregion Des 加解密
        #region Aes
        /// <summary>
        /// 获取Aes32位密钥
        /// </summary>
        /// <param name="key">Aes密钥字符串</param>
        /// <returns>Aes32位密钥</returns>
        public static byte[] GetAesKey(string key, Encoding encoding = null)
        {
            encoding = encoding ?? DefaultEncoding;
            if (string.IsNullOrEmpty(key))
            {
                throw new ArgumentNullException("key", "Aes密钥不能为空");
            }
            if (key.Length < 32)
            {
                // 不足32补全
                key = key.PadRight(32, '0');
            }
            if (key.Length > 32)
            {
                key = key.Substring(0, 32);
            }
            return encoding.GetBytes(key);
        }
        //public static byte[] GetAesKeyFromJava(string javaKey, Encoding encoding = null)
        //{
        //    encoding = encoding ?? DefaultEncoding;
        //    KeyGenerator kgen = KeyGenerator.getInstance("AES");
        //    java.security.SecureRandom random = java.security.SecureRandom.getInstance("SHA1PRNG");
        //    random.setSeed(encoding.GetBytes(javaKey));
        //    kgen.init(128, random);
        //    SecretKey secretKey = kgen.generateKey();
        //    return secretKey.getEncoded();
        //}
        /// <summary>
        /// Aes加密
        /// </summary>
        /// <param name="source">源字符串</param>
        /// <param name="key">aes密钥，长度必须32位</param>
        /// <returns>加密后的字符串</returns>
        public static byte[] AesEncrypt(byte[] source, byte[] key)
        {
            using (AesCryptoServiceProvider aesProvider = new AesCryptoServiceProvider())
            {
                aesProvider.Key = key;
                aesProvider.Mode = CipherMode.ECB;
                aesProvider.Padding = PaddingMode.PKCS7;
                using (ICryptoTransform cryptoTransform = aesProvider.CreateEncryptor())
                {
                    byte[] inputBuffers = source;
                    byte[] results = cryptoTransform.TransformFinalBlock(inputBuffers, 0, inputBuffers.Length);
                    aesProvider.Clear();
                    aesProvider.Dispose();
                    return results;
                }
            }
        }
        /// <summary>
        /// Aes解密
        /// </summary>
        /// <param name="source">源字符串</param>
        /// <param name="key">aes密钥，长度必须32位</param>
        /// <returns>解密后的字符串</returns>
        public static byte[] AesDecrypt(byte[] source, byte[] key)
        {
            using (AesCryptoServiceProvider aesProvider = new AesCryptoServiceProvider())
            {
                aesProvider.Key = key;
                aesProvider.Mode = CipherMode.ECB;
                aesProvider.Padding = PaddingMode.PKCS7;
                using (ICryptoTransform cryptoTransform = aesProvider.CreateDecryptor())
                {
                    byte[] inputBuffers = source;
                    byte[] results = cryptoTransform.TransformFinalBlock(inputBuffers, 0, inputBuffers.Length);
                    aesProvider.Clear();
                    return results;
                }
            }
        }
        #endregion
        #endregion
        #region Base64
        public static string Base64Encrypt(string inputStr, Encoding encoding = null)
        {
            encoding = encoding ?? DefaultEncoding;
            byte[] bytes = encoding.GetBytes(inputStr);
            return Convert.ToBase64String(bytes);
        }
        public static string Base64Decrypt(string inputStr, Encoding encoding = null)
        {
            encoding = encoding ?? DefaultEncoding;
            byte[] outputb = Convert.FromBase64String(inputStr);
            return encoding.GetString(outputb);
        }
        #endregion
        #region 非对称加密算法Rsa
        /// <summary>
        /// 生成 RSA 公钥和私钥
        /// </summary>
        /// <param name="publicKey"> 公钥 </param>
        /// <param name="privateKey"> 私钥 </param>
        public static void GenerateRsaKeys(out string publicKey, out string privateKey)
        {
            using (var rsa = RSA.Create())
            {
                publicKey = rsa.ToXmlStringForCore(false);
                privateKey = rsa.ToXmlStringForCore(true);
            }
        }
        /// <summary>
        /// 
        /// </summary>
        /// <param name="publicKey"></param>
        /// <param name="strdata"></param>
        /// <param name="encoding"></param>
        /// <returns></returns>
        public static byte[] RsaWithMD5(string publicKey, string strdata, Encoding encoding = null)
        {
            encoding = encoding ?? DefaultEncoding;
            using (var rsaProvider = RSA.Create())
            {
                rsaProvider.FromXmlStringForCore(publicKey);//载入公钥
                byte[] data = encoding.GetBytes(strdata);
                byte[] hashvalue = rsaProvider.SignData(data, HashAlgorithmName.MD5, RSASignaturePadding.Pkcs1);//为证书采用MD5withRSA 签名
                return hashvalue;
            }
        }
        /// <summary>
        /// RSA 加密
        /// </summary>
        /// <param name="publickey"> 公钥 </param>
        /// <param name="content"> 待加密的内容 </param>
        /// <returns>  </returns>
        public static byte[] RsaEncrypt(string publicKey, byte[] inputBytes)
        {
            if (string.IsNullOrWhiteSpace(publicKey))
            {
                throw new ArgumentException("Invalid Public Key");
            }
            using (var rsa = RSA.Create())
            {
                rsa.FromXmlStringForCore(publicKey);
                int maxBlockSize = rsa.KeySize / 8 - 11;
                if (inputBytes.Length <= maxBlockSize)
                {
                    return rsa.Encrypt(inputBytes, RSAEncryptionPadding.Pkcs1);
                }
                using (MemoryStream plaiStream = new MemoryStream(inputBytes))
                {
                    using (MemoryStream crypStream = new MemoryStream())
                    {
                        byte[] buffer = new byte[maxBlockSize];
                        int blockSize = plaiStream.Read(buffer, 0, maxBlockSize);
                        while (blockSize > 0)
                        {
                            byte[] toEncrypt = new byte[blockSize];
                            Array.Copy(buffer, 0, toEncrypt, 0, blockSize);
                            byte[] cryptograph = rsa.Encrypt(toEncrypt, RSAEncryptionPadding.Pkcs1);
                            crypStream.Write(cryptograph, 0, cryptograph.Length);
                            blockSize = plaiStream.Read(buffer, 0, maxBlockSize);
                        }
                        return crypStream.ToArray();
                    }
                }
            }
        }
        /// <summary>
        /// RSA 解密
        /// </summary>
        /// <param name="privatekey"> 私钥 </param>
        /// <param name="content"> 待解密的内容 </param>
        /// <returns>  </returns>
        public static byte[] RsaDecrypt(string privateKey, byte[] encryptedInput)
        {
            if (string.IsNullOrWhiteSpace(privateKey))
            {
                throw new ArgumentException("Invalid Private Key");
            }
            using (var rsa = RSA.Create())
            {
                rsa.FromXmlStringForCore(privateKey);
                int maxBlockSize = rsa.KeySize / 8;
                if (encryptedInput.Length <= maxBlockSize)
                    return rsa.Decrypt(encryptedInput, RSAEncryptionPadding.Pkcs1);
                using (MemoryStream crypStream = new MemoryStream(encryptedInput))
                {
                    using (MemoryStream plaiStream = new MemoryStream())
                    {
                        byte[] buffer = new byte[maxBlockSize];
                        int blockSize = crypStream.Read(buffer, 0, maxBlockSize);
                        while (blockSize > 0)
                        {
                            byte[] toDecrypt = new byte[blockSize];
                            Array.Copy(buffer, 0, toDecrypt, 0, blockSize);
                            byte[] plaintext = rsa.Decrypt(toDecrypt, RSAEncryptionPadding.Pkcs1);
                            plaiStream.Write(plaintext, 0, plaintext.Length);
                            blockSize = crypStream.Read(buffer, 0, maxBlockSize);
                        }
                        return plaiStream.ToArray();
                    }
                }
            }
        }
        #endregion 非对称加密算法
    }
}
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Xml;
using System.Xml.Serialization;
namespace Cis.Fm.Tools
{
    public class XmlHelper
    {
        /// <summary>
        /// 序列化成XML
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="obj"></param>
        /// <returns></returns>
        public static string XmlSerialize(object obj, Encoding encoding)
        {
            using (MemoryStream memoryStream = new MemoryStream())
            {
                XmlSerializer xmlSerializer = new XmlSerializer(obj.GetType());
                //序列化对象
                XmlSerializerNamespaces namespaces = new XmlSerializerNamespaces();
                namespaces.Add("", "");
                XmlTextWriter xmlTextWriter = new XmlTextWriter(memoryStream, encoding);
                xmlTextWriter.Formatting = System.Xml.Formatting.None;
                xmlSerializer.Serialize(xmlTextWriter, obj, namespaces);
                xmlTextWriter.Flush();
                xmlTextWriter.Close();
                var inputXmlByte = memoryStream.ToArray();
                return encoding.GetString(inputXmlByte, 0, inputXmlByte.Length);
            }
        }
        public static T XmlDeSerialize<T>(string xmlStr)
        {
            using (StringReader rdr = new StringReader(xmlStr))
            {
                XmlSerializer serializer = new XmlSerializer(typeof(T), new XmlRootAttribute("result"));
                T i = (T)serializer.Deserialize(rdr);
                return i;
            }
        }
    }
}
using System;
using System.Collections.Generic;
using System.IO;
using System.IO.Compression;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
namespace Cis.Fm.Tools
{
    public class ZipHelper
    {
        /// <summary>
        /// 默认编码
        /// </summary>
        public static Encoding DefaultEncoding { get; } = Encoding.UTF8;
        /// <summary>
        /// 将传入字符串以GZip算法压缩
        /// </summary>
        /// <param name="rawString">需要压缩的字符串</param>
        /// <returns>压缩后的Base64编码的字符串</returns>
        public static string CompressString(string rawString, Encoding encoding = null)
        {
            encoding = encoding ?? DefaultEncoding;
            return Convert.ToBase64String(Compress(encoding.GetBytes(rawString)));
        }
        /// <summary>
        /// 
        /// </summary>
        /// <param name="zippedData"></param>
        /// <returns></returns>
        public static string DecompressString(string zippedData, Encoding encoding = null)
        {
            encoding = encoding ?? DefaultEncoding;
            return encoding.GetString(Decompress(Convert.FromBase64String(zippedData)));
        }
        /// <summary>
        /// GZip压缩
        /// </summary>
        /// <param name="rawData"></param>
        /// <returns></returns>
        public static byte[] Compress(byte[] rawData)
        {
            MemoryStream ms = new MemoryStream();
            GZipStream compressedzipStream = new GZipStream(ms, CompressionMode.Compress, true);
            compressedzipStream.Write(rawData, 0, rawData.Length);
            compressedzipStream.Close();
            return ms.ToArray();
        }
        /// <summary>
        /// ZIP解压
        /// </summary>
        /// <param name="zippedData"></param>
        /// <returns></returns>
        public static byte[] Decompress(byte[] zippedData)
        {
            MemoryStream ms = new MemoryStream(zippedData);
            GZipStream compressedzipStream = new GZipStream(ms, CompressionMode.Decompress);
            MemoryStream outBuffer = new MemoryStream();
            byte[] block = new byte[1024];
            while (true)
            {
                int bytesRead = compressedzipStream.Read(block, 0, block.Length);
                if (bytesRead <= 0)
                    break;
                else
                    outBuffer.Write(block, 0, bytesRead);
            }
            compressedzipStream.Close();
            return outBuffer.ToArray();
        }
    }
}
using System;

namespace Cis.Fm.Web.Models
{
    /// <summary>
    /// This class is used to create standard responses for AJAX/remote requests.
    /// </summary>
    [Serializable]
    public class AjaxResponse : AjaxResponse<object>
    {
        /// <summary>
        /// Creates an <see cref="AjaxResponse"/> object.
        /// <see cref="AjaxResponseBase.Success"/> is set as true.
        /// </summary>
        public AjaxResponse()
        {

        }

        /// <summary>
        /// Creates an <see cref="AjaxResponse"/> object with <see cref="AjaxResponseBase.Success"/> specified.
        /// </summary>
        /// <param name="success">Indicates success status of the result</param>
        public AjaxResponse(bool success)
            : base(success)
        {

        }

        /// <summary>
        /// Creates an <see cref="AjaxResponse"/> object with <see cref="AjaxResponse{TResult}.Result"/> specified.
        /// <see cref="AjaxResponseBase.Success"/> is set as true.
        /// </summary>
        /// <param name="result">The actual result object</param>
        public AjaxResponse(object result)
            : base(result)
        {

        }

        /// <summary>
        /// Creates an <see cref="AjaxResponse"/> object with <see cref="AjaxResponseBase.Error"/> specified.
        /// <see cref="AjaxResponseBase.Success"/> is set as false.
        /// </summary>
        /// <param name="error">Error details</param>
        /// <param name="unAuthorizedRequest">Used to indicate that the current user has no privilege to perform this request</param>
        public AjaxResponse(ErrorInfo error, bool unAuthorizedRequest = false)
            : base(error, unAuthorizedRequest)
        {

        }
    }
}namespace Cis.Fm.Web.Models
{
    public abstract class AjaxResponseBase
    {
        /// <summary>
        /// This property can be used to redirect user to a specified URL.
        /// </summary>
        public string TargetUrl { get; set; }

        /// <summary>
        /// Indicates success status of the result.
        /// Set <see cref="Error"/> if this value is false.
        /// </summary>
        public bool Success { get; set; }

        /// <summary>
        /// Error details (Must and only set if <see cref="Success"/> is false).
        /// </summary>
        public ErrorInfo Error { get; set; }

        /// <summary>
        /// This property can be used to indicate that the current user has no privilege to perform this request.
        /// </summary>
        public bool UnAuthorizedRequest { get; set; }

        /// <summary>
        /// A special signature for AJAX responses. It's used in the client to detect if this is a response wrapped by ABP.
        /// </summary>
        public bool __abpasasasasasas { get; } = true;
    }
}using System;

namespace Cis.Fm.Web.Models
{
    /// <summary>
    /// This class is used to create standard responses for AJAX requests.
    /// </summary>
    [Serializable]
    public class AjaxResponse<TResult>: AjaxResponseBase
    {
        /// <summary>
        /// The actual result object of AJAX request.
        /// It is set if <see cref="AjaxResponseBase.Success"/> is true.
        /// </summary>
        public TResult Result { get; set; }

        /// <summary>
        /// Creates an <see cref="AjaxResponse"/> object with <see cref="Result"/> specified.
        /// <see cref="AjaxResponseBase.Success"/> is set as true.
        /// </summary>
        /// <param name="result">The actual result object of AJAX request</param>
        public AjaxResponse(TResult result)
        {
            Result = result;
            Success = true;
        }

        /// <summary>
        /// Creates an <see cref="AjaxResponse"/> object.
        /// <see cref="AjaxResponseBase.Success"/> is set as true.
        /// </summary>
        public AjaxResponse()
        {
            Success = true;
        }

        /// <summary>
        /// Creates an <see cref="AjaxResponse"/> object with <see cref="AjaxResponseBase.Success"/> specified.
        /// </summary>
        /// <param name="success">Indicates success status of the result</param>
        public AjaxResponse(bool success)
        {
            Success = success;
        }

        /// <summary>
        /// Creates an <see cref="AjaxResponse"/> object with <see cref="AjaxResponseBase.Error"/> specified.
        /// <see cref="AjaxResponseBase.Success"/> is set as false.
        /// </summary>
        /// <param name="error">Error details</param>
        /// <param name="unAuthorizedRequest">Used to indicate that the current user has no privilege to perform this request</param>
        public AjaxResponse(ErrorInfo error, bool unAuthorizedRequest = false)
        {
            Error = error;
            UnAuthorizedRequest = unAuthorizedRequest;
            Success = false;
        }
    }
}using System;

namespace Cis.Fm.Web.Models
{
    /// <summary>
    /// Used to store information about an error.
    /// </summary>
    [Serializable]
    public class ErrorInfo
    {
        /// <summary>
        /// Error code.
        /// </summary>
        public int Code { get; set; }

        /// <summary>
        /// Error message.
        /// </summary>
        public string Message { get; set; }

        /// <summary>
        /// Error details.
        /// </summary>
        public string Details { get; set; }

        /// <summary>
        /// Validation errors if exists.
        /// </summary>
        public ValidationErrorInfo[] ValidationErrors { get; set; }

        /// <summary>
        /// Creates a new instance of <see cref="ErrorInfo"/>.
        /// </summary>
        public ErrorInfo()
        {

        }

        /// <summary>
        /// Creates a new instance of <see cref="ErrorInfo"/>.
        /// </summary>
        /// <param name="message">Error message</param>
        public ErrorInfo(string message)
        {
            Message = message;
        }

        /// <summary>
        /// Creates a new instance of <see cref="ErrorInfo"/>.
        /// </summary>
        /// <param name="code">Error code</param>
        public ErrorInfo(int code)
        {
            Code = code;
        }

        /// <summary>
        /// Creates a new instance of <see cref="ErrorInfo"/>.
        /// </summary>
        /// <param name="code">Error code</param>
        /// <param name="message">Error message</param>
        public ErrorInfo(int code, string message)
            : this(message)
        {
            Code = code;
        }

        /// <summary>
        /// Creates a new instance of <see cref="ErrorInfo"/>.
        /// </summary>
        /// <param name="message">Error message</param>
        /// <param name="details">Error details</param>
        public ErrorInfo(string message, string details)
            : this(message)
        {
            Details = details;
        }

        /// <summary>
        /// Creates a new instance of <see cref="ErrorInfo"/>.
        /// </summary>
        /// <param name="code">Error code</param>
        /// <param name="message">Error message</param>
        /// <param name="details">Error details</param>
        public ErrorInfo(int code, string message, string details)
            : this(message, details)
        {
            Code = code;
        }
    }
}using System;

namespace Cis.Fm.Web.Models
{
    /// <summary>
    /// Used to store information about a validation error.
    /// </summary>
    [Serializable]
    public class ValidationErrorInfo
    {
        /// <summary>
        /// Validation error message.
        /// </summary>
        public string Message { get; set; }

        /// <summary>
        /// Relate invalid members (fields/properties).
        /// </summary>
        public string[] Members { get; set; }

        /// <summary>
        /// Creates a new instance of <see cref="ValidationErrorInfo"/>.
        /// </summary>
        public ValidationErrorInfo()
        {

        }

        /// <summary>
        /// Creates a new instance of <see cref="ValidationErrorInfo"/>.
        /// </summary>
        /// <param name="message">Validation error message</param>
        public ValidationErrorInfo(string message)
        {
            Message = message;
        }
        
        /// <summary>
        /// Creates a new instance of <see cref="ValidationErrorInfo"/>.
        /// </summary>
        /// <param name="message">Validation error message</param>
        /// <param name="members">Related invalid members</param>
        public ValidationErrorInfo(string message, string[] members)
            : this(message)
        {
            Members = members;
        }

        /// <summary>
        /// Creates a new instance of <see cref="ValidationErrorInfo"/>.
        /// </summary>
        /// <param name="message">Validation error message</param>
        /// <param name="member">Related invalid member</param>
        public ValidationErrorInfo(string message, string member)
            : this(message, new[] { member })
        {

        }
    }
}using Cis.Fm.Tools;
using Cis.Fm.WebApi.Dto;
using Newtonsoft.Json;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net;
using System.Net.Http;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
namespace Cis.Fm
{
    public class WebApiAgent
    {
        private Encoding encoding = Encoding.UTF8;
        private string rsaPriKey_send;
        //private string rsaPubKey_send = @"<RSAKeyValue><Modulus>mUFfdCXWLL0o06Bt8PgYacKM4UhgHYBhTF70TyGxdcmar6Dc3yx+3/BMuFLsGk4WeqWrnpZkLelHZy2w/TDjtvWphdO6QHfxULyHZzIS5aa1V1DKo5MiUmBmIXECXG11FI3tqFDMcajGj8R3gLwxoEmcXGjjNQIdetK1XtAkpYU=</Modulus><Exponent>AQAB</Exponent></RSAKeyValue>";
        //private string rsaPriKey_recive = @"<RSAKeyValue><Modulus>kMwqHs18NBtLwkl5SbykPJ/vSYTT5LtqqYWtxSJSl75mg1jh9eGA2JAaRN8dB+44+wd57O0B+igt+uSBHlbeLpQAVHH2sfydJ4rRKiijmSnfSusR8BlSKyMV/by0ghTHXqB7Z5Tcbc1r4b0TuSXpn3+NV3VpchnAj4QVrGyANgc=</Modulus><Exponent>AQAB</Exponent><P>+RC/k+ETRbGiWcIm6cXKXXMeUK9Bb15ombyZvqFTwAOuTVeHY7rMdN9wWOhOwUh0cI++LN3u62FzlxE3HhAZQQ==</P><Q>lNQ7GHZilGwWWyVqGBBsmyaknjLJe2jBkEjhgS5MwsXrnya9TRW3oaWFKJyjjKKad+TmAX1GIo91NhzyaF71Rw==</Q><DP>3SyoU9Pt31gNShQFpldEi5Ps+c2IGDQIQ22eQhDVZJBgOsJdsoxxf9/jzrANL8r9y+95/DHhNxlFIoPhJEs7gQ==</DP><DQ>Zeez1xoogcxIunwx2uxUESAyk4fe4btm3i6pCdT0BmGS5lSWRdPa+rnlJVuruL4V2oZG3zox7bQg476KVODAPQ==</DQ><InverseQ>Yk8/S1Z8ziamw8e//NlwqDTq7SwDtpuoiUkc8iF387A7RWYBH774eaQ9Qwat9zsdxDmIUR21cWIX6x1tK51rmQ==</InverseQ><D>DyignDrs7tOQudVRUkviccpYlbzHJiIMx5SMHaA7P1Gaj9OlTEWAZKupZF5rPqJM6tLci9ZAJ70/Gw4DCncTqWkDQgGzaus9pg/U9cifJdF8swDOztJxkPeCJ/cFSywqggZJ0PZI3P3d7QtLJjwElYSL/HDK588tvQlW8Vg+oYE=</D></RSAKeyValue>";
        //private string rsaPubKey_recive = @"<RSAKeyValue><Modulus>kMwqHs18NBtLwkl5SbykPJ/vSYTT5LtqqYWtxSJSl75mg1jh9eGA2JAaRN8dB+44+wd57O0B+igt+uSBHlbeLpQAVHH2sfydJ4rRKiijmSnfSusR8BlSKyMV/by0ghTHXqB7Z5Tcbc1r4b0TuSXpn3+NV3VpchnAj4QVrGyANgc=</Modulus><Exponent>AQAB</Exponent></RSAKeyValue>";
        private byte[] aesKey;
        public static int Num = 0;
        public WebApiAgent()
        {
            rsaPriKey_send = @"<RSAKeyValue><Modulus>mUFfdCXWLL0o06Bt8PgYacKM4UhgHYBhTF70TyGxdcmar6Dc3yx+3/BMuFLsGk4WeqWrnpZkLelHZy2w/TDjtvWphdO6QHfxULyHZzIS5aa1V1DKo5MiUmBmIXECXG11FI3tqFDMcajGj8R3gLwxoEmcXGjjNQIdetK1XtAkpYU=</Modulus><Exponent>AQAB</Exponent><P>30cAZ10S7zCcfYWlizPrihnbYOgXiCSmzrUr7dJIQZ//HdBvFxAtEIo99LnSXlOYBbjbAppxpNEEf+qEkDMAXQ==</P><Q>r7dC/B9U6EwwWFHr1R+Wa9GQz6H3wVJNhbfM0PvqbC8PWcUn6nw/v+RzBgD4xYnMiUwuL5FHwDUdiSk1wYMHSQ==</Q><DP>tOtjeF4Cqa5KH6vbqCA6C31INg3ag4avY2+KWPq7cfGjVxU97wI8gdqCuXqY67XwyTIwxLtAurxjWQM+x1mMQQ==</DP><DQ>hsTfOnJpc/WjisniQEcG3tEP6UBHvt16Gdob3Bmq9aiudGKzt7PuTSZRVkR+iTukRZXJQrCBwJi8e4vA8BeoCQ==</DQ><InverseQ>MqfvUw1xv1NrhNUk080Vd3DA+kbW4Du/nExp+It8XRFqYxqrF9GaQ5/Y9EAh/d3KLW7WGa+pzFjeFdhJZgjCXA==</InverseQ><D>c6L6DT+HbVaFebkxe4MXmKVte4cKzvfRcrirCxJXPpMSHrb4MYT3bq14lhQrhmWpXH2pEw5TJLlCYT3+r+y1xGhljMn4QH5BrEziHCoZiXUZxkodsEYuAdZy+BwOc/nhofI2HUl4+q7rDnWV6Ee6Nx9Bk05T//e2aA4r41xqxsE=</D></RSAKeyValue>";
            aesKey = SecurityHelper.GetAesKey("8CB5CDA1742572A487D9401E3400267E");
        }
        public WebApiAgent(string _rsaPriKey_send, string _aesKey)
        {
            rsaPriKey_send = _rsaPriKey_send;
            aesKey = SecurityHelper.GetAesKey(_aesKey);
        }
        public long GetTransNo()
        {
            return DateTime.Now.Ticks + Num++;
        }
        public string GetSign(IApiSign input)
        {
            var m = input.TransNo + input.Content;
            var s = SecurityHelper.RsaWithMD5(rsaPriKey_send, m, encoding);
            var b = Convert.ToBase64String(s);
            return b;
        }
        public bool VerifySign(IApiSign signInput)
        {
            return signInput.Sign == GetSign(signInput);
        }
        public string GetEncrypt(string input)
        {
            var trueBody = encoding.GetBytes(input);
            var compBody = ZipHelper.Compress(trueBody);
            var sendBody = SecurityHelper.AesEncrypt(compBody, aesKey);
            return Convert.ToBase64String(sendBody);
        }
        public string GetDecrypt(string input)
        {
            var sendBody = Convert.FromBase64String(input);
            var compBody = SecurityHelper.AesDecrypt(sendBody, aesKey);
            return encoding.GetString(ZipHelper.Decompress(compBody));
        }
        public ApiRequest GetRequest(string input)
        {
            string decryptStr = GetDecrypt(input);
            ApiRequest req = JsonConvert.DeserializeObject<ApiRequest>(decryptStr);
            if (!VerifySign(req))
            {
                throw new Exception("签名验证失败。");
            }
            return req;
        }
        public string GetResponse(ApiRequest req, object resModel)
        {
            ApiResponse res = new ApiResponse()
            {
                TransNo = req.TransNo + 1,
                Content = JsonConvert.SerializeObject(resModel)
            };
            res.Sign = GetSign(res);
            return GetEncrypt(JsonConvert.SerializeObject(res));
        }
        /// <summary>
        /// 
        /// </summary>
        /// <param name="transNo">传输序列号</param>
        /// <param name="formParams">参数：json格式</param>
        /// <returns></returns>
        public T Send<T>(string url, string bodyStr = null)
        {
            long transNo = GetTransNo();
            ApiRequest req = new ApiRequest()
            {
                Content = bodyStr,
                TransNo = transNo
            };
            req.Sign = GetSign(req);
            var ps = new Dictionary<string, string>();
            ps.Add("formParams", GetEncrypt(JsonConvert.SerializeObject(req)));
            string encryptRespone = RequestHelper.PostHtml(url, ps);
            var decryptRespone = GetDecrypt(encryptRespone);
            ApiResponse res = JsonConvert.DeserializeObject<ApiResponse>(decryptRespone);
            if (!VerifySign(res))
            {
                throw new Exception("签名验证失败。");
            }
            if (res.TransNo - 1 != transNo)
            {
                throw new Exception("非法传输。");
            }
            return JsonConvert.DeserializeObject<T>(res.Content);
        }
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
namespace Cis.Fm.WebApi.Dto
{
    public class ApiRequest: IApiSign
    {
        public string Sign { get; set; }
        public long TransNo { get; set; }
        public string Content { get; set; }
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
namespace Cis.Fm.WebApi.Dto
{
    public class ApiResponse : IApiSign
    {
        public string Sign { get; set; }
        public long TransNo { get; set; }
        public string Content { get; set; }
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
namespace Cis.Fm.WebApi.Dto
{
    public interface IApiSign
    {
        string Sign { get; set; }
        long TransNo { get; set; }
        string Content { get; set; }
    }
}
using Abp.Modules;
using System.Reflection;
namespace Abp.WebApi
{
    /// <summary>
    /// This module provides Abp features for ASP.NET Web API.
    /// </summary>
    //[DependsOn(typeof(AbpWebModule))]
    public class CisAbpModule : AbpModule
    {
        /// <inheritdoc/>
        public override void PreInitialize()
        {
        }
        /// <inheritdoc/>
        public override void Initialize()
        {
            IocManager.RegisterAssemblyByConvention(Assembly.GetExecutingAssembly());
        }
        public override void PostInitialize()
        {
            //var httpConfiguration = IocManager.Resolve<IAbpWebApiConfiguration>().HttpConfiguration;
            //httpConfiguration.MessageHandlers.Remove(IocManager.Resolve<ResultWrapperHandler>());
            //httpConfiguration.MessageHandlers.Add(IocManager.Resolve<Cis.Fm.Abp.WebApi.Controllers.ResultWrapperHandler>());
            //Configuration.Modules.AbpWebApi().HttpConfiguration.EnsureInitialized();
        }
    }
}
#region copyright
// <copyright file="FsManagerBase"  company="CIS"> 
// Copyright (c) CIS. All Right Reserved
// </copyright>
// <author>hankk</author>
// <datecreated>2018/4/20 16:30:23</datecreated>
#endregion
using Abp.Dependency;
using Cis.Infrastucture.FileSystem;
using System;
using System.Collections.Generic;
using System.Text;
namespace Cis.Fm.Abp.FileSystem
{
    public abstract class FsManagerBase : IFsManager, ISingletonDependency
    {
        protected readonly IIocManager IocManager;
        protected readonly IFsConfiguration FsConfiguration;

        public FsManagerBase(IIocManager iocManager, IFsConfiguration configuration)
        {
            IocManager = iocManager;
            FsConfiguration = configuration;
        }
        public abstract bool Upload();
    }
}
#region copyright
// <copyright file="IFsConfiguration"  company="CIS"> 
// Copyright (c) CIS. All Right Reserved
// </copyright>
// <author>hankk</author>
// <datecreated>2018/4/20 15:11:24</datecreated>
#endregion
using Abp.Configuration.Startup;
using System;
using System.Collections.Generic;
using System.Text;
namespace Cis.Infrastucture.FileSystem
{
    public interface IFsConfiguration
    {
        /// <summary>
        /// Gets the ABP configuration object.
        /// </summary>
        IAbpStartupConfiguration AbpConfiguration { get; }
    }
}
using System;
using System.Collections.Generic;
using System.Text;
namespace Cis.Fm.Abp.FileSystem
{
    public interface IFsManager
    {
         bool Upload();
    }
}
#region copyright
// <copyright file="UploadConfig"  company="CIS"> 
// Copyright (c) CIS. All Right Reserved
// </copyright>
// <author>hankk</author>
// <datecreated>2018/4/20 17:36:45</datecreated>
#endregion
using System;
using System.Collections.Generic;
using System.IO;
using System.Text;
namespace Cis.Fm.Abp.FileSystem
{
    public class UploadConfig
    {
        public Stream Stream { get; set; }
        public string FileName { get; set; }
    }
}
using Abp;
using Abp.Modules;
namespace Cis.Fm.Abp.Log4Net
{
    /// <summary>
    /// ABP Castle Log4Net module.
    /// </summary>
    [DependsOn(typeof(AbpKernelModule))]
    public class AbpCastleLog4NetModule : AbpModule
    {
    }
}using System;
using System.Globalization;
using log4net;
using log4net.Core;
using log4net.Util;
using ILogger = Castle.Core.Logging.ILogger;
using System.Collections.Concurrent;
namespace Cis.Fm.Abp.Log4Net
{
    //TODO: Test log4net with .net core!
    [Serializable]
    public class Log4NetLogger :
#if NET46
        MarshalByRefObject,
#endif
        ILogger
    {
        internal static ConcurrentQueue<LogInfo> LogQueue = new ConcurrentQueue<LogInfo>();
        private static readonly Type DeclaringType = typeof(Log4NetLogger);
        public Log4NetLogger(log4net.Core.ILogger logger, Log4NetLoggerFactory factory)
        {
            Logger = logger;
            Factory = factory;
        }
        internal Log4NetLogger()
        {
        }
        internal Log4NetLogger(ILog log, Log4NetLoggerFactory factory)
            : this(log.Logger, factory)
        {
        }
        public bool IsDebugEnabled
        {
            get { return Logger.IsEnabledFor(Level.Debug); }
        }
        public bool IsErrorEnabled
        {
            get { return Logger.IsEnabledFor(Level.Error); }
        }
        public bool IsFatalEnabled
        {
            get { return Logger.IsEnabledFor(Level.Fatal); }
        }
        public bool IsInfoEnabled
        {
            get { return Logger.IsEnabledFor(Level.Info); }
        }
        public bool IsWarnEnabled
        {
            get { return Logger.IsEnabledFor(Level.Warn); }
        }
        protected internal Log4NetLoggerFactory Factory { get; set; }
        protected internal log4net.Core.ILogger Logger { get; set; }
        public override string ToString()
        {
            return Logger.ToString();
        }
        public virtual global::Castle.Core.Logging.ILogger CreateChildLogger(string name)
        {
            return Factory.Create(Logger.Name + "." + name);
        }
        public void DoLog(Type callerStackBoundaryDeclaringType, Level level, object message, Exception exception)
        {
            LogQueue.Enqueue(new LogInfo()
            {
                Logger = Logger,
                CallerStackBoundaryDeclaringType = callerStackBoundaryDeclaringType,
                Level = level,
                Message = message,
                Exception = exception
            });
            //Logger.Log(callerStackBoundaryDeclaringType, level, message, exception);
        }
        public void Debug(string message)
        {
            if (IsDebugEnabled)
            {
                DoLog(DeclaringType, Level.Debug, message, null);
            }
        }
        public void Debug(Func<string> messageFactory)
        {
            if (IsDebugEnabled)
            {
                DoLog(DeclaringType, Level.Debug, messageFactory.Invoke(), null);
            }
        }
        public void Debug(string message, Exception exception)
        {
            if (IsDebugEnabled)
            {
                DoLog(DeclaringType, Level.Debug, message, exception);
            }
        }
        public void DebugFormat(string format, params Object[] args)
        {
            if (IsDebugEnabled)
            {
                DoLog(DeclaringType, Level.Debug, new SystemStringFormat(CultureInfo.InvariantCulture, format, args), null);
            }
        }
        public void DebugFormat(Exception exception, string format, params Object[] args)
        {
            if (IsDebugEnabled)
            {
                DoLog(DeclaringType, Level.Debug, new SystemStringFormat(CultureInfo.InvariantCulture, format, args), exception);
            }
        }
        public void DebugFormat(IFormatProvider formatProvider, string format, params Object[] args)
        {
            if (IsDebugEnabled)
            {
                DoLog(DeclaringType, Level.Debug, new SystemStringFormat(formatProvider, format, args), null);
            }
        }
        public void DebugFormat(Exception exception, IFormatProvider formatProvider, string format, params Object[] args)
        {
            if (IsDebugEnabled)
            {
                DoLog(DeclaringType, Level.Debug, new SystemStringFormat(formatProvider, format, args), exception);
            }
        }
        public void Error(string message)
        {
            if (IsErrorEnabled)
            {
                DoLog(DeclaringType, Level.Error, message, null);
            }
        }
        public void Error(Func<string> messageFactory)
        {
            if (IsErrorEnabled)
            {
                DoLog(DeclaringType, Level.Error, messageFactory.Invoke(), null);
            }
        }
        public void Error(string message, Exception exception)
        {
            if (IsErrorEnabled)
            {
                DoLog(DeclaringType, Level.Error, message, exception);
            }
        }
        public void ErrorFormat(string format, params Object[] args)
        {
            if (IsErrorEnabled)
            {
                DoLog(DeclaringType, Level.Error, new SystemStringFormat(CultureInfo.InvariantCulture, format, args), null);
            }
        }
        public void ErrorFormat(Exception exception, string format, params Object[] args)
        {
            if (IsErrorEnabled)
            {
                DoLog(DeclaringType, Level.Error, new SystemStringFormat(CultureInfo.InvariantCulture, format, args), exception);
            }
        }
        public void ErrorFormat(IFormatProvider formatProvider, string format, params Object[] args)
        {
            if (IsErrorEnabled)
            {
                DoLog(DeclaringType, Level.Error, new SystemStringFormat(formatProvider, format, args), null);
            }
        }
        public void ErrorFormat(Exception exception, IFormatProvider formatProvider, string format, params Object[] args)
        {
            if (IsErrorEnabled)
            {
                DoLog(DeclaringType, Level.Error, new SystemStringFormat(formatProvider, format, args), exception);
            }
        }
        public void Fatal(string message)
        {
            if (IsFatalEnabled)
            {
                DoLog(DeclaringType, Level.Fatal, message, null);
            }
        }
        public void Fatal(Func<string> messageFactory)
        {
            if (IsFatalEnabled)
            {
                DoLog(DeclaringType, Level.Fatal, messageFactory.Invoke(), null);
            }
        }
        public void Fatal(string message, Exception exception)
        {
            if (IsFatalEnabled)
            {
                DoLog(DeclaringType, Level.Fatal, message, exception);
            }
        }
        public void FatalFormat(string format, params Object[] args)
        {
            if (IsFatalEnabled)
            {
                DoLog(DeclaringType, Level.Fatal, new SystemStringFormat(CultureInfo.InvariantCulture, format, args), null);
            }
        }
        public void FatalFormat(Exception exception, string format, params Object[] args)
        {
            if (IsFatalEnabled)
            {
                DoLog(DeclaringType, Level.Fatal, new SystemStringFormat(CultureInfo.InvariantCulture, format, args), exception);
            }
        }
        public void FatalFormat(IFormatProvider formatProvider, string format, params Object[] args)
        {
            if (IsFatalEnabled)
            {
                DoLog(DeclaringType, Level.Fatal, new SystemStringFormat(formatProvider, format, args), null);
            }
        }
        public void FatalFormat(Exception exception, IFormatProvider formatProvider, string format, params Object[] args)
        {
            if (IsFatalEnabled)
            {
                DoLog(DeclaringType, Level.Fatal, new SystemStringFormat(formatProvider, format, args), exception);
            }
        }
        public void Info(string message)
        {
            if (IsInfoEnabled)
            {
                DoLog(DeclaringType, Level.Info, message, null);
            }
        }
        public void Info(Func<string> messageFactory)
        {
            if (IsInfoEnabled)
            {
                DoLog(DeclaringType, Level.Info, messageFactory.Invoke(), null);
            }
        }
        public void Info(string message, Exception exception)
        {
            if (IsInfoEnabled)
            {
                DoLog(DeclaringType, Level.Info, message, exception);
            }
        }
        public void InfoFormat(string format, params Object[] args)
        {
            if (IsInfoEnabled)
            {
                DoLog(DeclaringType, Level.Info, new SystemStringFormat(CultureInfo.InvariantCulture, format, args), null);
            }
        }
        public void InfoFormat(Exception exception, string format, params Object[] args)
        {
            if (IsInfoEnabled)
            {
                DoLog(DeclaringType, Level.Info, new SystemStringFormat(CultureInfo.InvariantCulture, format, args), exception);
            }
        }
        public void InfoFormat(IFormatProvider formatProvider, string format, params Object[] args)
        {
            if (IsInfoEnabled)
            {
                DoLog(DeclaringType, Level.Info, new SystemStringFormat(formatProvider, format, args), null);
            }
        }
        public void InfoFormat(Exception exception, IFormatProvider formatProvider, string format, params Object[] args)
        {
            if (IsInfoEnabled)
            {
                DoLog(DeclaringType, Level.Info, new SystemStringFormat(formatProvider, format, args), exception);
            }
        }
        public void Warn(string message)
        {
            if (IsWarnEnabled)
            {
                DoLog(DeclaringType, Level.Warn, message, null);
            }
        }
        public void Warn(Func<string> messageFactory)
        {
            if (IsWarnEnabled)
            {
                DoLog(DeclaringType, Level.Warn, messageFactory.Invoke(), null);
            }
        }
        public void Warn(string message, Exception exception)
        {
            if (IsWarnEnabled)
            {
                DoLog(DeclaringType, Level.Warn, message, exception);
            }
        }
        public void WarnFormat(string format, params Object[] args)
        {
            if (IsWarnEnabled)
            {
                DoLog(DeclaringType, Level.Warn, new SystemStringFormat(CultureInfo.InvariantCulture, format, args), null);
            }
        }
        public void WarnFormat(Exception exception, string format, params Object[] args)
        {
            if (IsWarnEnabled)
            {
                DoLog(DeclaringType, Level.Warn, new SystemStringFormat(CultureInfo.InvariantCulture, format, args), exception);
            }
        }
        public void WarnFormat(IFormatProvider formatProvider, string format, params Object[] args)
        {
            if (IsWarnEnabled)
            {
                DoLog(DeclaringType, Level.Warn, new SystemStringFormat(formatProvider, format, args), null);
            }
        }
        public void WarnFormat(Exception exception, IFormatProvider formatProvider, string format, params Object[] args)
        {
            if (IsWarnEnabled)
            {
                DoLog(DeclaringType, Level.Warn, new SystemStringFormat(formatProvider, format, args), exception);
            }
        }
    }
}using System;
using System.IO;
using System.Reflection;
using System.Xml;
using Castle.Core.Logging;
using log4net;
using log4net.Config;
using log4net.Repository;

namespace Cis.Fm.Abp.Log4Net
{
    public class Log4NetLoggerFactory : AbstractLoggerFactory
    {
        internal const string DefaultConfigFileName = "log4net.config";
        private readonly ILoggerRepository _loggerRepository;

        public Log4NetLoggerFactory()
            : this(DefaultConfigFileName)
        {
        }

        public Log4NetLoggerFactory(string configFileName)
        {
#if NET46
            var file = GetConfigFile(configFileName);
            XmlConfigurator.ConfigureAndWatch(file);
#else
            _loggerRepository = LogManager.CreateRepository(
                Assembly.GetEntryAssembly() ?? Assembly.GetCallingAssembly(),
                typeof(log4net.Repository.Hierarchy.Hierarchy)
            );
            var log4NetConfig = new XmlDocument();
            log4NetConfig.Load(File.OpenRead(configFileName));
            XmlConfigurator.Configure(_loggerRepository, log4NetConfig["log4net"]);
#endif
        }

        public override ILogger Create(string name)
        {
            if (name == null)
            {
                throw new ArgumentNullException(nameof(name));
            }

#if NET46
            return new Log4NetLogger(LogManager.GetLogger(name), this);
#else
            return new Log4NetLogger(LogManager.GetLogger(_loggerRepository.Name, name), this);
#endif
        }

        public override ILogger Create(string name, LoggerLevel level)
        {
            throw new NotSupportedException("Logger levels cannot be set at runtime. Please review your configuration file.");
        }
    }
}using Castle.Facilities.Logging;
using System.Linq;
using System.Threading;
namespace Cis.Fm.Abp.Log4Net
{
    public static class LoggingFacilityExtensions
    {
        public static LoggingFacility UseCisLog4Net(this LoggingFacility loggingFacility)
        {
            ThreadPool.QueueUserWorkItem(o =>
            {
                while (true)
                {
                    if (Log4NetLogger.LogQueue.Any())
                    {
                        Log4NetLogger.LogQueue.TryDequeue(out LogInfo log);
                        log.Log();
                    }
                    else
                    {
                        SpinWait.SpinUntil(() => false, 50);
                        //Thread.Sleep(50);
                    }
                }
            });
            return loggingFacility.LogUsing<Log4NetLoggerFactory>();
        }
    }
}using log4net.Core;
using System;
namespace Cis.Fm.Abp.Log4Net
{
    public class LogInfo
    {
        public log4net.Core.ILogger Logger { get; set; }
        public Type CallerStackBoundaryDeclaringType { get; set; }
        public Level Level { get; set; }
        public object Message { get; set; }
        public Exception Exception { get; set; }
        public void Log()
        {
            Logger.Log(CallerStackBoundaryDeclaringType, Level, Message, Exception);
        }
    }
}
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Filters;

namespace Abp.AspNetCore.Mvc.Results.Wrapping
{
    public class CisActionResultWrapperFactory : IAbpActionResultWrapperFactory
    {
        public IAbpActionResultWrapper CreateFor(ResultExecutingContext actionResult)
        {
            Check.NotNull(actionResult, nameof(actionResult));

            if (actionResult.Result is ObjectResult)
            {
                return new CisObjectActionResultWrapper(actionResult.HttpContext.RequestServices);
            }

            if (actionResult.Result is JsonResult)
            {
                return new CisJsonActionResultWrapper();
            }

            if (actionResult.Result is EmptyResult)
            {
                return new CisEmptyActionResultWrapper();
            }

            return new NullCisActionResultWrapper();
        }
    }
}using Abp.Web.Models;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Filters;

namespace Abp.AspNetCore.Mvc.Results.Wrapping
{
    public class CisEmptyActionResultWrapper : IAbpActionResultWrapper
    {
        public void Wrap(ResultExecutingContext actionResult)
        {
            actionResult.Result = new ObjectResult(new Cis.Fm.Web.Models.AjaxResponse());
        }
    }
}using System;
using Abp.Web.Models;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Filters;

namespace Abp.AspNetCore.Mvc.Results.Wrapping
{
    public class CisJsonActionResultWrapper : IAbpActionResultWrapper
    {
        public void Wrap(ResultExecutingContext actionResult)
        {
            var jsonResult = actionResult.Result as JsonResult;
            if (jsonResult == null)
            {
                throw new ArgumentException($"{nameof(actionResult)} should be JsonResult!");
            }

            if (!(jsonResult.Value is Cis.Fm.Web.Models.AjaxResponseBase))
            {
                jsonResult.Value = new Cis.Fm.Web.Models.AjaxResponse(jsonResult.Value);
            }
        }
    }
}using System;
using System.Buffers;
using System.Linq;
using Abp.Web.Models;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Filters;
using Microsoft.AspNetCore.Mvc.Formatters;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Options;
namespace Abp.AspNetCore.Mvc.Results.Wrapping
{
    public class CisObjectActionResultWrapper : IAbpActionResultWrapper
    {
        private readonly IServiceProvider _serviceProvider;

        public CisObjectActionResultWrapper(IServiceProvider serviceProvider)
        {
            _serviceProvider = serviceProvider;
        }

        public void Wrap(ResultExecutingContext actionResult)
        {
            var objectResult = actionResult.Result as ObjectResult;
            if (objectResult == null)
            {
                throw new ArgumentException($"{nameof(actionResult)} should be ObjectResult!");
            }

            if (!(objectResult.Value is AjaxResponseBase))
            {
                objectResult.Value = new AjaxResponse(objectResult.Value);
                if (!objectResult.Formatters.Any(f => f is JsonOutputFormatter))
                {
                    objectResult.Formatters.Add(
                        new JsonOutputFormatter(
                            _serviceProvider.GetRequiredService<IOptions<MvcJsonOptions>>().Value.SerializerSettings,
                            _serviceProvider.GetRequiredService<ArrayPool<char>>()
                        )
                    );
                }
            }
        }
    }
}using Microsoft.AspNetCore.Mvc.Filters;

namespace Abp.AspNetCore.Mvc.Results.Wrapping
{
    public class NullCisActionResultWrapper : IAbpActionResultWrapper
    {
        public void Wrap(ResultExecutingContext actionResult)
        {
            
        }
    }
}using System;
namespace Cis.Fm.FileSystem.LocalFs
{
    public class Class1
    {
    }
}
using Cis.Fm.Rpc.Dto;
using Cis.Fm.Tools;
using Microsoft.AspNetCore.Http;
using Newtonsoft.Json;
using RestSharp;
using System;
using System.Net;
namespace Cis.Fm.Rpc.Http
{
    public class ClientAgent : IClientAgent
    {
        private ServiceConfig sConfig;
        private RestClient client;
        private AuthorizationInfo authorizationInfo;
        public ClientAgent(ServiceConfig config)
        {
            sConfig = config;
            client = new RestClient(sConfig.ApiUrl);
        }
        private AuthorizationInfo GetAuthorizationInfo()
        {
            var client = new RestClient(sConfig.ApiUrl);
            var request = new RestRequest(sConfig.AuthorizationUrl, Method.POST);
            request.AddHeader("__AppId", sConfig.AppId);
            request.AddHeader("__ApiKey", sConfig.ApiKey);
            var response = client.Execute(request);
            if (!response.IsSuccessful || response.StatusCode != HttpStatusCode.OK)
            {
                throw new Exception(sConfig.ServiceName + "认证发生错误。");
            }
            return JsonConvert.DeserializeObject<AuthorizationInfo>(response.Content);
        }
        public string Execute(IRequestInfo reqInfo)
        {
            #region 验证认证信息
            if (authorizationInfo == null || authorizationInfo.ExpiryTime < DateTime.Now)
            {
                authorizationInfo = GetAuthorizationInfo();
            }
            reqInfo.AddAuthorizationInfo(authorizationInfo);
            #endregion
            Method method = (Method)Enum.Parse(typeof(Method), reqInfo.Method.ToUpper());
            var request = new RestRequest(reqInfo.Url, method);
            foreach (var item in reqInfo.Headers)
            {
                request.AddHeader(item.Key, item.Value);
            }
            if (!string.IsNullOrEmpty(reqInfo.UserInfo))
            {
                request.AddHeader("__UserInfo", SecurityHelper.Base64Encrypt(reqInfo.UserInfo));
            }
            foreach (var item in reqInfo.Querys)
            {
                request.AddParameter(item.Key, item.Value);
            }
            foreach (var item in reqInfo.Forms)
            {
                request.AddQueryParameter(item.Key, item.Value);
            }
            if (reqInfo.AuthorizationInfo != null)
            {
                //认证信息
                request.AddHeader("__AppId", reqInfo.AuthorizationInfo.AppId);
                request.AddHeader("__Authorization", reqInfo.AuthorizationInfo.AccessToken);
            }
            request.JsonSerializer = new RestJsonSerializer();
            var response = client.Execute(request);
            if (response.StatusCode != HttpStatusCode.OK)
            {
                throw new Exception($"接口调用发生错误：{client.BaseUrl + reqInfo.Url}");
            }
            return response.Content;
        }
        public string Execute(string url)
        {
            RequestInfo reqInfo = new RequestInfo(url);
            return Execute(reqInfo);
        }
        public string Execute(string url, HttpRequest request)
        {
            RequestInfo reqInfo = new RequestInfo(url);
            reqInfo.AddRequestInfo(request);
            return Execute(reqInfo);
        }
        public T Execute<T>(IRequestInfo reqInfo) where T : new()
        {
            return JsonConvert.DeserializeObject<T>(Execute(reqInfo));
        }
        public T Execute<T>(string url) where T : new()
        {
            RequestInfo reqInfo = new RequestInfo(url);
            return JsonConvert.DeserializeObject<T>(Execute(reqInfo));
        }
        public T Execute<T>(string url, HttpRequest request) where T : new()
        {
            RequestInfo reqInfo = new RequestInfo(url);
            reqInfo.AddRequestInfo(request);
            return JsonConvert.DeserializeObject<T>(Execute(reqInfo));
        }
    }
}
using Cis.Fm.Tools;
using Microsoft.AspNetCore.Http;
using RestSharp;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Security.Claims;
namespace Cis.Fm.Rpc
{
    public class RequestInfo : IRequestInfo
    {
        public string Url { get; set; } = string.Empty;
        public string Method { get; set; } = "POST";
        public AuthorizationInfo AuthorizationInfo { get; set; }
        public Dictionary<string, string> Headers { get; set; } = new Dictionary<string, string>();
        public Dictionary<string, string> Forms { get; set; } = new Dictionary<string, string>();
        public Dictionary<string, string> Querys { get; set; } = new Dictionary<string, string>();
        public string UserInfo { get; set; } = string.Empty;
        public RequestInfo(string url)
        {
            Url = url;
        }
        public IRequestInfo AddHeader(string key, string value)
        {
            Headers.Add(key, value);
            return this;
        }
        public IRequestInfo AddForm(string key, string value)
        {
            Forms.Add(key, value);
            return this;
        }
        public IRequestInfo AddQuery(string key, string value)
        {
            Querys.Add(key, value);
            return this;
        }
        public IRequestInfo AddUserInfo(string userInfo)
        {
            UserInfo = userInfo;
            return this;
        }
        public IRequestInfo AddAuthorizationInfo(AuthorizationInfo authorizationInfo)
        {
            AuthorizationInfo = authorizationInfo;
            return this;
        }
        public IRequestInfo AddRequestInfo(HttpRequest request)
        {
            Method = request.Method;
            foreach (var item in request.Headers.Keys)
            {
                AddHeader(item, request.Headers[item]);
            }
            if (request.HttpContext.User.Identity.IsAuthenticated
                && request.HttpContext.User.Identity is ClaimsIdentity)
            {
                if (request.HttpContext.User.HasClaim(x =>
                {
                    return x.Type == "UserInfo";
                }))
                {
                    string u = request.HttpContext.User.Claims.First(x =>
                      {
                          return x.Type == "UserInfo";
                      }).Value;
                    AddUserInfo(SecurityHelper.Base64Encrypt(u));
                }
            }
            foreach (var item in request.Query.Keys)
            {
                AddQuery(item, request.Query[item]);
            }
            if (request.HasFormContentType)
            {
                foreach (var item in request.Form.Keys)
                {
                    AddForm(item, request.Form[item]);
                }
            }
            return this;
        }
    }
}
using Newtonsoft.Json;
using RestSharp.Serializers;
namespace Cis.Fm.Rpc.Http
{
    public class RestJsonSerializer : ISerializer
    {
        public RestJsonSerializer()
        {
            ContentType = "application/json";
        }
        public string Serialize(object obj)
        {
            return JsonConvert.SerializeObject(obj);
        }
        public string RootElement { get; set; }
        public string Namespace { get; set; }
        public string DateFormat { get; set; }
        public string ContentType { get; set; }
    }
}
{
  "Logging": {
    "IncludeScopes": false,
    "LogLevel": {
      "Default": "Debug",
      "System": "Information",
      "Microsoft": "Information"
    }
  }
}
{
  "Logging": {
    "IncludeScopes": false,
    "LogLevel": {
      "Default": "Warning"
    }
  }
}
{
  "name": "asp.net",
  "private": true,
  "dependencies": {
    "bootstrap": "3.3.7",
    "jquery": "2.2.0",
    "jquery-validation": "1.14.0",
    "jquery-validation-unobtrusive": "3.2.6"
  }
}
// Configure bundling and minification for the project.
// More info at https://go.microsoft.com/fwlink/?LinkId=808241
[
  {
    "outputFileName": "wwwroot/css/site.min.css",
    // An array of relative input file paths. Globbing patterns supported
    "inputFiles": [
      "wwwroot/css/site.css"
    ]
  },
  {
    "outputFileName": "wwwroot/js/site.min.js",
    "inputFiles": [
      "wwwroot/js/site.js"
    ],
    // Optionally specify minification options
    "minify": {
      "enabled": true,
      "renameLocals": true
    },
    // Optionally generate .map file
    "sourceMap": false
  }
]
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;
namespace Cis.Fm.Web
{
    public class Program
    {
        public static void Main(string[] args)
        {
            BuildWebHost(args).Run();
        }
        public static IWebHost BuildWebHost(string[] args) =>
            WebHost.CreateDefaultBuilder(args)
                .UseStartup<Startup>()
                .Build();
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
namespace Cis.Fm.Web
{
    public class Startup
    {
        public Startup(IConfiguration configuration)
        {
            Configuration = configuration;
        }
        public IConfiguration Configuration { get; }
        // This method gets called by the runtime. Use this method to add services to the container.
        public void ConfigureServices(IServiceCollection services)
        {
            services.AddMvc();
        }
        // This method gets called by the runtime. Use this method to configure the HTTP request pipeline.
        public void Configure(IApplicationBuilder app, IHostingEnvironment env)
        {
            if (env.IsDevelopment())
            {
                app.UseDeveloperExceptionPage();
                app.UseBrowserLink();
            }
            else
            {
                app.UseExceptionHandler("/Home/Error");
            }
            app.UseStaticFiles();
            app.UseMvc(routes =>
            {
                routes.MapRoute(
                    name: "default",
                    template: "{controller=Home}/{action=Index}/{id?}");
            });
        }
    }
}
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using Cis.Fm.Web.Models;
namespace Cis.Fm.Web.Controllers
{
    public class HomeController : Controller
    {
        public IActionResult Index()
        {
            return View();
        }
        public IActionResult About()
        {
            ViewData["Message"] = "Your application description page.";
            return View();
        }
        public IActionResult Contact()
        {
            ViewData["Message"] = "Your contact page.";
            return View();
        }
        public IActionResult Error()
        {
            return View(new ErrorViewModel { RequestId = Activity.Current?.Id ?? HttpContext.TraceIdentifier });
        }
    }
}
using System;
namespace Cis.Fm.Web.Models
{
    public class ErrorViewModel
    {
        public string RequestId { get; set; }
        public bool ShowRequestId => !string.IsNullOrEmpty(RequestId);
    }
}{
  "iisSettings": {
    "windowsAuthentication": false,
    "anonymousAuthentication": true,
    "iisExpress": {
      "applicationUrl": "http://localhost:51391/",
      "sslPort": 0
    }
  },
  "profiles": {
    "IIS Express": {
      "commandName": "IISExpress",
      "launchBrowser": true,
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "Cis.Fm.Web": {
      "commandName": "Project",
      "launchBrowser": true,
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      },
      "applicationUrl": "http://localhost:51392/"
    }
  }
}
// Write your JavaScript code.
{
  "Logging": {
    "IncludeScopes": false,
    "LogLevel": {
      "Default": "Debug",
      "System": "Information",
      "Microsoft": "Information"
    }
  }
}
{
  "Logging": {
    "IncludeScopes": false,
    "Debug": {
      "LogLevel": {
        "Default": "Warning"
      }
    },
    "Console": {
      "LogLevel": {
        "Default": "Warning"
      }
    }
  }
}
using Abp.AspNetCore;
using Abp.AspNetCore.Mvc.Results.Wrapping;
using Abp.Dependency;
using Abp.Modules;
using Abp.Reflection.Extensions;
using Abp.WebApi.Configuration;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
namespace Cis.Fm.WebApi
{
    [DependsOn(typeof(AbpAspNetCoreModule))]
    public class FmWebApiModule : AbpModule
    {
        public FmWebApiModule(IHostingEnvironment env)
        {
        }
        public override void PreInitialize()
        {
            IocManager.RegisterIfNot<IAbpActionResultWrapperFactory, CisActionResultWrapperFactory>(DependencyLifeStyle.Transient);
        }
        public override void Initialize()
        {
            IocManager.RegisterAssemblyByConvention(typeof(FmWebApiModule).GetAssembly());
        }
    }
}
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;
namespace Cis.Fm.WebApi
{
    public class Program
    {
        public static void Main(string[] args)
        {
            BuildWebHost(args).Run();
        }
        public static IWebHost BuildWebHost(string[] args) =>
            WebHost.CreateDefaultBuilder(args)
                .UseStartup<Startup>()
                .Build();
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;
using Microsoft.Extensions.Options;
using Swashbuckle.AspNetCore.Swagger;
using Abp.AspNetCore;
using Castle.Facilities.Logging;
using Abp.Castle.Logging.Log4Net;
namespace Cis.Fm.WebApi
{
    public class Startup
    {
        public Startup(IConfiguration configuration)
        {
            Configuration = configuration;
        }
        public IConfiguration Configuration { get; }
        
        // This method gets called by the runtime. Use this method to add services to the container.
        public IServiceProvider ConfigureServices(IServiceCollection services)
        {
            //services.AddMvc(options => { options.Filters.AddService(typeof(CisResultFilter)); });
            services.AddMvc(options => 
            {
                //options.Filters.Remove();
                //var filters =  options.Filters;
                //var currentExceptionFilter = filters.First(h => h. is AbpResultFilter).Instance;
                //filters.Remove(currentExceptionFilter);
                //options.Filters.AddService(typeof(DontWrapResultAttribute));
            });
            
            
            services.AddSwaggerGen(options =>
            {
                options.SwaggerDoc("v1", new Info
                {
                    Version = "v1",
                    Title = "综合服务平台 API"
                });
                //Determine base path for the application.  
                //var basePath = PlatformServices.Default.Application.ApplicationBasePath;
                //TODO Set the comments path for the swagger json and ui.  
                //var xmlPath = Path.Combine(basePath, "MsSystem.API.xml");
                //options.IncludeXmlComments(xmlPath);
            });
            
            return services.AddAbp<FmWebApiModule>(options =>
            {
                //Configure Log4Net logging
                options.IocManager.IocContainer.AddFacility<LoggingFacility>(
                    f => f.UseAbpLog4Net().WithConfig("log4net.config")
                );
            });
        }
        // This method gets called by the runtime. Use this method to configure the HTTP request pipeline.
        public void Configure(IApplicationBuilder app, IHostingEnvironment env)
        {
            if (env.IsDevelopment())
            {
                app.UseDeveloperExceptionPage();
            }
            app.UseAbp(); //Initializes ABP framework.
            app.UseMvc();
            app.UseSwagger();
            app.UseSwaggerUI(c =>
            {
                c.SwaggerEndpoint("/swagger/v1/swagger.json", "综合服务平台 API V1");
            });
        }
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using Abp.AspNetCore.Mvc.Controllers;
namespace Cis.Fm.WebApi.Controllers
{
    [Route("api/[controller]")]
    public class ValuesController : AbpController
    {
        // GET api/values
        //[HttpGet]
        //public IEnumerable<string> Get()
        //{
        //    return new string[] { "value1", "value2" };
        //}
        // GET api/values
        [HttpGet]
        public ActionResult GetJson()
        {
            return Json(new string[] { "value1", "value2" });
        }
        // GET api/values/5
        [HttpGet("{id}")]
        public string Get(int id)
        {
            return "value";
        }
        // POST api/values
        [HttpPost]
        public void Post([FromBody]string value)
        {
        }
        // PUT api/values/5
        [HttpPut("{id}")]
        public void Put(int id, [FromBody]string value)
        {
        }
        // DELETE api/values/5
        [HttpDelete("{id}")]
        public void Delete(int id)
        {
        }
    }
}
{
  "iisSettings": {
    "windowsAuthentication": false,
    "anonymousAuthentication": true,
    "iisExpress": {
      "applicationUrl": "http://localhost:51403/",
      "sslPort": 0
    }
  },
  "profiles": {
    "IIS Express": {
      "commandName": "IISExpress",
      "launchBrowser": true,
      "launchUrl": "swagger",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "Cis.Fm.WebApi": {
      "commandName": "Project",
      "launchBrowser": true,
      "launchUrl": "api/values",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      },
      "applicationUrl": "http://localhost:51404/"
    }
  }
}
using System;
namespace Cis.Global
{
    public class Class1
    {
    }
}
#region copyright
// <copyright file="NotSupportExpressionException.cs" company="cis"> 
// Copyright (c) cis. All Right Reserved
// </copyright>
// <author>孙强</author>
// <datecreated>2018-04-20</datecreated>
#endregion
namespace Cis.Global
{
    using System.Collections.Generic;
    public class TempUser
    {
        /// <summary>
        /// 用户类型
        /// </summary>
        public string UserType { get; set; }
    }
    /// <summary>
    /// 当前请求信息
    /// </summary>
    public static class CurrentApp
    {
        public static string LoginCookieName { get; set; } = "";
        public static string WebRootPath { get; set; } = "";
        public static string FilesPath { get; set; } = "";
        public static string LogsPath { get; set; } = "";
        private static List<string> appKey = null;
        public static List<string> AppKey
        {
            get
            {
                if (appKey == null)
                {
                    appKey = new List<string>(Infrastructure.ConfigHelper.Instance.Get("Fm:AppKey").Split(','));
                }
                return appKey;
            }
        }
    }
}
#region copyright
// <copyright file="NotSupportExpressionException.cs" company="cis"> 
// Copyright (c) cis. All Right Reserved
// </copyright>
// <author>孙强</author>
// <datecreated>2018-04-20</datecreated>
#endregion
namespace Cis.Global
{
    using Microsoft.AspNetCore.Http;
    using Newtonsoft.Json;
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    /// <summary>
    /// 当前请求信息
    /// </summary>
   
    public static class HttpContext
    {
        private static IHttpContextAccessor _accessor;
        public static Microsoft.AspNetCore.Http.HttpContext Current => _accessor.HttpContext;
        internal static void Configure(IHttpContextAccessor accessor)
        {
            _accessor = accessor;
        }
    }
    public class CurrentRequest
    {
        public static bool IsHttp
        {
            get
            {
                try
                {
                    var s = HttpContext.Current.Request.Cookies;
                    return true;
                }
                catch
                {
                    return false;
                }
            }
        }
        /// <summary>
        /// 获取Cookie对象
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <returns></returns>
        public static T GetLoginInfo<T>() where T : class
        {
            var userCookie = HttpContext.Current.Request.Cookies[CurrentApp.LoginCookieName];
            if (userCookie != null)
            {
                string data = ""; //FormsAuthentication.Decrypt(userCookie).UserData;
                return JsonConvert.DeserializeObject<T>(data);
            }
            return null;
        }
        /// <summary>
        /// 获取请求IP
        /// </summary>
        /// <param name="context"></param>
        /// <returns></returns>
        public static string IP
        {
            get
            {
                return HttpContext.Current.Request.Headers["X-Forwarded-For"].FirstOrDefault();
            }
        }
        /// <summary>
        /// 获取用户当前登录的统筹区ID
        /// </summary>
        /// <param name="context"></param>
        /// <returns></returns>
        public static string DbKey
        {
            get
            {
                var userCookie = HttpContext.Current.Request.Cookies[CurrentApp.LoginCookieName];
                if (userCookie != null)
                {
                    string data = "";//FormsAuthentication.Decrypt(userCookie).UserData;
                    var dicData = JsonConvert.DeserializeObject<Dictionary<string, object>>(data);
                    return dicData["DbKey"].ToString();
                }
                return null;
            }
        }
    }
}
/* ***********************************************
 * author :  xieb
 * function: 药品信息解密
 * history:  created by xieb 2015/9/25 11:26:15 
 * ***********************************************/
using System;
using System.Text;
namespace Cis.Infrastructure
{
    /// <summary>
    /// Base64
    /// </summary>
    public static class Base64Encoder
    {
        /// <summary>
        /// 编码解密
        /// </summary>
        /// <param name="code"></param>
        /// <param name="content"></param>
        /// <returns></returns>
        public static string ConvertData(string code, string content)
        {
            if (string.IsNullOrEmpty(code) || string.IsNullOrEmpty(content))
            {
                return "";
            }
            try
            {
                string key = Encryption.EncryptAES(Convert.ToBase64String(Encoding.UTF8.GetBytes(code)));
                int len = key.Length / 2;
                content = content.Replace(key.Substring(0, len), "");
                content = content.Replace(key.Substring(len), "");
                byte[] bcontent = Convert.FromBase64String(content);
                content = Encoding.UTF8.GetString(bcontent, 0, bcontent.Length);
                return content;
            }
            catch
            {
                return "";
            }
        }
    }
}
using System;
using System.Collections.Generic;
using Cis.Infrastructure;
namespace Cis.Infrastructure
{
    /// <summary>
    /// 系统配置帮助
    /// </summary>
    public sealed class BaseConfigHelper
    {
        private static readonly LogHelper logHelper = new LogHelper(typeof(BaseConfigHelper));
        private static BaseConfigHelper _instance = null;
        private static readonly object _obj = new object();
        /// <summary>
        /// 单例,通过它访问系统配置
        /// </summary>
        public static BaseConfigHelper Instance
        {
            get
            {
                if (_instance == null)
                {
                    lock (_obj)
                    {
                        if (_instance == null)
                        {
                            _instance = new BaseConfigHelper();
                        }
                    }
                }
                return _instance;
            }
        }
        /// <summary>
        /// 系统核心配置信息
        /// </summary>
        private static Dictionary<string, object> ParamConfigs = new Dictionary<string, object>();
        /// <summary>
        /// 更新核心配置信息
        /// </summary>
        /// <param name="configs"></param>
        public static void RefreshSysConfig(Dictionary<string, object> configs)
        {
            ParamConfigs = configs;
        }
        /// <summary>
        /// 获取配置值
        /// </summary>
        /// <param name="key">配置Key</param>
        /// <returns></returns>
        public string GetValue(string key)
        {
            try
            {
                return ParamConfigs[key]?.ToString();
            }
            catch (Exception ex)
            {
                logHelper.Error(key + "字典值未找到");
                throw ex;
            }
            //lock (ParamConfigs)
            //{
            //    return ParamConfigs[key].Value;
            //}
        }
        public int GetInt(string key)
        {
            lock (ParamConfigs)
            {
                return int.Parse(this.GetValue(key));
                //return int.Parse(ParamConfigs[key].Value);.
            }
        }
        public bool GetBool(string key)
        {
            lock (ParamConfigs)
            {
                return bool.Parse(this.GetValue(key));
            }
        }
        public decimal GetDecimal(string key)
        {
            lock (ParamConfigs)
            {
                return decimal.Parse(this.GetValue(key));
            }
        }
        public double GetDouble(string key)
        {
            lock (ParamConfigs)
            {
                return Convert.ToDouble(this.GetValue(key));
            }
        }
        public DateTime GetDate(string key)
        {
            lock (ParamConfigs)
            {
                return DateTime.Parse(this.GetValue(key));
            }
        }
    }
}
using System;
using System.Web;
using System.Collections;
using System.IO;
using System.Collections.Generic;
using System.Linq;
using Newtonsoft.Json;
namespace Cis.Infrastructure
{
    //TODO 考虑删除这个无用的类，用cis.cache代替
    //public class CacheHelper
    //{
    //    public static Dictionary<string, CacheInfo> cacheDic = new Dictionary<string, CacheInfo>();
    //    private static FileSystemWatcher watcher = new FileSystemWatcher(AppDomain.CurrentDomain.BaseDirectory, "cacheConfig.json");
    //    /// <summary>
    //    /// 初始化缓存配置
    //    /// </summary>
    //    public static void InitCacheConfig()
    //    {
    //        watcher.Renamed += new RenamedEventHandler(watcher_Changed);
    //        watcher.EnableRaisingEvents = true;
    //        RefreshCacheConfig();
    //    }
    //    /// <summary>
    //    /// 配置文件监控事件
    //    /// </summary>
    //    /// <param name="sender"></param>
    //    /// <param name="e"></param>
    //    private static void watcher_Changed(object sender, RenamedEventArgs e)
    //    {
    //        RefreshCacheConfig();
    //    }
    //    /// <summary>
    //    /// 刷新缓存
    //    /// </summary>
    //    public static void RefreshCacheConfig()
    //    {
    //        var filePath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "cacheConfig.json");
    //        var content = File.ReadAllText(filePath);
    //        cacheDic = JsonConvert.DeserializeObject<Dictionary<string, CacheInfo>>(content);
    //        var refreshDic = cacheDic.Where(m =>
    //        {
    //            return m.Value.IsRefresh == true;
    //        });
    //        //刷新已经更新的缓存
    //        foreach (var item in refreshDic)
    //        {
    //            Remove(item.Key);
    //            cacheDic[item.Key].IsRefresh = false;
    //        }
    //        //更新配置文件
    //        watcher.Renamed -= new RenamedEventHandler(watcher_Changed);
    //        File.WriteAllText(filePath, ConvertJsonString(JsonConvert.SerializeObject(cacheDic)));
    //        watcher.Renamed += new RenamedEventHandler(watcher_Changed);
    //    }
    //    /// <summary>
    //    /// 格式化json字符串
    //    /// </summary>
    //    /// <param name="str"></param>
    //    /// <returns></returns>
    //    private static string ConvertJsonString(string str)
    //    {
    //        JsonSerializer serializer = new JsonSerializer();
    //        TextReader tr = new StringReader(str);
    //        JsonTextReader jtr = new JsonTextReader(tr);
    //        object obj = serializer.Deserialize(jtr);
    //        if (obj != null)
    //        {
    //            StringWriter textWriter = new StringWriter();
    //            JsonTextWriter jsonWriter = new JsonTextWriter(textWriter)
    //            {
    //                Formatting = Formatting.Indented
    //            };
    //            serializer.Serialize(jsonWriter, obj);
    //            return textWriter.ToString();
    //        }
    //        else
    //        {
    //            return str;
    //        }
    //    }
    //    /// <summary>
    //    /// 获取数据 如果缓存有则从缓存中获取 没有则走业务方法
    //    /// </summary>
    //    /// <typeparam name="T"></typeparam>
    //    /// <param name="key"></param>
    //    /// <param name="addItemFactory"></param>
    //    /// <returns></returns>
    //    public static T GetOrAdd<T>(string key, Func<T> addItemFactory)
    //    {
    //        System.Web.Caching.Cache objCache = HttpRuntime.Cache;
    //        var existingCacheItem = objCache.Get(key);
    //        if (existingCacheItem != null)
    //        {
    //            return (T)existingCacheItem;
    //        }
    //        try
    //        {
    //            CacheInfo cacheInfo = cacheDic[key];
    //            object rel = addItemFactory();
    //            Set(key, rel, DateTime.Now.AddMinutes(cacheInfo.Time));
    //            return (T)(rel);
    //        }
    //        catch
    //        {
    //            objCache.Remove(key);
    //            throw;
    //        }
    //    }
    //    /// <summary>
    //    /// 获取数据缓存
    //    /// </summary>
    //    /// <param name="CacheKey">键</param>
    //    public static object Get(string CacheKey)
    //    {
    //        System.Web.Caching.Cache objCache = HttpRuntime.Cache;
    //        return objCache.Get(CacheKey);
    //    }
    //    /// <summary>
    //    /// 设置数据缓存
    //    /// </summary>
    //    public static void Set(string CacheKey, object objObject, DateTime outTime)
    //    {
    //        System.Web.Caching.Cache objCache = HttpRuntime.Cache;
    //        objCache.Insert(CacheKey, objObject, null, outTime, System.Web.Caching.Cache.NoSlidingExpiration, System.Web.Caching.CacheItemPriority.Default, null);
    //    }
    //    /// <summary>
    //    /// 移除指定数据缓存
    //    /// </summary>
    //    public static void Remove(string CacheKey)
    //    {
    //        System.Web.Caching.Cache _cache = HttpRuntime.Cache;
    //        _cache.Remove(CacheKey);
    //    }
    //}
    //public class CacheInfo
    //{
    //    public long Time { get; set; }
    //    public bool IsRefresh { get; set; }
    //}
}#region copyright
// <copyright file="Comparer.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>????</author>
// <datecreated>2012-11-07</datecreated>
#endregion
namespace Cis.Infrastructure
{
    using System;
    using System.Collections.Generic;
    public class Comparer<T> : IComparer<T>
    {
        #region Fields
        private readonly Func<T, T, int> _compareFn;
        #endregion
        #region Constructors and Destructors
        public Comparer(Func<T, T, int> fn)
        {
            this._compareFn = fn;
        }
        #endregion
        #region Public Methods and Operators
        public int Compare(T x, T y)
        {
            return this._compareFn(x, y);
        }
        #endregion
    }
}using Newtonsoft.Json;
using System;
using System.Collections;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text.RegularExpressions;
namespace Cis.Infrastructure
{
    public class ConfigHelper
    {
        private static object obj = new object();
        private static ConfigHelper instance = null;
        private const string Const_Key_Delimiter = ":";
        private Stack<string> stack = new Stack<string>();
        private Dictionary<string, object> Configuration = new Dictionary<string, object>();
        public static ConfigHelper Instance
        {
            get
            {
                if (instance == null)
                {
                    lock (obj)
                    {
                        if (instance == null)
                        {
                            instance = new ConfigHelper();
                        }
                    }
                }
                return instance;
            }
        }
        public ConfigHelper()
        {
            this.Load("config.json");
            this.Load("configChange.json");
        }
        public ConfigHelper(string[] files)
        {
            foreach (var item in files)
            {
                this.Load(item);
            }
        }
        public string Get(string key)
        {
            try
            {
                return Configuration[key].ToString();
            }
            catch
            {
                return null;
            }
        }
        public Dictionary<string, string> GetSection(string key)
        {
            Dictionary<string, string> result = new Dictionary<string, string>();
            foreach (var item in Configuration)
            {
                if (item.Key.Contains(key))
                {
                    result.Add(item.Key.Replace(key + ":", ""), item.Value.ToString());
                }
            }
            return result;
        }
        public void Load(string fileName)
        {
            var content = File.ReadAllText(Path.Combine(AppDomain.CurrentDomain.BaseDirectory, fileName));
            // 过滤单行注释 
            var result = Regex.Replace(content, @"\s//(.*)", string.Empty);
            //将指定的 JSON 字符串转换为 Dictionary<string, object> 类型的对象
            var dict = JsonConvert.DeserializeObject<Dictionary<string, object>>(result);
            addConfiguration(dict);
        }
        public void addConfiguration(Dictionary<string, object> dict)
        {
            foreach (var item in dict)
            {
                Type type = item.Value.GetType();
                //key值入栈
                stack.Push(item.Key);
                if (type.Name.Contains("Dictionary"))
                {
                    addConfiguration((Dictionary<string, Object>)item.Value);
                }
                else if (type.Name.Contains("ArrayList"))
                {
                    ArrayList conns = item.Value as ArrayList;
                    for (int index = 0; index < conns.Count; index++)
                    {
                        Dictionary<string, Object> con = (Dictionary<string, Object>)conns[index];
                        addConfiguration(con);
                    }
                }
                else
                {
                    var currentPath = string.Join(Const_Key_Delimiter, stack.Reverse());
                    // 如果key重复，则覆盖则值
                    if (Configuration.Keys.Contains<string>(currentPath))
                    {
                        Configuration[currentPath] = item.Value.ToString();
                    }
                    else
                    {
                        Configuration.Add(currentPath, item.Value.ToString());
                    }
                }
                //key值出栈
                stack.Pop();
            }
        }
        public string GetValue(string key)
        {
            lock (Configuration)
            {
                return Configuration[key].ToString();
            }
        }
        public int GetInt(string key)
        {
            lock (Configuration)
            {
                return int.Parse(Configuration[key].ToString());
            }
        }
        public bool GetBool(string key)
        {
            lock (Configuration)
            {
                return bool.Parse(Configuration[key].ToString());
            }
        }
        public decimal GetDecimal(string key)
        {
            lock (Configuration)
            {
                return decimal.Parse(Configuration[key].ToString());
            }
        }
        public double GetDouble(string key)
        {
            lock (Configuration)
            {
                return Convert.ToDouble(Configuration[key]);
            }
        }
        public DateTime GetDate(string key)
        {
            lock (Configuration)
            {
                return DateTime.Parse(Configuration[key].ToString());
            }
        }
    }
}// -----------------------------------------------------------------------
// <copyright file="DateTimeHelper.cs" company="">
// TODO: Update copyright text.
// </copyright>
// -----------------------------------------------------------------------
namespace Cis.Infrastructure
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text;
    /// <summary>
    /// TODO: Update summary.
    /// </summary>
    public class DateTimeHelper
    {
        /// <summary>
        /// 计算年龄
        /// </summary>
        /// <param name="end"></param>
        /// <param name="birth"></param>
        /// <returns></returns>
        public static int? GetAge(DateTime end, DateTime birth )
        {
            int? age = end.Year - birth.Year;
            //if (birth > end.AddYears(-age)) age--;
            if (birth.AddYears(age.Value) > end && age > 0)
                age--;
            return age < 0 ? null : age;
        }
        public static DateTime Min(DateTime date1, DateTime date2)
        {
            return (date1 < date2 ? date1 : date2);
        }
        /// <summary>
        /// 计算年龄new
        /// </summary>
        /// <param name="end"></param>
        /// <param name="birth"></param>
        /// <returns></returns>
        public static string GetAge_New(DateTime end, DateTime birth)
        {
            string strAge = "";
            // 计算天数
            int day = end.Day - birth.Day;
            if (day < 0)
            {
                //当天数差小于0时月数减1并且补上天数
                end = end.AddMonths(-1);
                day += DateTime.DaysInMonth(end.Year, end.Month);
            }
            // 计算月数
            int month = end.Month - birth.Month;
            if (month < 0)
            {
                //当月数差小于0时年数减1并且补上月数
                month += 12;
                end = end.AddYears(-1);
            }
            // 计算年数
            int year = end.Year - birth.Year;
            //一周岁以上显示年数
            if (year >= 1)
            {
                strAge = year.ToString();
                return strAge;
            }
            // 1月至1周岁之内显示月数
            if (month > 0)
            {
                //当月的天数
                double daysInMonth = Convert.ToDouble(DateTime.DaysInMonth(end.Year, end.Month));
                double a = Convert.ToDouble(day) / daysInMonth;
                strAge = (month + a).ToString("0.0") + "月";
                return strAge;
            }
            if (day <= 28)        // 28天以内的算日龄
            {
                if (day == 0)
                {
                    strAge = "1日";
                }
                else
                {
                    strAge = day.ToString() + "日";
                }
            }
            else                  //28至一个月之内算1.0月
            {
                strAge = "1.0月";
            }
            return strAge;
        }
        /// <summary>
        /// 获取给定时间月份第一天
        /// </summary>
        /// <param name="dt"></param>
        /// <returns></returns>
        public static DateTime GetsFirstDay(DateTime dt)
        {
            return dt.AddDays(1 - dt.Day);//给定时间的月份第一天
        }
        /// <summary>
        /// 获取给定时间月份最后一天
        /// </summary>
        /// <param name="dt"></param>
        /// <returns></returns>
        public static DateTime GetsEndDay(DateTime dt)
        {
            //1. 取得月初
            //2. 月份+1 的前一天
            return dt.AddDays(1 - dt.Day).AddMonths(1).AddDays(-1);//给定时间月份最后一天
        }
    }
}
#region copyright
// <copyright file="HupMd5.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-11-08</datecreated>
#endregion
using System.IO;
namespace Cis.Infrastructure
{
    using System;
    using System.Security.Cryptography;
    using System.Text;
    public static class Encryption
    {
        /// <summary>
        /// 计算 SHA256 哈希值
        /// </summary>
        /// <param name="inString"></param>
        /// <returns></returns>
        public static string Sha256(string inString)
        {
            byte[] _byte = Encoding.UTF8.GetBytes(inString);
            SHA256 _sha256 = new SHA256Managed();
            byte[] _result = _sha256.ComputeHash(_byte);
            return Convert.ToBase64String(_result, 0, _result.Length);
        }
        #region AES 加密解密
        // 使用AES加密字符串
        /// <summary>
        /// 使用AES加密字符串
        /// </summary>
        /// <param name="encryptString">待加密字符串</param>
        /// <returns>加密结果，加密失败则返回源串</returns>
        public static string EncryptAES(string encryptString)
        {
            return EncryptAES(encryptString, "", "");
        }
        // 使用AES加密字符串
        /// <summary>
        /// 使用AES加密字符串
        /// </summary>
        /// <param name="encryptString">待加密字符串</param>
        /// <param name="encryptKey">加密密匙</param>
        /// <param name="salt">盐</param>
        /// <returns>加密结果，加密失败则返回源串</returns>
        private static string EncryptAES(string encryptString, string encryptKey, string salt)
        {
            AesManaged aes = null;
            MemoryStream ms = null;
            CryptoStream cs = null;
            try
            {
                if (encryptKey == "")
                    encryptKey = "CIS20141125";
                if (salt == "")
                    salt = "CIS20141125";
                Rfc2898DeriveBytes rfc2898 = new Rfc2898DeriveBytes(encryptKey, Encoding.UTF8.GetBytes(salt));
                aes = new AesManaged();
                aes.Key = rfc2898.GetBytes(aes.KeySize / 8);
                aes.IV = rfc2898.GetBytes(aes.BlockSize / 8);
                ms = new MemoryStream();
                cs = new CryptoStream(ms, aes.CreateEncryptor(), CryptoStreamMode.Write);
                byte[] data = Encoding.UTF8.GetBytes(encryptString);
                cs.Write(data, 0, data.Length);
                cs.FlushFinalBlock();
                return Convert.ToBase64String(ms.ToArray());
            }
            catch
            {
                return encryptString;
            }
            finally
            {
                if (cs != null)
                    cs.Close();
                if (ms != null)
                    ms.Close();
                if (aes != null)
                    aes.Clear();
            }
        }
        // 使用AES解密字符串
        /// <summary>
        /// 使用AES解密字符串
        /// </summary>
        /// <param name="decryptString">待解密字符串</param>
        /// <returns>解密结果，解谜失败则返回源串</returns>
        public static string DecryptAES(string decryptString)
        {
            return DecryptAES(decryptString, "", "");
        }
        // 使用AES解密字符串
        /// <summary>
        /// 使用AES解密字符串
        /// </summary>
        /// <param name="decryptString">待解密字符串</param>
        /// <param name="decryptKey">解密密匙</param>
        /// <param name="salt">盐</param>
        /// <returns>解密结果，解谜失败则返回源串</returns>
        private static string DecryptAES(string decryptString, string decryptKey, string salt)
        {
            AesManaged aes = null;
            MemoryStream ms = null;
            CryptoStream cs = null;
            try
            {
                Rfc2898DeriveBytes rfc2898 = new Rfc2898DeriveBytes(decryptKey, Encoding.UTF8.GetBytes(salt));
                aes = new AesManaged();
                aes.Key = rfc2898.GetBytes(aes.KeySize / 8);
                aes.IV = rfc2898.GetBytes(aes.BlockSize / 8);
                ms = new MemoryStream();
                cs = new CryptoStream(ms, aes.CreateDecryptor(), CryptoStreamMode.Write);
                byte[] data = Convert.FromBase64String(decryptString);
                cs.Write(data, 0, data.Length);
                cs.FlushFinalBlock();
                return Encoding.UTF8.GetString(ms.ToArray(), 0, ms.ToArray().Length);
            }
            catch
            {
                return decryptString;
            }
            finally
            {
                if (cs != null)
                    cs.Close();
                if (ms != null)
                    ms.Close();
                if (aes != null)
                    aes.Clear();
            }
        }
        #endregion AES
    }
}
namespace Cis.Infrastructure
{
    using System;
    using System.Collections.Generic;
    using System.Linq.Expressions;
    public static class Evaluator
    {
        /// <summary>
        /// Performs evaluation & replacement of independent sub-trees
        /// </summary>
        /// <param name="expression">The root of the expression tree.</param>
        /// <param name="fnCanBeEvaluated">A function that decides whether a given expression node can be part of the local function.</param>
        /// <returns>A new tree with sub-trees evaluated and replaced.</returns>
        public static Expression PartialEval(Expression expression, Func<Expression, bool> fnCanBeEvaluated)
        {
            return new SubtreeEvaluator(new Nominator(fnCanBeEvaluated).Nominate(expression)).Eval(expression);
        }
        /// <summary>
        /// Performs evaluation & replacement of independent sub-trees
        /// </summary>
        /// <param name="expression">The root of the expression tree.</param>
        /// <returns>A new tree with sub-trees evaluated and replaced.</returns>
        public static Expression PartialEval(Expression expression)
        {
            return PartialEval(expression, Evaluator.CanBeEvaluatedLocally);
        }
        private static bool CanBeEvaluatedLocally(Expression expression)
        {
            return expression.NodeType != ExpressionType.Parameter;
        }
        /// <summary>
        /// Evaluates & replaces sub-trees when first candidate is reached (top-down)
        /// </summary>
        class SubtreeEvaluator : ExpressionVisitor
        {
            HashSet<Expression> candidates;
            internal SubtreeEvaluator(HashSet<Expression> candidates)
            {
                this.candidates = candidates;
            }
            internal Expression Eval(Expression exp)
            {
                return this.Visit(exp);
            }
            public override Expression Visit(Expression exp)
            {
                if (exp == null)
                {
                    return null;
                }
                if (this.candidates.Contains(exp))
                {
                    return this.Evaluate(exp);
                }
                return base.Visit(exp);
            }
            private Expression Evaluate(Expression e)
            {
                if (e.NodeType == ExpressionType.Constant)
                {
                    return e;
                }
                LambdaExpression lambda = Expression.Lambda(e);
                Delegate fn = lambda.Compile();
                return Expression.Constant(fn.DynamicInvoke(null), e.Type);
            }
        }
        /// <summary>
        /// Performs bottom-up analysis to determine which nodes can possibly
        /// be part of an evaluated sub-tree.
        /// </summary>
        class Nominator : ExpressionVisitor
        {
            Func<Expression, bool> fnCanBeEvaluated;
            HashSet<Expression> candidates;
            bool cannotBeEvaluated;
            internal Nominator(Func<Expression, bool> fnCanBeEvaluated)
            {
                this.fnCanBeEvaluated = fnCanBeEvaluated;
            }
            internal HashSet<Expression> Nominate(Expression expression)
            {
                this.candidates = new HashSet<Expression>();
                this.Visit(expression);
                return this.candidates;
            }
            public override Expression Visit(Expression expression)
            {
                if (expression != null)
                {
                    bool saveCannotBeEvaluated = this.cannotBeEvaluated;
                    this.cannotBeEvaluated = false;
                    base.Visit(expression);
                    if (!this.cannotBeEvaluated)
                    {
                        if (this.fnCanBeEvaluated(expression))
                        {
                            this.candidates.Add(expression);
                        }
                        else
                        {
                            this.cannotBeEvaluated = true;
                        }
                    }
                    this.cannotBeEvaluated |= saveCannotBeEvaluated;
                }
                return expression;
            }
        }
    }
}using Newtonsoft.Json;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
namespace Cis.Infrastructure
{
    //TODO 考虑删除这个无用的类，用Newtonsoft代替
    public class JsonHelper
    {
        /// <summary>
        /// 将对象序列化为JSON格式
        /// </summary>
        /// <param name="o">对象</param>
        /// <returns>json字符串</returns>
        public static string SerializeObject(object o)
        {
            string json = JsonConvert.SerializeObject(o);
            return json;
        }
        /// <summary>
        /// 解析JSON字符串生成对象实体
        /// </summary>
        /// <typeparam name="T">对象类型</typeparam>
        /// <param name="json">json字符串(eg.{"ID":"112","Name":"石子儿"})</param>
        /// <returns>对象实体</returns>
        public static T DeserializeJsonToObject<T>(string json) where T : class
        {
            JsonSerializer serializer = new JsonSerializer();
            StringReader sr = new StringReader(json);
            object o = serializer.Deserialize(new JsonTextReader(sr), typeof(T));
            T t = o as T;
            return t;
        }
        /// <summary>
        /// 解析JSON数组生成对象实体集合
        /// </summary>
        /// <typeparam name="T">对象类型</typeparam>
        /// <param name="json">json数组字符串(eg.[{"ID":"112","Name":"石子儿"}])</param>
        /// <returns>对象实体集合</returns>
        public static List<T> DeserializeJsonToList<T>(string json) where T : class
        {
            JsonSerializer serializer = new JsonSerializer();
            StringReader sr = new StringReader(json);
            object o = serializer.Deserialize(new JsonTextReader(sr), typeof(List<T>));
            List<T> list = o as List<T>;
            return list;
        }
        /// <summary>
        /// 反序列化JSON到给定的匿名对象.
        /// </summary>
        /// <typeparam name="T">匿名对象类型</typeparam>
        /// <param name="json">json字符串</param>
        /// <param name="anonymousTypeObject">匿名对象</param>
        /// <returns>匿名对象</returns>
        public static T DeserializeAnonymousType<T>(string json, T anonymousTypeObject)
        {
            T t = JsonConvert.DeserializeAnonymousType(json, anonymousTypeObject);
            return t;
        }
    }
}
#region copyright
// <copyright file="KeyEqualityComparer.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>????</author>
// <datecreated>2012-11-07</datecreated>
#endregion
namespace Cis.Infrastructure
{
    using System;
    using System.Collections.Generic;
    public class KeyEqualityComparer<T, TKey> : IEqualityComparer<T>
    {
        #region Fields
        protected readonly Func<T, TKey> keyExtractor;
        #endregion
        #region Constructors and Destructors
        public KeyEqualityComparer(Func<T, TKey> keyExtractor)
        {
            this.keyExtractor = keyExtractor;
        }
        #endregion
        #region Public Methods and Operators
        public virtual bool Equals(T x, T y)
        {
            return this.keyExtractor(x).Equals(this.keyExtractor(y));
        }
        public int GetHashCode(T obj)
        {
            return this.keyExtractor(obj).GetHashCode();
        }
        #endregion
    }
}using System;
namespace Cis.Infrastructure
{
    public class LogHelper
    {
        private Type type;
        public LogHelper(Type type)
        {
            this.type = type;
        }
        public void Info(string v)
        {
            Log.Logger.Log(Log.Level.Info, v);
        }
        public void Debug(string v)
        {
            Log.Logger.Log(Log.Level.Debug, v);
        }
        public void Error(string v, Exception ex)
        {
            Log.Logger.LogException(ex);
        }
        public void Error(string msg)
        {
            Log.Logger.Log(Log.Level.Error, msg);
        }
    }
}using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
namespace Cis.Infrastructure
{
    public class NumHelper
    {
        private readonly static char[] chnGenText = new char[] { '零', '一', '二', '三', '四', '五', '六', '七', '八', '九' };
        private readonly static char[] chnGenDigit = new char[] { '十', '百', '千', '万', '亿' };
        public static string ToChinese(int num)
        {
            // 去掉数字前面所有的'0'
            // 并把数字分割到字符数组中
            char[] integral = (num.ToString()).ToCharArray();
            // 定义结果字符串
            StringBuilder strInt = new StringBuilder();
            int digit;
            digit = integral.Length - 1;
            // 使用正确的引用
            char[] chnText = chnGenText;
            char[] chnDigit = chnGenDigit;
            // 变成中文数字并添加中文数位
            // 处理最高位到十位的所有数字
            int i;
            for (i = 0; i < integral.Length - 1; i++)
            {
                // 添加数字
                strInt.Append(chnText[integral[i] - '0']);
                // 添加数位
                if (0 == digit % 4)     // '万' 或 '亿'
                {
                    if (4 == digit || 12 == digit)
                    {
                        strInt.Append(chnDigit[3]); // '万'
                    }
                    else if (8 == digit)
                    {
                        strInt.Append(chnDigit[4]); // '亿'
                    }
                }
                else         // '十'，'百'或'千'
                {
                    strInt.Append(chnDigit[digit % 4 - 1]);
                }
                digit--;
            }
            // 如果个位数不是'0'
            // 或者只有一位数
            // 则添加相应的中文数字
            if ('0' != integral[integral.Length - 1] || 1 == integral.Length)
            {
                strInt.Append(chnText[integral[i] - '0']);
            }
            // 遍历整个字符串
            i = 0;
            string strTemp; // 临时存储字符串
            int j;    // 查找“零x”结构时用
            bool bDoSomething; // 找到“零万”或“零亿”时为真
            while (i < strInt.Length)
            {
                j = i;
                bDoSomething = false;
                // 查找所有相连的“零x”结构
                while (j < strInt.Length - 1 && "零" == strInt.ToString().Substring(j, 1))
                {
                    strTemp = strInt.ToString().Substring(j + 1, 1);
                    // 如果是“零万”或者“零亿”则停止查找
                    if (chnDigit[3].ToString() /* 万或f */ == strTemp ||
                     chnDigit[4].ToString() /* 亿或| */ == strTemp)
                    {
                        bDoSomething = true;
                        break;
                    }
                    j += 2;
                }
                if (j != i) // 如果找到非“零万”或者“零亿”的“零x”结构，则全部删除
                {
                    strInt = strInt.Remove(i, j - i);
                    // 除了在最尾处，或后面不是"零万"或"零亿"的情况下, 
                    // 其他处均补入一个“零”
                    if (i <= strInt.Length - 1 && !bDoSomething)
                    {
                        strInt = strInt.Insert(i, '零');
                        i++;
                    }
                }
                if (bDoSomething) // 如果找到"零万"或"零亿"结构
                {
                    strInt = strInt.Remove(i, 1); // 去掉'零'
                    i++;
                    continue;
                }
                // 指针每次可移动2位
                i += 2;
            }
            // 遇到“亿万”变成“亿零”或"亿"
            strTemp = chnDigit[4].ToString() + chnDigit[3].ToString(); // 定义字符串“亿万”或“|f”
            int index = strInt.ToString().IndexOf(strTemp);
            if (-1 != index)
            {
                if (strInt.Length - 2 != index && // 如果"亿万"不在末尾
                 (index + 2 < strInt.Length
                  && "零" != strInt.ToString().Substring(index + 2, 1))) // 并且其后没有"零"
                {
                    strInt = strInt.Replace(strTemp, chnDigit[4].ToString(), index, 2); // 变“亿万”为“亿零”
                    strInt = strInt.Insert(index + 1, "零");
                }
                else // 如果“亿万”在末尾或是其后已经有“零”
                {
                    strInt = strInt.Replace(strTemp, chnDigit[4].ToString(), index, 2); // 变“亿万”为“亿”
                }
            }
            // 开头为“一十”改为“十”
            if (strInt.Length > 1 && "一十" == strInt.ToString().Substring(0, 2))
            {
                strInt = strInt.Remove(0, 1);
            }
            return strInt.ToString();
        }
    }
}
namespace Cis.Infrastructure
{
    using System;
    using System.Globalization;
    using System.IO;
    using System.Security.Cryptography;
    using System.Text;
    public class RsaPublicKey
    {
        public string Exponent { get; set; }
        public string Modulus { get; set; }
    }
    /// <summary> 
    /// RSA加密解密及RSA签名和验证
    /// </summary> 
    public class RSACryption
    {
        /// <summary>
        /// The rsap.
        /// </summary>
        private readonly RSAParameters rsap = new RSAParameters()
        {
            Modulus =
                Convert.FromBase64String(
                    @"sB6+4rtO2sYeIZ8kJGGM647PIm+dJkwvSPNWcQ01D2cwPjIGV2c41h39FjYuzgAKzrIFjSvuBpG4y/PFEHuN+
        LackSt6MU7qcbs7lzub8V97XZ5fddPaq/GWXo9mrIMMFDMW7z88WrukLGTvwkqySPBemc22rjua1uTR3azae7U="), 
            Exponent = Convert.FromBase64String(@"AQAB"), 
            P =
                Convert.FromBase64String(
                    @"8yUCFVCufr3z2LDAwHaUO4r3na3WZqhAb3J7aXv/rj9UEXQWwZoG8IbUzV2fUhMXjnFXyrRSqywWdpxeE6oLWw=="), 
            Q =
                Convert.FromBase64String(
                    @"uW6NlpzkBl4Do7K4RUDCsZ9uiVqnU0cbm7JVuygWJts+pu1ho5s0auUekQy5al6p4xifjWIcCsLvPxsLuWISLw=="), 
            DP =
                Convert.FromBase64String(
                    @"rDsf0ad4I3E8hNcXgn28nLzgj8Hu6ILwOcGXZ+4c+/oB++cGo5cOqVxo6xwRWhsKCa2B6aV4FaZCNzymazl9lw=="), 
            DQ =
                Convert.FromBase64String(
                    @"dVVT+FKMIs9IZEPJP+DrkTM94WHgcNyUxp9Aii2iXrHqYfvhBYJG18Dk54lypbECtLU2+GJ1NgYFFxxI/ePldw=="), 
            InverseQ =
                Convert.FromBase64String(
                    @"z8qRY0+yyfZFNFPMtlTumpYyCXUbK+GpWnFp2hOyTABya/h7g4DCRE6iO9UZKgW4paB5K75mJwdBgVib5NgFiQ=="), 
            D =
                Convert.FromBase64String(@"W1ZWoLeLWaJNlho2YDfHIZLakX1Y/reb/jVUqySyU96sAlVnPITn0QOUcaR/+Y3EDRX+EwypUPbZ48v0c2vgYDHwIb
rIbsEyN+vHoUNJ319R5kUZ8Wlfw/w6/6BSclqbWQ8OdSj1cKwx/EEJh4iipqJ8HBTsmoT0anQHP/jdybE=")
        };
        #region RSA 加密解密 
        #region RSA 的密钥产生 
        public static byte[] HexStringToBytes(string hex)
        {
            if (hex.Length == 0)
            {
                return new byte[] { 0 };
            }
            if (hex.Length % 2 == 1)
            {
                hex = "0" + hex;
            }
            byte[] result = new byte[hex.Length / 2];
            for (int i = 0; i < hex.Length / 2; i++)
            {
                result[i] = byte.Parse(hex.Substring(2 * i, 2), NumberStyles.AllowHexSpecifier);
            }
            return result;
        }
        /// <summary>
        /// RSA 的密钥产生 产生私钥 和公钥 
        /// </summary>
        /// <param name="publicKey">
        /// The public Key.
        /// </param>
        /// <param name="xmlPrivateKey">
        /// The xml Private Key.
        /// </param>
        public void RSAKey(RsaPublicKey publicKey, out string xmlPrivateKey)
        {
            using (var rsa = new RSACryptoServiceProvider())
            {
                rsa.ImportParameters(rsap);
                xmlPrivateKey = rsa.ToXmlString(true);
                publicKey.Exponent = BytesToHexString(rsap.Exponent);
                publicKey.Modulus = BytesToHexString(rsap.Modulus);
            }
        }
        /// <summary>
        /// The get public key.
        /// </summary>
        /// <returns>
        /// The <see cref="RsaPublicKey"/>.
        /// </returns>
        public RsaPublicKey GetPublicKey()
        {
            var publicKey = new RsaPublicKey()
            {
                Exponent = BytesToHexString(rsap.Exponent), 
                Modulus = BytesToHexString(rsap.Modulus)
            };
            return publicKey;
        }
        /// <summary>
        /// The get private key.
        /// </summary>
        /// <returns>
        /// The <see cref="string"/>.
        /// </returns>
        public string GetPrivateKey()
        {
            using (var rsa = new RSACryptoServiceProvider())
            {
                rsa.ImportParameters(rsap);
                return rsa.ToXmlString(true);
            }
        }
        #endregion
        #region RSA的加密函数 
        // ############################################################################## 
        // RSA 方式加密 
        // 说明KEY必须是XML的行式,返回的是字符串 
        // 在有一点需要说明！！该加密方式有 长度 限制的！！ 
        // ############################################################################## 
        // RSA的加密函数  string
        public string RSAEncrypt(string xmlPublicKey, string m_strEncryptString)
        {
            using (var rsa = new RSACryptoServiceProvider())
            {
                rsa.FromXmlString(xmlPublicKey);
                var plainTextBArray = (new UnicodeEncoding()).GetBytes(m_strEncryptString);
                var cypherTextBArray = rsa.Encrypt(plainTextBArray, false);
                var result = Convert.ToBase64String(cypherTextBArray);
                return result;
            }
        }
        // RSA的加密函数 byte[]
        public string RSAEncrypt(string xmlPublicKey, byte[] encryptString)
        {
            using (var rsa = new RSACryptoServiceProvider())
            {
                rsa.FromXmlString(xmlPublicKey);
                var cypherTextBArray = rsa.Encrypt(encryptString, false);
                var result = Convert.ToBase64String(cypherTextBArray);
                return result;
            }
        }
        #endregion
        #region RSA的解密函数 
        // RSA的解密函数  string
        public string RSADecrypt(string xmlPrivateKey, string m_strDecryptString)
        {
            using (var rsa = new RSACryptoServiceProvider())
            {
                rsa.FromXmlString(xmlPrivateKey);
                var plainTextBArray = HexStringToBytes(m_strDecryptString);
                var result = rsa.Decrypt(plainTextBArray, false);
                var enc = new ASCIIEncoding();
                return enc.GetString(result);
            }
        }
        // RSA的解密函数  byte
        public string RSADecrypt(string xmlPrivateKey, byte[] decryptString)
        {
            using (var rsa = new RSACryptoServiceProvider())
            {
                rsa.FromXmlString(xmlPrivateKey);
                var dypherTextBArray = rsa.Decrypt(decryptString, false);
                var result = (new UnicodeEncoding()).GetString(dypherTextBArray);
                return result;
            }
        }
        #endregion
        #endregion
        #region RSA数字签名 
        #region 获取Hash描述表 
        // 获取Hash描述表 ，outofmemory.cn
        public bool GetHash(string m_strSource, ref byte[] hashData)
        {
            // 从字符串中取得Hash描述 
            var md5 = HashAlgorithm.Create("MD5");
            var buffer = Encoding.GetEncoding("GB2312").GetBytes(m_strSource);
            if (md5 != null)
            {
                hashData = md5.ComputeHash(buffer);
            }
            return true;
        }
        // 获取Hash描述表 
        public bool GetHash(string m_strSource, ref string strHashData)
        {
            // 从字符串中取得Hash描述 
            var md5 = HashAlgorithm.Create("MD5");
            var buffer = Encoding.GetEncoding("GB2312").GetBytes(m_strSource);
            if (md5 != null)
            {
                var hashData = md5.ComputeHash(buffer);
                strHashData = Convert.ToBase64String(hashData);
            }
            return true;
        }
        // 获取Hash描述表 
        public bool GetHash(FileStream objFile, ref byte[] hashData)
        {
            // 从文件中取得Hash描述 
            var md5 = HashAlgorithm.Create("MD5");
            if (md5 != null)
            {
                hashData = md5.ComputeHash(objFile);
            }
            objFile.Close();
            return true;
        }
        // 获取Hash描述表 
        public bool GetHash(FileStream objFile, ref string strHashData)
        {
            // 从文件中取得Hash描述 
            var md5 = HashAlgorithm.Create("MD5");
            if (md5 != null)
            {
                var hashData = md5.ComputeHash(objFile);
                objFile.Close();
                strHashData = Convert.ToBase64String(hashData);
            }
            return true;
        }
        #endregion
        #endregion
        private string BytesToHexString(byte[] input)
        {
            var hexString = new StringBuilder(64);
            for (int i = 0; i < input.Length; i++)
            {
                hexString.Append(string.Format("{0:X2}", input[i]));
            }
            return hexString.ToString();
        }
    }
    #region RSA
    #endregion RSA
}
using System;
using System.IO;
using System.Security.Cryptography;
using System.Text;
namespace Cis.Infrastructure
{
    /// <summary>
    ///     加密类
    /// </summary>
    public class SymmetricMethod
    {
        private readonly string Key;
        private readonly SymmetricAlgorithm mobjCryptoService;
        /// <summary>
        ///     构造函数
        /// </summary>
        public SymmetricMethod()
        {
            mobjCryptoService = new AesManaged();
            Key = @"Ehong2017&Guz(%&hj7x89H$yuBI0456FtmaT5&fvHUFCy76*h%(HilJ$lhj!y6&(*jkP87jH7";
        }
        /// <summary>
        ///     获得密钥
        /// </summary>
        /// <returns></returns>
        private byte[] GetLegalKey()
        {
            string sTemp = Key;
            mobjCryptoService.GenerateKey();
            byte[] bytTemp = mobjCryptoService.Key;
            int KeyLength = bytTemp.Length;
            if (sTemp.Length > KeyLength)
                sTemp = sTemp.Substring(0, KeyLength);
            else if (sTemp.Length < KeyLength)
                sTemp = sTemp.PadRight(KeyLength, ' ');
            return Encoding.UTF8.GetBytes(sTemp);
        }
        private byte[] GetLegalIV()
        {
            string sTemp = @"Ehong2017&E4ghj*Ghg7!rNIfb&95GUY86GfghUb#er57HBh(u%g6HJ($jhWk7&!hg4ui%$hjk";
            mobjCryptoService.GenerateIV();
            byte[] bytTemp = mobjCryptoService.IV;
            int IVLength = bytTemp.Length;
            if (sTemp.Length > IVLength)
                sTemp = sTemp.Substring(0, IVLength);
            else if (sTemp.Length < IVLength)
                sTemp = sTemp.PadRight(IVLength, ' ');
            return Encoding.UTF8.GetBytes(sTemp);
        }
        /// <summary>
        ///     加密方法
        /// </summary>
        /// <param name="Source"></param>
        /// <returns></returns>
        public string Encrypto(string Source)
        {
            byte[] bytIn = Encoding.UTF8.GetBytes(Source);
            var ms = new MemoryStream();
            mobjCryptoService.Key = GetLegalKey();
            mobjCryptoService.IV = GetLegalIV();
            ICryptoTransform encrypto = mobjCryptoService.CreateEncryptor();
            var cs = new CryptoStream(ms, encrypto, CryptoStreamMode.Write);
            cs.Write(bytIn, 0, bytIn.Length);
            cs.FlushFinalBlock();
            ms.Close();
            byte[] bytOut = ms.ToArray();
            return Convert.ToBase64String(bytOut);
        }
        /// <summary>
        ///     解密方法
        /// </summary>
        /// <param name="source"></param>
        /// <returns></returns>
        public string Decrypto(string source)
        {
            try
            {
                byte[] bytIn = Convert.FromBase64String(source);
                var ms = new MemoryStream(bytIn, 0, bytIn.Length);
                mobjCryptoService.Key = GetLegalKey();
                mobjCryptoService.IV = GetLegalIV();
                ICryptoTransform encrypto = mobjCryptoService.CreateDecryptor();
                var cs = new CryptoStream(ms, encrypto, CryptoStreamMode.Read);
                var sr = new StreamReader(cs);
                return sr.ReadToEnd();
            }
            catch (Exception)
            {
                // Logger.LogException(exp);
                return null;
            }
        }
    }
}
using ICSharpCode.SharpZipLib.Zip;
using System;
using System.IO;
namespace Cis.Infrastructure
{
    public class ZipHelper
    {
        #region 加压解压方法
        /// <summary>
        /// 功能：压缩文件（暂时只压缩文件夹下一级目录中的文件，文件夹及其子级被忽略）
        /// </summary>
        /// <param name="dirPath">被压缩的文件夹夹路径</param>
        /// <param name="zipFilePath">生成压缩文件的路径，为空则默认与被压缩文件夹同一级目录，名称为：文件夹名+.zip</param>
        /// <param name="err">出错信息</param>
        /// <returns>是否压缩成功</returns>
        public static bool ZipFile(string dirPath, string zipFilePath, out string err)
        {
            err = "";
            if (dirPath == string.Empty)
            {
                err = "要压缩的文件夹不能为空！";
                return false;
            }
            if (!Directory.Exists(dirPath))
            {
                err = "要压缩的文件夹不存在！";
                return false;
            }
            //压缩文件名为空时使用文件夹名＋.zip
            if (zipFilePath == string.Empty)
            {
                if (dirPath.EndsWith("\\"))
                {
                    dirPath = dirPath.Substring(0, dirPath.Length - 1);
                }
                zipFilePath = dirPath + ".zip";
            }
            try
            {
                string[] filenames = Directory.GetFiles(dirPath);
                using (ZipOutputStream s = new ZipOutputStream(File.Create(zipFilePath)))
                {
                    s.SetLevel(9);
                    byte[] buffer = new byte[4096];
                    foreach (string file in filenames)
                    {
                        ZipEntry entry = new ZipEntry(Path.GetFileName(file));
                        entry.DateTime = DateTime.Now;
                        s.PutNextEntry(entry);
                        using (FileStream fs = File.OpenRead(file))
                        {
                            int sourceBytes;
                            do
                            {
                                sourceBytes = fs.Read(buffer, 0, buffer.Length);
                                s.Write(buffer, 0, sourceBytes);
                            } while (sourceBytes > 0);
                        }
                    }
                    s.Finish();
                    s.Close();
                }
            }
            catch (Exception ex)
            {
                err = ex.Message;
                return false;
            }
            return true;
        }
        /// <summary>
        /// 功能：解压zip格式的文件。
        /// </summary>
        /// <param name="zipFilePath">压缩文件路径</param>
        /// <param name="unZipDir">解压文件存放路径,为空时默认与压缩文件同一级目录下，跟压缩文件同名的文件夹</param>
        /// <param name="err">出错信息</param>
        /// <returns>解压是否成功</returns>
        public static bool UnZipFile(string zipFilePath, string unZipDir, out string err)
        {
            err = "";
            if (zipFilePath == string.Empty)
            {
                err = "压缩文件不能为空！";
                return false;
            }
            if (!File.Exists(zipFilePath))
            {
                err = "压缩文件不存在！";
                return false;
            }
            //解压文件夹为空时默认与压缩文件同一级目录下，跟压缩文件同名的文件夹
            if (unZipDir == string.Empty)
                unZipDir = zipFilePath.Replace(Path.GetFileName(zipFilePath), Path.GetFileNameWithoutExtension(zipFilePath));
            if (!unZipDir.EndsWith("\\"))
                unZipDir += "\\";
            if (!Directory.Exists(unZipDir))
                Directory.CreateDirectory(unZipDir);
            try
            {
                using (ZipInputStream s = new ZipInputStream(File.OpenRead(zipFilePath)))
                {
                    ZipEntry theEntry;
                    while ((theEntry = s.GetNextEntry()) != null)
                    {
                        string directoryName = Path.GetDirectoryName(theEntry.Name);
                        string fileName = Path.GetFileName(theEntry.Name);
                        if (directoryName.Length > 0)
                        {
                            Directory.CreateDirectory(unZipDir + directoryName);
                        }
                        if (!directoryName.EndsWith("\\"))
                            directoryName += "\\";
                        if (fileName != String.Empty)
                        {
                            using (FileStream streamWriter = File.Create(unZipDir + theEntry.Name))
                            {
                                int size = 2048;
                                byte[] data = new byte[2048];
                                while (true)
                                {
                                    size = s.Read(data, 0, data.Length);
                                    if (size > 0)
                                    {
                                        streamWriter.Write(data, 0, size);
                                    }
                                    else
                                    {
                                        break;
                                    }
                                }
                            }
                        }
                    }//while
                }
            }
            catch (Exception ex)
            {
                err = ex.Message;
                return false;
            }
            return true;
        }
        #endregion
        /// <summary>
        /// 压缩文件
        /// </summary>
        /// <param name="patch"></param>
        /// <param name="rarPatch"></param>
        /// <param name="rarName"></param>
        //public static bool CompressRAR(string patch, string rarPatch, string rarName)
        //{
        //    try
        //    {
        //        RegistryKey the_Reg = Registry.LocalMachine.OpenSubKey(
        //           @"SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\WinRAR.exe");
        //        object the_Obj = the_Reg.GetValue("");
        //        string the_rar = the_Obj.ToString();
        //        the_Reg.Close();
        //        if (Directory.Exists(rarPatch) == false)
        //        {
        //            Directory.CreateDirectory(rarPatch);
        //        }
        //        string ls = rarPatch + "\\" + rarName;
        //        string the_Info = "a -as -r " + ls + " * ";
        //        ProcessStartInfo the_StartInfo = new ProcessStartInfo();
        //        the_StartInfo.FileName = the_rar;
        //        the_StartInfo.Arguments = the_Info;
        //        the_StartInfo.WindowStyle = ProcessWindowStyle.Hidden;
        //        the_StartInfo.WorkingDirectory = patch;//获取压缩包路径
        //        Process the_Process = new Process();
        //        the_Process.StartInfo = the_StartInfo;
        //        the_Process.Start();
        //        the_Process.WaitForExit();
        //        the_Process.Close();
        //        return true;
        //    }
        //    catch (Exception ex)
        //    {
        //        return false;
        //        throw ex;
        //    }
        //}
        ///// <summary>
        ///// 解压
        ///// </summary>
        ///// <param name="unRarPatch">解压后的文件路径</param>
        ///// <param name="rarPatch">需要解压的文件路径</param>
        ///// <param name="rarName">文件名</param>
        ///// <param name="err">错误信息</param>
        ///// <returns></returns>
        //public static void UnRar(string unRarPath, string rarPath, string rarName)
        //{
        //    string fileFullName = Path.Combine(rarPath ,rarName);
        //    if (Directory.Exists(unRarPath) == false)
        //    {
        //        Directory.CreateDirectory(unRarPath);
        //    }
        //    RegistryKey registry = Registry.LocalMachine.OpenSubKey(
        //        @"SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\WinRAR.exe");
        //    ProcessStartInfo ProStartInfo = new ProcessStartInfo();
        //    ProStartInfo.FileName = registry.GetValue("").ToString();
        //    ProStartInfo.Arguments = "x " + rarName + " " + unRarPath + " -y"; ;
        //    ProStartInfo.WindowStyle = ProcessWindowStyle.Hidden;
        //    ProStartInfo.WorkingDirectory = rarPath;//获取压缩包路径
        //    Process process = new Process();
        //    process.StartInfo = ProStartInfo;
        //    process.Start();
        //    process.WaitForExit();
        //    process.Close();
        //    registry.Close();
        //}
        ///// <summary>
        ///// 判断是否安装RAR软件
        ///// </summary>
        ///// <param name=""></param>
        ///// <returns></returns>
        //private static bool Exists()
        //{
        //    RegistryKey registry = Registry.LocalMachine.OpenSubKey(
        //            @"SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\WinRAR.exe");
        //    return !string.IsNullOrEmpty(registry.GetValue("").ToString());
        //}
    }
}
// -----------------------------------------------------------------------
// <copyright file="DateTimeExtension.cs" company="">
// TODO: Update copyright text.
// </copyright>
// -----------------------------------------------------------------------
using System.Collections.Generic;
namespace Cis.Infrastructure
{
    using System;
    /// <summary>
    /// TODO: Update summary.
    /// </summary>
    public static class DateTimeExtension
    {
        public static DateTime ToStartDate(this DateTime dateTime)
        {
            var str = dateTime.ToString("yyyy-MM-dd") + " 00:00:00";
            return DateTime.Parse(str);
        }
        public static DateTime ToEndDate(this DateTime dateTime)
        {
            var str = dateTime.ToString("yyyy-MM-dd") + " 23:59:59";
            return DateTime.Parse(str);
        }
        /// <summary>
        /// 转换为20100701格式字符串
        /// </summary>
        /// <param name="dateTime"></param>
        /// <returns></returns>
        public static int ToYearMonth(this DateTime dateTime)
        {
            var str = dateTime.ToString("yyyyMMdd");
            return int.Parse(str);
        }
        /// <summary>
        /// 得到自定义的开始日期和结束日期
        /// </summary>
        /// <param name="inputMonth">日期的月份</param>
        /// <param name="lastMonthBeginDay">上月的天数</param>
        /// <param name="currentMonthEndDay">当月的天数</param>
        /// <returns></returns>
        public static Dictionary<int, DateTime> GetCustomDate(this DateTime inputMonth, int lastMonthBeginDay, int currentMonthEndDay)
        {
            var dic = new Dictionary<int, DateTime>();
            var beginDate = Convert.ToDateTime(string.Format("{0:yyyy-MM-01}", inputMonth));
            var endDate = beginDate.AddMonths(1);
            if (lastMonthBeginDay == 0)
            {
                dic.Add(0, beginDate);
                dic.Add(1, endDate);
            }
            else
            {
                if (currentMonthEndDay == 0)
                {
                    dic.Add(0, beginDate);
                    dic.Add(1, endDate);
                }
                else
                {
                    var lastMonth = beginDate.AddMonths(-1);
                    var lastMonthDaysInMonth = DateTime.DaysInMonth(lastMonth.Year, lastMonth.Month);
                    var currentMonthDaysInMonth = DateTime.DaysInMonth(inputMonth.Year, inputMonth.Month);
                    var isBeginDayRight = lastMonthBeginDay > 0 && lastMonthBeginDay <= lastMonthDaysInMonth;
                    var isEndDayRight = currentMonthEndDay > 0 && currentMonthEndDay <= currentMonthDaysInMonth;
                    if (isBeginDayRight && isEndDayRight)
                    {
                        dic.Add(0,DateTime.Parse(string.Format("{0}-{1}-{2}",lastMonth.Year,lastMonth.Month,lastMonthBeginDay)));
                        dic.Add(1, DateTime.Parse(string.Format("{0}-{1}-{2}", beginDate.Year, beginDate.Month, currentMonthEndDay)).AddDays(1));
                    }
                    else
                    {
                        dic.Add(0, beginDate);
                        dic.Add(1, endDate);
                    }
                }
            }
            return dic;
        }
        /// <summary>
        /// 得到日期的自定义的月份
        /// </summary>
        /// <param name="inputDateTime"></param>
        /// <param name="lastMonthBeginDay"></param>
        /// <param name="currentMonthEndDay"></param>
        /// <returns></returns>
        public static DateTime GetCurrentMonth(this DateTime inputDateTime, int lastMonthBeginDay, int currentMonthEndDay)
        {
            if (lastMonthBeginDay == 0)
            {
                return inputDateTime;
            }
            if (currentMonthEndDay == 0)
            {
                return inputDateTime;
            }
            var dic = inputDateTime.GetCustomDate(lastMonthBeginDay, currentMonthEndDay);
            if (inputDateTime >= dic[0] && inputDateTime < dic[1])
            {
                return inputDateTime;
            }
            if (inputDateTime < dic[0])
            {
                return inputDateTime.AddMonths(-1);
            }
            return inputDateTime >= dic[1] ? inputDateTime.AddMonths(1) : inputDateTime;
        }
    }
}
// -----------------------------------------------------------------------
// <copyright file="ExpressionExtension.cs" company="">
// TODO: Update copyright text.
// </copyright>
// -----------------------------------------------------------------------
namespace Cis.Infrastructure
{
    using System;
    using System.Collections.Generic;
    using System.IO;
    using System.Linq;
    using System.Linq.Expressions;
    using System.Reflection;
    using System.Runtime.Serialization;
    /// <summary>
    /// TODO: Update summary.
    /// </summary>
    public static class ExpressionExtension
    {
        //public static string GetPropertySymbol<T, TResult>(Expression<Func<T, TResult>> expression)
        //{
        //    return String.Join(".",
        //        GetMembersOnPath(expression.Body as MemberExpression)
        //            .Select(m => m.Member.Name)
        //            .Reverse());
        //}
        public static MemberInfo GetMemberInfo1(this Expression expression)
        {
            var lambda = (LambdaExpression)expression;
            MemberExpression memberExpression;
            if (lambda.Body is UnaryExpression)
            {
                var unaryExpression = (UnaryExpression)lambda.Body;
                memberExpression = (MemberExpression)unaryExpression.Operand;
            }
            else
            {
                memberExpression = (MemberExpression)lambda.Body;
            }
            return memberExpression.Member;
        }
        public static string GetPropertySymbol<TResult>(this Expression<Func<TResult>> expression)
        {
            return String.Join(".",
                GetMembersOnPath(expression.Body as MemberExpression)
                    .Select(m => m.Member.Name)
                    .Reverse());
        }
        private static IEnumerable<MemberExpression> GetMembersOnPath(MemberExpression expression)
        {
            while (expression != null)
            {
                yield return expression;
                expression = expression.Expression as MemberExpression;
            }
        }
        public static MemberExpression GetRightMostMember(this Expression e)
        {
            if (e is LambdaExpression)
            {
                return GetRightMostMember(((LambdaExpression)e).Body);
            }
            if (e is MemberExpression)
            {
                return (MemberExpression)e;
            }
            if (e is MethodCallExpression)
            {
                var callExpression = (MethodCallExpression)e;
                Expression member = callExpression.Arguments.Count > 0
                                        ? callExpression.Arguments[0]
                                        : callExpression.Object;
                return GetRightMostMember(member);
            }
            if (e is UnaryExpression)
            {
                var unaryExpression = (UnaryExpression)e;
                return GetRightMostMember(unaryExpression.Operand);
            }
            throw new Exception(e.ToString());
        }
        public static string ToPath(this MemberExpression e)
        {
            string path = "";
            var parent = e.Expression as MemberExpression;
            if (parent != null)
            {
                path = parent.ToPath() + ".";
            }
            return path + e.Member.Name;
        }
        public static string PropertyName<TDomain,TProp>(this Expression<Func<TDomain, TProp>> expression)
        {
            LambdaExpression lambda = expression as LambdaExpression;
            if (lambda == null)
                throw new ArgumentNullException("expression");
            MemberExpression memberExpr = null;
            if (lambda.Body.NodeType == ExpressionType.Convert)
            {
                memberExpr =
                    ((UnaryExpression)lambda.Body).Operand as MemberExpression;
            }
            else if (lambda.Body.NodeType == ExpressionType.MemberAccess)
            {
                memberExpr = lambda.Body as MemberExpression;
            }
            if (memberExpr == null)
                throw new ArgumentException("method");
            return memberExpr.Member.Name;
        }
        #region Shicz,2013-7-29 修改
        public static MemberExpression ConvertMemberExpressionForConstant(this MemberExpression expression)
        {
            if (expression.Expression is ConstantExpression)
            {
                return expression;
            }
            else
            {
                return ConvertMemberExpressionForConstant(expression.Expression as MemberExpression);
            }
        }
        #endregion
        /// <summary>
        /// 深拷贝方法
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="source"></param>
        /// <returns></returns>
        public static T DeepClone<T>(this T source)
        {
            var serializer = new DataContractSerializer(typeof(T));
            using (var ms = new MemoryStream())
            {
                serializer.WriteObject(ms, source);
                ms.Seek(0, SeekOrigin.Begin);
                return (T)serializer.ReadObject(ms);
            }
        }
    }
}
// -----------------------------------------------------------------------
// <copyright file="Class1.cs" company="">
// TODO: Update copyright text.
// </copyright>
// -----------------------------------------------------------------------
namespace Cis.Infrastructure.Extensions
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text;
    /// <summary>
    /// TODO: Update summary.
    /// </summary>
    public static class HashSetExtensions
    {
        public static void AddRange<T>(this HashSet<T> hashSet, IEnumerable<T> list)
        {
            foreach (T ts in list)
            {
                hashSet.Add(ts);
            }
        }
    }
}
/* ***********************************************
 * author :  闫刘盘
 * function: 批量扣款Dao
 * history:  created by 闫刘盘 2015/07/02 
 * ***********************************************/
namespace Cis.Infrastructure.Extensions
{
    using System;
    using System.Collections.Generic;
    using System.IO;
    using System.Linq;
    using System.Runtime.Serialization;
    using System.Text;
    using System.Threading.Tasks;
    /// <summary>
    /// 扩展方法
    /// </summary>
    public static class IEnumerableExtention
    {
        /// <summary>
        /// 将数组平滑平展，中间用逗号隔开
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="lst"></param>
        /// <returns></returns>
        public static string ToSmoothString<T>(this IEnumerable<T> lst)
        {
            string strReturn = string.Empty;
            if (lst != null)
            {
                var enumerable = lst as T[] ?? lst.ToArray();
                if (enumerable.Any())
                {
                    var sb = new StringBuilder();
                    foreach (var item in enumerable)
                    {
                        sb.Append(item + ",");
                    }
                    sb.Remove(sb.Length - 1, 1);
                    strReturn = sb.ToString();
                }
            }
            return strReturn;
        }
    }
}

using System;
using System.Collections.Generic;
using System.Reflection;
using System.Text;
using System.Text.RegularExpressions;
namespace Cis.Infrastructure
{
    public static class Strings
    {
        private static readonly Dictionary<int, string> _entityTable = new Dictionary<int, string>();
        private static readonly Dictionary<string, string> _USStateTable = new Dictionary<string, string>();
        /// <summary>
        /// Initializes the <see cref="Strings"/> class.
        /// </summary>
        static Strings()
        {
            FillEntities();
            FillUSStates();
        }
        public static bool Matches(this string source, string compare)
        {
            return String.Equals(source, compare, StringComparison.InvariantCultureIgnoreCase);
        }
        public static bool MatchesTrimmed(this string source, string compare)
        {
            return String.Equals(source.Trim(), compare.Trim(), StringComparison.InvariantCultureIgnoreCase);
        }
        public static bool MatchesRegex(this string inputString, string matchPattern)
        {
            return Regex.IsMatch(inputString, matchPattern,
                RegexOptions.IgnoreCase | RegexOptions.IgnorePatternWhitespace);
        }
        /// <summary>
        /// Strips the last specified chars from a string.
        /// </summary>
        /// <param name="sourceString">The source string.</param>
        /// <param name="removeFromEnd">The remove from end.</param>
        /// <returns></returns>
        public static string Chop(this string sourceString, int removeFromEnd)
        {
            string result = sourceString;
            if ((removeFromEnd > 0) && (sourceString.Length > removeFromEnd - 1))
                result = result.Remove(sourceString.Length - removeFromEnd, removeFromEnd);
            return result;
        }
        /// <summary>
        /// Strips the last specified chars from a string.
        /// </summary>
        /// <param name="sourceString">The source string.</param>
        /// <param name="backDownTo">The back down to.</param>
        /// <returns></returns>
        public static string Chop(this string sourceString, string backDownTo)
        {
            int removeDownTo = sourceString.LastIndexOf(backDownTo);
            int removeFromEnd = 0;
            if (removeDownTo > 0)
                removeFromEnd = sourceString.Length - removeDownTo;
            string result = sourceString;
            if (sourceString.Length > removeFromEnd - 1)
                result = result.Remove(removeDownTo, removeFromEnd);
            return result;
        }
       
      
      
        /// <summary>
        /// Removes the specified chars from the beginning of a string.
        /// </summary>
        /// <param name="sourceString">The source string.</param>
        /// <param name="removeFromBeginning">The remove from beginning.</param>
        /// <returns></returns>
        public static string Clip(this string sourceString, int removeFromBeginning)
        {
            string result = sourceString;
            if (sourceString.Length > removeFromBeginning)
                result = result.Remove(0, removeFromBeginning);
            return result;
        }
        /// <summary>
        /// Removes chars from the beginning of a string, up to the specified string
        /// </summary>
        /// <param name="sourceString">The source string.</param>
        /// <param name="removeUpTo">The remove up to.</param>
        /// <returns></returns>
        public static string Clip(this string sourceString, string removeUpTo)
        {
            int removeFromBeginning = sourceString.IndexOf(removeUpTo);
            string result = sourceString;
            if (sourceString.Length > removeFromBeginning && removeFromBeginning > 0)
                result = result.Remove(0, removeFromBeginning);
            return result;
        }
        /// <summary>
        /// Strips the last char from a a string.
        /// </summary>
        /// <param name="sourceString">The source string.</param>
        /// <returns></returns>
        public static string Chop(this string sourceString)
        {
            return Chop(sourceString, 1);
        }
        /// <summary>
        /// Strips the last char from a a string.
        /// </summary>
        /// <param name="sourceString">The source string.</param>
        /// <returns></returns>
        public static string Clip(this string sourceString)
        {
            return Clip(sourceString, 1);
        }
        /// <summary>
        /// Fasts the replace.
        /// </summary>
        /// <param name="original">The original.</param>
        /// <param name="pattern">The pattern.</param>
        /// <param name="replacement">The replacement.</param>
        /// <returns></returns>
        public static string FastReplace(this string original, string pattern, string replacement)
        {
            return FastReplace(original, pattern, replacement, StringComparison.InvariantCultureIgnoreCase);
        }
        /// <summary>
        /// Fasts the replace.
        /// </summary>
        /// <param name="original">The original.</param>
        /// <param name="pattern">The pattern.</param>
        /// <param name="replacement">The replacement.</param>
        /// <param name="comparisonType">Type of the comparison.</param>
        /// <returns></returns>
        public static string FastReplace(this string original, string pattern, string replacement,
                                         StringComparison comparisonType)
        {
            if (original == null)
                return null;
            if (String.IsNullOrEmpty(pattern))
                return original;
            int lenPattern = pattern.Length;
            int idxPattern = -1;
            int idxLast = 0;
            StringBuilder result = new StringBuilder();
            while (true)
            {
                idxPattern = original.IndexOf(pattern, idxPattern + 1, comparisonType);
                if (idxPattern < 0)
                {
                    result.Append(original, idxLast, original.Length - idxLast);
                    break;
                }
                result.Append(original, idxLast, idxPattern - idxLast);
                result.Append(replacement);
                idxLast = idxPattern + lenPattern;
            }
            return result.ToString();
        }
        /// <summary>
        /// Returns text that is located between the startText and endText tags.
        /// </summary>
        /// <param name="sourceString">The source string.</param>
        /// <param name="startText">The text from which to start the crop</param>
        /// <param name="endText">The endpoint of the crop</param>
        /// <returns></returns>
        public static string Crop(this string sourceString, string startText, string endText)
        {
            int startIndex = sourceString.IndexOf(startText, StringComparison.CurrentCultureIgnoreCase);
            if (startIndex == -1)
                return String.Empty;
            startIndex += startText.Length;
            int endIndex = sourceString.IndexOf(endText, startIndex, StringComparison.CurrentCultureIgnoreCase);
            if (endIndex == -1)
                return String.Empty;
            return sourceString.Substring(startIndex, endIndex - startIndex);
        }
        /// <summary>
        /// Removes excess white space in a string.
        /// </summary>
        /// <param name="sourceString">The source string.</param>
        /// <returns></returns>
        public static string Squeeze(this string sourceString)
        {
            char[] delim = { ' ' };
            string[] lines = sourceString.Split(delim, StringSplitOptions.RemoveEmptyEntries);
            StringBuilder sb = new StringBuilder();
            foreach (string s in lines)
            {
                if (!String.IsNullOrEmpty(s.Trim()))
                    sb.Append(s + " ");
            }
            //remove the last pipe
            string result = Chop(sb.ToString());
            return result.Trim();
        }
        /// <summary>
        /// Removes all non-alpha numeric characters in a string
        /// </summary>
        /// <param name="sourceString">The source string.</param>
        /// <returns></returns>
        public static string ToAlphaNumericOnly(this string sourceString)
        {
            return Regex.Replace(sourceString, @"\W*", "");
        }
        /// <summary>
        /// Creates a string array based on the words in a sentence
        /// </summary>
        /// <param name="sourceString">The source string.</param>
        /// <returns></returns>
        public static string[] ToWords(this string sourceString)
        {
            string result = sourceString.Trim();
            return result.Split(new[] { ' ' }, StringSplitOptions.RemoveEmptyEntries);
        }
        /// <summary>
        /// Strips all HTML tags from a string
        /// </summary>
        /// <param name="htmlString">The HTML string.</param>
        /// <returns></returns>
        public static string StripHTML(this string htmlString)
        {
            return StripHTML(htmlString, String.Empty);
        }
        /// <summary>
        /// Strips all HTML tags from a string and replaces the tags with the specified replacement
        /// </summary>
        /// <param name="htmlString">The HTML string.</param>
        /// <param name="htmlPlaceHolder">The HTML place holder.</param>
        /// <returns></returns>
        public static string StripHTML(this string htmlString, string htmlPlaceHolder)
        {
            const string pattern = @"<(.|\n)*?>";
            string sOut = Regex.Replace(htmlString, pattern, htmlPlaceHolder);
            sOut = sOut.Replace("&nbsp;", String.Empty);
            sOut = sOut.Replace("&amp;", "&");
            sOut = sOut.Replace("&gt;", ">");
            sOut = sOut.Replace("&lt;", "<");
            return sOut;
        }
        public static List<string> FindMatches(this string source, string find)
        {
            Regex reg = new Regex(find, RegexOptions.IgnoreCase);
            List<string> result = new List<string>();
            foreach (Match m in reg.Matches(source))
                result.Add(m.Value);
            return result;
        }
        /// <summary>
        /// Converts a generic List collection to a single comma-delimitted string.
        /// </summary>
        /// <param name="list">The list.</param>
        /// <returns></returns>
        public static string ToDelimitedList(this IEnumerable<string> list)
        {
            return ToDelimitedList(list, ",");
        }
        /// <summary>
        /// Converts a generic List collection to a single string using the specified delimitter.
        /// </summary>
        /// <param name="list">The list.</param>
        /// <param name="delimiter">The delimiter.</param>
        /// <returns></returns>
        public static string ToDelimitedList(this IEnumerable<string> list, string delimiter)
        {
            StringBuilder sb = new StringBuilder();
            foreach (string s in list)
                sb.Append(String.Concat(s, delimiter));
            string result = sb.ToString();
            result = Chop(result);
            return result;
        }
        /// <summary>
        /// Strips the specified input.
        /// </summary>
        /// <param name="sourceString">The source string.</param>
        /// <param name="stripValue">The strip value.</param>
        /// <returns></returns>
        public static string Strip(this string sourceString, string stripValue)
        {
            if (!String.IsNullOrEmpty(stripValue))
            {
                string[] replace = stripValue.Split(new[] { ',' });
                for (int i = 0; i < replace.Length; i++)
                {
                    if (!String.IsNullOrEmpty(sourceString))
                        sourceString = Regex.Replace(sourceString, replace[i], String.Empty);
                }
            }
            return sourceString;
        }
        /// <summary>
        /// Converts ASCII encoding to Unicode
        /// </summary>
        /// <param name="asciiCode">The ASCII code.</param>
        /// <returns></returns>
        public static string AsciiToUnicode(this int asciiCode)
        {
            Encoding ascii = Encoding.UTF32;
            char c = (char)asciiCode;
            Byte[] b = ascii.GetBytes(c.ToString());
            return ascii.GetString((b));
        }
        /// <summary>
        /// Converts Text to HTML-encoded string
        /// </summary>
        /// <param name="textString">The text string.</param>
        /// <returns></returns>
        public static string TextToEntity(this string textString)
        {
            foreach (KeyValuePair<int, string> key in _entityTable)
                textString = textString.Replace(AsciiToUnicode(key.Key), key.Value);
            return textString.Replace(AsciiToUnicode(38), "&amp;");
        }
        /// <summary>
        /// Converts HTML-encoded bits to Text
        /// </summary>
        /// <param name="entityText">The entity text.</param>
        /// <returns></returns>
        public static string EntityToText(this string entityText)
        {
            entityText = entityText.Replace("&amp;", "&");
            foreach (KeyValuePair<int, string> key in _entityTable)
                entityText = entityText.Replace(key.Value, AsciiToUnicode(key.Key));
            return entityText;
        }
        /// <summary>
        /// Formats the args using String.Format with the target string as a format string.
        /// </summary>
        /// <param name="fmt">The format string passed to String.Format</param>
        /// <param name="args">The args passed to String.Format</param>
        /// <returns></returns>
        public static string ToFormattedString(this string fmt, params object[] args)
        {
            return String.Format(fmt, args);
        }
        /// <summary>
        /// Strings to enum.
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="Value">The value.</param>
        /// <returns></returns>
        public static T ToEnum<T>(this string Value)
        {
            T oOut = default(T);
            Type t = typeof(T);
            foreach (FieldInfo fi in t.GetFields())
            {
                if (fi.Name.Matches(Value))
                    oOut = (T)fi.GetValue(null);
            }
            return oOut;
        }
        /// <summary>
        /// Fills the entities.
        /// </summary>
        private static void FillEntities()
        {
            _entityTable.Add(160, "&nbsp;");
            _entityTable.Add(161, "&iexcl;");
            _entityTable.Add(162, "&cent;");
            _entityTable.Add(163, "&pound;");
            _entityTable.Add(164, "&curren;");
            _entityTable.Add(165, "&yen;");
            _entityTable.Add(166, "&brvbar;");
            _entityTable.Add(167, "&sect;");
            _entityTable.Add(168, "&uml;");
            _entityTable.Add(169, "&copy;");
            _entityTable.Add(170, "&ordf;");
            _entityTable.Add(171, "&laquo;");
            _entityTable.Add(172, "&not;");
            _entityTable.Add(173, "&shy;");
            _entityTable.Add(174, "&reg;");
            _entityTable.Add(175, "&macr;");
            _entityTable.Add(176, "&deg;");
            _entityTable.Add(177, "&plusmn;");
            _entityTable.Add(178, "&sup2;");
            _entityTable.Add(179, "&sup3;");
            _entityTable.Add(180, "&acute;");
            _entityTable.Add(181, "&micro;");
            _entityTable.Add(182, "&para;");
            _entityTable.Add(183, "&middot;");
            _entityTable.Add(184, "&cedil;");
            _entityTable.Add(185, "&sup1;");
            _entityTable.Add(186, "&ordm;");
            _entityTable.Add(187, "&raquo;");
            _entityTable.Add(188, "&frac14;");
            _entityTable.Add(189, "&frac12;");
            _entityTable.Add(190, "&frac34;");
            _entityTable.Add(191, "&iquest;");
            _entityTable.Add(192, "&Agrave;");
            _entityTable.Add(193, "&Aacute;");
            _entityTable.Add(194, "&Acirc;");
            _entityTable.Add(195, "&Atilde;");
            _entityTable.Add(196, "&Auml;");
            _entityTable.Add(197, "&Aring;");
            _entityTable.Add(198, "&AElig;");
            _entityTable.Add(199, "&Ccedil;");
            _entityTable.Add(200, "&Egrave;");
            _entityTable.Add(201, "&Eacute;");
            _entityTable.Add(202, "&Ecirc;");
            _entityTable.Add(203, "&Euml;");
            _entityTable.Add(204, "&Igrave;");
            _entityTable.Add(205, "&Iacute;");
            _entityTable.Add(206, "&Icirc;");
            _entityTable.Add(207, "&Iuml;");
            _entityTable.Add(208, "&ETH;");
            _entityTable.Add(209, "&Ntilde;");
            _entityTable.Add(210, "&Ograve;");
            _entityTable.Add(211, "&Oacute;");
            _entityTable.Add(212, "&Ocirc;");
            _entityTable.Add(213, "&Otilde;");
            _entityTable.Add(214, "&Ouml;");
            _entityTable.Add(215, "&times;");
            _entityTable.Add(216, "&Oslash;");
            _entityTable.Add(217, "&Ugrave;");
            _entityTable.Add(218, "&Uacute;");
            _entityTable.Add(219, "&Ucirc;");
            _entityTable.Add(220, "&Uuml;");
            _entityTable.Add(221, "&Yacute;");
            _entityTable.Add(222, "&THORN;");
            _entityTable.Add(223, "&szlig;");
            _entityTable.Add(224, "&agrave;");
            _entityTable.Add(225, "&aacute;");
            _entityTable.Add(226, "&acirc;");
            _entityTable.Add(227, "&atilde;");
            _entityTable.Add(228, "&auml;");
            _entityTable.Add(229, "&aring;");
            _entityTable.Add(230, "&aelig;");
            _entityTable.Add(231, "&ccedil;");
            _entityTable.Add(232, "&egrave;");
            _entityTable.Add(233, "&eacute;");
            _entityTable.Add(234, "&ecirc;");
            _entityTable.Add(235, "&euml;");
            _entityTable.Add(236, "&igrave;");
            _entityTable.Add(237, "&iacute;");
            _entityTable.Add(238, "&icirc;");
            _entityTable.Add(239, "&iuml;");
            _entityTable.Add(240, "&eth;");
            _entityTable.Add(241, "&ntilde;");
            _entityTable.Add(242, "&ograve;");
            _entityTable.Add(243, "&oacute;");
            _entityTable.Add(244, "&ocirc;");
            _entityTable.Add(245, "&otilde;");
            _entityTable.Add(246, "&ouml;");
            _entityTable.Add(247, "&divide;");
            _entityTable.Add(248, "&oslash;");
            _entityTable.Add(249, "&ugrave;");
            _entityTable.Add(250, "&uacute;");
            _entityTable.Add(251, "&ucirc;");
            _entityTable.Add(252, "&uuml;");
            _entityTable.Add(253, "&yacute;");
            _entityTable.Add(254, "&thorn;");
            _entityTable.Add(255, "&yuml;");
            _entityTable.Add(402, "&fnof;");
            _entityTable.Add(913, "&Alpha;");
            _entityTable.Add(914, "&Beta;");
            _entityTable.Add(915, "&Gamma;");
            _entityTable.Add(916, "&Delta;");
            _entityTable.Add(917, "&Epsilon;");
            _entityTable.Add(918, "&Zeta;");
            _entityTable.Add(919, "&Eta;");
            _entityTable.Add(920, "&Theta;");
            _entityTable.Add(921, "&Iota;");
            _entityTable.Add(922, "&Kappa;");
            _entityTable.Add(923, "&Lambda;");
            _entityTable.Add(924, "&Mu;");
            _entityTable.Add(925, "&Nu;");
            _entityTable.Add(926, "&Xi;");
            _entityTable.Add(927, "&Omicron;");
            _entityTable.Add(928, "&Pi;");
            _entityTable.Add(929, "&Rho;");
            _entityTable.Add(931, "&Sigma;");
            _entityTable.Add(932, "&Tau;");
            _entityTable.Add(933, "&Upsilon;");
            _entityTable.Add(934, "&Phi;");
            _entityTable.Add(935, "&Chi;");
            _entityTable.Add(936, "&Psi;");
            _entityTable.Add(937, "&Omega;");
            _entityTable.Add(945, "&alpha;");
            _entityTable.Add(946, "&beta;");
            _entityTable.Add(947, "&gamma;");
            _entityTable.Add(948, "&delta;");
            _entityTable.Add(949, "&epsilon;");
            _entityTable.Add(950, "&zeta;");
            _entityTable.Add(951, "&eta;");
            _entityTable.Add(952, "&theta;");
            _entityTable.Add(953, "&iota;");
            _entityTable.Add(954, "&kappa;");
            _entityTable.Add(955, "&lambda;");
            _entityTable.Add(956, "&mu;");
            _entityTable.Add(957, "&nu;");
            _entityTable.Add(958, "&xi;");
            _entityTable.Add(959, "&omicron;");
            _entityTable.Add(960, "&pi;");
            _entityTable.Add(961, "&rho;");
            _entityTable.Add(962, "&sigmaf;");
            _entityTable.Add(963, "&sigma;");
            _entityTable.Add(964, "&tau;");
            _entityTable.Add(965, "&upsilon;");
            _entityTable.Add(966, "&phi;");
            _entityTable.Add(967, "&chi;");
            _entityTable.Add(968, "&psi;");
            _entityTable.Add(969, "&omega;");
            _entityTable.Add(977, "&thetasym;");
            _entityTable.Add(978, "&upsih;");
            _entityTable.Add(982, "&piv;");
            _entityTable.Add(8226, "&bull;");
            _entityTable.Add(8230, "&hellip;");
            _entityTable.Add(8242, "&prime;");
            _entityTable.Add(8243, "&Prime;");
            _entityTable.Add(8254, "&oline;");
            _entityTable.Add(8260, "&frasl;");
            _entityTable.Add(8472, "&weierp;");
            _entityTable.Add(8465, "&image;");
            _entityTable.Add(8476, "&real;");
            _entityTable.Add(8482, "&trade;");
            _entityTable.Add(8501, "&alefsym;");
            _entityTable.Add(8592, "&larr;");
            _entityTable.Add(8593, "&uarr;");
            _entityTable.Add(8594, "&rarr;");
            _entityTable.Add(8595, "&darr;");
            _entityTable.Add(8596, "&harr;");
            _entityTable.Add(8629, "&crarr;");
            _entityTable.Add(8656, "&lArr;");
            _entityTable.Add(8657, "&uArr;");
            _entityTable.Add(8658, "&rArr;");
            _entityTable.Add(8659, "&dArr;");
            _entityTable.Add(8660, "&hArr;");
            _entityTable.Add(8704, "&forall;");
            _entityTable.Add(8706, "&part;");
            _entityTable.Add(8707, "&exist;");
            _entityTable.Add(8709, "&empty;");
            _entityTable.Add(8711, "&nabla;");
            _entityTable.Add(8712, "&isin;");
            _entityTable.Add(8713, "&notin;");
            _entityTable.Add(8715, "&ni;");
            _entityTable.Add(8719, "&prod;");
            _entityTable.Add(8721, "&sum;");
            _entityTable.Add(8722, "&minus;");
            _entityTable.Add(8727, "&lowast;");
            _entityTable.Add(8730, "&radic;");
            _entityTable.Add(8733, "&prop;");
            _entityTable.Add(8734, "&infin;");
            _entityTable.Add(8736, "&ang;");
            _entityTable.Add(8743, "&and;");
            _entityTable.Add(8744, "&or;");
            _entityTable.Add(8745, "&cap;");
            _entityTable.Add(8746, "&cup;");
            _entityTable.Add(8747, "&int;");
            _entityTable.Add(8756, "&there4;");
            _entityTable.Add(8764, "&sim;");
            _entityTable.Add(8773, "&cong;");
            _entityTable.Add(8776, "&asymp;");
            _entityTable.Add(8800, "&ne;");
            _entityTable.Add(8801, "&equiv;");
            _entityTable.Add(8804, "&le;");
            _entityTable.Add(8805, "&ge;");
            _entityTable.Add(8834, "&sub;");
            _entityTable.Add(8835, "&sup;");
            _entityTable.Add(8836, "&nsub;");
            _entityTable.Add(8838, "&sube;");
            _entityTable.Add(8839, "&supe;");
            _entityTable.Add(8853, "&oplus;");
            _entityTable.Add(8855, "&otimes;");
            _entityTable.Add(8869, "&perp;");
            _entityTable.Add(8901, "&sdot;");
            _entityTable.Add(8968, "&lceil;");
            _entityTable.Add(8969, "&rceil;");
            _entityTable.Add(8970, "&lfloor;");
            _entityTable.Add(8971, "&rfloor;");
            _entityTable.Add(9001, "&lang;");
            _entityTable.Add(9002, "&rang;");
            _entityTable.Add(9674, "&loz;");
            _entityTable.Add(9824, "&spades;");
            _entityTable.Add(9827, "&clubs;");
            _entityTable.Add(9829, "&hearts;");
            _entityTable.Add(9830, "&diams;");
            _entityTable.Add(34, "&quot;");
            //_entityTable.Add(38, "&amp;");
            _entityTable.Add(60, "&lt;");
            _entityTable.Add(62, "&gt;");
            _entityTable.Add(338, "&OElig;");
            _entityTable.Add(339, "&oelig;");
            _entityTable.Add(352, "&Scaron;");
            _entityTable.Add(353, "&scaron;");
            _entityTable.Add(376, "&Yuml;");
            _entityTable.Add(710, "&circ;");
            _entityTable.Add(732, "&tilde;");
            _entityTable.Add(8194, "&ensp;");
            _entityTable.Add(8195, "&emsp;");
            _entityTable.Add(8201, "&thinsp;");
            _entityTable.Add(8204, "&zwnj;");
            _entityTable.Add(8205, "&zwj;");
            _entityTable.Add(8206, "&lrm;");
            _entityTable.Add(8207, "&rlm;");
            _entityTable.Add(8211, "&ndash;");
            _entityTable.Add(8212, "&mdash;");
            _entityTable.Add(8216, "&lsquo;");
            _entityTable.Add(8217, "&rsquo;");
            _entityTable.Add(8218, "&sbquo;");
            _entityTable.Add(8220, "&ldquo;");
            _entityTable.Add(8221, "&rdquo;");
            _entityTable.Add(8222, "&bdquo;");
            _entityTable.Add(8224, "&dagger;");
            _entityTable.Add(8225, "&Dagger;");
            _entityTable.Add(8240, "&permil;");
            _entityTable.Add(8249, "&lsaquo;");
            _entityTable.Add(8250, "&rsaquo;");
            _entityTable.Add(8364, "&euro;");
        }
        /// <summary>
        /// Converts US State Name to it's two-character abbreviation. Returns null if the state name was not found.
        /// </summary>
        /// <param name="stateName">US State Name (ie Texas)</param>
        /// <returns></returns>
        public static string USStateNameToAbbrev(string stateName)
        {
            stateName = stateName.ToUpper();
            foreach (KeyValuePair<string, string> key in _USStateTable)
            {
                if (stateName == key.Key)
                    return key.Value;
            }
            return null;
        }
        /// <summary>
        /// Converts a two-character US State Abbreviation to it's official Name Returns null if the abbreviation was not found.
        /// </summary>
        /// <param name="stateAbbrev">US State Name (ie Texas)</param>
        /// <returns></returns>
        public static string USStateAbbrevToName(string stateAbbrev)
        {
            stateAbbrev = stateAbbrev.ToUpper();
            foreach (KeyValuePair<string, string> key in _USStateTable)
            {
                if (stateAbbrev == key.Value)
                    return key.Key;
            }
            return null;
        }
        /// <summary>
        /// Fills the US States.
        /// </summary>
        private static void FillUSStates()
        {
            _USStateTable.Add("ALABAMA", "AL");
            _USStateTable.Add("ALASKA", "AK");
            _USStateTable.Add("AMERICAN SAMOA", "AS");
            _USStateTable.Add("ARIZONA ", "AZ");
            _USStateTable.Add("ARKANSAS", "AR");
            _USStateTable.Add("CALIFORNIA ", "CA");
            _USStateTable.Add("COLORADO ", "CO");
            _USStateTable.Add("CONNECTICUT", "CT");
            _USStateTable.Add("DELAWARE", "DE");
            _USStateTable.Add("DISTRICT OF COLUMBIA", "DC");
            _USStateTable.Add("FEDERATED STATES OF MICRONESIA", "FM");
            _USStateTable.Add("FLORIDA", "FL");
            _USStateTable.Add("GEORGIA", "GA");
            _USStateTable.Add("GUAM ", "GU");
            _USStateTable.Add("HAWAII", "HI");
            _USStateTable.Add("IDAHO", "ID");
            _USStateTable.Add("ILLINOIS", "IL");
            _USStateTable.Add("INDIANA", "IN");
            _USStateTable.Add("IOWA", "IA");
            _USStateTable.Add("KANSAS", "KS");
            _USStateTable.Add("KENTUCKY", "KY");
            _USStateTable.Add("LOUISIANA", "LA");
            _USStateTable.Add("MAINE", "ME");
            _USStateTable.Add("MARSHALL ISLANDS", "MH");
            _USStateTable.Add("MARYLAND", "MD");
            _USStateTable.Add("MASSACHUSETTS", "MA");
            _USStateTable.Add("MICHIGAN", "MI");
            _USStateTable.Add("MINNESOTA", "MN");
            _USStateTable.Add("MISSISSIPPI", "MS");
            _USStateTable.Add("MISSOURI", "MO");
            _USStateTable.Add("MONTANA", "MT");
            _USStateTable.Add("NEBRASKA", "NE");
            _USStateTable.Add("NEVADA", "NV");
            _USStateTable.Add("NEW HAMPSHIRE", "NH");
            _USStateTable.Add("NEW JERSEY", "NJ");
            _USStateTable.Add("NEW MEXICO", "NM");
            _USStateTable.Add("NEW YORK", "NY");
            _USStateTable.Add("NORTH CAROLINA", "NC");
            _USStateTable.Add("NORTH DAKOTA", "ND");
            _USStateTable.Add("NORTHERN MARIANA ISLANDS", "MP");
            _USStateTable.Add("OHIO", "OH");
            _USStateTable.Add("OKLAHOMA", "OK");
            _USStateTable.Add("OREGON", "OR");
            _USStateTable.Add("PALAU", "PW");
            _USStateTable.Add("PENNSYLVANIA", "PA");
            _USStateTable.Add("PUERTO RICO", "PR");
            _USStateTable.Add("RHODE ISLAND", "RI");
            _USStateTable.Add("SOUTH CAROLINA", "SC");
            _USStateTable.Add("SOUTH DAKOTA", "SD");
            _USStateTable.Add("TENNESSEE", "TN");
            _USStateTable.Add("TEXAS", "TX");
            _USStateTable.Add("UTAH", "UT");
            _USStateTable.Add("VERMONT", "VT");
            _USStateTable.Add("VIRGIN ISLANDS", "VI");
            _USStateTable.Add("VIRGINIA ", "VA");
            _USStateTable.Add("WASHINGTON", "WA");
            _USStateTable.Add("WEST VIRGINIA", "WV");
            _USStateTable.Add("WISCONSIN", "WI");
            _USStateTable.Add("WYOMING", "WY");
        }
    }
}#region copyright
// <copyright file="TypeExtensions.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>????</author>
// <datecreated>2012-11-20</datecreated>
#endregion
namespace Cis.Infrastructure.Extensions
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Reflection;
    public static class TypeExtensions
    {
        #region Public Methods and Operators
        /// <summary>
        /// 
        /// </summary>
        /// <param name="type"></param>
        /// <returns></returns>
        public static List<PropertyInfo> GetPropertys(this Type type)
        {
            return Reflection.Reflection.GetPropertys(type);
        }
        /// <summary>
        /// ???????????????????????????IsPrimitive()?ж??????????Enum???IsNullableEnum
        /// </summary>
        /// <param name="type"></param>
        /// <returns></returns>
        public static List<PropertyInfo> GetPrimitivePropertys(this Type type)
        {
            
            return Reflection.Reflection.GetPropertys(type).Where(p => p.PropertyType.IsPrimitive()||p.PropertyType.IsNullableEnum()||p.PropertyType.IsEnum).ToList();
        }
        /// <summary>
        /// ?ж?????????????
        /// </summary>
        /// <param name="t"></param>
        /// <returns></returns>
        public static bool IsNullableEnum(this Type t)
        {
            Type u = Nullable.GetUnderlyingType(t);
            return (u != null) && u.IsEnum;
        }
       
        /// <summary>
        /// ???????????
        /// </summary>
        /// <param name="type"></param>
        /// <returns></returns>
        public static List<PropertyInfo> GetComplexPropertys(this Type type)
        {
            return Reflection.Reflection.GetPropertys(type).Where(p => !p.PropertyType.IsPrimitive()).ToList();
        }
        /// <exception cref="System.InvalidCastException"></exception>
        public static dynamic DynamicCast(this Type T, dynamic o)
        {
            return
                typeof(TypeExtensions).GetMethod("Cast", BindingFlags.Static | BindingFlags.NonPublic).MakeGenericMethod
                    (T).Invoke(null, new object[] { o });
        }
        public static bool IsPrimitive(this Type T)
        {
            // TODO: put any type here that you consider as primitive as I didn't
            // quite understand what your definition of primitive type is
            return
                new[]
                    {
                        typeof(string), typeof(char), typeof(byte), typeof(ushort), typeof(short), typeof(uint),
                        typeof(int), typeof(ulong), typeof(long), typeof(float), typeof(double), typeof(decimal),
                        typeof(DateTime), typeof(Guid), typeof(char?), typeof(byte?), typeof(ushort?), typeof(short?),
                        typeof(uint?), typeof(int?), typeof(ulong?), typeof(long?), typeof(float?), typeof(double?),
                        typeof(decimal?), typeof(DateTime?), typeof(Guid?),typeof(bool),typeof(bool?),typeof(byte[])
                    }.Contains(T);
        }
        #endregion
        #region Methods
        /// <summary>
        /// ????????????+string "false 0 true ,1"????bool
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="value"></param>
        /// <returns></returns>
        private static T Cast<T>(dynamic value)
        {
            if (typeof(T) == typeof(bool) && value is string)
            {
                if (value.ToString() == "1")
                {
                    return (T)Convert.ChangeType("True", typeof(T));
                }
                else if (value.ToString() == "0")
                {
                    return (T)Convert.ChangeType("False", typeof(T));
                }
                return (T)Convert.ToBoolean(value);
            }
            return (T)value;
        }
        //public static dynamic DynamicCast2<T>(this Type TT, dynamic o)
        //{
        //    return (T)o;
        //}
        #endregion
    }
}#region copyright
// <copyright file="Reflection.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>????</author>
// <datecreated>2012-11-20</datecreated>
#endregion
namespace Cis.Infrastructure.Reflection
{
    using System;
    using System.Collections;
    using System.Collections.Generic;
    using System.Linq;
    using System.Reflection;
    using System.Reflection.Emit;
    using Cis.Cache;
    using Cis.Infrastructure.Extensions;
    using Cis.Log;
    using EnsureThat;
    internal delegate void GenericSetter(object target, object value);
    internal delegate object GenericGetter(object target);
    internal delegate object FastCreateInstanceHandler();
    internal delegate object FastInvokeHandler(object target, object[] parameters);
    /// <summary>
    /// ????????????
    /// </summary>
    public static class Reflection
    {
        #region Static Fields
      
        private static readonly ICacheProvider<FastInvokeHandler> methodCache =
           new LruMemoryCache<FastInvokeHandler>();
        /// <summary>
        ///??????????????  value ? GenericSetter,GenericGetter
        /// </summary>
       private static readonly ICacheProvider<object> propertyAccessorCache =
           new LruMemoryCache<object>();
        /// <summary>
        /// ???????????key ????????? GetPropertys???????????
        /// </summary>
       
        private static readonly ICacheProvider<List<PropertyInfo>> typePropertyCache =
           new LruMemoryCache<List<PropertyInfo>>();
        /// <summary>
        /// ????????????????????GetProperty???????????
        /// </summary>
        private static readonly ICacheProvider<PropertyInfo> propertyCache =
           new LruMemoryCache<PropertyInfo>();
        private static readonly ICacheProvider<FastCreateInstanceHandler> typeCache =
            new LruMemoryCache<FastCreateInstanceHandler>();
        #endregion
        #region Public Methods and Operators
        /// <summary>
        /// 
        /// </summary>
        /// <param name="obj">???÷????????????????null</param>
        /// <param name="methodName"></param>
        /// <param name="parameters"></param>
        /// <returns></returns>
        public static object CallMethod(object obj, string methodName, object[] parameters)
        {
            Type type = obj.GetType();
            string key = type.FullName + "$" + "method" + methodName;
            var method= methodCache.GetOrAdd(key, () => GetMethodInvoker(type, methodName));
            return method(obj, parameters);
           
        }
        private static object ChangeType(object value, Type conversionType)
        {
            if (conversionType.IsGenericType && conversionType.GetGenericTypeDefinition().Equals(typeof(Nullable<>)))
            {
                if (value == null)
                {
                    return null;
                }
                throw new NotSupportedException();
                //System.ComponentModel.NullableConverter nullableConverter
                //    = new System.ComponentModel.NullableConverter(conversionType);
                // conversionType = nullableConverter.UnderlyingType;
            }
            if (conversionType.GetInterface("IConvertible", true) != null)
            {
                return Convert.ChangeType(value, conversionType, null);
            }
            return value;
            //return Convert.ChangeType(value, conversionType,null);
        }
        /// <summary>
        /// silverlight????
        /// </summary>
        /// <param name="type">????????????</param>
        /// <param name="value"></param>
        /// <returns></returns>
        public static object ChangeType2(Type type, object value)
        {
            if ((value == null) && type.IsGenericType)
            {
                return Activator.CreateInstance(type);
            }
            if (value == null)
            {
                return null;
            }
            if (type == value.GetType())
            {
                return value;
            }
            if (type.IsEnum)
            {
                string s = Convert.ToString(value);
                return Enum.Parse(type, s, true);
                //if (value is string)
                //{
                //    return Enum.Parse(type, value as string, true);
                //}
                //return Enum.ToObject(type, value);
            }
            if (!type.IsInterface && type.IsGenericType)
            {
                Type type1 = type.GetGenericArguments()[0];
                object obj1 = ChangeType2(type1, value);
                return Activator.CreateInstance(type, new[] { obj1 });
            }
            if ((value is string) && (type == typeof(Guid)))
            {
                return new Guid(value as string);
            }
            if ((value is string) && (type == typeof(Version)))
            {
                return new Version(value as string);
            }
            if ((value is string) && (type == typeof(bool)))
            {
                if (value.ToString() == "1")
                {
                    return true;
                }
                else if (value.ToString() == "0")
                {
                    return false;
                }
                else
                {
                    return Convert.ToBoolean(value);
                }
                
            }
            if (!(value is IConvertible))
            {
                return value;
            }
            return Convert.ChangeType(value, type, null);
        }
        public static object CreateInstance(string name)
        {
            Type t = Type.GetType(name);
            return CreateInstance(t);
        }
        /// <summary>
        /// ??????????????
        /// </summary>
        /// <param name="type"></param>
        /// <returns></returns>
        public static object CreateInstance(Type type)
        {
            try
            {
                var typeFac= typeCache.GetOrAdd(type.FullName,()=> GetInstanceCreator(type));
                return typeFac();
               
            }
            catch (Exception ex)
            {
                
                Logger.Log(Level.Error, ex.StackTrace+ ex.Message+ "???????????????");
                return null;
            }
          
        }
        /// <summary>
        /// ?????????????
        /// </summary>
        /// <param name="type"></param>
        /// <returns></returns>
        public static object CreateInstanceNoCache(Type type)
        {
            try
            {
                var typeFac= GetInstanceCreator(type);
                return typeFac();
            }
            catch (Exception ex)
            {
                Logger.Log(Level.Error,  "???????????????,?????????"+type.FullName+ex.Message);
                return null;
            }
        }
        public static object GetPropertyValue(object obj, string propertyName)
        {
            Type type = obj.GetType();
            string key = type.FullName + "$" + "get" + propertyName;
            var properyAccessor= propertyAccessorCache.GetOrAdd(key, () => CreateGetMethod(type, propertyName));
            return ((GenericGetter)properyAccessor)(obj);
           
        }
        public static bool IsContainProperty(object obj, string propertyName)
        {
            Type type = obj.GetType();
            string key = type.FullName + "$" +  propertyName;
            PropertyInfo propertyInfo = type.GetProperty(propertyName);
            return propertyInfo != null;
        }
        public static bool ImplementsGenericDefinition(
            Type type, Type genericInterfaceDefinition, out Type implementingType)
        {
            //ValidationUtils.ArgumentNotNull(type, "type");
            //ValidationUtils.ArgumentNotNull(genericInterfaceDefinition, "genericInterfaceDefinition");
            if (!genericInterfaceDefinition.IsInterface || !genericInterfaceDefinition.IsGenericTypeDefinition)
            {
                throw new ArgumentNullException();
            }
            if (type.IsInterface)
            {
                if (type.IsGenericType)
                {
                    Type interfaceDefinition = type.GetGenericTypeDefinition();
                    if (genericInterfaceDefinition == interfaceDefinition)
                    {
                        implementingType = type;
                        return true;
                    }
                }
            }
            foreach (Type i in type.GetInterfaces())
            {
                if (i.IsGenericType)
                {
                    Type interfaceDefinition = i.GetGenericTypeDefinition();
                    if (genericInterfaceDefinition == interfaceDefinition)
                    {
                        implementingType = i;
                        return true;
                    }
                }
            }
            implementingType = null;
            return false;
        }
        /// <summary>
        /// <![CDATA[IList<CustomType>]]>
        /// </summary>
        /// <param name="type"></param>
        /// <returns></returns>
        public static bool IsComplexGenericList(Type type)
        {
            foreach (Type interfaceType in type.GetInterfaces())
            {
                if (interfaceType.IsGenericType && interfaceType.GetGenericTypeDefinition() == typeof(IList<>))
                {
                    Type itemType = type.GetGenericArguments()[0];
                    return !itemType.IsPrimitive();
                    //return !IsPrimitive(itemType);
                }
            }
            return false;
        }
        //public static bool IsPrimitive(Type t)
        //{
        //    // TODO: put any type here that you consider as primitive as I didn't
        //    // quite understand what your definition of primitive type is
        //    return
        //        new[]
        //            {
        //                typeof(string), typeof(char), typeof(byte), typeof(ushort), typeof(short), typeof(uint),
        //                typeof(int), typeof(ulong), typeof(long), typeof(float), typeof(double), typeof(decimal),
        //                typeof(DateTime), typeof(Guid), typeof(char?), typeof(byte?), typeof(ushort?), typeof(short?),
        //                typeof(uint?), typeof(int?), typeof(ulong?), typeof(long?), typeof(float?), typeof(double?),
        //                typeof(decimal?), typeof(DateTime?), typeof(Guid?)
        //            }.Contains(t);
        //}
        /// <summary>
        /// <![CDATA[List<primitive>]]>
        /// </summary>
        /// <param name="type"></param>
        /// <returns></returns>
        public static bool IsPrimitiveGenericList(Type type)
        {
            foreach (Type interfaceType in type.GetInterfaces())
            {
                if (interfaceType.IsGenericType && interfaceType.GetGenericTypeDefinition() == typeof(IList<>))
                {
                    Type itemType = type.GetGenericArguments()[0];
                    return itemType.IsPrimitive();
                    //return true;
                }
            }
            return false;
        }
        /// <summary>
        /// ????????????????档?????????????档??null
        /// </summary>
        /// <param name="type"></param>
        /// <param name="propertyName"></param>
        /// <returns></returns>
        private static PropertyInfo GetCachedProperty(Type type,string propertyName)
        {
            string pKey = type.FullName + "$" + propertyName;
            return propertyCache.GetOrAdd(pKey, () => type.GetProperty(propertyName));
           
        }
        /// <summary>
        /// ????????????
        /// </summary>
        /// <param name="type"></param>
        /// <returns></returns>
        public static List<PropertyInfo> GetPropertys(Type type)
        {
            string key = type.FullName;
            return typePropertyCache.GetOrAdd(key, () => type.GetProperties(BindingFlags.Instance | BindingFlags.Public).ToList());
           
        }
        public static void SetPropertyValue(object obj, object value, string propertyName)
        {
            try
            {
                Type type = obj.GetType();
                string key = type.FullName + "$" + "set" + propertyName;
                var pi = GetCachedProperty(type, propertyName);
                if (pi == null)
                    throw new ArgumentException();
                var ptype = pi.PropertyType;
                var properySetter = propertyAccessorCache.GetOrAdd(key, () => CreateSetMethod(type, propertyName));
                object o = ChangeType2(ptype, value);
                ((GenericSetter)properySetter)(obj, o);
            }
            catch (Exception ex)
            {
                string msgValue = "";
                if (value == null)
                {
                    msgValue = "";
                }
                else
                {
                    msgValue = value.ToString();
                }
                string message = ex.Message + msgValue + "   " + propertyName;
                #if DEBUG
                throw new Exception(message); 
                #endif
                #if Release
                 Logger.Log(Level.Error, string.Format("???P??????{0}.{1}",value,message));
                #endif
            }
        }
        /// <summary>
        /// ????????A.B.C????????B????????B???????C
        /// </summary>
        /// <param name="obj"></param>
        /// <param name="value"></param>
        /// <param name="propertyPath"></param>
        /// <returns>???????????????false</returns>
        public static bool SetPropertyValueByPath(object obj, object value, string propertyPath)
        {
          
            Ensure.That(obj).IsNotNull();
            Ensure.That(propertyPath).IsNotNullOrEmpty();
            string[] splitter = { "." };
            string[] sourceProperties = propertyPath.Split(splitter, StringSplitOptions.None);
            object tempSourceObj = obj;
            Type tempPropertyType = obj.GetType();
            for (int x = 0; x < sourceProperties.Length; ++x)
            {
                PropertyInfo sourcePropertyInfo = GetCachedProperty(tempPropertyType, sourceProperties[x]);
                if (sourcePropertyInfo == null)
                {
                    Logger.Log(Level.Trace, string.Format("{0}???????????{1} ????・????{2}", tempPropertyType.Name,sourceProperties[x], propertyPath));
                    return false;
                    //
                }
                else
                {
                    var subSourceObj = GetPropertyValue(tempSourceObj, sourceProperties[x]);
                    bool isPrimitive = sourcePropertyInfo.PropertyType.IsPrimitive();
                    if(isPrimitive)
                    {
                        //Primitive????????
                        SetPropertyValue(tempSourceObj, value, sourceProperties[x]);
                        return true;
                    }
                    if (subSourceObj == null)
                    {
                        if (x == sourceProperties.Length - 1)
                        {
                            //?????????
                            SetPropertyValue(tempSourceObj, value, sourceProperties[x]);
                            return true;
                        }
                        else
                        {
                            subSourceObj = CreateInstance(sourcePropertyInfo.PropertyType);
                            SetPropertyValue(tempSourceObj, subSourceObj, sourceProperties[x]);
                        }
                    }
                   
                    tempSourceObj = subSourceObj;
                }
                tempPropertyType = sourcePropertyInfo.PropertyType;
            }
            return true;
        }
        /// <summary>
        /// ???・?????????????・???????????
        /// </summary>
        /// <param name="obj"></param>
        /// <param name="propertyPath"></param>
        /// <returns></returns>
        public static object GetPropertyValueByPath(object obj, string propertyPath)
        {
            Ensure.That(obj).IsNotNull();
            Ensure.That(propertyPath).IsNotNullOrEmpty();
            string[] splitter = { "." };
            string[] sourceProperties = propertyPath.Split(splitter, StringSplitOptions.None);
            object tempSourceObj = obj;
            Type tempPropertyType = obj.GetType();
            for (int x = 0; x < sourceProperties.Length; ++x)
            {
                //if (tempSourceObj == null) return tempSourceObj;
                tempSourceObj = GetPropertyValue(tempSourceObj, sourceProperties[x]);
            }
            return tempSourceObj;
        }
        /// <summary>
        /// Gets the type of the typed collection's items.
        /// </summary>
        /// <param name="type">The type.</param>
        /// <returns>The type of the typed collection's items.</returns>
        public static bool TryGetCollectionItemType(Type type, out Type itemType)
        {
            itemType = null;
            Type genericListType;
            if (type.IsArray)
            {
                itemType = type.GetElementType();
                return true;
            }
            else if (ImplementsGenericDefinition(type, typeof(IEnumerable<>), out genericListType))
            {
                if (genericListType.IsGenericTypeDefinition)
                {
                    return false;
                }
                else
                {
                    itemType = genericListType.GetGenericArguments()[0];
                    return true;
                }
            }
            else if (typeof(IEnumerable).IsAssignableFrom(type))
            {
                itemType = null;
                throw new Exception();
            }
            else
            {
                itemType = null;
                return false;
            }
        }
        #endregion
        #region Methods
       
        ///
        /// Creates a dynamic getter for the property
        ///
        private static GenericGetter CreateGetMethod(Type type, string propertyName)
        {
            PropertyInfo propertyInfo = type.GetProperty(propertyName);
            if (propertyInfo == null)
            {
                throw new ArgumentNullException(propertyName);
            }
            /*
            * If there's no getter return null
            */
            MethodInfo getMethod = propertyInfo.GetGetMethod();
            if (getMethod == null)
            {
                return null;
            }
            /*
            * Create the dynamic method
            */
            var arguments = new Type[1];
            arguments[0] = typeof(object);
            var getter = new DynamicMethod(String.Concat("_Get", propertyInfo.Name, "_"), typeof(object), arguments);
            ILGenerator generator = getter.GetILGenerator();
            generator.DeclareLocal(typeof(object));
            generator.Emit(OpCodes.Ldarg_0);
            generator.Emit(OpCodes.Castclass, propertyInfo.DeclaringType);
            generator.EmitCall(OpCodes.Callvirt, getMethod, null);
            if (!propertyInfo.PropertyType.IsClass)
            {
                generator.Emit(OpCodes.Box, propertyInfo.PropertyType);
            }
            generator.Emit(OpCodes.Ret);
            /*
            * Create the delegate and return it
            */
            return (GenericGetter)getter.CreateDelegate(typeof(GenericGetter));
        }
        ///
        /// Creates a dynamic setter for the property
        ///???? silverlight ????
        ///
        private static GenericSetter CreateSetMethod(Type type, string propertyName)
        {
            PropertyInfo propertyInfo = type.GetProperty(propertyName);
            /*
            * If there's no setter return null
            */
            MethodInfo setMethod = propertyInfo.GetSetMethod();
            if (setMethod == null)
            {
                return null;
            }
            /*
            * Create the dynamic method
            */
            var arguments = new Type[2];
            arguments[0] = arguments[1] = typeof(object);
            
            var setter = new DynamicMethod(String.Concat("_Set", propertyInfo.Name, "_"), typeof(void), arguments);
            ILGenerator generator = setter.GetILGenerator();
            generator.Emit(OpCodes.Ldarg_0);
            generator.Emit(OpCodes.Castclass, propertyInfo.DeclaringType);
            generator.Emit(OpCodes.Ldarg_1);
            if (propertyInfo.PropertyType.IsClass)
            {
                generator.Emit(OpCodes.Castclass, propertyInfo.PropertyType);
            }
            else
            {
                generator.Emit(OpCodes.Unbox_Any, propertyInfo.PropertyType);
            }
            generator.EmitCall(OpCodes.Callvirt, setMethod, null);
            generator.Emit(OpCodes.Ret);
            /*
            * Create the delegate and return it
            */
            return (GenericSetter)setter.CreateDelegate(typeof(GenericSetter));
        }
        /// <summary>Boxes a type if needed.</summary>
        /// <param name="ilGenerator">The MSIL generator.</param>
        /// <param name="type">The type.</param>
        private static void EmitBoxIfNeeded(ILGenerator ilGenerator, Type type)
        {
            if (type.IsValueType)
            {
                ilGenerator.Emit(OpCodes.Box, type);
            }
        }
        /// <summary>Emits the cast to a reference, unboxing if needed.</summary>
        /// <param name="il">The MSIL generator.</param>
        /// <param name="type">The type to cast.</param>
        private static void EmitCastToReference(ILGenerator ilGenerator, Type type)
        {
            if (type.IsValueType)
            {
                ilGenerator.Emit(OpCodes.Unbox_Any, type);
            }
            else
            {
                ilGenerator.Emit(OpCodes.Castclass, type);
            }
        }
        /// <summary>Emits code to save an integer to the evaluation stack.</summary>
        /// <param name="ilGeneartor">The MSIL generator.</param>
        /// <param name="value">The value to push.</param>
        private static void EmitFastInt(ILGenerator ilGenerator, int value)
        {
            // for small integers, emit the proper opcode
            switch (value)
            {
                case -1:
                    ilGenerator.Emit(OpCodes.Ldc_I4_M1);
                    return;
                case 0:
                    ilGenerator.Emit(OpCodes.Ldc_I4_0);
                    return;
                case 1:
                    ilGenerator.Emit(OpCodes.Ldc_I4_1);
                    return;
                case 2:
                    ilGenerator.Emit(OpCodes.Ldc_I4_2);
                    return;
                case 3:
                    ilGenerator.Emit(OpCodes.Ldc_I4_3);
                    return;
                case 4:
                    ilGenerator.Emit(OpCodes.Ldc_I4_4);
                    return;
                case 5:
                    ilGenerator.Emit(OpCodes.Ldc_I4_5);
                    return;
                case 6:
                    ilGenerator.Emit(OpCodes.Ldc_I4_6);
                    return;
                case 7:
                    ilGenerator.Emit(OpCodes.Ldc_I4_7);
                    return;
                case 8:
                    ilGenerator.Emit(OpCodes.Ldc_I4_8);
                    return;
            }
            // for bigger values emit the short or long opcode
            if (value > -129 && value < 128)
            {
                ilGenerator.Emit(OpCodes.Ldc_I4_S, (SByte)value);
            }
            else
            {
                ilGenerator.Emit(OpCodes.Ldc_I4, value);
            }
        }
        private static FastCreateInstanceHandler GetInstanceCreator(Type type)
        {
            // generates a dynamic method to generate a FastCreateInstanceHandler delegate
            var dynamicMethod = new DynamicMethod(string.Empty, type, new Type[0]);
            ILGenerator ilGenerator = dynamicMethod.GetILGenerator();
            // generates code to create a new object of the specified type using the default constructor
            ilGenerator.Emit(OpCodes.Newobj, type.GetConstructor(Type.EmptyTypes));
            // returns the value to the caller
            ilGenerator.Emit(OpCodes.Ret);
            // converts the DynamicMethod to a FastCreateInstanceHandler delegate to create the object
            var creator = (FastCreateInstanceHandler)dynamicMethod.CreateDelegate(typeof(FastCreateInstanceHandler));
            return creator;
        }
        private static FastInvokeHandler GetMethodInvoker(Type type, string methodName)
        {
            MethodInfo methodInfo = type.GetMethod(methodName);
            // generates a dynamic method to generate a FastInvokeHandler delegate
            var dynamicMethod = new DynamicMethod(
                string.Empty, typeof(object), new[] { typeof(object), typeof(object[]) });
            ILGenerator ilGenerator = dynamicMethod.GetILGenerator();
            ParameterInfo[] parameters = methodInfo.GetParameters();
            var paramTypes = new Type[parameters.Length];
            // copies the parameter types to an array
            for (int i = 0; i < paramTypes.Length; i++)
            {
                if (parameters[i].ParameterType.IsByRef)
                {
                    paramTypes[i] = parameters[i].ParameterType.GetElementType();
                }
                else
                {
                    paramTypes[i] = parameters[i].ParameterType;
                }
            }
            var locals = new LocalBuilder[paramTypes.Length];
            // generates a local variable for each parameter
            for (int i = 0; i < paramTypes.Length; i++)
            {
                locals[i] = ilGenerator.DeclareLocal(paramTypes[i], true);
            }
            // creates code to copy the parameters to the local variables
            for (int i = 0; i < paramTypes.Length; i++)
            {
                ilGenerator.Emit(OpCodes.Ldarg_1);
                EmitFastInt(ilGenerator, i);
                ilGenerator.Emit(OpCodes.Ldelem_Ref);
                EmitCastToReference(ilGenerator, paramTypes[i]);
                ilGenerator.Emit(OpCodes.Stloc, locals[i]);
            }
            if (!methodInfo.IsStatic)
            {
                // loads the object into the stack
                ilGenerator.Emit(OpCodes.Ldarg_0);
                ilGenerator.Emit(OpCodes.Castclass, methodInfo.DeclaringType);
            }
            // loads the parameters copied to the local variables into the stack
            for (int i = 0; i < paramTypes.Length; i++)
            {
                if (parameters[i].ParameterType.IsByRef)
                {
                    ilGenerator.Emit(OpCodes.Ldloca_S, locals[i]);
                }
                else
                {
                    ilGenerator.Emit(OpCodes.Ldloc, locals[i]);
                }
            }
            // calls the method
            if (!methodInfo.IsStatic)
            {
                ilGenerator.EmitCall(OpCodes.Callvirt, methodInfo, null);
            }
            else
            {
                ilGenerator.EmitCall(OpCodes.Call, methodInfo, null);
            }
            // creates code for handling the return value
            if (methodInfo.ReturnType == typeof(void))
            {
                ilGenerator.Emit(OpCodes.Ldnull);
            }
            else
            {
                EmitBoxIfNeeded(ilGenerator, methodInfo.ReturnType);
            }
            // iterates through the parameters updating the parameters passed by ref
            for (int i = 0; i < paramTypes.Length; i++)
            {
                if (parameters[i].ParameterType.IsByRef)
                {
                    ilGenerator.Emit(OpCodes.Ldarg_1);
                    EmitFastInt(ilGenerator, i);
                    ilGenerator.Emit(OpCodes.Ldloc, locals[i]);
                    if (locals[i].LocalType.IsValueType)
                    {
                        ilGenerator.Emit(OpCodes.Box, locals[i].LocalType);
                    }
                    ilGenerator.Emit(OpCodes.Stelem_Ref);
                }
            }
            // returns the value to the caller
            ilGenerator.Emit(OpCodes.Ret);
            // converts the DynamicMethod to a FastInvokeHandler delegate to call to the method
            var invoker = (FastInvokeHandler)dynamicMethod.CreateDelegate(typeof(FastInvokeHandler));
            return invoker;
        }
        #endregion
    }
}#region copyright
// <copyright file="ReflectionHelper.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-11-20</datecreated>
#endregion
namespace Cis.Infrastructure.Reflection
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Reflection;
    /// <summary>
    /// Utility class that handles various
    /// functions dealing with reflection.
    /// </summary>
    public static class ReflectionHelper
    {
        #region Public Methods and Operators
        /// <summary>
        /// Determine if a property exists in an object
        /// </summary>
        /// <param name="propertyName">Name of the property </param>
        /// <param name="srcObject">the object to inspect</param>
        /// <returns>true if the property exists, false otherwise</returns>
        /// <exception cref="ArgumentNullException">if srcObject is null</exception>
        /// <exception cref="ArgumentException">if propertName is empty or null </exception>
        /// --------------------------------------------------------------------
        public static bool Exists(string propertyName, object srcObject)
        {
            if (srcObject == null)
            {
                throw new ArgumentNullException("srcObject");
            }
            if ((propertyName == null) || (propertyName == String.Empty) || (propertyName.Length == 0))
            {
                throw new ArgumentException("Property name cannot be empty or null.");
            }
            PropertyInfo propInfoSrcObj = srcObject.GetType().GetProperty(propertyName);
            return (propInfoSrcObj != null);
        }
        public static List<PropertyInfo> GetProperties<T>(BindingFlags bindingAttr)
        {
            return GetProperties(typeof(T), bindingAttr);
        }
        public static List<PropertyInfo> GetProperties(Type type, BindingFlags bindingAttr)
        {
            var targetMembers = new List<PropertyInfo>(type.GetProperties(bindingAttr));
            return targetMembers;
        }
        public static PropertyInfo GetProperty<Source>(string PropertyPath)
        {
            try
            {
                if (string.IsNullOrEmpty(PropertyPath))
                {
                    return null;
                }
                string[] Splitter = { "." };
                string[] SourceProperties = PropertyPath.Split(Splitter, StringSplitOptions.None);
                Type PropertyType = typeof(Source);
                PropertyInfo PropertyInfo = PropertyType.GetProperty(SourceProperties[0]);
                PropertyType = PropertyInfo.PropertyType;
                for (int x = 1; x < SourceProperties.Length; ++x)
                {
                    PropertyInfo = PropertyType.GetProperty(SourceProperties[x]);
                    PropertyType = PropertyInfo.PropertyType;
                }
                return PropertyInfo;
            }
            catch
            {
                throw;
            }
        }
        public static PropertyInfo GetProperty(Type objType, string PropertyPath)
        {
            try
            {
                if (string.IsNullOrEmpty(PropertyPath))
                {
                    return null;
                }
                string[] Splitter = { "." };
                string[] SourceProperties = PropertyPath.Split(Splitter, StringSplitOptions.None);
                PropertyInfo PropertyInfo = objType.GetProperty(SourceProperties[0]);
                objType = PropertyInfo.PropertyType;
                for (int x = 1; x < SourceProperties.Length; ++x)
                {
                    PropertyInfo = objType.GetProperty(SourceProperties[x]);
                    objType = PropertyInfo.PropertyType;
                }
                return PropertyInfo;
            }
            catch
            {
                throw;
            }
        }
        /// <summary>
        /// Gets a property's parent object
        /// </summary>
        /// <param name="SourceObject">Source object</param>
        /// <param name="PropertyPath">Path of the property (ex: Prop1.Prop2.Prop3 would be
        /// the Prop1 of the source object, which then has a Prop2 on it, which in turn
        /// has a Prop3 on it.)</param>
        /// <param name="PropertyInfo">Property info that is sent back</param>
        /// <returns>The property's parent object</returns>
        public static object GetPropertyParent(object SourceObject, string PropertyPath, out PropertyInfo PropertyInfo)
        {
            try
            {
                if (SourceObject == null)
                {
                    PropertyInfo = null;
                    return null;
                }
                string[] Splitter = { "." };
                string[] SourceProperties = PropertyPath.Split(Splitter, StringSplitOptions.None);
                object TempSourceProperty = SourceObject;
                Type PropertyType = SourceObject.GetType();
                PropertyInfo = PropertyType.GetProperty(SourceProperties[0]);
                PropertyType = PropertyInfo.PropertyType;
                for (int x = 1; x < SourceProperties.Length; ++x)
                {
                    if (TempSourceProperty != null)
                    {
                        TempSourceProperty = PropertyInfo.GetValue(TempSourceProperty, null);
                    }
                    PropertyInfo = PropertyType.GetProperty(SourceProperties[x]);
                    PropertyType = PropertyInfo.PropertyType;
                }
                return TempSourceProperty;
            }
            catch
            {
                throw;
            }
        }
        /// <summary>
        /// Gets a property's value
        /// </summary>
        /// <param name="SourceObject">object who contains the property</param>
        /// <param name="PropertyPath">Path of the property (ex: Prop1.Prop2.Prop3 would be
        /// the Prop1 of the source object, which then has a Prop2 on it, which in turn
        /// has a Prop3 on it.)</param>
        /// <returns>The value contained in the property or null if the property can not
        /// be reached</returns>
        public static object GetPropertyValue(object SourceObject, string PropertyPath)
        {
            try
            {
                if (SourceObject == null || string.IsNullOrEmpty(PropertyPath))
                {
                    return null;
                }
                string[] Splitter = { "." };
                string[] SourceProperties = PropertyPath.Split(Splitter, StringSplitOptions.None);
                object TempSourceProperty = SourceObject;
                Type PropertyType = SourceObject.GetType();
                for (int x = 0; x < SourceProperties.Length; ++x)
                {
                    PropertyInfo SourcePropertyInfo = PropertyType.GetProperty(SourceProperties[x]);
                    if (SourcePropertyInfo == null)
                    {
                        return null;
                    }
                    TempSourceProperty = SourcePropertyInfo.GetValue(TempSourceProperty, null);
                    if (TempSourceProperty == null)
                    {
                        return null;
                    }
                    PropertyType = SourcePropertyInfo.PropertyType;
                }
                return TempSourceProperty;
            }
            catch
            {
                throw;
            }
        }
        /// <summary>
        /// Checks whether <paramref name="givenType"/> implements/inherits <paramref name="genericType"/>.
        /// </summary>
        /// <param name="givenType">Type to check</param>
        /// <param name="genericType">Generic type</param>
        public static bool IsAssignableToGenericType(Type givenType, Type genericType)
        {
            var givenTypeInfo = givenType.GetTypeInfo();

            if (givenTypeInfo.IsGenericType && givenType.GetGenericTypeDefinition() == genericType)
            {
                return true;
            }

            foreach (var interfaceType in givenType.GetInterfaces())
            {
                if (interfaceType.GetTypeInfo().IsGenericType && interfaceType.GetGenericTypeDefinition() == genericType)
                {
                    return true;
                }
            }

            if (givenTypeInfo.BaseType == null)
            {
                return false;
            }

            return IsAssignableToGenericType(givenTypeInfo.BaseType, genericType);
        }

        /// <summary>
        /// Gets a list of attributes defined for a class member and it's declaring type including inherited attributes.
        /// </summary>
        /// <param name="inherit">Inherit attribute from base classes</param>
        /// <param name="memberInfo">MemberInfo</param>
        public static List<object> GetAttributesOfMemberAndDeclaringType(MemberInfo memberInfo, bool inherit = true)
        {
            var attributeList = new List<object>();

            attributeList.AddRange(memberInfo.GetCustomAttributes(inherit));

            if (memberInfo.DeclaringType != null)
            {
                attributeList.AddRange(memberInfo.DeclaringType.GetTypeInfo().GetCustomAttributes(inherit));
            }

            return attributeList;
        }

        /// <summary>
        /// Gets a list of attributes defined for a class member and type including inherited attributes.
        /// </summary>
        /// <param name="memberInfo">MemberInfo</param>
        /// <param name="type">Type</param>
        /// <param name="inherit">Inherit attribute from base classes</param>
        public static List<object> GetAttributesOfMemberAndType(MemberInfo memberInfo, Type type, bool inherit = true)
        {
            var attributeList = new List<object>();
            attributeList.AddRange(memberInfo.GetCustomAttributes(inherit));
            attributeList.AddRange(type.GetTypeInfo().GetCustomAttributes(inherit));
            return attributeList;
        }

        /// <summary>
        /// Gets a list of attributes defined for a class member and it's declaring type including inherited attributes.
        /// </summary>
        /// <typeparam name="TAttribute">Type of the attribute</typeparam>
        /// <param name="memberInfo">MemberInfo</param>
        /// <param name="inherit">Inherit attribute from base classes</param>
        public static List<TAttribute> GetAttributesOfMemberAndDeclaringType<TAttribute>(MemberInfo memberInfo, bool inherit = true)
            where TAttribute : Attribute
        {
            var attributeList = new List<TAttribute>();

            if (memberInfo.IsDefined(typeof(TAttribute), inherit))
            {
                attributeList.AddRange(memberInfo.GetCustomAttributes(typeof(TAttribute), inherit).Cast<TAttribute>());
            }

            if (memberInfo.DeclaringType != null && memberInfo.DeclaringType.GetTypeInfo().IsDefined(typeof(TAttribute), inherit))
            {
                attributeList.AddRange(memberInfo.DeclaringType.GetTypeInfo().GetCustomAttributes(typeof(TAttribute), inherit).Cast<TAttribute>());
            }

            return attributeList;
        }

        /// <summary>
        /// Gets a list of attributes defined for a class member and type including inherited attributes.
        /// </summary>
        /// <typeparam name="TAttribute">Type of the attribute</typeparam>
        /// <param name="memberInfo">MemberInfo</param>
        /// <param name="type">Type</param>
        /// <param name="inherit">Inherit attribute from base classes</param>
        public static List<TAttribute> GetAttributesOfMemberAndType<TAttribute>(MemberInfo memberInfo, Type type, bool inherit = true)
            where TAttribute : Attribute
        {
            var attributeList = new List<TAttribute>();

            if (memberInfo.IsDefined(typeof(TAttribute), inherit))
            {
                attributeList.AddRange(memberInfo.GetCustomAttributes(typeof(TAttribute), inherit).Cast<TAttribute>());
            }

            if (type.GetTypeInfo().IsDefined(typeof(TAttribute), inherit))
            {
                attributeList.AddRange(type.GetTypeInfo().GetCustomAttributes(typeof(TAttribute), inherit).Cast<TAttribute>());
            }

            return attributeList;
        }

        /// <summary>
        /// Tries to gets an of attribute defined for a class member and it's declaring type including inherited attributes.
        /// Returns default value if it's not declared at all.
        /// </summary>
        /// <typeparam name="TAttribute">Type of the attribute</typeparam>
        /// <param name="memberInfo">MemberInfo</param>
        /// <param name="defaultValue">Default value (null as default)</param>
        /// <param name="inherit">Inherit attribute from base classes</param>
        public static TAttribute GetSingleAttributeOfMemberOrDeclaringTypeOrDefault<TAttribute>(MemberInfo memberInfo, TAttribute defaultValue = default(TAttribute), bool inherit = true)
            where TAttribute : class
        {
            return memberInfo.GetCustomAttributes(true).OfType<TAttribute>().FirstOrDefault()
                   ?? memberInfo.ReflectedType?.GetTypeInfo().GetCustomAttributes(true).OfType<TAttribute>().FirstOrDefault()
                   ?? defaultValue;
        }

        /// <summary>
        /// Tries to gets an of attribute defined for a class member and it's declaring type including inherited attributes.
        /// Returns default value if it's not declared at all.
        /// </summary>
        /// <typeparam name="TAttribute">Type of the attribute</typeparam>
        /// <param name="memberInfo">MemberInfo</param>
        /// <param name="defaultValue">Default value (null as default)</param>
        /// <param name="inherit">Inherit attribute from base classes</param>
        public static TAttribute GetSingleAttributeOrDefault<TAttribute>(MemberInfo memberInfo, TAttribute defaultValue = default(TAttribute), bool inherit = true)
            where TAttribute : Attribute
        {
            //Get attribute on the member
            if (memberInfo.IsDefined(typeof(TAttribute), inherit))
            {
                return memberInfo.GetCustomAttributes(typeof(TAttribute), inherit).Cast<TAttribute>().First();
            }

            return defaultValue;
        }

        /// <summary>
        /// Gets a property by it's full path from given object
        /// </summary>
        /// <param name="obj">Object to get value from</param>
        /// <param name="objectType">Type of given object</param>
        /// <param name="propertyPath">Full path of property</param>
        /// <returns></returns>
        internal static object GetPropertyByPath(object obj, Type objectType, string propertyPath)
        {
            var property = obj;
            var currentType = objectType;
            var objectPath = currentType.FullName;
            var absolutePropertyPath = propertyPath;
            if (absolutePropertyPath.StartsWith(objectPath))
            {
                absolutePropertyPath = absolutePropertyPath.Replace(objectPath + ".", "");
            }

            foreach (var propertyName in absolutePropertyPath.Split('.'))
            {
                property = currentType.GetProperty(propertyName);
                currentType = ((PropertyInfo)property).PropertyType;
            }

            return property;
        }

        /// <summary>
        /// Gets value of a property by it's full path from given object
        /// </summary>
        /// <param name="obj">Object to get value from</param>
        /// <param name="objectType">Type of given object</param>
        /// <param name="propertyPath">Full path of property</param>
        /// <returns></returns>
        internal static object GetValueByPath(object obj, Type objectType, string propertyPath)
        {
            var value = obj;
            var currentType = objectType;
            var objectPath = currentType.FullName;
            var absolutePropertyPath = propertyPath;
            if (absolutePropertyPath.StartsWith(objectPath))
            {
                absolutePropertyPath = absolutePropertyPath.Replace(objectPath + ".", "");
            }

            foreach (var propertyName in absolutePropertyPath.Split('.'))
            {
                var property = currentType.GetProperty(propertyName);
                value = property.GetValue(value, null);
                currentType = property.PropertyType;
            }

            return value;
        }
        /// <summary>
        /// Sets value of a property by it's full path on given object
        /// </summary>
        /// <param name="obj"></param>
        /// <param name="objectType"></param>
        /// <param name="propertyPath"></param>
        /// <param name="value"></param>
        internal static void SetValueByPath(object obj, Type objectType, string propertyPath, object value)
        {
            var currentType = objectType;
            PropertyInfo property;
            var objectPath = currentType.FullName;
            var absolutePropertyPath = propertyPath;
            if (absolutePropertyPath.StartsWith(objectPath))
            {
                absolutePropertyPath = absolutePropertyPath.Replace(objectPath + ".", "");
            }

            var properties = absolutePropertyPath.Split('.');

            if (properties.Length == 1)
            {
                property = objectType.GetProperty(properties.First());
                property.SetValue(obj, value);
                return;
            }

            for (int i = 0; i < properties.Length - 1; i++)
            {
                property = currentType.GetProperty(properties[i]);
                obj = property.GetValue(obj, null);
                currentType = property.PropertyType;
            }

            property = currentType.GetProperty(properties.Last());
            property.SetValue(obj, value);
        }
        #endregion
    }
}#region copyright
// <copyright file="LocalFsManager"  company="CIS"> 
// Copyright (c) CIS. All Right Reserved
// </copyright>
// <author>hankk</author>
// <datecreated>2018/4/20 16:01:44</datecreated>
#endregion
using Abp.Dependency;
using Cis.Fm.Abp.FileSystem;
using Cis.Infrastucture.FileSystem;
using System;
using System.Collections.Generic;
using System.Text;
namespace Cis.LocalFs
{
    public class CisLocalFsManager : FsManagerBase
    {
        public CisLocalFsManager(IIocManager iocManager, IFsConfiguration configuration):
            base(iocManager, configuration)
        {
        }
        public override bool Upload()
        {
            throw new NotImplementedException();
        }
    }
}
#region copyright
// <copyright file="CisLocalFsModule"  company="CIS"> 
// Copyright (c) CIS. All Right Reserved
// </copyright>
// <author>hankk</author>
// <datecreated>2018/4/20 16:36:07</datecreated>
#endregion
using Abp;
using Abp.Modules;
using Abp.Reflection.Extensions;
using System;
using System.Collections.Generic;
using System.Text;
namespace Cis.LocalFs
{
    /// <summary>
    /// This modules is used to replace Cis's file system with Local File server.
    /// </summary>
    [DependsOn(typeof(AbpKernelModule))]
    public class CisLocalFsModule:AbpModule
    {
        public override void PreInitialize()
        {
            IocManager.Register<CisLocalFsOption>();
        }

        public override void Initialize()
        {
            IocManager.RegisterAssemblyByConvention(typeof(CisLocalFsModule).GetAssembly());
        }
    }
}
#region copyright
// <copyright file="LocalFsOption"  company="CIS"> 
// Copyright (c) CIS. All Right Reserved
// </copyright>
// <author>hankk</author>
// <datecreated>2018/4/20 15:21:48</datecreated>
#endregion
using System;
using System.Collections.Generic;
using System.Text;
namespace Cis.LocalFs
{
    public class CisLocalFsOption
    {
    }
}

using Abp.Dependency;
using Cis.Fm.Abp.FileSystem;
using Cis.Infrastucture.FileSystem;
using System;
namespace Cis.LocalFs
{
    public static class LocalFsConfigurationExtension
    {
        /// <summary>
        /// Configures File System to use Local Folder as File server.
        /// </summary>
        /// <param name="cachingConfiguration">The caching configuration.</param>
        public static void UseLocalFs(this IFsConfiguration fsConfiguratoin)
        {
            fsConfiguratoin.UseLocalFs(options => { });
        }
        /// <summary>
        /// Configures File System to use Local Folder as File server.
        /// </summary>
        /// <param name="cachingConfiguration">The caching configuration.</param>
        public static void UseLocalFs(this IFsConfiguration fsConfiguratoin, Action<CisLocalFsOption> optionsAction)
        {
            var iocManager = fsConfiguratoin.AbpConfiguration.IocManager;

            iocManager.RegisterIfNot<IFsManager, CisLocalFsManager>();

            optionsAction(iocManager.Resolve<CisLocalFsOption>());
        }
    }
}
using System;
namespace Cis.Log
{
    public class Class1
    {
    }
}
#region copyright
// <copyright file="Logger.cs" company="ehong"> 
// Copyright (c) ehong. All Right Reserved
// </copyright>
// <author>丁浩</author>
// <datecreated>2012-11-07</datecreated>
#endregion
namespace Cis.Log
{
    using System;
    using NLog;
    using NLog.Config;
    using NLog.Targets;
    public enum Level
    {
        Trace,
        Debug,
        Info,
        Warn,
        Error,
        Fatal
    }
    public static class Logger
    {
        #region Static Fields
        private static NLog.Logger Nlogger = null;
        #endregion
        /// <summary>
        /// 配置Nlog读取配置文件
        /// </summary>
        /// <param name="logsPath"></param>
        public static void LoggergConfiguration(string logsPath)
        {
            #region Step 1.Create configuration object
            var config = new LoggingConfiguration();
            #endregion
            #region Step 2. Create targets and add them to the configuration 
            var outPutTarget = new DebuggerTarget()
            {
                Name = "Debugger",
                Layout = "${longdate} ${level:uppercase=false} ${message}"
            };
            config.AddTarget(outPutTarget);
            var fileErrorTarget = new FileTarget()
            {
                ArchiveAboveSize = 10240,
                Name = "FileError",
                Layout = "${longdate} ${level:uppercase=false} ${message}",
                FileName = logsPath + "/${shortdate}/${shortdate}_error.log"
            };
            config.AddTarget(fileErrorTarget);
            #endregion
            #region Step 4. Define rules
            config.LoggingRules.Add(new LoggingRule("*", LogLevel.Trace, outPutTarget));
            config.LoggingRules.Add(new LoggingRule("*", LogLevel.Error, fileErrorTarget));
            #endregion
            #region  Step 5. Activate the configuration
            LogManager.Configuration = config;
            config.Reload();
            #endregion
            Nlogger = LogManager.GetCurrentClassLogger();
        }
        /// <summary>
        /// 修改nlog配置文件
        /// </summary>
        /// <param name="fileName"></param>
        public static void UpdateLoggergConfiguration(string logsPath, bool logFullMode)
        {
            // 获取Nlog配置文件
            var config = LogManager.Configuration;
            // 添加Debug日志级别记录Target
            if (logFullMode)
            {
                #region 添加target
                var debugFileTarget = new FileTarget()
                {
                    ArchiveAboveSize = 1024 * 1024 * 5,
                    Name = "FileDebug",
                    Layout = "${longdate} ${level:uppercase=false} ${message}",
                    FileName = logsPath + "/${shortdate}/${shortdate}.log"
                };
                config.AddTarget(debugFileTarget);
                config.LoggingRules.Add(new LoggingRule("*", LogLevel.Debug, debugFileTarget));
                #endregion
            }
            else
            {
                #region 如果存在，就移除
                if (config.FindTargetByName("FileDebug") != null)
                {
                    //先移除Target, 再移除Rule
                    config.RemoveTarget("FileDebug");
                    config.LoggingRules.RemoveAt(2);
                }
                #endregion
            }
            #region 激活新的配置文件
            LogManager.Configuration = config;
            LogManager.Configuration.Reload();
            #endregion
        }
        #region 通过静态构造函数，配置Nlog
        //static Logger()
        //{
        ////Step 1.Create configuration object
        //var config = new LoggingConfiguration();
        //// Step 2. Create targets and add them to the configuration 
        //var consoleTarget = new DebuggerTarget();
        //config.AddTarget("console", consoleTarget);
        //var fileTarget = new FileTarget();
        //config.AddTarget("file", fileTarget);
        //var fileErrorTarget = new FileTarget();
        //config.AddTarget("file", fileErrorTarget);
        //// Step 3. Set target properties 
        //consoleTarget.Layout = @"${longdate} ${level:uppercase=false} ${message}";
        ////配置日常日志文件路径及格式
        ////fileTarget.FileName = "${basedir}/logs/${shortdate}/${shortdate}.log";
        //fileTarget.FileName = "c:/logs/${shortdate}/${shortdate}.log";
        //fileTarget.Layout = "${longdate} ${level:uppercase=false} ${message}";
        ////配置错误日志文件路径及格式
        //fileErrorTarget.FileName = "${basedir}/logs/${shortdate}/${shortdate}_error.log";
        //fileErrorTarget.Layout = "${longdate} ${level:uppercase=false} ${message}";
        //// Step 4. Define rules
        //config.LoggingRules.Add(new LoggingRule("*", LogLevel.Trace, consoleTarget));
        //////是否开启全量模式
        //config.LoggingRules.Add(new LoggingRule("*", LogLevel.Debug, fileTarget));
        //config.LoggingRules.Add(new LoggingRule("*", LogLevel.Error, fileErrorTarget));
        //// Step 5. Activate the configuration
        //LogManager.Configuration = config;
        //}
        #endregion
        #region Public Methods and Operators
        /// <summary>
        /// 当messageCallback 结果不为 null时记录日志
        /// </summary>
        /// <param name="level"></param>
        /// <param name="messageCallback"></param>
        public static void Log(Level level, Func<string> messageCallback)
        {
            var message = messageCallback();
            if (message != null)
                Log(level, message);
        }
        /// <summary>
        /// 记录所有异常信息，包括inneerexcepiton
        /// </summary>
        /// <param name="ex"></param>
        public static void LogException(Exception ex)
        {
            Nlogger.Log(LogLevel.Error, ex.ToString);
        }
        public static void Log(Level level, string message)
        {
            if (Nlogger == null)
            {
                return;
            }
            LogLevel l;
            switch (level)
            {
                case Level.Trace:
                    l = LogLevel.Trace;
                    break;
                case Level.Debug:
                    l = LogLevel.Debug;
                    break;
                case Level.Info:
                    l = LogLevel.Info;
                    break;
                case Level.Warn:
                    l = LogLevel.Warn;
                    break;
                case Level.Error:
                    l = LogLevel.Error;
                    break;
                case Level.Fatal:
                    l = LogLevel.Fatal;
                    break;
                default:
                    l = LogLevel.Trace;
                    break;
            }
            Nlogger.Log(l, message);
        }
        #endregion
    }
}using System;
namespace Cis.ModelMapper
{
    public class Class1
    {
    }
}
#region copyright
// <copyright file="NotSupportExpressionException.cs" company="cis"> 
// Copyright (c) cis. All Right Reserved
// </copyright>
// <author>孙强</author>
// <datecreated>2018-04-20</datecreated>
#endregion
namespace Cis.ModelMapper
{
    using System;
    public class ColAttribute : Attribute
    {
        public string Name { get; set; }
    }
}
#region copyright
// <copyright file="NotSupportExpressionException.cs" company="cis"> 
// Copyright (c) cis. All Right Reserved
// </copyright>
// <author>孙强</author>
// <datecreated>2018-04-20</datecreated>
#endregion
namespace Cis.ModelMapper
{
    using System.Collections.Generic;
    using System.Data;
    /// <summary>
    /// 数据源转为Model 作者:苗建龙
    /// </summary>
    public class DeserializeObject
    {
        /// <summary>
        /// DataRow to Model
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="row"></param>
        /// <returns></returns>
        public static T CreateItem<T>(DataRow row) where T : class
        {
            return GetAccessor<T>().GetModel(row, GetColumns(row.Table.Columns));
        }
        /// <summary>
        /// DataRow to Model
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="row"></param>
        /// <param name="columns"></param>
        /// <returns></returns>
        public static T CreateItem<T>(DataRow row, IList<string> columns) where T : class
        {
            return GetAccessor<T>().GetModel(row, columns);
        }
        /// <summary>
        /// IDataRecord to Model
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="row"></param>
        /// <returns></returns>
        public static T CreateItem<T>(IDataRecord dr) where T : class
        {
            return GetAccessor<T>().GetModel(dr, GetColumns(dr));
        }
        /// <summary>
        /// IDataRecord to Model
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="dr"></param>
        /// <param name="columns"></param>
        /// <returns></returns>
        public static T CreateItem<T>(IDataRecord dr, IList<string> columns) where T : class
        {
            return GetAccessor<T>().GetModel(dr, columns);
        }
        /// <summary>
        /// IDataRecord to Model
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="row"></param>
        /// <returns></returns>
        public static T CreateItem<T>(IDictionary<string, object> dic) where T : class
        {
            return GetAccessor<T>().GetModel(dic);
        }
        /// <summary>
        /// 列明忽略大小写 保持效率
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="table"></param>
        /// <returns></returns>
        public static IList<T> CreateList<T>(DataTable table) where T : class
        {
            List<string> cols = GetColumns(table.Columns);
            IList<T> list = new List<T>();
            foreach (DataRow row in table.Rows)
            {
                list.Add(CreateItem<T>(row, cols));
            }
            return list;
        }
        private static DynamicAccessor<T> GetAccessor<T>() where T : class
        {
            int key = typeof(T).FullName.GetHashCode();
            if (Dic.ContainsKey(key))
            {
                return Dic[key] as DynamicAccessor<T>;
            }
            var accessor = new DynamicAccessor<T>();
            Dic.Add(key, accessor);
            return accessor;
        }
        private static Dictionary<int, object> Dic { get; set; } = new Dictionary<int, object>();
        /// <summary>
        /// DataColumnCollection 转List<string> 忽略大小写
        /// </summary>
        /// <param name="cols"></param>
        /// <returns></returns>
        private static List<string> GetColumns(DataColumnCollection cols)
        {
            List<string> columnNames = new List<string>();
            for (int i = 0; i < cols.Count; i++)
            {
                //.ToUpper()可忽略大小写转换
                columnNames.Add(cols[i].ColumnName.ToUpper());
            }
            return columnNames;
        }
        /// <summary>
        /// 
        /// </summary>
        /// <param name="record"></param>
        /// <returns></returns>
        private static List<string> GetColumns(IDataRecord record)
        {
            List<string> columnNames = new List<string>();
            for (int i = 0; i < record.FieldCount; i++)
            {
                //.ToUpper()可忽略大小写转换
                columnNames.Add(record.GetName(i).ToUpper());
            }
            return columnNames;
        }
    }
}
#region copyright
// <copyright file="NotSupportExpressionException.cs" company="cis"> 
// Copyright (c) cis. All Right Reserved
// </copyright>
// <author>孙强</author>
// <datecreated>2018-04-20</datecreated>
#endregion
namespace Cis.ModelMapper
{
    using System;
    using System.Collections.Generic;
    using System.ComponentModel;
    using System.Data;
    using System.Linq;
    using System.Linq.Expressions;
    using System.Reflection;
    /// <summary>
    /// Model动态对象
    /// 动态编译相关功能
    /// </summary>
    /// <typeparam name="TResult"></typeparam>
    public class DynamicAccessor<TResult>
    {
        private Type _type;
        private Action<object, string, object> _setValueDelegate;
        private Func<object, string, object> _getValueDelegate;
        private Func<IDataRecord, IList<string>, TResult> _getModelByIDataRecordDelegate;
        private Func<DataRow, IList<string>, TResult> _getModelByDataRowDelegate;
        private Func<IDictionary<string, object>, TResult> _getModelByIDictionaryDelegate;
        /// <summary>
        /// 属性-名称 映射列表
        /// </summary>
        private Dictionary<string, string> ProList { get; set; }
        /// <summary>
        /// 实例化
        /// </summary>
        public DynamicAccessor()
        {
            _type = typeof(TResult);
            ProList = GetProList();
            _getValueDelegate = GenerateGetValue();
            _setValueDelegate = GenerateSetValue();
            _getModelByDataRowDelegate = GenerateGetModelByDataRow();
            _getModelByIDataRecordDelegate = GenerateGetModelByIDataRecord();
            _getModelByIDictionaryDelegate = GenerateGetModelByIDictionary();
        }
        /// <summary>
        /// 属性-Column 映射列表
        /// </summary>
        //public Dictionary<string, ColumnAttribute> ColumnProMap { get; set; }
        /// <summary>
        /// 获取指定对象的指定属性的值
        /// </summary>
        /// <param name="instance">要获取属性值的对象</param>
        /// <param name="memberName">要获取的属性的名称</param>
        /// <returns></returns>
        public object GetValue(object instance, string memberName)
        {
            return _getValueDelegate(instance, ProList[memberName.ToLower()]);
        }
        /// <summary>
        /// 为指定对象的指定属性设置值。
        /// </summary>
        /// <param name="instance">要设置属性的对象</param>
        /// <param name="memberName">要设置的属性名</param>
        /// <param name="newValue">要设置的值</param>
        public void SetValue(object instance, string memberName, object newValue)
        {
            _setValueDelegate(instance, ProList[memberName.ToLower()], newValue == DBNull.Value ? null : newValue);
        }
        /// <summary>
        /// 根据IDataRecord GetModel
        /// </summary>
        /// <param name="dr"></param>
        /// <returns></returns>
        public TResult GetModel(IDataRecord dr, IList<string> columns)
        {
            return _getModelByIDataRecordDelegate(dr, columns);
        }
        /// <summary>
        /// 根据DataRow  GetModel
        /// </summary>
        /// <param name="dr"></param>
        /// <returns></returns>
        public TResult GetModel(DataRow dr, IList<string> columns)
        {
            return _getModelByDataRowDelegate(dr, columns);
        }
        /// <summary>
        /// IDictionary GetModel
        /// </summary>
        /// <param name="dic"></param>
        /// <returns></returns>
        public TResult GetModel(IDictionary<string, object> dic)
        {
            return _getModelByIDictionaryDelegate(dic);
        }
        /// <summary>
        /// 设置属性小写对应列表 用于做映射
        /// 属性名和数据列名不一定要一致  列名保证全部大写 否则会影响性能
        /// </summary>
        /// <returns></returns>
        private Dictionary<string, string> GetProList()
        {
            Dictionary<string, string> rel = new Dictionary<string, string>();
            foreach (var propertyInfo in _type.GetProperties())
            {
                var colAtt = propertyInfo.GetCustomAttributes(true).OfType<ColAttribute>().FirstOrDefault();
                if (colAtt != null)
                {
                    rel.Add(propertyInfo.Name.ToLower(), colAtt.Name);
                }
                else
                {
                    rel.Add(propertyInfo.Name.ToLower(), propertyInfo.Name);
                }
            }
            return rel;
        }
        /// <summary>
        /// 构建读取值函数
        /// </summary>
        /// <returns></returns>
        private Func<object, string, object> GenerateGetValue()
        {
            var instance = Expression.Parameter(typeof(object), "instance");
            var memberName = Expression.Parameter(typeof(string), "memberName");
            var nameHash = Expression.Variable(typeof(int), "nameHash");
            var calHash = Expression.Assign(nameHash, Expression.Call(memberName, typeof(object).GetMethod("GetHashCode")));
            var cases = new List<SwitchCase>();
            foreach (var propertyInfo in _type.GetProperties())
            {
                if (propertyInfo.CanRead)
                {
                    var property = Expression.Property(Expression.Convert(instance, _type), propertyInfo.Name);
                    var propertyHash = Expression.Constant(propertyInfo.Name.GetHashCode(), typeof(int));
                    cases.Add(Expression.SwitchCase(Expression.Convert(property, typeof(object)), propertyHash));
                }
            }
            var switchEx = Expression.Switch(nameHash, Expression.Constant(null), cases.ToArray());
            var methodBody = Expression.Block(typeof(object), new[] { nameHash }, calHash, switchEx);
            return Expression.Lambda<Func<object, string, object>>(methodBody, instance, memberName).Compile();
        }
        /// <summary>
        /// 构建设置属性值函数
        /// </summary>
        /// <returns></returns/
        private Action<object, string, object> GenerateSetValue()
        {
            var instance = Expression.Parameter(typeof(object), "instance");
            var memberName = Expression.Parameter(typeof(string), "memberName");
            var newValue = Expression.Parameter(typeof(object), "newValue");
            var nameHash = Expression.Variable(typeof(int), "nameHash");
            var calHash = Expression.Assign(nameHash, Expression.Call(memberName, typeof(object).GetMethod("GetHashCode")));
            var cases = new List<SwitchCase>();
            foreach (var propertyInfo in _type.GetProperties())
            {
                // 属性必须可写
                //if (!(propertyInfo.CanWrite && IsSimpleType(propertyInfo.PropertyType)))
                if (!propertyInfo.CanWrite)
                {
                    continue;
                }
                var property = Expression.Property(Expression.Convert(instance, _type), propertyInfo.Name);
                var setValue = Expression.Assign(property, Expression.Convert(newValue, propertyInfo.PropertyType));
                var propertyHash = Expression.Constant(propertyInfo.Name.GetHashCode(), typeof(int));
                cases.Add(Expression.SwitchCase(Expression.Convert(setValue, typeof(object)), propertyHash));
            }
            var switchEx = Expression.Switch(nameHash, Expression.Constant(null), cases.ToArray());
            var methodBody = Expression.Block(new[] { nameHash }, calHash, switchEx);
            return Expression.Lambda<Action<object, string, object>>(methodBody, instance, memberName, newValue).Compile();
        }
        /// <summary>
        /// 获得属性的赋值表达式
        /// </summary>
        /// <param name="instance"></param>
        /// <param name="pro"></param>
        /// <param name="value"></param>
        /// <returns></returns>
        private Expression GetSetValueExpression(Expression instance, PropertyInfo pro, Expression getValue)
        {
            bool isNullable = IsNullableType(pro.PropertyType);
            string convertFn = GetConvertFn(pro.PropertyType);
            var tempGetValue = getValue;
            if (pro.PropertyType.IsEnum)
            {
                //枚举特殊处理
                tempGetValue = Expression.Call
                (
                    typeof(Convert).GetMethod("ChangeType", new Type[] { typeof(object), typeof(Type) }),
                    getValue,
                    Expression.Constant(pro.PropertyType.GetEnumUnderlyingType())
                );
            }
            Expression convertValue;
            if (string.IsNullOrEmpty(convertFn))
            {
                convertValue = Expression.Convert(tempGetValue, pro.PropertyType);
            }
            else
            {
                //强制转换
                Type convertsionType = null;
                if (isNullable)
                {
                    convertsionType = new NullableConverter(pro.PropertyType).UnderlyingType;
                    convertValue = Expression.Convert
                    (
                        Expression.Call
                        (
                            typeof(Convert).GetMethod("ChangeType", new Type[] { typeof(object), typeof(Type) }),
                            tempGetValue,
                            Expression.Constant(convertsionType)
                        ),
                        pro.PropertyType
                    );
                }
                else
                {
                    convertsionType = pro.PropertyType;
                    convertValue = Expression.Call
                    (
                        typeof(Convert).GetMethod(convertFn, new Type[] { typeof(object) }),
                        tempGetValue
                    );
                }
            }
            Expression nullAbleExpression;
            if (isNullable)
            {
                nullAbleExpression = Expression.Assign(Expression.Property(instance, pro.Name), Expression.Convert(Expression.Constant(null), pro.PropertyType));
            }
            else
            {
#if DEBUG
                nullAbleExpression = Expression.Assign(Expression.Property(instance, pro.Name), Expression.Convert(Expression.Constant(null), pro.PropertyType));
#else
                nullAbleExpression = Expression.Empty();
#endif
            }
            Expression setValue = Expression.IfThenElse
            (
                Expression.Equal(getValue, Expression.Constant(DBNull.Value)),
                nullAbleExpression,
                Expression.Assign(Expression.Property(instance, pro.Name), convertValue)
            );
            return setValue;
        }
        /// <summary>
        /// DataRow转model 忽略大小写 保持效率
        /// </summary>
        /// <returns></returns>
        private Func<DataRow, IList<string>, TResult> GenerateGetModelByDataRow()
        {
            var variable = new List<ParameterExpression>();
            var expres = new List<Expression>();
            var read = Expression.Parameter(typeof(DataRow), "read");
            var columnNames = Expression.Parameter(typeof(IList<string>), "columnNames");
            var instance = Expression.Variable(_type, "instance");
            var index = Expression.Variable(typeof(int), "index");
            variable.Add(instance);
            variable.Add(index);
            expres.Add(Expression.Assign(instance, Expression.New(_type)));
            PropertyInfo indexerInfo = typeof(DataRow).GetProperty("Item", new[] { typeof(int) });
            foreach (var propertyInfo in _type.GetProperties())
            {
                if (!(propertyInfo.CanWrite && IsSimpleType(propertyInfo.PropertyType)))
                {
                    continue;
                }
                //数据库返回列全部大小 忽略大小写赋值
                string colName = ProList[propertyInfo.Name.ToLower()].ToUpper();
                var callIndex = Expression.Call(columnNames, typeof(IList<string>).GetMethod("IndexOf"), Expression.Constant(colName));
                var assIndex = Expression.Assign(index, callIndex);
                expres.Add(assIndex);
                var getItem = Expression.MakeIndex
                (
                    read,
                    indexerInfo,
                    new[] { index }
                );
                var setValue = GetSetValueExpression(instance, propertyInfo, getItem);
                var ifAssign = Expression.IfThen
                (
                    Expression.NotEqual(index, Expression.Constant(-1)),
                    setValue
                );
                expres.Add(ifAssign);
            }
            LabelTarget returnTarget = Expression.Label(_type);
            expres.Add(Expression.Return(returnTarget, instance, _type));
            expres.Add(Expression.Label(returnTarget, instance));
            var methodBody = Expression.Block(_type, variable, expres);
            return Expression.Lambda<Func<DataRow, IList<string>, TResult>>(methodBody, read, columnNames).Compile();
        }
        /// <summary>
        /// IDataRecord转model 忽略大小写 保持效率
        /// </summary>
        /// <returns></returns>
        private Func<IDataRecord, IList<string>, TResult> GenerateGetModelByIDataRecord()
        {
            //内部快变量
            var variable = new List<ParameterExpression>();
            //表达式
            var expres = new List<Expression>();
            var dr = Expression.Parameter(typeof(IDataRecord), "dr");
            var columnNames = Expression.Parameter(typeof(IList<string>), "columnNames");
            var instance = Expression.Variable(_type, "instance");
            var index = Expression.Variable(typeof(int), "index");
            variable.Add(instance);
            variable.Add(index);
            //使用默认构造函数创建一个对象 var model = new Model();
            expres.Add(Expression.Assign(instance, Expression.New(_type)));
            foreach (var propertyInfo in _type.GetProperties())
            {
                if (!(propertyInfo.CanWrite && IsSimpleType(propertyInfo.PropertyType)))
                {
                    continue;
                }
                //数据库返回列全部大小 忽略大小写赋值
                string colName = ProList[propertyInfo.Name.ToLower()].ToUpper();
                //给临时变量index赋值
                var callIndex = Expression.Call(columnNames, typeof(IList<string>).GetMethod("IndexOf"), Expression.Constant(colName));
                var assIndex = Expression.Assign(index, callIndex);
                expres.Add(assIndex);
                var getItem = Expression.Call(dr, typeof(IDataRecord).GetMethod("GetValue"), index);
                var setValue = GetSetValueExpression(instance, propertyInfo, getItem);
                var blok = Expression.IfThen
                (
                    Expression.NotEqual(index, Expression.Constant(-1)),
                    setValue
                );
                expres.Add(blok);
            }
            LabelTarget returnTarget = Expression.Label(_type);
            expres.Add(Expression.Return(returnTarget, instance, _type));
            expres.Add(Expression.Label(returnTarget, instance));
            var methodBody = Expression.Block(_type, variable, expres);
            return Expression.Lambda<Func<IDataRecord, IList<string>, TResult>>(methodBody, dr, columnNames).Compile();
        }
        /// <summary>
        /// IDataRecord转model 忽略大小写 保持效率
        /// </summary>
        /// <returns></returns>
        private Func<IDictionary<string, object>, TResult> GenerateGetModelByIDictionary()
        {
            //内部快变量
            var variable = new List<ParameterExpression>();
            //表达式
            var expres = new List<Expression>();
            var dic = Expression.Parameter(typeof(IDictionary<string, object>), "dic");
            var key = Expression.Variable(typeof(string), "key");
            var instance = Expression.Variable(_type, "instance");
            variable.Add(instance);
            variable.Add(key);
            //使用默认构造函数创建一个对象 var model = new Model();
            expres.Add(Expression.Assign(instance, Expression.New(_type)));
            PropertyInfo indexerInfo = typeof(IDictionary<string, object>).GetProperty("Item", new[] { typeof(string) });
            foreach (var propertyInfo in _type.GetProperties())
            {
                if (!(propertyInfo.CanWrite && IsSimpleType(propertyInfo.PropertyType)))
                {
                    continue;
                }
                //数据库返回列全部大小 忽略大小写赋值
                string colName = ProList[propertyInfo.Name.ToLower()];
                var assIndex = Expression.Assign(key, Expression.Constant(colName));
                expres.Add(assIndex);
                var getItem = Expression.MakeIndex
                (
                    dic,
                    indexerInfo,
                    new[] { key }
                );
                var containsKey = Expression.Call(dic, typeof(IDictionary<string, object>).GetMethod("ContainsKey"), Expression.Constant(colName));
                Expression setValue = Expression.IfThen
                (
                    containsKey,
                    Expression.Assign(Expression.Property(instance, propertyInfo.Name), Expression.Convert(getItem, propertyInfo.PropertyType))
                );
                expres.Add(setValue);
            }
            LabelTarget returnTarget = Expression.Label(_type);
            expres.Add(Expression.Return(returnTarget, instance, _type));
            expres.Add(Expression.Label(returnTarget, instance));
            var methodBody = Expression.Block(_type, variable, expres);
            return Expression.Lambda<Func<IDictionary<string, object>, TResult>>(methodBody, dic).Compile();
        }
        /// <summary>
        /// 类型是否支持转换
        /// </summary>
        /// <param name="tempType"></param>
        /// <returns></returns>
        static bool IsSimpleType(Type tempType)
        {
            return (
                        tempType.Equals(typeof(Int16))
                        || tempType.Equals(typeof(int))
                        || tempType.Equals(typeof(Int64))
                        || tempType.Equals(typeof(string))
                        || tempType.Equals(typeof(decimal))
                        || tempType.Equals(typeof(double))
                        || tempType.Equals(typeof(DateTime))
                        || tempType.Equals(typeof(float))
                        || tempType.Equals(typeof(DateTimeOffset))
                        || tempType.Equals(typeof(char))
                        || tempType.Equals(typeof(long))
                        || tempType.Equals(typeof(bool))
                        || tempType.Equals(typeof(Int16?))
                        || tempType.Equals(typeof(int?))
                        || tempType.Equals(typeof(Int64?))
                        || tempType.Equals(typeof(decimal?))
                        || tempType.Equals(typeof(double?))
                        || tempType.Equals(typeof(DateTime?))
                        || tempType.Equals(typeof(float?))
                        || tempType.Equals(typeof(DateTimeOffset?))
                        || tempType.Equals(typeof(char?))
                        || tempType.Equals(typeof(long?))
                        || tempType.Equals(typeof(bool?))
                        || tempType.IsEnum
                   //|| IsTopModelType(tempType)
                   );
        }
        /// <summary>
        /// 判断类型是否为可空类型
        /// </summary>
        /// <param name="theType"></param>
        /// <returns></returns>
        static bool IsNullableType(Type theType)
        {
            return (theType.IsGenericType && theType.
              GetGenericTypeDefinition().Equals
              (typeof(Nullable<>)));
        }
        /// <summary>
        /// 需要强转的类型
        /// </summary>
        /// <param name="theType"></param>
        /// <returns></returns>
        static string GetConvertFn(Type theType)
        {
            string convertTo = null;
            string typeFullName = theType.FullName;
            if (IsNullableType(theType))
            {
                typeFullName = theType.GenericTypeArguments[0].FullName;
            }
            switch (typeFullName)
            {
                case "System.Int16":
                    convertTo = "ToInt16";
                    break;
                case "System.Int32":
                    convertTo = "ToInt32";
                    break;
                case "System.Int64":
                    convertTo = "ToInt64";
                    break;
                case "System.Boolean":
                    convertTo = "ToBoolean";
                    break;
                case "System.String":
                    convertTo = "ToString";
                    break;
                default:
                    break;
            }
            return convertTo;
        }
    }
}
using System;
namespace Cis.Sso
{
    public class Class1
    {
    }
}
#region copyright
// <copyright file="NotSupportExpressionException.cs" company="cis"> 
// Copyright (c) cis. All Right Reserved
// </copyright>
// <author>孙强</author>
// <datecreated>2018-04-20</datecreated>
#endregion
namespace Cis.Sso
{
    using System;
    /// <summary>
    /// 用户信息
    /// </summary>
    public class CurrentUser
    {
        /// <summary>
        /// 主键,标识列,序列 就这样
        /// </summary>
        public string Id { get; set; }
        /// <summary>
        /// 用户编码
        /// </summary>
        public string Code { get; set; }
        /// <summary>
        /// 用户名称
        /// </summary>
        public string Name { get; set; }
        /// <summary>
        /// 机构编码
        /// </summary>
        public string OrgId { get; set; }
        /// <summary>
        /// 机构名称
        /// </summary>
        public string OrgName { get; set; }
        /// <summary>
        /// 是否内置角色 1：是0：否
        /// </summary>
        public string IsSysFlag { get; set; }
        /// <summary>
        /// 时间戳
        /// </summary>
        public DateTime TimeStamp { get; set; }
        /// <summary>
        /// 随机数
        /// </summary>
        public int Random { get; set; }
        /// <summary>
        /// 统筹区名称
        /// </summary>
        public string RegionName { get; set; }
        /// <summary>
        /// 针对审核系统的 多数据库模式
        /// </summary>
        public string DbKey { get; set; }
        /// <summary>
        /// 针对审核系统的 多统筹区模式
        /// </summary>
        public string Region { get; set; }
        /// <summary>
        /// 附加用户信息 用于子系统用户权限
        /// </summary>
        public string Append { get; set; }
        /// <summary>
        /// 用户工号
        /// </summary>
        public string WorkNo { get; set; }
        /// <summary>
        /// 用户类型
        /// </summary>
        public string UserType { get; set; }
        /// <summary>
        /// 用户登录码 验证用户是否已重新登录
        /// </summary>
        public string LoginKey { get; set; }
    }
}
#region copyright
// <copyright file="NotSupportExpressionException.cs" company="cis"> 
// Copyright (c) cis. All Right Reserved
// </copyright>
// <author>孙强</author>
// <datecreated>2018-04-20</datecreated>
#endregion
namespace Cis.Sso
{
    using System;
    using System.IO;
    using System.Security.Cryptography;
    using System.Text;
    public class Encryption
    {
        #region AES 加密解密
        // 使用AES加密字符串
        /// <summary>
        /// 使用AES加密字符串
        /// </summary>
        /// <param name="encryptString">待加密字符串</param>
        /// <param name="encryptKey">加密密匙</param>
        /// <param name="salt">盐</param>
        /// <returns>加密结果，加密失败则返回源串</returns>
        public static string EncryptAES(string encryptString, string encryptKey, string salt)
        {
            AesManaged aes = null;
            MemoryStream ms = null;
            CryptoStream cs = null;
            try
            {
                Rfc2898DeriveBytes rfc2898 = new Rfc2898DeriveBytes(encryptKey, Encoding.UTF8.GetBytes(salt));
                aes = new AesManaged();
                aes.Key = rfc2898.GetBytes(aes.KeySize / 8);
                aes.IV = rfc2898.GetBytes(aes.BlockSize / 8);
                ms = new MemoryStream();
                cs = new CryptoStream(ms, aes.CreateEncryptor(), CryptoStreamMode.Write);
                byte[] data = Encoding.UTF8.GetBytes(encryptString);
                cs.Write(data, 0, data.Length);
                cs.FlushFinalBlock();
                return Convert.ToBase64String(ms.ToArray());
            }
            catch
            {
                return null;
            }
            finally
            {
                if (cs != null)
                    cs.Close();
                if (ms != null)
                    ms.Close();
                if (aes != null)
                    aes.Clear();
            }
        }
        // 使用AES解密字符串
        /// <summary>
        /// 使用AES解密字符串
        /// </summary>
        /// <param name="decryptString">待解密字符串</param>
        /// <param name="decryptKey">解密密匙</param>
        /// <param name="salt">盐</param>
        /// <returns>解密结果，解谜失败则返回源串</returns>
        public static string DecryptAES(string decryptString, string decryptKey, string salt)
        {
            AesManaged aes = null;
            MemoryStream ms = null;
            CryptoStream cs = null;
            try
            {
                Rfc2898DeriveBytes rfc2898 = new Rfc2898DeriveBytes(decryptKey, Encoding.UTF8.GetBytes(salt));
                aes = new AesManaged();
                aes.Key = rfc2898.GetBytes(aes.KeySize / 8);
                aes.IV = rfc2898.GetBytes(aes.BlockSize / 8);
                ms = new MemoryStream();
                cs = new CryptoStream(ms, aes.CreateDecryptor(), CryptoStreamMode.Write);
                byte[] data = Convert.FromBase64String(decryptString);
                cs.Write(data, 0, data.Length);
                cs.FlushFinalBlock();
                return Encoding.UTF8.GetString(ms.ToArray(), 0, ms.ToArray().Length);
            }
            catch
            {
                return null;
            }
            finally
            {
                if (cs != null)
                    cs.Close();
                if (ms != null)
                    ms.Close();
                if (aes != null)
                    aes.Clear();
            }
        }
        #endregion AES
    }
}
using Cis.Tool.Extjs.Validator;
using Newtonsoft.Json;
using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Text;
namespace Cis.Tool.Extjs
{
    public class BuildModel
    {
        public void Build(string filePath, string appName, List<string> dtoAssemblys)
        {
            foreach (var item in dtoAssemblys)
            {
                BuildModelJs(filePath, appName, item, GetDtoTypes(item));
            }
        }
        private IList<Type> GetDtoTypes(string dtoAssembly)
        {
            IList<Type> types = new List<Type>();
            try
            {
                foreach (Type t in Assembly.Load(dtoAssembly).GetTypes())
                {
                    if ((t.FullName.Contains(".DTO.")|| t.FullName.Contains(".Dto.")) && t.BaseType.FullName != "System.Enum")
                    {
                        types.Add(t);
                    }
                }
            }
            catch (Exception)
            {
            }
            return types;
        }
        private void BuildModelJs(string filePath, string appName, string dtoAssembly, IList<Type> types)
        {
            var jsonSet = new JsonSerializerSettings() { NullValueHandling = NullValueHandling.Ignore };
            foreach (var item in types)
            {
                var model = new ExtModel();
                var props = item.GetProperties(BindingFlags.Public | BindingFlags.Instance);
                if (props.Length < 1)
                {
                    continue;
                }
                foreach (var pro in props)
                {
                    var notList = new List<string>();
                    notList.Add("PageNum");
                    notList.Add("PageSize");
                    notList.Add("TotalCount");
                    notList.Add("BeginIndex");
                    notList.Add("EndIndex");
                    notList.Add("PageIndex");
                    if (notList.IndexOf(pro.Name) > -1)
                    {
                        continue;
                    }
                    model.fields.Add(new ExtModelField(pro));
                    var vsList = new List<Top>();
                    var attrLen = pro.GetCustomAttributes(true).OfType<StringLengthAttribute>().FirstOrDefault();
                    if (attrLen != null)
                    {
                        vsList.Add(new StringLength(pro));
                    }
                    var attrMaxLen = pro.GetCustomAttributes(true).OfType<MaxLengthAttribute>().FirstOrDefault();
                    if (attrMaxLen != null)
                    {
                        vsList.Add(new MaxLength(pro));
                    }
                    var attrMinLen = pro.GetCustomAttributes(true).OfType<MinLengthAttribute>().FirstOrDefault();
                    if (attrMinLen != null)
                    {
                        vsList.Add(new MinLength(pro));
                    }
                    var attrRe = pro.GetCustomAttributes(true).OfType<RequiredAttribute>().FirstOrDefault();
                    if (attrRe != null)
                    {
                        vsList.Add(new Validator.Required(pro));
                    }
                    var attrReg = pro.GetCustomAttributes(true).OfType<RegularExpressionAttribute>().FirstOrDefault();
                    if (attrReg != null)
                    {
                        vsList.Add(new RegularExpression(pro));
                    }
                    var attrEmail = pro.GetCustomAttributes(true).OfType<EmailAddressAttribute>().FirstOrDefault();
                    if (attrEmail != null)
                    {
                        vsList.Add(new EmailAddress(pro));
                    }
                    var attrRange = pro.GetCustomAttributes(true).OfType<RangeAttribute>().FirstOrDefault();
                    if (attrRange != null)
                    {
                        vsList.Add(new Range(pro));
                    }
                    if (vsList.Count > 0)
                    {
                        model.validators.Add(pro.Name, vsList);
                    }
                }
                var strModelName = item.FullName.Replace(dtoAssembly + ".DTO.", "").Replace(dtoAssembly + ".Dto.", "").Replace(item.Name, "").ToLower() + item.Name;
                if (item.DeclaringType != null)
                {
                    strModelName = item.DeclaringType.FullName.Replace(dtoAssembly + ".DTO.", "").Replace(dtoAssembly + ".Dto.", "").Replace(item.DeclaringType.Name, "").ToLower() + item.DeclaringType.Name;
                }
                FileInfo file = new FileInfo(filePath + strModelName.Replace(".", "\\") + ".js");
                if (!Directory.Exists(file.DirectoryName))
                {
                    Directory.CreateDirectory(file.DirectoryName);
                }
                StringBuilder sb = new StringBuilder();
                sb.AppendFormat(@"Ext.define('{0}.model.{1}',{{
	extend: 'Fm.base.Model',
	fields: [",
        appName,
        strModelName
    );
                foreach (var fild in model.fields)
                {
                    sb.Append("\r\n       " + ConvertJsonString(JsonConvert.SerializeObject(fild, jsonSet)) + ",");
                }
                if (model.fields.Count > 0)
                {
                    sb.Remove(sb.Length - 1, 1);
                }
                sb.Append("\r\n    ]");
                if (model.validators.Count > 0)
                {
                    sb.Append(@",
    validators: {");
                    foreach (var validator in model.validators)
                    {
                        sb.Append("\r\n	    " + validator.Key + " :[");
                        foreach (var vasub in validator.Value)
                        {
                            sb.Append("\r\n            " + vasub.GetJsonStr() + ",");
                        }
                        sb.Remove(sb.Length - 1, 1);
                        sb.Append("\r\n	    ],");
                    }
                    sb.Remove(sb.Length - 1, 1);
                    sb.Append("\r\n    }");
                }
                sb.Append(@"
});");
                //string strModel = string.Format("Ext.define('CisApp.model.{0}',{1});", strModelName, ConvertJsonString(JsonConvert.SerializeObject(model, jsonSet)));
                File.WriteAllText(file.FullName, sb.ToString(), Encoding.UTF8);
            }
        }
        private string ConvertJsonString(string str)
        {
            //格式化json字符串
            JsonSerializer serializer = new JsonSerializer();
            TextReader tr = new StringReader(str);
            JsonTextReader jtr = new JsonTextReader(tr);
            object obj = serializer.Deserialize(jtr);
            if (obj != null)
            {
                StringWriter textWriter = new StringWriter();
                JsonTextWriter jsonWriter = new JsonTextWriter(textWriter)
                {
                    Formatting = Formatting.None,
                    Indentation = 0,
                    IndentChar = '\t',
                    QuoteChar = '\'',
                    QuoteName = false
                };
                serializer.Serialize(jsonWriter, obj);
                return textWriter.ToString();
            }
            else
            {
                return str;
            }
        }
    }
}using Cis.Tool.Extjs.Validator;
using System.Collections.Generic;
namespace Cis.Tool.Extjs
{
    public class ExtModel
    {
        public string extend { get; set; } = "CisApp.base.Model";
        public List<ExtModelField> fields { get; set; } = new List<ExtModelField>();
        private Dictionary<string, List<Top>> _validators;
        public Dictionary<string, List<Top>> validators
        {
            get
            {
                if (_validators == null)
                {
                    _validators = new Dictionary<string, List<Top>>();
                }
                return _validators;
            }
        }
    }
}
using System;
using System.ComponentModel;
using System.Linq;
using System.Reflection;
namespace Cis.Tool.Extjs
{
    public class ExtModelField
    {
        //public bool allowNull { get; set; } = false;
        //public string calculate { get; set; }
        //public string convert { get; set; }
        //public bool critical { get; set; } = false;
        //public string depends { get; set; }
        public string name { get; set; }
        public string type { get; set; }
        public object defaultValue { get; set; }
        public ExtModelField(PropertyInfo pro)
        {
            name = pro.Name;
            type = GetFieldType(pro.PropertyType);
            var defaultValueAttr = pro.GetCustomAttributes(true).OfType<DefaultValueAttribute>().FirstOrDefault();
            if (defaultValueAttr != null)
            {
                defaultValue = defaultValueAttr.Value;
            }
        }
        /// <summary>
        /// 转Extjs类型
        /// </summary>
        /// <param name="_type"></param>
        /// <returns></returns>
        private static string GetFieldType(Type _type)
        {
            string type = null;
            if (_type.Equals(typeof(Int16))
                || _type.Equals(typeof(Int32))
                || _type.Equals(typeof(Int16?))
                || _type.Equals(typeof(Int32?)))
            {
                type = "int";
            }
            if (_type.Equals(typeof(Int64))
                || _type.Equals(typeof(Int64?)))
            {
                type = "number";
            }
            if (_type.Equals(typeof(string)))
            {
                type = "string";
            }
            if (_type.Equals(typeof(DateTime))
                || _type.Equals(typeof(DateTime?)))
            {
                type = "date";
            }
            if (_type.Equals(typeof(bool))
                || _type.Equals(typeof(bool?)))
            {
                type = "boolean";
            }
            return type;
        }
    }
}
using System.ComponentModel.DataAnnotations;
using System.Linq;
using System.Reflection;
namespace Cis.Tool.Extjs.Validator
{
    public class EmailAddress : Top
    {
        public string type { get; set; } = "email";
        public string matcher { get; set; }
        public string message { get; set; }
        public EmailAddress(PropertyInfo pro)
        {
            var attr = pro.GetCustomAttributes(true).OfType<EmailAddressAttribute>().FirstOrDefault();
            if (attr != null)
            {
                this.message = attr.ErrorMessage;
            }
        }
    }
}
using System.ComponentModel.DataAnnotations;
using System.Linq;
using System.Reflection;
namespace Cis.Tool.Extjs.Validator
{
    public class MaxLength : Top
    {
        public string type { get; set; } = "length";
        public int max { get; set; }
        public string message { get; set; }
        public MaxLength(PropertyInfo pro)
        {
            var attr = pro.GetCustomAttributes(true).OfType<MaxLengthAttribute>().FirstOrDefault();
            if (attr != null)
            {
                this.max = attr.Length;
                this.message = attr.ErrorMessage;
            }
        }
    }
}
using System.ComponentModel.DataAnnotations;
using System.Linq;
using System.Reflection;
namespace Cis.Tool.Extjs.Validator
{
    public class MinLength : Top
    {
        public string type { get; set; } = "length";
        public int min { get; set; }
        public string message { get; set; }
        public MinLength(PropertyInfo pro)
        {
            var attr = pro.GetCustomAttributes(true).OfType<MinLengthAttribute>().FirstOrDefault();
            if (attr != null)
            {
                this.min = attr.Length;
                this.message = attr.ErrorMessage;
            }
        }
    }
}
using System.ComponentModel.DataAnnotations;
using System.Linq;
using System.Reflection;
namespace Cis.Tool.Extjs.Validator
{
    public class Range : Top
    {
        public string type { get; set; } = "range";
        public object max { get; set; }
        public object min { get; set; }
        public string matcher { get; set; }
        public string bothMessage { get; set; }
        public Range(PropertyInfo pro)
        {
            var attr = pro.GetCustomAttributes(true).OfType<RangeAttribute>().FirstOrDefault();
            if (attr != null)
            {
                this.max = attr.Maximum;
                this.max = attr.Minimum;
                this.bothMessage = attr.ErrorMessage;
            }
        }
    }
}
using Newtonsoft.Json;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using System.Linq;
using System.Reflection;
namespace Cis.Tool.Extjs.Validator
{
    public class RegularExpression : Top
    {
        public string type { get; set; } = "format";
        public string matcher { get; set; }
        public string message { get; set; }
        public RegularExpression(PropertyInfo pro)
        {
            var attr = pro.GetCustomAttributes(true).OfType<RegularExpressionAttribute>().FirstOrDefault();
            if (attr != null)
            {
                this.matcher = attr.Pattern;
                this.message = attr.ErrorMessage;
            }
        }
        public override string GetJsonStr()
        {
            var msg = JsonConvert.SerializeObject(this.message ?? "");
            msg = msg.Remove(0, 1);
            msg = msg.Remove(msg.Length - 1, 1);
            return string.Format("{{ type: 'format', matcher: /{0}/, message: '{1}' }}", this.matcher, msg);
            //return JsonConvert.SerializeObject(this, jsonSet);
        }
    }
}
using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using System.Linq;
using System.Reflection;
using System.Threading.Tasks;
namespace Cis.Tool.Extjs.Validator
{
    public class Required : Top
    {
        
        //public bool allowBlank { get; set; } = false;
        public string type { get; set; }= "presence";
        public string message { get; set; }
        public Required(PropertyInfo pro)
        {
            var attr = pro.GetCustomAttributes(true).OfType<RequiredAttribute>().FirstOrDefault();
            if (attr != null)
            {
                this.message = attr.ErrorMessage;
            }
        }
    }
}
using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using System.Linq;
using System.Reflection;
using System.Threading.Tasks;
namespace Cis.Tool.Extjs.Validator
{
    public class StringLength : Top
    {
        public string type { get; set; } = "length";
        public int? max { get; set; }
        public int? min { get; set; }
        public string bothMessage { get; set; }
        public string emptyMessage { get; set; }
        public string maxOnlyMessage { get; set; }
        public string minOnlyMessage { get; set; }
        public StringLength(PropertyInfo pro)
        {
            var attr = pro.GetCustomAttributes(true).OfType<StringLengthAttribute>().FirstOrDefault();
            if (attr != null)
            {
                if (attr.MaximumLength == 0 && attr.MinimumLength != 0)
                {
                    this.min = attr.MinimumLength;
                    this.minOnlyMessage = attr.ErrorMessage;
                }
                else if (attr.MaximumLength != 0 && attr.MinimumLength == 0)
                {
                    this.max = attr.MaximumLength;
                    this.maxOnlyMessage = attr.ErrorMessage;
                }
                else
                {
                    if (attr.MaximumLength != 0)
                    {
                        this.max = attr.MaximumLength;
                    }
                    if (attr.MinimumLength != 0)
                    {
                        this.min = attr.MinimumLength;
                    }
                    this.bothMessage = attr.ErrorMessage;
                }
            }
        }
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Newtonsoft.Json;
using System.IO;
namespace Cis.Tool.Extjs.Validator
{
    public abstract class Top
    {
        [NonSerialized()]
        public JsonSerializerSettings jsonSet = new JsonSerializerSettings()
        {
            NullValueHandling = NullValueHandling.Ignore,
            TypeNameHandling = TypeNameHandling.None
        };
        public virtual string GetJsonStr()
        {
            return ConvertJsonString(JsonConvert.SerializeObject(this, jsonSet));
        }
        private string ConvertJsonString(string str)
        {
            //格式化json字符串
            JsonSerializer serializer = new JsonSerializer();
            TextReader tr = new StringReader(str);
            JsonTextReader jtr = new JsonTextReader(tr);
            object obj = serializer.Deserialize(jtr);
            if (obj != null)
            {
                StringWriter textWriter = new StringWriter();
                JsonTextWriter jsonWriter = new JsonTextWriter(textWriter)
                {
                    Formatting = Formatting.None,
                    Indentation = 0,
                    IndentChar = '\t',
                    QuoteChar = '\'',
                    QuoteName = false
                };
                serializer.Serialize(jsonWriter, obj);
                return textWriter.ToString();
            }
            else
            {
                return str;
            }
        }
    }
}
